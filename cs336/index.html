<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Tokenization &amp; Language Modeling | emopps</title><noscript>å¼€å¯JavaScriptæ‰èƒ½è®¿é—®æœ¬ç«™å“¦~</noscript><link rel="icon" href="/img/favicon.png"><link rel="stylesheet" href="/css/index.css?v=3.0.21&amp;t=1770527738353"><link rel="canonical" href="https://emopps.github.io/cs336/index.html"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.2/css/all.min.css"><!-- Feature-specific CSS--><!-- aplayer--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css"><!-- swiper--><!-- fancybox ui--><!-- katex--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"><!-- Open Graph--><meta name="description" content="Assignment 01: Tokenization &amp;amp; Language ModelingAssignment 01 è¦æ±‚æˆ‘ä»¬å®ç°ä¸€ä¸ªç®€å•çš„è¯­è¨€æ¨¡å‹è®­ç»ƒæµç¨‹ï¼Œæ¶µç›–æ•°æ®é¢„å¤„ç†ã€æ¨¡å‹å®šä¹‰ã€è®­ç»ƒå’Œè¯„ä¼°ç­‰æ­¥éª¤ã€‚é€šè¿‡è¿™ä¸ªä½œä¸šï¼Œæˆ‘ä»¬å°†å·©å›ºå¯¹è‡ªç„¶è¯­è¨€å¤„ç†åŸºç¡€æ¦‚å¿µçš„ç†è§£ï¼Œå¹¶æŒæ¡ä½¿ç”¨PyTorchè¿›è¡Œæ·±åº¦"><!-- pwa--><meta name="apple-mobile-web-app-capable" content="emopps"><meta name="theme-color" content="var(--efu-main)"><meta name="apple-mobile-web-app-status-bar-style" content="var(--efu-main)"><link rel="bookmark" href="/img/favicon.png"><link rel="apple-touch-icon" href="/img/favicon.png" sizes="180x180"><script>console.log(' %c Solitude %c ' + '3.0.21' + ' %c https://github.com/everfu/hexo-theme-solitude',
    'background:#35495e ; padding: 1px; border-radius: 3px 0 0 3px;  color: #fff',
    'background:#ff9a9a ; padding: 1px; border-radius: 0 3px 3px 0;  color: #fff',
    'background:unset ; padding: 1px; border-radius: 0 3px 3px 0;  color: #fff')
</script><style>
[data-theme="dark"] body {
  background-color: #0b0f1a;
  background-image:
    radial-gradient(1200px 800px at 20% 25%, rgba(255, 88, 118, 0.22), rgba(11, 15, 26, 0) 60%),
    radial-gradient(1000px 700px at 80% 35%, rgba(90, 160, 255, 0.18), rgba(11, 15, 26, 0) 55%),
    radial-gradient(900px 600px at 55% 80%, rgba(180, 90, 255, 0.16), rgba(11, 15, 26, 0) 60%);
  background-attachment: fixed;
  background-repeat: no-repeat;
  background-size: cover;
}
</style>
<style>
body[data-type="music"] #Music-page .aplayer-list {
  background: rgba(0, 0, 0, 0.35);
  border: 1px solid rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(18px);
  -webkit-backdrop-filter: blur(18px);
  border-radius: 14px;
  padding: 10px 10px;
}
body[data-type="music"] #Music-page .aplayer-list ol {
  padding: 0 6px;
}
body[data-type="music"] #Music-page .aplayer-body {
  padding: 0 12px;
}
</style>
<link rel="stylesheet" href="/schedule/schedule.css"><script>(()=>{
        const saveToLocal = {
            set: function setWithExpiry(key, value, ttl) {
                if (ttl === 0)
                    return
                const now = new Date()
                const expiryDay = ttl * 86400000
                const item = {
                    value: value,
                    expiry: now.getTime() + expiryDay
                }
                localStorage.setItem(key, JSON.stringify(item))
            },
            get: function getWithExpiry(key) {
                const itemStr = localStorage.getItem(key)

                if (!itemStr) {
                    return undefined
                }
                const item = JSON.parse(itemStr)
                const now = new Date()

                if (now.getTime() > item.expiry) {
                    localStorage.removeItem(key)
                    return undefined
                }
                return item.value
            }
        };
        window.utils = {
            saveToLocal: saveToLocal,
            getCSS: (url, id = false) => new Promise((resolve, reject) => {
              const link = document.createElement('link')
              link.rel = 'stylesheet'
              link.href = url
              if (id) link.id = id
              link.onerror = reject
              link.onload = link.onreadystatechange = function() {
                const loadState = this.readyState
                if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
                link.onload = link.onreadystatechange = null
                resolve()
              }
              document.head.appendChild(link)
            }),
            getScript: (url, attr = {}) => new Promise((resolve, reject) => {
              const script = document.createElement('script')
              script.src = url
              script.async = true
              script.onerror = reject
              script.onload = script.onreadystatechange = function() {
                const loadState = this.readyState
                if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
                script.onload = script.onreadystatechange = null
                resolve()
              }

              Object.keys(attr).forEach(key => {
                script.setAttribute(key, attr[key])
              })

              document.head.appendChild(script)
            }),
            addGlobalFn: (key, fn, name = false, parent = window) => {
                const globalFn = parent.globalFn || {}
                const keyObj = globalFn[key] || {}

                if (name && keyObj[name]) return

                name = name || Object.keys(keyObj).length
                keyObj[name] = fn
                globalFn[key] = keyObj
                parent.globalFn = globalFn
            },
            addEventListenerPjax: (ele, event, fn, option = false) => {
              ele.addEventListener(event, fn, option)
              utils.addGlobalFn('pjax', () => {
                  ele.removeEventListener(event, fn, option)
              })
            },
            diffDateFormat: (selector) => {
                selector.forEach(item => {
                    const date = new Date(item.getAttribute('datetime') || item.textContent);
                    item.textContent = (date.getMonth() + 1).toString()+'/'+date.getDate().toString();
                });
            },
        }
    })()</script><!-- theme--><script>initTheme = () => {
    const cachedMode = utils.saveToLocal.get('theme');
    if (cachedMode === undefined)
        document.documentElement.setAttribute('data-theme', 'light');
    else
        document.documentElement.setAttribute('data-theme', cachedMode);
    typeof rm === 'object' && rm.mode(cachedMode === 'dark')
}
initTheme()</script><script>const GLOBAL_CONFIG = {
    root: '/',
    algolia: undefined,
    localsearch: {"preload":true,"path":"/search.xml"},
    runtime: '2026-01-26 00:00:00',
    lazyload: {
        enable: false,
        error: '/img/error_load.avif'
    },
    copyright: false,
    highlight: {"limit":200,"expand":true,"copy":true,"syntax":"highlight.js"},
    randomlink: false,
    lang: {"theme":{"dark":"å·²åˆ‡æ¢è‡³æ·±è‰²æ¨¡å¼","light":"å·²åˆ‡æ¢è‡³æµ…è‰²æ¨¡å¼"},"copy":{"success":"å¤åˆ¶æˆåŠŸ","error":"å¤åˆ¶å¤±è´¥"},"backtop":"è¿”å›é¡¶éƒ¨","time":{"day":"å¤©å‰","hour":"å°æ—¶å‰","just":"åˆšåˆš","min":"åˆ†é’Ÿå‰","month":"ä¸ªæœˆå‰"},"day":" å¤©","f12":"å¼€å‘è€…æ¨¡å¼å·²æ‰“å¼€ï¼Œè¯·éµå¾ªGPLåè®®ã€‚","totalk":"æ— éœ€åˆ é™¤ç©ºè¡Œï¼Œç›´æ¥è¾“å…¥è¯„è®ºå³å¯","search":{"empty":"æ‰¾ä¸åˆ°ä½ æŸ¥è¯¢çš„å†…å®¹ï¼š${query}","hit":"æ‰¾åˆ° ${hits} æ¡ç»“æœï¼Œç”¨æ—¶ ${time} æ¯«ç§’","placeholder":"è¾“å…¥å…³é”®è¯å¿«é€ŸæŸ¥æ‰¾","count":"å…± <b>${count}</b> æ¡ç»“æœã€‚","loading":"æœç´¢ä¸­..."}},
    aside: {
        state: {
            morning: "âœ¨ æ—©ä¸Šå¥½ï¼Œæ–°çš„ä¸€å¤©å¼€å§‹äº†",
            noon: "ğŸ² åˆé¤æ—¶é—´",
            afternoon: "ğŸŒ ä¸‹åˆå¥½",
            night: "æ—©ç‚¹ä¼‘æ¯",
            goodnight: "æ™šå®‰ ğŸ˜´",
        },
        witty_words: [],
        witty_comment: {
            prefix: 'å¥½ä¹…ä¸è§ï¼Œ',
            back: 'æ¬¢è¿å†æ¬¡å›æ¥ï¼Œ',
        },
    },
    covercolor: {
        enable: true
    },
    comment: false,
    lightbox: 'null',
    right_menu: {"mode":{"dark":"æ·±è‰²æ¨¡å¼","light":"æµ…è‰²æ¨¡å¼"},"img_error":"æ­¤å›¾ç‰‡æ— æ³•å¤åˆ¶ä¸ä¸‹è½½","translate":false},
    translate: {"translateDelay":0,"defaultEncoding":2},
    lure: false,
    expire: false,
};</script><script id="config-diff">var PAGE_CONFIG = {
    is_post: true,
    is_page: false,
    is_home: false,
    page: '',
    toc: true,
    comment: false,
    ai_text: false,
    color: false,
}</script><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body id="body"><div><canvas id="universe"></canvas></div><div><div id="loading-box" onclick="preloader.endLoading();" style="zoom:1"><div class="loading-bg"><img class="loading-img nolazyload" src="/img/avatar.png" alt="loading image"></div></div><script>const preloader = {
    isLoaded: false,
    endLoading: () => {
        if (!preloader.isLoaded) {
            document.getElementById('loading-box').classList.add('loaded');
            preloader.isLoaded = true;
            preloader.togglePaceDone();
        }
    },
    initLoading: () => {
        document.getElementById('loading-box').classList.remove('loaded');
        preloader.isLoaded = false;
        preloader.togglePaceDone();
    },
    togglePaceDone: () => {
        document.getElementById('body').className = preloader.isLoaded ? 'pace-done' : '';
    }
}

window.addEventListener('load', () => {
    preloader.endLoading();
});

window.addEventListener('pjax:send', () => {
    preloader.initLoading();
});

document.addEventListener('pjax:complete', () => {
    preloader.endLoading();
});

setTimeout(() => {
    preloader.endLoading();
}, 5000);</script></div><div id="console"><div class="close-btn" onclick="sco.hideConsole()"><i class="solitude fas fa-xmark"></i></div><div class="console-card-group"><div class="console-card-group-right"><div class="console-card tags" onclick="sco.hideConsole()"><div class="card-content"><div class="author-content-item-tips">æ ‡ç­¾</div><div class="author-content-item-title">å¯»æ‰¾æ„Ÿå…´è¶£çš„é¢†åŸŸ</div></div><div class="card-tag-cloud"><a href="/tags/LLM/">LLM<sup>1</sup></a><a href="/tags/NLP/">NLP<sup>1</sup></a><a href="/tags/PyTorch/">PyTorch<sup>1</sup></a><a href="/tags/Tokenization/">Tokenization<sup>1</sup></a><a href="/tags/Transformer/">Transformer<sup>1</sup></a><a href="/tags/c/">c++<sup>2</sup></a><a href="/tags/%E5%AD%A6%E4%B9%A0/">å­¦ä¹ <sup>3</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/">æ•°æ®ç»“æ„ä¸ç®—æ³•<sup>1</sup></a><a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">æ“ä½œç³»ç»Ÿ<sup>1</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">è®¡ç®—æœºç½‘ç»œ<sup>1</sup></a></div></div><div class="console-card history" onclick="sco.hideConsole()"><ul class="card-archive-list"><li class="item"><a href="/archives/2026/01/"><span class="date">2026/01</span><div class="count-group"><span class="count">1</span><span class="unit">ç¯‡</span></div></a></li><li class="item"><a href="/archives/2025/09/"><span class="date">2025/09</span><div class="count-group"><span class="count">1</span><span class="unit">ç¯‡</span></div></a></li><li class="item"><a href="/archives/2025/07/"><span class="date">2025/07</span><div class="count-group"><span class="count">3</span><span class="unit">ç¯‡</span></div></a></li><li class="item"><a href="/archives/"><span class="date">å…¨éƒ¨æ–‡ç« </span><div class="count-group"><span class="count">5</span><span class="unit">ç¯‡</span></div></a></li></ul></div></div></div><div class="button-group"><div class="console-btn-item"><span class="darkmode_switchbutton" onclick="sco.switchDarkMode()" title="æ˜¼å¤œåˆ‡æ¢"><i class="solitude fas fa-circle-half-stroke"></i></span></div><div class="console-btn-item" id="consoleHideAside"><span class="asideSwitch" onclick="sco.switchHideAside()" title="è¾¹æ æ˜¾ç¤ºæ§åˆ¶"><i class="solitude fas fa-arrows-left-right-to-line"></i></span></div></div><div class="console-mask" onclick="sco.hideConsole()"></div></div><div id="sidebar" style="zoom: 1;"><div id="menu-mask" style="display: none;"></div><div id="sidebar-menus"><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">5</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">2</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">10</div></a></div></div></div><span class="sidebar-menu-item-title">åŠŸèƒ½</span><div class="sidebar-menu-item"><span class="darkmode_switchbutton menu-child" onclick="sco.switchDarkMode()"><i class="solitude fas fa-circle-half-stroke"></i><span>æ˜¾ç¤ºæ¨¡å¼</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>æ–‡åº“</span></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="solitude  fas fa-file-lines"></i><span>æ–‡ç« </span></a></li><li><a class="site-page child" href="/categories/"><i class="solitude  fas fa-clone"></i><span>åˆ†ç±»</span></a></li><li><a class="site-page child" href="/tags/"><i class="solitude  fas fa-tags"></i><span>æ ‡ç­¾</span></a></li><li><a class="site-page child" href="/stats/"><i class="solitude  fas fa-chart-simple"></i><span>ç»Ÿè®¡</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>å¨±ä¹</span></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="solitude  fas fa-music"></i><span>éŸ³ä¹é¦†</span></a></li><li><a class="site-page child" href="/hot/"><i class="solitude  fas fa-fire-flame-curved"></i><span>çƒ­æ¦œ</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>æˆ‘çš„</span></a><ul class="menus_item_child"><li><a class="site-page child" href="/update/"><i class="solitude  fas fa-clock-rotate-left"></i><span>æ›´æ–°</span></a></li><li><a class="site-page child" href="/essay/"><i class="solitude  fas fa-message"></i><span>åŠ¨æ€</span></a></li><li><a class="site-page child" href="/about/"><i class="solitude  fas fa-user"></i><span>å…³äº</span></a></li></ul></div></div><span class="sidebar-menu-item-title">æ ‡ç­¾</span><div class="card-tags"><div class="card-tag-cloud"><a href="/tags/LLM/">LLM<sup>1</sup></a><a href="/tags/NLP/">NLP<sup>1</sup></a><a href="/tags/PyTorch/">PyTorch<sup>1</sup></a><a href="/tags/Tokenization/">Tokenization<sup>1</sup></a><a href="/tags/Transformer/">Transformer<sup>1</sup></a><a href="/tags/c/">c++<sup>2</sup></a><a href="/tags/%E5%AD%A6%E4%B9%A0/">å­¦ä¹ <sup>3</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/">æ•°æ®ç»“æ„ä¸ç®—æ³•<sup>1</sup></a><a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">æ“ä½œç³»ç»Ÿ<sup>1</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">è®¡ç®—æœºç½‘ç»œ<sup>1</sup></a></div></div><span class="sidebar-menu-item-title">ç½‘ç«™ä¿¡æ¯</span><div class="webinfo"><div class="webinfo-item"><div class="item-name">å…¨ç«™å­—æ•° :</div><div class="item-count">130.5k</div></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav class="show" id="nav"><div id="nav-group"><div id="blog_name"><a href="/" title="è¿”å›åšå®¢ä¸»é¡µ" id="site-name"><span class="title">emopps</span><i class="solitude fas fa-home"></i></a></div><div id="page-name-mask"><div id="page-name"><a id="page-name-text" onclick="sco.toTop()">Tokenization &amp; Language Modeling</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>æ–‡åº“</span></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="solitude  fas fa-file-lines"></i><span>æ–‡ç« </span></a></li><li><a class="site-page child" href="/categories/"><i class="solitude  fas fa-clone"></i><span>åˆ†ç±»</span></a></li><li><a class="site-page child" href="/tags/"><i class="solitude  fas fa-tags"></i><span>æ ‡ç­¾</span></a></li><li><a class="site-page child" href="/stats/"><i class="solitude  fas fa-chart-simple"></i><span>ç»Ÿè®¡</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>å¨±ä¹</span></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="solitude  fas fa-music"></i><span>éŸ³ä¹é¦†</span></a></li><li><a class="site-page child" href="/hot/"><i class="solitude  fas fa-fire-flame-curved"></i><span>çƒ­æ¦œ</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>æˆ‘çš„</span></a><ul class="menus_item_child"><li><a class="site-page child" href="/update/"><i class="solitude  fas fa-clock-rotate-left"></i><span>æ›´æ–°</span></a></li><li><a class="site-page child" href="/essay/"><i class="solitude  fas fa-message"></i><span>åŠ¨æ€</span></a></li><li><a class="site-page child" href="/about/"><i class="solitude  fas fa-user"></i><span>å…³äº</span></a></li></ul></div></div></div><div id="nav-left"></div><div id="nav-right"><div class="nav-button" id="nav-darkmode"><a class="site-page" href="javascript:void(0);" onclick="sco.switchDarkMode()" title="æ¨¡å¼åˆ‡æ¢"><i class="solitude fas fa-circle-half-stroke"></i></a></div><div class="nav-button" id="nav-github"><a class="site-page" target="_blank" rel="noopener" href="https://github.com/emopps" title="Github"><i class="solitude fab fa-github"></i></a></div><div class="nav-button" id="nav-rss"><a class="site-page" href="/atom.xml" title="RSS"><i class="solitude fas fa-rss"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="æœç´¢"><i class="solitude fas fa-magnifying-glass"></i></a></div><div class="nav-button" id="nav-totop" onclick="sco.toTop()"><a class="totopbtn"><i class="solitude fas fa-arrow-up"></i><span id="percent">0</span></a></div><div id="toggle-menu"><a class="site-page"><i class="solitude fas fa-bars"></i></a></div></div></div></nav><div class="coverdiv" id="coverdiv"><img class="nolazyload" id="post-cover" src="/img/covers/cs336.png" alt="Tokenization &amp; Language Modeling"></div><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original" title="è¯¥æ–‡ç« ä¸ºåŸåˆ›æ–‡ç« ï¼Œæ³¨æ„ç‰ˆæƒåè®®">åŸåˆ›</a><span class="post-meta-categories"><a class="post-meta-categories" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">å­¦ä¹ ç¬”è®°</a></span><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/LLM/"><span class="tags-name tags-punctuation"><i class="solitude fas fa-hashtag"></i>LLM</span></a><a class="post-meta__tags" href="/tags/NLP/"><span class="tags-name tags-punctuation"><i class="solitude fas fa-hashtag"></i>NLP</span></a><a class="post-meta__tags" href="/tags/PyTorch/"><span class="tags-name tags-punctuation"><i class="solitude fas fa-hashtag"></i>PyTorch</span></a><a class="post-meta__tags" href="/tags/Tokenization/"><span class="tags-name tags-punctuation"><i class="solitude fas fa-hashtag"></i>Tokenization</span></a><a class="post-meta__tags" href="/tags/Transformer/"><span class="tags-name tags-punctuation"><i class="solitude fas fa-hashtag"></i>Transformer</span></a></div></div></div></div><h1 class="post-title">Tokenization &amp; Language Modeling</h1><div id="post-meta"><div class="meta-secondline"><span class="post-meta-date" title="å‘å¸ƒäº 2026-01-27 14:05:53"><i class="post-meta-icon solitude fas fa-calendar-days"></i><time datetime="2026-01-27T06:05:53.000Z">2026-01-27T06:05:53.000Z</time></span><span class="post-meta-date" title="æœ€åæ›´æ–°äº 2026-02-05 12:42:55"><i class="post-meta-icon solitude fas fa-arrows-rotate"></i><time datetime="2026-02-05T04:42:55.901Z">2026-02-05T04:42:55.901Z</time></span><span class="post-meta-wordcount"><span class="post-meta-separator"></span></span></div></div></div><div class="post-radius-bottom"></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content article-container"><h1 id="Assignment-01-Tokenization-amp-Language-Modeling"><a href="#Assignment-01-Tokenization-amp-Language-Modeling" class="headerlink" title="Assignment 01: Tokenization &amp; Language Modeling"></a>Assignment 01: Tokenization &amp; Language Modeling</h1><p><strong>Assignment 01 è¦æ±‚æˆ‘ä»¬å®ç°ä¸€ä¸ªç®€å•çš„è¯­è¨€æ¨¡å‹è®­ç»ƒæµç¨‹ï¼Œæ¶µç›–æ•°æ®é¢„å¤„ç†ã€æ¨¡å‹å®šä¹‰ã€è®­ç»ƒå’Œè¯„ä¼°ç­‰æ­¥éª¤ã€‚é€šè¿‡è¿™ä¸ªä½œä¸šï¼Œæˆ‘ä»¬å°†å·©å›ºå¯¹è‡ªç„¶è¯­è¨€å¤„ç†åŸºç¡€æ¦‚å¿µçš„ç†è§£ï¼Œå¹¶æŒæ¡ä½¿ç”¨PyTorchè¿›è¡Œæ·±åº¦å­¦ä¹ æ¨¡å‹å¼€å‘çš„åŸºæœ¬æŠ€èƒ½ã€‚</strong></p>
<hr>
<p>Assignment 01 è¦æ±‚æˆ‘ä»¬ä»0å®ç°ä¸€ä¸ªç®€å•çš„è¯­è¨€æ¨¡å‹è®­ç»ƒæµç¨‹ï¼Œæ¶µç›–:</p>
<ul>
<li>Tokenization ç®—æ³•çš„å®ç°</li>
<li>æ¨¡å‹çš„å®šä¹‰</li>
<li>ä¼˜åŒ–å™¨çš„å®šä¹‰</li>
<li>è®­ç»ƒä»£ç </li>
</ul>
<p>é€šè¿‡è¿™ä¸€ä¸ªAssignmentï¼Œæˆ‘ä»¬å¯ä»¥äº†è§£åˆ°åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„LMæ¨¡å‹çš„å…¨éƒ¨æµç¨‹ï¼Œåç»­çš„è¯¾ç¨‹ä»¥åŠAssignmentéƒ½ä¼šåŸºäºè¿™ä¸ªæµç¨‹è¿›è¡Œæ‰©å±•å’Œä¼˜åŒ–ã€‚</p>
<hr>
<h2 id="1-å‡†å¤‡"><a href="#1-å‡†å¤‡" class="headerlink" title="1 å‡†å¤‡"></a>1 å‡†å¤‡</h2><p>åœ¨å®Œæˆè¿™ä¸ªAssignmentä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦å­¦ä¹ Lecture 01,02,03 çš„å†…å®¹ï¼Œä¸»è¦åŒ…æ‹¬:</p>
<ul>
<li>Byte Pair Encoding (BPE)ç®—æ³•</li>
<li>Transformeræ¨¡å‹</li>
<li>è¯­è¨€æ¨¡å‹çš„è®­ç»ƒæ–¹æ³•</li>
<li>ä¼˜åŒ–å™¨çš„ä½¿ç”¨</li>
<li>PyTorchçš„åŸºæœ¬ä½¿ç”¨</li>
</ul>
<p>é¢„è®¡éœ€è¦çš„æ—¶é—´10hours.</p>
<hr>
<h3 id="1-1-PyTorch-æ ¸å¿ƒæ¦‚å¿µé€Ÿè§ˆ"><a href="#1-1-PyTorch-æ ¸å¿ƒæ¦‚å¿µé€Ÿè§ˆ" class="headerlink" title="1.1 PyTorch æ ¸å¿ƒæ¦‚å¿µé€Ÿè§ˆ"></a>1.1 PyTorch æ ¸å¿ƒæ¦‚å¿µé€Ÿè§ˆ</h3><p>å¦‚æœä½ ä»æœªæ¥è§¦è¿‡ PyTorchï¼Œç†è§£ä»¥ä¸‹ä¸‰ä¸ªæ¦‚å¿µå¯¹äºå®Œæˆæœ¬æ¬¡ä½œä¸šè‡³å…³é‡è¦ï¼š</p>
<ol>
<li><p><strong>Tensor (å¼ é‡)</strong>: å®ƒæ˜¯ PyTorch ä¸­çš„åŸºæœ¬æ•°æ®ç»“æ„ï¼Œå¯ä»¥ç®€å•ç†è§£ä¸ºâ€œå¤šç»´æ•°ç»„â€ã€‚</p>
<ul>
<li>æ ‡é‡ (Scalar): 0ç»´å¼ é‡ï¼Œå¦‚ 1.0ã€‚</li>
<li>å‘é‡ (Vector): 1ç»´å¼ é‡ï¼Œå¦‚ [1.0, 2.0]ã€‚</li>
<li>çŸ©é˜µ (Matrix): 2ç»´å¼ é‡ï¼Œå¦‚ [[1, 2], [3, 4]]ã€‚</li>
<li><strong>LLM ä¸­çš„å½¢çŠ¶ (B, T, D)</strong>: åœ¨è¯­è¨€æ¨¡å‹ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸å¤„ç† 3ç»´å¼ é‡ã€‚<ul>
<li><strong>B (Batch Size)</strong>: ä¸€æ¬¡å¹¶è¡Œå¤„ç†å¤šå°‘ä¸ªå¥å­ã€‚</li>
<li><strong>T (Time/Sequence Length)</strong>: å¥å­çš„é•¿åº¦ï¼ˆtokençš„æ•°é‡ï¼‰ã€‚</li>
<li><strong>D (Dimension/Hidden Size)</strong>: æ¯ä¸ª token ç”¨å¤šå°‘ç»´çš„å‘é‡æ¥è¡¨ç¤ºã€‚</li>
</ul>
</li>
</ul>
<ol>
<li><p><strong>Computational Graph (è®¡ç®—å›¾)</strong>: ç¥ç»ç½‘ç»œçš„è®­ç»ƒè¿‡ç¨‹æœ¬è´¨ä¸Šæ˜¯æ„å»ºä¸€ä¸ªå›¾ã€‚</p>
<ul>
<li>forward() è¿‡ç¨‹æ˜¯å»ºç«‹å›¾çš„è¿‡ç¨‹ã€‚</li>
<li>backward() è¿‡ç¨‹æ˜¯æ²¿ç€å›¾åå‘ä¼ æ’­ï¼Œè®¡ç®—æ¢¯åº¦ï¼ˆå³ Loss å¯¹æ¯ä¸ªå‚æ•°çš„å¯¼æ•°ï¼‰ã€‚</li>
</ul>
</li>
<li><p><strong>Broadcasting (å¹¿æ’­æœºåˆ¶)</strong>: å½“ä¸¤ä¸ªå½¢çŠ¶ä¸åŒçš„å¼ é‡è¿›è¡Œè®¡ç®—æ—¶ï¼ˆå¦‚ (3, 1) åŠ  (3, 4)ï¼‰ï¼ŒPyTorch ä¼šè‡ªåŠ¨æ‰©å±•è¾ƒå°çš„ç»´åº¦ä»¥åŒ¹é…è¾ƒå¤§çš„ç»´åº¦ã€‚è¿™åœ¨ Masked Attention å’Œ RMSNorm çš„ä»£ç ä¸­ä¼šé¢‘ç¹å‡ºç°ã€‚</p>
</li>
</ol>
</li>
</ol>
<h3 id="1-2-ä¸‹è½½åŸå§‹ä»£ç å’Œæ•°æ®é›†"><a href="#1-2-ä¸‹è½½åŸå§‹ä»£ç å’Œæ•°æ®é›†" class="headerlink" title="1.2 ä¸‹è½½åŸå§‹ä»£ç å’Œæ•°æ®é›†"></a>1.2 ä¸‹è½½åŸå§‹ä»£ç å’Œæ•°æ®é›†</h3><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦ä¸‹è½½åŸå§‹ä»£ç å’Œæ•°æ®é›†ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/stanford-cs336/assignment1-basics</span><br></pre></td></tr></table></figure>
<p>ä¸‹è½½å®Œä»£ç ä¹‹åï¼Œæˆ‘ä»¬å†ä¸‹è½½æ•°æ®é›†:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p data</span><br><span class="line"><span class="built_in">cd</span> data</span><br><span class="line"></span><br><span class="line">wget https://huggingface.co/datasets/roneneldan/TinyStories/resolve/main/TinyStoriesV2-GPT4-train.txt</span><br><span class="line">wget https://huggingface.co/datasets/roneneldan/TinyStories/resolve/main/TinyStoriesV2-GPT4-valid.txt</span><br><span class="line"></span><br><span class="line">wget https://huggingface.co/datasets/stanford-cs336/owt-sample/resolve/main/owt_train.txt.gz</span><br><span class="line">gunzip owt_train.txt.gz</span><br><span class="line">wget https://huggingface.co/datasets/stanford-cs336/owt-sample/resolve/main/owt_valid.txt.gz</span><br><span class="line">gunzip owt_valid.txt.gz</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> ..</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢è¿™ä¸ªä»£ç ä¼šä¸‹è½½ä¸¤ä¸ªæ•°æ®é›†:</p>
<ul>
<li><strong>TinyStories</strong>: ä¸€ä¸ªéå¸¸å°çš„æ•…äº‹æ•°æ®é›†ï¼Œé€‚åˆå¿«é€Ÿæµ‹è¯•å’Œè°ƒè¯•ä»£ç ã€‚</li>
<li><strong>OpenWebText (OWT) Sample</strong>: ä¸€ä¸ªè¾ƒå¤§çš„æ–‡æœ¬æ•°æ®é›†ï¼Œé€‚åˆè¿›è¡Œæ›´æ·±å…¥çš„è®­ç»ƒå’Œè¯„ä¼°ã€‚</li>
</ul>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å®‰è£… uv:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install uv</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ğŸ“Œ <strong>uv æ˜¯ä»€ä¹ˆ?</strong><br>uv æ˜¯ä¸€ä¸ªè½»é‡çº§çš„Pythoné¡¹ç›®ç®¡ç†å’Œè¿è¡Œå·¥å…·ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´æ–¹ä¾¿åœ°è¿è¡Œå’Œæµ‹è¯•ä»£ç ã€‚åœ¨è¿™ä¸ªAssignmentä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨uvæ¥è¿è¡Œæµ‹è¯•å’Œç®¡ç†é¡¹ç›®ä¾èµ–ã€‚</p>
</blockquote>
<p>å®‰è£…å®Œuvä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ä»¥ä¸‹çš„ä»£ç æ¥è¿è¡Œæµ‹è¯•ä»£ç :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">uv run pytest </span><br><span class="line">uv run python train.py </span><br></pre></td></tr></table></figure>
<hr>
<h2 id="2-Part-01-å­—èŠ‚å¯¹ç¼–ç -BPE-å®ç°"><a href="#2-Part-01-å­—èŠ‚å¯¹ç¼–ç -BPE-å®ç°" class="headerlink" title="2 Part 01: å­—èŠ‚å¯¹ç¼–ç  (BPE) å®ç°"></a>2 Part 01: å­—èŠ‚å¯¹ç¼–ç  (BPE) å®ç°</h2><p>åœ¨è¿™ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†å®ç°Byte Pair Encoding (BPE) (Sennrich, Haddow, and Birch 2016)ç®—æ³•ï¼Œç”¨äºæ–‡æœ¬çš„tokenizationã€‚åœ¨ Lecture 01 ä¸­ï¼Œæˆ‘ä»¬å·²ç»ä»‹ç»äº†BPEçš„åŸºæœ¬åŸç†å’Œå®ç°æ–¹æ³•ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å°†é€šè¿‡ä»£ç æ¥è¿›ä¸€æ­¥çš„å®ç°å¹¶ä¸”ä¼˜åŒ–BPEç®—æ³•ã€‚</p>
<hr>
<h3 id="2-1-BPE-ç®—æ³•å›é¡¾"><a href="#2-1-BPE-ç®—æ³•å›é¡¾" class="headerlink" title="2.1 BPE ç®—æ³•å›é¡¾"></a>2.1 BPE ç®—æ³•å›é¡¾</h3><p>å›é¡¾ä¸€ä¸‹BPEç®—æ³•çš„åŸºæœ¬æ­¥éª¤:</p>
<ol>
<li><strong>åˆå§‹åŒ–</strong>: å°†è¾“å…¥æ–‡æœ¬è§†ä¸ºå­—èŠ‚åºåˆ—ï¼Œæ¯ä¸ªå­—èŠ‚ä½œä¸ºä¸€ä¸ªtokenã€‚åˆå§‹åŒ–è¯æ±‡è¡¨åŒ…å«æ‰€æœ‰å¯èƒ½çš„å­—èŠ‚ï¼ˆ0-255ï¼‰ã€‚ä»¥åŠSpecial Tokensï¼Œæ¯”å¦‚ &lt;|endoftext|&gt;</li>
<li><strong>ç»Ÿè®¡å­—èŠ‚å¯¹é¢‘ç‡</strong>: ç»Ÿè®¡æ–‡æœ¬ä¸­æ‰€æœ‰ç›¸é‚»å­—èŠ‚å¯¹çš„å‡ºç°é¢‘ç‡ã€‚</li>
<li><strong>åˆå¹¶å­—èŠ‚å¯¹</strong>: å°†é¢‘ç‡æœ€é«˜çš„å­—èŠ‚å¯¹åˆå¹¶ä¸ºä¸€ä¸ªæ–°çš„tokenï¼Œæ›´æ–°æ–‡æœ¬å’Œè¯æ±‡è¡¨:<ol>
<li>æ‰¾å‡ºæœ€é«˜é¢‘å­—èŠ‚å¯¹: æ‰¾åˆ°å‡ºç°é¢‘ç‡æœ€é«˜çš„å­—èŠ‚å¯¹ã€‚</li>
<li>æ·»åŠ æ–°å­—èŠ‚å¯¹: å°†è¿™ä¸ªæ–°çš„å¯¹åŠ å…¥è¯æ±‡è¡¨ã€‚</li>
<li>æ›´æ–°æ–‡æœ¬è®¡æ•°: æ›´æ–°æ–‡æœ¬ä¸­æ‰€æœ‰å‡ºç°è¯¥å­—èŠ‚å¯¹çš„åœ°æ–¹ã€‚</li>
<li>æ›´æ–°å­—èŠ‚å¯¹é¢‘ç‡: é‡æ–°ç»Ÿè®¡æ–‡æœ¬ä¸­æ‰€æœ‰ç›¸é‚»å­—èŠ‚å¯¹çš„å‡ºç°é¢‘ç‡ã€‚</li>
</ol>
</li>
<li><strong>é‡å¤æ‰§è¡Œ</strong>: é‡å¤æ­¥éª¤2-3ï¼Œç›´åˆ°è¾¾åˆ°é¢„å®šçš„åˆå¹¶æ¬¡æ•°</li>
</ol>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥å®ç°ä¸€ä¸‹æœ€ç®€å•çš„BPEç®—æ³•:</p>
<hr>
<h3 id="2-2-BPE-V0"><a href="#2-2-BPE-V0" class="headerlink" title="2.2 BPE V0"></a>2.2 BPE V0</h3><p>å‡å¦‚æˆ‘ä»¬è¦Tokenizedä»¥ä¸‹çš„æ–‡æœ¬:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">string = <span class="string">&quot;&quot;&quot; </span></span><br><span class="line"><span class="string">low low low low low &lt;|endoftext|&gt;</span></span><br><span class="line"><span class="string">lower lower widest widest widest &lt;|endoftext|&gt;</span></span><br><span class="line"><span class="string">newest newest newest newest newest newest </span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<p><strong>Step1</strong> è¦åšçš„å°±æ˜¯åˆå§‹åŒ–æˆ‘ä»¬çš„è¯æ±‡è¡¨:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">init_vocab</span>(<span class="params">special_tokens: <span class="built_in">list</span>[<span class="built_in">str</span>] | <span class="literal">None</span> = <span class="literal">None</span></span>) -&gt; <span class="built_in">dict</span>[<span class="built_in">int</span>, <span class="built_in">bytes</span>]:</span><br><span class="line">    vocab: <span class="built_in">dict</span>[<span class="built_in">int</span>, <span class="built_in">bytes</span>] = &#123;x: <span class="built_in">bytes</span>([x]) <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>)&#125;  <span class="comment"># idx -&gt; byte representation</span></span><br><span class="line">    current_index = <span class="number">256</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> special_tokens:</span><br><span class="line">        <span class="keyword">for</span> token <span class="keyword">in</span> special_tokens:</span><br><span class="line">            token_bytes = token.encode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">            vocab[current_index] = token_bytes</span><br><span class="line">            current_index += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> vocab</span><br></pre></td></tr></table></figure>
<p>åˆå§‹åŒ–æ—¶ï¼Œæˆ‘ä»¬ä¼šå…ˆä¸ºæ‰€æœ‰ byte (0-255) å»ºç«‹åŸºç¡€è¯è¡¨ï¼ˆæ–‡æœ¬å…ˆç”¨ UTF-8 ç¼–ç æˆå­—èŠ‚åºåˆ—æ¥å¤„ç†ï¼‰ï¼Œå¹¶é¢å¤–åŠ å…¥ special tokensã€‚åœ¨ç¼–ç è¿‡ç¨‹ä¸­è¿™äº› special tokens ä¼šè¢«ä¼˜å…ˆåŒ¹é…å¹¶ä½œä¸ºæ•´ä½“ä¿ç•™ï¼Œä¸å‚ä¸æ™®é€šçš„åˆ‡åˆ†ä¸ BPE åˆå¹¶ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥å®ç°<strong>Step2</strong>: ç»Ÿè®¡æ–‡æœ¬ä¸­æ‰€æœ‰ç›¸é‚»å­—èŠ‚å¯¹çš„å‡ºç°é¢‘ç‡ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">pair_counts</span>(<span class="params">word_counter: <span class="built_in">dict</span>[<span class="built_in">tuple</span>[<span class="built_in">int</span>, ...], <span class="built_in">int</span>]</span>) -&gt; <span class="built_in">dict</span>[<span class="built_in">tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>], <span class="built_in">int</span>]:</span><br><span class="line">    pairs: <span class="built_in">dict</span>[<span class="built_in">tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>], <span class="built_in">int</span>] = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> word, count <span class="keyword">in</span> word_counter.items():</span><br><span class="line">        <span class="keyword">for</span> a, b <span class="keyword">in</span> <span class="built_in">zip</span>(word, word[<span class="number">1</span>:]):</span><br><span class="line">            pairs[(a, b)] = pairs.get((a, b), <span class="number">0</span>) + count</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> pairs</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>ğŸ’¡ ä»£ç è§£æï¼šzip çš„å¦™ç”¨</strong><br>åœ¨ pair_counts å‡½æ•°ä¸­ï¼Œzip(word, word[1:]) æ˜¯ä¸€ä¸ªéå¸¸ç»å…¸çš„ Python æŠ€å·§ï¼Œç”¨äºè·å–åºåˆ—ä¸­çš„ç›¸é‚»å…ƒç´ å¯¹ã€‚</p>
<ul>
<li>å‡è®¾ word = [A, B, C, D]</li>
<li>word æ˜¯ [A, B, C, D]</li>
<li>word[1:] æ˜¯ [B, C, D] (åˆ‡ç‰‡æ“ä½œ)</li>
<li>zip ä¼šå°†ä¸¤è€…å¯¹é½æ‰“åŒ…ï¼š(A, B), (B, C), (C, D)<br>è¿™æ ·æˆ‘ä»¬å°±ä¼˜é›…åœ°éå†äº†æ‰€æœ‰çš„ç›¸é‚»å­—ç¬¦å¯¹ï¼Œè€Œä¸éœ€è¦å†™ç¹ççš„ for i in range(len(word)-1) å¾ªç¯ã€‚</li>
</ul>
</blockquote>
<p>æˆ‘ä»¬å…ˆç»Ÿè®¡æ¯ä¸ªè¯ï¼ˆtoken åºåˆ—ï¼‰å‡ºç°çš„æ¬¡æ•° countï¼Œå†åœ¨éå†è¯¥è¯çš„ç›¸é‚» token å¯¹æ—¶ï¼ŒæŠŠæ¯ä¸ª pair çš„å‡ºç°æ¬¡æ•°ç´¯åŠ  countï¼Œä»è€Œå¾—åˆ°å…¨éƒ¨è¯­æ–™çš„ pair é¢‘æ¬¡ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦å®ç° <strong>Step3.1</strong>: æ‰¾åˆ°å‡ºç°é¢‘ç‡æœ€é«˜çš„å­—èŠ‚å¯¹ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬éµå¾ªçš„è§„åˆ™æ˜¯:</p>
<ol>
<li>é¢‘ç‡æœ€é«˜çš„pair</li>
<li>è‹¥å¤šä¸ª pair é¢‘ç‡ç›¸åŒï¼Œæˆ‘ä»¬æŒ‰ pair çš„å­—å…¸åºï¼ˆå…ˆæ¯”å·¦ tokenï¼Œå†æ¯”å³ tokenï¼‰é€‰æ‹©æ›´å¤§çš„é‚£ä¸ªã€‚</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_most_frequent_pair</span>(<span class="params"></span></span><br><span class="line"><span class="params">    pair_counter: <span class="built_in">dict</span>[<span class="built_in">tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>], <span class="built_in">int</span>],</span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="built_in">tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>]:</span><br><span class="line">    max_freq = <span class="built_in">max</span>(pair_counter.values())</span><br><span class="line">    candidates = [pair <span class="keyword">for</span> pair, freq <span class="keyword">in</span> pair_counter.items() <span class="keyword">if</span> freq == max_freq]</span><br><span class="line">    res = <span class="built_in">max</span>(candidates)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res</span><br></pre></td></tr></table></figure>
<p>å®ƒæ˜¯æœ¬è½®è¦ merge çš„ pairï¼ˆå°†å®ƒæ›¿æ¢ä¸ºä¸€ä¸ªæ–° tokenï¼‰</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦å®ç°<strong>Step3.2</strong>: å°†è¿™ä¸ªæ–°çš„å­—èŠ‚å¯¹åŠ å…¥è¯æ±‡è¡¨:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add_pair_to_vocab</span>(<span class="params"></span></span><br><span class="line"><span class="params">    vocab: <span class="built_in">dict</span>[<span class="built_in">int</span>, <span class="built_in">bytes</span>],</span></span><br><span class="line"><span class="params">    pair: <span class="built_in">tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>],</span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    index1, index2 = pair</span><br><span class="line">    vocab[<span class="built_in">len</span>(vocab)] = vocab[index1] + vocab[index2]</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">len</span>(vocab) - <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>å°†è¿™ä¸ªæ–°çš„pairåŠ å…¥è¯æ±‡è¡¨åï¼Œæˆ‘ä»¬éœ€è¦å®ç° <strong>Step3.3 å’Œ Step3.4</strong>: æ›´æ–°æ–‡æœ¬ä¸­æ‰€æœ‰å‡ºç°è¯¥å­—èŠ‚å¯¹çš„åœ°æ–¹ï¼Œä»¥åŠé‡æ–°ç»Ÿè®¡æ–‡æœ¬ä¸­æ‰€æœ‰ç›¸é‚»å­—èŠ‚å¯¹çš„å‡ºç°é¢‘ç‡ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬éœ€è¦éå†æ‰€æœ‰çš„è¯ï¼Œæ¥çœ‹æ˜¯ä¸æ˜¯æœ‰è¿™ä¸ªpairå‡ºç°ï¼Œè‹¥å‡ºç°äº†ï¼Œå°±å°†å…¶åˆå¹¶æˆä¸€ä¸ªæ–°çš„tokenã€‚åŒæ—¶ï¼Œæˆ‘ä»¬è¿˜éœ€è¦é‡æ–°ç»Ÿè®¡æ‰€æœ‰çš„pairçš„é¢‘ç‡ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">merge_pair_ids</span>(<span class="params"></span></span><br><span class="line"><span class="params">    word_counter: <span class="built_in">dict</span>[<span class="built_in">tuple</span>[<span class="built_in">bytes</span>] | <span class="built_in">tuple</span>[<span class="built_in">int</span>], <span class="built_in">int</span>],</span></span><br><span class="line"><span class="params">    pair: <span class="built_in">tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>],</span></span><br><span class="line"><span class="params">    new_id: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="built_in">tuple</span>[<span class="built_in">dict</span>[<span class="built_in">tuple</span>[<span class="built_in">int</span>], <span class="built_in">int</span>], <span class="built_in">dict</span>[<span class="built_in">tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>], <span class="built_in">int</span>]]:</span><br><span class="line">    new_word_counter: defaultdict[<span class="built_in">tuple</span>[<span class="built_in">int</span>], <span class="built_in">int</span>] = defaultdict(<span class="built_in">int</span>)</span><br><span class="line">    updated_pair_counts: defaultdict[<span class="built_in">tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>], <span class="built_in">int</span>] = defaultdict(<span class="built_in">int</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> token, freq <span class="keyword">in</span> word_counter.items():</span><br><span class="line">        new_token = []</span><br><span class="line">        i = <span class="number">0</span></span><br><span class="line">        L = <span class="built_in">len</span>(token)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> i &lt; L:</span><br><span class="line">            <span class="keyword">if</span> i + <span class="number">1</span> &lt; L <span class="keyword">and</span> (token[i], token[i + <span class="number">1</span>]) == pair:</span><br><span class="line">                new_token.append(new_id)</span><br><span class="line">                i += <span class="number">2</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                new_token.append(token[i])</span><br><span class="line">                i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        new_word_counter[<span class="built_in">tuple</span>(new_token)] += freq</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> index1, index2 <span class="keyword">in</span> <span class="built_in">zip</span>(new_token[:-<span class="number">1</span>], new_token[<span class="number">1</span>:]):</span><br><span class="line">            updated_pair_counts[(index1, index2)] += freq</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">dict</span>(new_word_counter), <span class="built_in">dict</span>(updated_pair_counts)</span><br></pre></td></tr></table></figure>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†ä¸€è½®ï¼Œé‡å¤ä»¥ä¸Šçš„æ­¥éª¤ï¼Œç›´åˆ°æˆ‘ä»¬è¾¾åˆ°ç›®æ ‡çš„è½®æ•°ï¼Œæ”¾åœ¨ä¸€èµ·ä»£ç å°±æ˜¯:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">train_bpe</span>(<span class="params"></span></span><br><span class="line"><span class="params">    string: <span class="built_in">str</span> = string,</span></span><br><span class="line"><span class="params">    vocab_size: <span class="built_in">int</span> = <span class="number">263</span>,</span></span><br><span class="line"><span class="params">    special_tokens: <span class="built_in">list</span>[<span class="built_in">str</span>] = special_tokens,</span></span><br><span class="line"><span class="params">    save_path: <span class="built_in">str</span> | <span class="literal">None</span> = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    vocab = init_vocab(special_tokens)</span><br><span class="line">    num_merges = vocab_size - <span class="built_in">len</span>(vocab)</span><br><span class="line"></span><br><span class="line">    merges: <span class="built_in">dict</span>[<span class="built_in">tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>], <span class="built_in">int</span>] = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    word_counter = pre_tokenize(string, special_tokens, including_special=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    pairs_freqs = pair_counts(word_counter)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(num_merges):</span><br><span class="line">        most_common_pair = get_most_frequent_pair(pairs_freqs)</span><br><span class="line">        new_index = add_pair_to_vocab(vocab, most_common_pair)</span><br><span class="line">        merges[most_common_pair] = new_index</span><br><span class="line">        word_counter, pairs_freqs = merge_pair_ids(word_counter, most_common_pair, new_index)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> vocab, merges</span><br></pre></td></tr></table></figure>
<p>è¿™ä¹Ÿå°±æ˜¯æœ€ç®€å•çš„BPEçš„ç®—æ³•ï¼Œæˆ‘ä»¬ç§°å…¶ä¸ºBPE Version0, å½“æˆ‘ä»¬è¿è¡Œè¿™ä¸ªä»£ç ï¼Œå¹¶ä¸”æŠŠvocab_sizeè®¾ç½®ä¸º263æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä»¥ä¸‹mergesçš„é¡ºåºã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">train_bpe(</span><br><span class="line">    string=string,</span><br><span class="line">    vocab_size=<span class="number">256</span> + <span class="number">1</span> + <span class="number">6</span>,</span><br><span class="line">    special_tokens=special_tokens,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Most common pair: (<span class="string">b&#x27;s&#x27;</span>, <span class="string">b&#x27;t&#x27;</span>) -&gt; <span class="number">9</span></span><br><span class="line">Most common pair: (<span class="string">b&#x27;e&#x27;</span>, <span class="string">b&#x27;st&#x27;</span>) -&gt; <span class="number">9</span></span><br><span class="line">Most common pair: (<span class="string">b&#x27;o&#x27;</span>, <span class="string">b&#x27;w&#x27;</span>) -&gt; <span class="number">7</span></span><br><span class="line">Most common pair: (<span class="string">b&#x27;l&#x27;</span>, <span class="string">b&#x27;ow&#x27;</span>) -&gt; <span class="number">7</span></span><br><span class="line">Most common pair: (<span class="string">b&#x27;w&#x27;</span>, <span class="string">b&#x27;est&#x27;</span>) -&gt; <span class="number">6</span></span><br><span class="line">Most common pair: (<span class="string">b&#x27;n&#x27;</span>, <span class="string">b&#x27;e&#x27;</span>) -&gt; <span class="number">6</span></span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå°½ç®¡è¿™ä¸ªç‰ˆæœ¬çš„BPEç®—æ³•æ˜¯æ­£ç¡®çš„ï¼Œä½†æ˜¯å®ƒçš„æ•ˆç‡éå¸¸ä½ï¼Œå› ä¸ºæ¯æ¬¡æˆ‘ä»¬éƒ½éœ€è¦éå†æ‰€æœ‰çš„pairï¼Œæ¥æ‰¾åˆ°å‡ºç°é¢‘ç‡æœ€é«˜çš„pairã€‚è¿™æ ·çš„æ—¶é—´å¤æ‚åº¦æ˜¯ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mo>â‹…</mo><mi>P</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N \cdot P)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mclose">)</span></span></span></span>ï¼Œå…¶ä¸­Næ˜¯åˆå¹¶çš„æ¬¡æ•°ï¼ŒPæ˜¯pairçš„æ•°é‡ã€‚å¦‚æœåªæ˜¯ç”¨è¿™ç§ç®€å•çš„ç®—æ³•ï¼Œæˆ‘ä»¬æ˜¯é€šä¸è¿‡æµ‹è¯•çš„ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦ä¼˜åŒ–è¿™ä¸ªç®—æ³•ï¼Œä¸è¿‡åœ¨ä¼˜åŒ–ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹Pre-Processingçš„æ­¥éª¤ã€‚</p>
<hr>
<h2 id="2-3-é¢„å¤„ç†"><a href="#2-3-é¢„å¤„ç†" class="headerlink" title="2.3 é¢„å¤„ç†"></a>2.3 é¢„å¤„ç†</h2><p>åœ¨å®ç°BPEç®—æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ–‡æœ¬è¿›è¡Œé¢„å¤„ç†ï¼ˆPre-Processingï¼‰ï¼Œä¸»è¦åŒ…æ‹¬ä¸¤ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>æ ¹æ® Special Tokens æ¥åˆ†æ–‡æœ¬</li>
<li>æ ¹æ®æ­£åˆ™è¡¨è¾¾å¼æ¥åˆ†æ–‡æœ¬</li>
</ol>
<hr>
<h3 id="2-3-1-åŸºäºç‰¹æ®Š-Token-çš„åˆ‡åˆ†"><a href="#2-3-1-åŸºäºç‰¹æ®Š-Token-çš„åˆ‡åˆ†" class="headerlink" title="2.3.1 åŸºäºç‰¹æ®Š Token çš„åˆ‡åˆ†"></a>2.3.1 åŸºäºç‰¹æ®Š Token çš„åˆ‡åˆ†</h3><p>åœ¨è¿™ä¸€èŠ‚ï¼ˆSection 2.1ï¼‰æˆ‘ä»¬å·²ç»äº†è§£è¿‡ï¼Œåœ¨åˆå§‹åŒ– vocab æ—¶ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦åˆå§‹åŒ– special tokensï¼Œå…¶ä¸­ä¸€ä¸ªå¸¸è§çš„ special tokens å°±æ˜¯ &lt;|endoftext|&gt;ã€‚è¿™ä¸ª token æ„å‘³ç€ä¸€æ®µæ–‡æœ¬çš„ç»“æŸã€‚ç»™å‡ºä¸€æ®µå¾ˆé•¿çš„æ–‡æœ¬ï¼Œæˆ‘ä»¬è¦åšçš„ç¬¬ä¸€ä»¶äº‹æƒ…å°±æ˜¯æŠŠè¿™ä¸ªæ–‡æœ¬åˆ†æˆè®¸å¤šæ®µï¼Œä»£ç çš„å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">split_by_special_tokens</span>(<span class="params">text: <span class="built_in">str</span>, special_tokens: <span class="built_in">list</span>[<span class="built_in">str</span>], include_special: <span class="built_in">bool</span> = <span class="literal">False</span></span>) -&gt; <span class="built_in">list</span>[<span class="built_in">str</span>]:</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> special_tokens:</span><br><span class="line">        <span class="keyword">return</span> [text]</span><br><span class="line"></span><br><span class="line">    special_tokens_sorted = <span class="built_in">sorted</span>(special_tokens, key=<span class="built_in">len</span>, reverse=<span class="literal">True</span>)</span><br><span class="line">    pattern = <span class="string">&quot;|&quot;</span>.join(re.escape(t) <span class="keyword">for</span> t <span class="keyword">in</span> special_tokens_sorted)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> include_special:</span><br><span class="line">        special_chunks = re.split(<span class="string">f&quot;(<span class="subst">&#123;pattern&#125;</span>)&quot;</span>, text)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># ä¸æ•è· special tokenï¼Œä»…æŒ‰å…¶è¿›è¡Œåˆ‡åˆ†ï¼ˆåˆ‡åˆ†ç»“æœé‡Œä¸åŒ…å« special token æœ¬èº«ï¼‰</span></span><br><span class="line">        special_chunks = re.split(pattern, text)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> special_chunks</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>ğŸ§  æ·±åº¦æ€è€ƒï¼šä¸ºä»€ä¹ˆè¦å¤„ç† Byte (å­—èŠ‚) è€Œä¸æ˜¯ Character (å­—ç¬¦)?</strong><br>åœ¨ BPE ç®—æ³•ä¸­ï¼Œæˆ‘ä»¬ä¸ºä»€ä¹ˆè¦æŠŠæ–‡æœ¬ encode(â€œutf-8â€) å˜æˆå­—èŠ‚åºåˆ—ï¼Ÿ</p>
<ul>
<li><strong>é€šç”¨æ€§</strong>: Unicode å­—ç¬¦é›†éå¸¸å¤§ï¼ˆè¶…è¿‡14ä¸‡ä¸ªå­—ç¬¦ï¼‰ï¼Œå¦‚æœç›´æ¥ç”¨å­—ç¬¦ä½œä¸ºåŸºç¡€å•å…ƒï¼Œè¯è¡¨ä¼šéå¸¸ç¨€ç–ä¸”åºå¤§ã€‚</li>
<li><strong>UTF-8 ç¼–ç </strong>: ä»»ä½• Unicode å­—ç¬¦éƒ½å¯ä»¥è¢«ç¼–ç æˆ 1 åˆ° 4 ä¸ªå­—èŠ‚ã€‚é€šè¿‡åœ¨ Byte çº§åˆ«è¿›è¡Œåˆå¹¶ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®ä¿æ¨¡å‹èƒ½å¤Ÿå¤„ç†<strong>ä»»ä½•</strong>æ–‡æœ¬å­—ç¬¦ä¸²ï¼Œå³ä½¿æ˜¯è®­ç»ƒé›†ä¸­æ²¡è§è¿‡çš„ç”Ÿåƒ»å­—ï¼Œæœ€ç»ˆä¹Ÿèƒ½å›é€€åˆ°å­—èŠ‚çº§åˆ«è¿›è¡Œè¡¨ç¤ºï¼Œé¿å…äº† <UNK> (Unknown Token) çš„å‡ºç°ã€‚</li>
</ul>
<p><strong>ğŸ“ æ­£åˆ™å°è´´å£«</strong></p>
<ul>
<li>re.escape(t): è¿™æ˜¯ä¸€ä¸ªå®‰å…¨æªæ–½ã€‚å‡è®¾ä½ çš„ special token åŒ…å«æ­£åˆ™è¡¨è¾¾å¼çš„ç‰¹æ®Šç¬¦å·ï¼ˆå¦‚ . æˆ– *ï¼‰ï¼Œre.escape ä¼šåœ¨å®ƒä»¬å‰é¢åŠ åæ–œæ ï¼Œå°†å…¶è½¬ä¹‰ä¸ºæ™®é€šå­—ç¬¦ï¼Œé˜²æ­¢æ­£åˆ™å¼•æ“è¯¯è¯»ã€‚</li>
</ul>
</blockquote>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å®Œæˆäº† Special Token-aware çš„åˆ‡åˆ†ï¼š</p>
<ol>
<li>é€šè¿‡æŠŠæ‰€æœ‰ special tokens å…ˆæŒ‰é•¿åº¦é™åºæ’åºï¼Œå¹¶ç”¨æ­£åˆ™æ„é€ åŒ¹é… patternï¼Œæˆ‘ä»¬å¯ä»¥æŠŠåŸå§‹æ–‡æœ¬æ‹†æˆä¸€ç³»åˆ—æ™®é€šæ–‡æœ¬ç‰‡æ®µï¼ˆä»¥åŠå¯¹åº”çš„ special token ç‰‡æ®µï¼‰ã€‚</li>
<li>å½“ include_special=True æ—¶ï¼Œre.split(fâ€({pattern})â€, text) ä¼šæŠŠåŒ¹é…åˆ°çš„ special token ä¹Ÿä¿ç•™ä¸‹æ¥ï¼Œä»è€Œåœ¨åç»­ç¼–ç æ—¶å¯ä»¥æŠŠå®ƒä»¬å½“ä½œâ€œåŸå­ tokenâ€ç›´æ¥æ˜ å°„åˆ°å¯¹åº”çš„ idã€‚</li>
<li>å½“ include_special=False æ—¶ï¼Œspecial token ä¼šè¢«å½“ä½œåˆ†éš”ç¬¦ä¸¢å¼ƒï¼Œä»…è¿”å›æ™®é€šæ–‡æœ¬ç‰‡æ®µï¼Œé€‚åˆè®­ç»ƒé˜¶æ®µä¸æƒ³è®© special tokens å‚ä¸ pair / token / merges çš„åœºæ™¯ã€‚</li>
</ol>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¯¹æ¯ä¸ªæ™®é€šç‰‡æ®µæ‰§è¡Œ Regex-based çš„åˆ‡åˆ†äº†ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¼šæŠŠæ–‡æœ¬åˆ‡æˆæ›´å°çš„ç‰‡æ®µï¼Œæ¯”å¦‚è¯ã€å­è¯ç‰‡æ®µã€æ ‡ç‚¹åˆ†éš”ç‰‡æ®µç­‰ã€‚</p>
<hr>
<h3 id="2-3-2-åŸºäºæ­£åˆ™è¡¨è¾¾å¼çš„åˆ‡åˆ†"><a href="#2-3-2-åŸºäºæ­£åˆ™è¡¨è¾¾å¼çš„åˆ‡åˆ†" class="headerlink" title="2.3.2 åŸºäºæ­£åˆ™è¡¨è¾¾å¼çš„åˆ‡åˆ†"></a>2.3.2 åŸºäºæ­£åˆ™è¡¨è¾¾å¼çš„åˆ‡åˆ†</h3><p><strong>Pre-Tokenizationï¼ˆé¢„åˆ†è¯ï¼‰</strong>æ˜¯åœ¨çœŸæ­£è®­ç»ƒ BPE åˆå¹¶è§„åˆ™ä¹‹å‰ï¼Œå…ˆå¯¹æ•´ä»½è¯­æ–™åšä¸€æ¬¡ç²—ç²’åº¦çš„åˆ‡åˆ†ï¼ŒæŠŠæ–‡æœ¬åˆ‡æˆä¸€æ®µæ®µâ€œæ›´å¤§çš„å—â€ï¼ˆpre-tokenï¼‰ï¼Œç„¶ååœ¨è¿™äº›ç‰‡æ®µå†…éƒ¨å»ç»Ÿè®¡ç›¸é‚»å­—èŠ‚ï¼ˆbyte pairï¼‰çš„å‡ºç°é¢‘ç‡ã€‚é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆéœ€è¦ Pre-Tokenization å‘¢ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªåŸå› ï¼š</p>
<h4 id="åŸå› ä¸€ï¼šé¿å…â€œæ¯åˆå¹¶ä¸€æ¬¡å°±éœ€è¦é‡æ–°æ‰«æä¸€éâ€"><a href="#åŸå› ä¸€ï¼šé¿å…â€œæ¯åˆå¹¶ä¸€æ¬¡å°±éœ€è¦é‡æ–°æ‰«æä¸€éâ€" class="headerlink" title="åŸå› ä¸€ï¼šé¿å…â€œæ¯åˆå¹¶ä¸€æ¬¡å°±éœ€è¦é‡æ–°æ‰«æä¸€éâ€"></a>åŸå› ä¸€ï¼šé¿å…â€œæ¯åˆå¹¶ä¸€æ¬¡å°±éœ€è¦é‡æ–°æ‰«æä¸€éâ€</h4><p>æˆ‘ä»¬çŸ¥é“ï¼Œæ¯åˆå¹¶ä¸€æ¬¡ï¼Œæˆ‘ä»¬å°±è¦é‡æ–°æ‰«æä¸€æ¬¡ï¼Œä»¥è·å¾—æ›´æ–°åçš„æ–°è¯­æ–™ï¼Œå¦‚æœè¿™ä¸ªè¯­æ–™ç‰¹åˆ«å¤§ï¼Œæˆ–è€…æˆ‘ä»¬ merge çš„æ¬¡æ•°ç‰¹åˆ«å¤šï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´æˆ‘ä»¬ç®—æ³•ç‰¹åˆ«æ…¢ã€‚è¿™ä¸ªæ—¶å€™å°±éœ€è¦ Pre-Tokenizationï¼Œå®ƒçš„ä½œç”¨æ˜¯ï¼š</p>
<ul>
<li>å…ˆæŠŠè¯­æ–™åˆ‡æˆå¾ˆå¤š pre-tokenï¼ˆæ¯”å¦‚è¯ã€å­è¯ç‰‡æ®µã€æ ‡ç‚¹åˆ†éš”ç‰‡æ®µç­‰ï¼‰</li>
<li>ç»Ÿè®¡æ—¶ä¸å†å¯¹æ•´ä¸ªè¯­æ–™é€å­—ç¬¦/é€å­—èŠ‚æ‰«æï¼Œè€Œæ˜¯åˆ©ç”¨é‡å¤å‡ºç°çš„ pre-token çš„æ¬¡æ•°æ¥åŠ é€Ÿã€‚</li>
</ul>
<p>ä¸¾ä¸ªä¾‹å­ï¼š</p>
<ul>
<li>â€œtextâ€è¿™ä¸ª pre-token å‡ºç°äº† 10 æ¬¡</li>
<li>â€œtexiâ€è¿™ä¸ª pre-token ä¹Ÿå‡ºç°äº†æ•°æ¬¡</li>
<li>å½“æˆ‘ä»¬è¦ç»Ÿè®¡ t å’Œ e ç›¸é‚»å‡ºç°æ¬¡æ•°</li>
<li>åªè¦åœ¨â€œtextâ€é‡Œçœ‹åˆ°ä¸€æ¬¡â€œt+eâ€ç›¸é‚»ï¼Œå°±å¯ä»¥ä¸€æ¬¡æ€§æŠŠè®¡æ•°åŠ  10 è€Œä¸æ˜¯æŠŠè¯­æ–™é‡Œæ¯ä¸ªâ€œtextâ€éƒ½é€å­—èŠ‚å†çœ‹ä¸€éã€‚</li>
</ul>
<h4 id="åŸå› äºŒï¼šé¿å…â€œåˆ‡å‡ºåªæœ‰æ ‡ç‚¹ä¸åŒçš„é‡å¤-tokenâ€"><a href="#åŸå› äºŒï¼šé¿å…â€œåˆ‡å‡ºåªæœ‰æ ‡ç‚¹ä¸åŒçš„é‡å¤-tokenâ€" class="headerlink" title="åŸå› äºŒï¼šé¿å…â€œåˆ‡å‡ºåªæœ‰æ ‡ç‚¹ä¸åŒçš„é‡å¤ tokenâ€"></a>åŸå› äºŒï¼šé¿å…â€œåˆ‡å‡ºåªæœ‰æ ‡ç‚¹ä¸åŒçš„é‡å¤ tokenâ€</h4><p>æ¯”å¦‚æœ‰ä¸¤ä¸ªè¯ dog! å’Œ dog.ï¼Œå¦‚æœæˆ‘ä»¬é‚£ä¸ Pre-tokenizationï¼Œé‚£ä¹ˆè¿™ä¸ªå¾ˆå®¹æ˜“è¢«å½“æˆä¸åŒçš„åºåˆ—ï¼Œä»è€Œå¯¹äºè¿™ä¸ªç±»ä¼¼çš„è¯ï¼Œæœ‰ä¸¤ä¸ªå®Œå…¨ä¸åŒçš„ idã€‚è€Œ Pre-tokenization é€šå¸¸ä¼šç”¨ä¸€äº›è§„åˆ™ï¼ˆæ¯”å¦‚æŒ‰ç©ºç™½ã€æ ‡ç‚¹è¾¹ç•Œç­‰ï¼‰å…ˆåˆ‡å¼€ï¼Œè®© BPE æ›´å¤šåœ¨â€œè¯å†…éƒ¨â€å­¦ä¹ åˆå¹¶è§„åˆ™ï¼Œè€Œä¸æ˜¯æŠŠè¯å’Œå„ç§æ ‡ç‚¹ç²˜åœ¨ä¸€èµ·ä¹±åˆå¹¶ã€‚</p>
<p>åœ¨è¿™ä¸ª Assignment é‡Œï¼Œæˆ‘ä»¬é‡‡ç”¨ regex-based pre-tokenizerï¼ˆGPT-2 ä½¿ç”¨çš„é‚£æ¡æ­£åˆ™ï¼‰ï¼Œå…ˆæŠŠåŸå§‹æ–‡æœ¬åˆ‡æˆä¸€ä¸²â€œé¢„åˆ†è¯ç‰‡æ®µâ€ï¼ˆpre-tokensï¼‰ï¼Œå†å¯¹æ¯ä¸ªç‰‡æ®µåš byte-level BPEã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PAT = <span class="string">r&quot;&quot;&quot;&#x27;(?:[sdmt]|ll|ve|re)| ?\p&#123;L&#125;+| ?\p&#123;N&#125;+| ?[^\s\p&#123;L&#125;\p&#123;N&#125;]+|\s+(?!\S)|\s+&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<h5 id="Regex-è¯¦è§£"><a href="#Regex-è¯¦è§£" class="headerlink" title="Regex è¯¦è§£"></a>Regex è¯¦è§£</h5><p>æˆ‘ä»¬æ¥è¯¦ç»†è§£é‡Šä¸€ä¸‹è¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼šå®ƒçš„åˆ†å—è§„åˆ™ï¼ˆä»å·¦åˆ°å³åŒ¹é…ï¼‰ï¼š</p>
<ul>
<li><strong>è‹±è¯­ç¼©å†™/è¯å°¾</strong>ï¼šâ€™s, â€˜t, â€˜re, â€˜ve, â€˜ll, â€˜m, â€˜d ç­‰ï¼ˆç¬¬ä¸€æ®µï¼‰</li>
<li><strong>å­—æ¯ä¸²</strong>ï¼š?+ â€”â€” ä¸€æ®µå­—æ¯ï¼ˆå…è®¸å‰é¢å¸¦ä¸€ä¸ªå¯é€‰ç©ºæ ¼ï¼ŒæŠŠç©ºæ ¼â€œç²˜â€åˆ°åé¢çš„ token ä¸Šï¼‰</li>
<li><strong>æ•°å­—ä¸²</strong>ï¼š?+ â€”â€” ä¸€æ®µæ•°å­—ï¼ˆåŒæ ·å…è®¸å‰ç½®ç©ºæ ¼ï¼‰</li>
<li><strong>æ ‡ç‚¹/å…¶å®ƒç¬¦å·ä¸²</strong>ï¼š?[^\s\p{L}\p{N}]+ â€”â€” éç©ºç™½ã€éå­—æ¯ã€éæ•°å­—çš„ä¸€ä¸²ç¬¦å·ï¼ˆä¹Ÿå…è®¸å‰ç½®ç©ºæ ¼ï¼‰</li>
<li><strong>ç©ºç™½</strong>ï¼š+(!?)ï¼ˆæœ«å°¾ç©ºç™½ï¼‰æˆ– +ï¼ˆä¸€èˆ¬ç©ºç™½ï¼‰<ul>
<li>+: åŒ¹é…ä¸€æ®µç©ºç™½ï¼ˆç©ºæ ¼ã€æ¢è¡Œã€tab ç­‰ï¼‰ã€‚</li>
<li>(?!)ï¼šè´Ÿå‘å‰ç»ï¼Œç¡®ä¿è¿™æ®µç©ºç™½åé¢æ²¡æœ‰éç©ºç™½å­—ç¬¦ï¼ˆå³è¿™æ˜¯è¡Œå°¾æˆ–æ–‡æœ¬æœ«å°¾çš„ç©ºç™½ï¼‰ã€‚</li>
</ul>
</li>
</ul>
<p>è¿™ç§åˆ‡åˆ†çš„å…³é”®æ˜¯ï¼šå¾ˆå¤š token ä¼šæŠŠå‰å¯¼ç©ºæ ¼åŒ…å«è¿›å»ï¼ˆä¾‹å¦‚  hello ä¼šè¢«å½“æˆä¸€ä¸ªæ•´ä½“çš„ pre-tokenï¼‰ï¼Œè¿™èƒ½æ›´å¥½åœ°åŒ¹é…è‹±è¯­â€œè¯è¾¹ç•Œ+ç©ºæ ¼â€çš„ç»Ÿè®¡ç‰¹æ€§ï¼Œä¹Ÿæ›´æ¥è¿‘ GPT-2 å®é™…çš„ tokenize è¡Œä¸ºã€‚å¦‚æœä¸ç†è§£ï¼Œä¹Ÿæ²¡æœ‰å…³ç³»ï¼Œç›´æ¥ä½¿ç”¨è¿™ä¸ªæ­£åˆ™å°±è¡Œã€‚</p>
<p>æœ‰äº†è¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼Œæˆ‘ä»¬å°±å¯ä»¥å®ç° Pre-Tokenization äº†ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">pre_tokenize</span>(<span class="params">string: <span class="built_in">str</span>, special_tokens: <span class="built_in">list</span>[<span class="built_in">str</span>], including_special: <span class="built_in">bool</span> = <span class="literal">False</span></span>) -&gt; Counter:</span><br><span class="line">    word_counter = Counter()</span><br><span class="line"></span><br><span class="line">    chunks = split_by_special_tokens(string, special_tokens, include_special=including_special)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> chunk <span class="keyword">in</span> chunks:</span><br><span class="line">        <span class="keyword">if</span> including_special <span class="keyword">and</span> chunk <span class="keyword">in</span> special_tokens:</span><br><span class="line">            word_counter[<span class="built_in">tuple</span>(string_to_bytes(chunk))] += <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">for</span> <span class="keyword">match</span> <span class="keyword">in</span> re.finditer(PAT, chunk):</span><br><span class="line">                word = <span class="keyword">match</span>.group(<span class="number">0</span>)</span><br><span class="line">                word_encoded = <span class="built_in">tuple</span>(string_to_bytes(word, return_int=<span class="literal">True</span>))</span><br><span class="line">                word_counter[word_encoded] += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> word_counter</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡ pre-tokenizationï¼Œæˆ‘ä»¬æŠŠåŸå§‹æ–‡æœ¬è½¬æ¢æˆè®¸å¤šâ€œé¢„åˆ†è¯ç‰‡æ®µâ€çš„ byte/id åºåˆ—ï¼Œå¹¶ç”¨ Counter ç»Ÿè®¡æ¯ç§ç‰‡æ®µå‡ºç°çš„æ¬¡æ•°ã€‚åç»­åœ¨ç»Ÿè®¡ pair é¢‘ç‡æ—¶ï¼Œæ¯ä¸ªç‰‡æ®µçš„ç›¸é‚» token å‡ºç°æ¬¡æ•°éƒ½ä¼šæŒ‰å…¶ count åŠ æƒç´¯åŠ ï¼Œä»è€Œå¾—åˆ°å…¨è¯­æ–™çš„ pair é¢‘æ¬¡ã€‚</p>
<hr>
<h3 id="2-3-3-å¤šè¿›ç¨‹"><a href="#2-3-3-å¤šè¿›ç¨‹" class="headerlink" title="2.3.3 å¤šè¿›ç¨‹"></a>2.3.3 å¤šè¿›ç¨‹</h3><p>é€šè¿‡å‰é¢çš„æ­¥éª¤ï¼ˆåŸºäºç‰¹æ®Š Token çš„åˆ‡åˆ† å’Œ åŸºäºæ­£åˆ™è¡¨è¾¾å¼çš„åˆ‡åˆ†ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ä¸ª Multi-Processing æ¥åŠ é€Ÿã€‚</p>
<p><strong>Tip</strong><br>Python çš„ MultiProcessing æ˜¯ä¸€ä¸ªå¤šè¿›ç¨‹ã€æ›´é€‚åˆ CPU å¯†é›†å‹ä»»åŠ¡ï¼ˆæ¯”å¦‚é¢„åˆ†è¯ã€ç»Ÿè®¡ï¼‰ã€‚æˆ‘ä»¬åªéœ€è¦äº†è§£ä»¥ä¸‹çš„å†…å®¹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process, Queue  </span><br><span class="line"><span class="keyword">import</span> queue  </span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> Counter </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">task</span>(<span class="params">*args</span>):  <span class="comment"># å®šä¹‰å®é™…è¦å¹¶è¡Œæ‰§è¡Œçš„ä»»åŠ¡å‡½æ•°</span></span><br><span class="line">    <span class="comment"># è¿™é‡Œå†™ä½ çš„çœŸå®ä»»åŠ¡é€»è¾‘</span></span><br><span class="line">    <span class="keyword">return</span> Counter()  <span class="comment"># è¿”å›ä¸€ä¸ª Counterï¼ˆç¤ºä¾‹ï¼‰ï¼Œä¾¿äºä¸»è¿›ç¨‹èšåˆ</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">task_worker</span>(<span class="params">out_queue: Queue, *args</span>):  <span class="comment"># workerï¼šæ¥æ”¶è¾“å‡ºé˜Ÿåˆ—å’Œä»»åŠ¡å‚æ•°</span></span><br><span class="line"></span><br><span class="line">    output = task(*args)  <span class="comment"># æ‰§è¡Œä»»åŠ¡ï¼Œå¾—åˆ°éƒ¨åˆ†ç»“æœ</span></span><br><span class="line">    </span><br><span class="line">    out_queue.put(output)  <span class="comment"># æŠŠç»“æœæ”¾è¿›é˜Ÿåˆ—ï¼Œäº¤ç»™ä¸»è¿›ç¨‹æ±‡æ€»</span></span><br><span class="line"></span><br><span class="line">num_process = <span class="number">4</span>  <span class="comment"># è¿›ç¨‹æ•°ç¤ºä¾‹ï¼ˆä½ éœ€è¦è‡ªå·±è®¾ç½®ï¼‰</span></span><br><span class="line">task_args_list = [(<span class="string">&quot;a&quot;</span>,), (<span class="string">&quot;b&quot;</span>,), (<span class="string">&quot;c&quot;</span>,), (<span class="string">&quot;d&quot;</span>,)]  <span class="comment"># æ¯ä¸ªè¿›ç¨‹çš„å‚æ•°ç¤ºä¾‹ï¼ˆä½ éœ€è¦æ›¿æ¢æˆçœŸå®å‚æ•°ï¼‰</span></span><br><span class="line"></span><br><span class="line">out_queue: Queue = manager.Queue() <span class="comment"># åˆ›å»ºè¿›ç¨‹é—´é€šä¿¡é˜Ÿåˆ—</span></span><br><span class="line">processes: <span class="built_in">list</span>[Process] = []  <span class="comment"># ä¿å­˜æ‰€æœ‰è¿›ç¨‹å¯¹è±¡ï¼Œæ–¹ä¾¿åé¢ join</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> args <span class="keyword">in</span> task_args_list:  <span class="comment"># éå†æ¯ä¸ªä»»åŠ¡çš„å‚æ•°</span></span><br><span class="line">    p = Process(target=task_worker, args=(out_queue, *args))  <span class="comment"># åˆ›å»ºè¿›ç¨‹ï¼Œå¹¶æŠŠé˜Ÿåˆ—+å‚æ•°ä¼ ç»™ worker</span></span><br><span class="line">    processes.append(p)  <span class="comment"># è®°å½•è¿›ç¨‹å¯¹è±¡</span></span><br><span class="line">    p.start()  <span class="comment"># å¯åŠ¨è¿›ç¨‹å¼€å§‹æ‰§è¡Œ</span></span><br><span class="line"></span><br><span class="line">all_out = Counter()  <span class="comment"># ä¸»è¿›ç¨‹çš„æ€» Counterï¼Œç”¨äºç´¯åŠ æ‰€æœ‰éƒ¨åˆ†ç»“æœ</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(processes)):  <span class="comment"># é¢„æœŸæ¯ä¸ªè¿›ç¨‹éƒ½ä¼š put ä¸€æ¬¡ç»“æœï¼Œæ‰€ä»¥æ”¶ len(processes) æ¬¡</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        partial_out = out_queue.get(timeout=<span class="number">10</span>)  <span class="comment"># ä»é˜Ÿåˆ—å–ä¸€ä¸ªç»“æœï¼Œæœ€å¤šç­‰å¾… 10 ç§’</span></span><br><span class="line">        all_out.update(partial_out)  <span class="comment"># æŠŠè¿™ä¸ªè¿›ç¨‹çš„ Counter åˆå¹¶åˆ°æ€» Counter</span></span><br><span class="line">    <span class="keyword">except</span> queue.Empty:  <span class="comment"># å¦‚æœè¶…æ—¶æ²¡å–åˆ°ï¼Œå°±è·³è¿‡</span></span><br><span class="line">        <span class="keyword">continue</span>  <span class="comment"># ç»§ç»­å°è¯•ä¸‹ä¸€ä¸ª</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> p <span class="keyword">in</span> processes:  <span class="comment"># éå†æ‰€æœ‰è¿›ç¨‹</span></span><br><span class="line">    p.join()  <span class="comment"># ç­‰å¾…è¿›ç¨‹ç»“æŸ</span></span><br></pre></td></tr></table></figure>
<p>æœ‰äº†è¿™äº›å‰ç½®çŸ¥è¯†ä¹‹åï¼Œå®ç°è¿™ä¸ª Pre-Processing çš„æ­¥éª¤å°±å¾ˆå®¹æ˜“äº†ï¼Œä»¥ä¸‹æ˜¯ Pre-process çš„ä»£ç ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">pre_tokenize_string_worker</span>(<span class="params">*args</span>):</span><br><span class="line">    input_path, special_tokens, queue, start, end, include_special = args</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä»æ–‡ä»¶ä¸­è¯»å–å½“å‰è¿›ç¨‹è´Ÿè´£çš„åˆ†ç‰‡ï¼ˆchunkï¼‰</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(input_path, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.seek(start)</span><br><span class="line">        chunk = f.read(end - start).decode(<span class="string">&quot;utf-8&quot;</span>, errors=<span class="string">&quot;ignore&quot;</span>)</span><br><span class="line"></span><br><span class="line">    word_counter = pre_tokenize(chunk, special_tokens, include_special)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æŠŠå½“å‰åˆ†ç‰‡çš„ç»Ÿè®¡ç»“æœæ”¾è¿›é˜Ÿåˆ—ï¼Œäº¤ç»™ä¸»è¿›ç¨‹æ±‡æ€»</span></span><br><span class="line">    queue.put(word_counter)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">train_bpe</span>():</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(input_path, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        chunk_boundaries = find_chunk_boundaries(</span><br><span class="line">            f, desired_num_chunks=kwargs.get(<span class="string">&quot;desired_num_chunks&quot;</span>, NUM_PROCESSES), split_special_token=<span class="string">b&quot;\n&quot;</span></span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    manager = Manager()</span><br><span class="line">    queue = manager.Queue()</span><br><span class="line">    processes: <span class="built_in">list</span>[Process] = []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> start, end <span class="keyword">in</span> <span class="built_in">zip</span>(chunk_boundaries[:-<span class="number">1</span>], chunk_boundaries[<span class="number">1</span>:]):</span><br><span class="line">        p = Process(</span><br><span class="line">            target=pre_tokenize_string_worker,</span><br><span class="line">            args=(input_path, special_tokens, queue, start, end, <span class="literal">False</span>),</span><br><span class="line">        )</span><br><span class="line">        processes.append(p)</span><br><span class="line">        p.start()</span><br><span class="line"></span><br><span class="line">word_counter = Counter()</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(processes)):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># ä»é˜Ÿåˆ—ä¸­å–å‡ºå­è¿›ç¨‹çš„å±€éƒ¨ç»Ÿè®¡ç»“æœï¼Œå¹¶åˆå¹¶åˆ°æ€»è®¡æ•°å™¨</span></span><br><span class="line">            partial_counter = queue.get(timeout=<span class="number">10</span>)</span><br><span class="line">            word_counter.update(partial_counter)</span><br><span class="line">        <span class="keyword">except</span> Empty:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> processes:</span><br><span class="line">        p.join()</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡è¿™ä¸ªèšåˆï¼Œæˆ‘ä»¬å¾—åˆ° word_counter è¿™ä¸ªå˜é‡ã€‚</p>
<blockquote>
<p><strong>Multi-Processing æ³¨æ„äº‹é¡¹</strong><br>éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œè¿›ç¨‹æ•°ï¼ˆNUM_PROCESSORï¼‰å¹¶ä¸æ˜¯è¶Šå¤šè¶Šå¥½ã€‚åœ¨å®é™…å®ç°ä¸­ï¼Œå½“è¿›ç¨‹æ•°ç»§ç»­å¢å¤§æ—¶ï¼Œæ•´ä½“é€Ÿåº¦åè€Œå¯èƒ½å˜æ…¢ï¼Œä¸»è¦åŸå› æœ‰ä¸‰ç‚¹ï¼š</p>
<ol>
<li><strong>åˆ›å»ºä¸è°ƒåº¦å¼€é”€</strong>ï¼šå¯åŠ¨å¤šä¸ªè¿›ç¨‹æœ¬èº«æœ‰æˆæœ¬ï¼ˆfork/spawnã€åˆ†å‘ä»»åŠ¡ã€å¤šçº¿ç¨‹é”ï¼‰ï¼Œè¿™éƒ¨åˆ†å¼€é”€ä¼šå¼•å…¥åºåˆ—åŒ–/ååºåˆ—åŒ–ï¼ˆpickleï¼‰ä»¥åŠ IPC çš„é¢å¤–è€—æ—¶ã€‚</li>
<li><strong>è·¨è¿›ç¨‹é€šä¿¡æˆæœ¬</strong>ï¼šå¤šè¿›ç¨‹ä¹‹é—´éœ€è¦ä¼ é€’æ•°æ®ï¼ˆä¾‹å¦‚æŠŠ chunk åˆ†å‘ç»™ workerï¼Œå†æŠŠç»Ÿè®¡ç»“æœæ±‡æ€»å›æ¥ï¼‰ã€‚</li>
<li><strong>å†…å­˜ä¸ç¼“å­˜å‹åŠ›</strong>ï¼šè¿›ç¨‹è¶Šå¤šï¼Œå¾€å¾€ä¼šå¸¦æ¥æ›´é«˜çš„å†…å­˜å ç”¨ä¸ cache/memory bandwidth ç«äº‰ï¼Œåè€Œæ‹–æ…¢ååã€‚</li>
</ol>
</blockquote>
<p>å› æ­¤ï¼Œå¤šè¿›ç¨‹çš„æœ€ä½³æ•°é‡é€šå¸¸å–å†³äºï¼šä»»åŠ¡å¤æ‚åº¦ã€æ•°æ®è§„æ¨¡ã€CPU ä¸ IPC çš„æ¯”ä¾‹ã€‚åœ¨æœ¬æ¬¡ Assignment çš„è¯­æ–™è§„æ¨¡ä¸å®ç°æ–¹å¼ä¸‹ï¼Œä¸€ä¸ªç»éªŒä¸Šæ›´ä¼˜çš„é€‰æ‹©æ˜¯ NUM_PROCESSES=4ï¼šæ—¢èƒ½è·å¾—æ˜æ˜¾çš„å¹¶è¡ŒåŠ é€Ÿï¼Œåˆèƒ½é¿å…è¿‡å¤šè¿›ç¨‹å¸¦æ¥çš„é¢å¤–å¼€é”€ä¸æ‹¥å¡ã€‚</p>
<hr>
<h3 id="2-3-4-å…¶ä»–"><a href="#2-3-4-å…¶ä»–" class="headerlink" title="2.3.4 å…¶ä»–"></a>2.3.4 å…¶ä»–</h3><p>é™¤äº† word_counterï¼ˆè®°å½•æ¯ä¸ª word/token åºåˆ—å‡ºç°æ¬¡æ•°ï¼‰ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜ä¼šé¢å¤–æ„å»ºä¸¤ä¸ªè¾…åŠ©ç»“æ„ï¼Œæ¥æ”¯æŒåç»­æ›´é«˜æ•ˆçš„ pair ç»Ÿè®¡ä¸æ›´æ–°ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pairs_counter = Counter()</span><br><span class="line">pair_to_words: <span class="built_in">dict</span>[<span class="built_in">tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>], <span class="built_in">set</span>[<span class="built_in">tuple</span>[<span class="built_in">int</span>, ...]]] = defaultdict(<span class="built_in">set</span>)</span><br><span class="line"><span class="keyword">for</span> word <span class="keyword">in</span> word_counter:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(word) - <span class="number">1</span>):</span><br><span class="line">        pair = (word[i], word[i + <span class="number">1</span>])</span><br><span class="line">        pair_to_words[pair].add(word)</span><br><span class="line">        pairs_counter[pair] += word_counter[word]</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>pairs_counter[pair]</strong>ï¼šè®°å½•è¯¥ç›¸é‚» pair åœ¨å…¨è¯­æ–™ä¸­çš„æ€»å‡ºç°æ¬¡æ•°ã€‚å› ä¸ºæ¯ä¸ª word åœ¨è¯­æ–™ä¸­å‡ºç°äº† word_counter[word] æ¬¡ï¼Œæ‰€ä»¥ word å†…éƒ¨æ¯å‡ºç°ä¸€æ¬¡ pairï¼Œå°±ä¸ºå…¨å±€é¢‘æ¬¡è´¡çŒ® word_counter[word]ã€‚</li>
<li><strong>pair_to_words[pair]</strong>ï¼šè®°å½•è¯¥ pair å‡ºç°åœ¨å“ªäº› wordï¼ˆtoken åºåˆ—ï¼‰é‡Œã€‚è¿™ä¸ªæ˜ å°„éå¸¸å…³é”®ï¼šå½“æˆ‘ä»¬é€‰æ‹©æŸä¸ª pair è¿›è¡Œ merge æ—¶ï¼Œåªæœ‰åŒ…å«è¯¥ pair çš„ word ä¼šå‘ç”Ÿå˜åŒ–ã€‚å€ŸåŠ© pair_to_wordsï¼Œæˆ‘ä»¬å¯ä»¥åªéå†è¿™äº›å—å½±å“çš„ wordsï¼Œå¹¶å¯¹ pairs_counter åšå±€éƒ¨å¢é‡æ›´æ–°ï¼Œè€Œä¸æ˜¯æ¯è½®éƒ½é‡æ–°æ‰«æå…¨éƒ¨ word_counterã€‚</li>
</ul>
<hr>
<h2 id="2-4-BPE-V1-å †ä¼˜åŒ–"><a href="#2-4-BPE-V1-å †ä¼˜åŒ–" class="headerlink" title="2.4 BPE V1: å †ä¼˜åŒ–"></a>2.4 BPE V1: å †ä¼˜åŒ–</h2><p>ä¸€ä¸ªå¾ˆæ˜æ˜¾çš„ä¼˜åŒ–ç‚¹æ˜¯ï¼šæ¯ä¸€è½®éƒ½è¦æ‰¾å½“å‰é¢‘ç‡æœ€é«˜çš„ pairã€‚åœ¨ Version 0ï¼ˆSection 2.2ï¼‰é‡Œï¼Œæˆ‘ä»¬æ¯è½®éƒ½é€šè¿‡éå† pairs_counter æ¥å–æœ€å¤§å€¼ï¼Œè¿™æ˜¯ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>P</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(P)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mclose">)</span></span></span></span>ï¼ˆ<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span> æ˜¯ pair çš„æ•°é‡ï¼‰ã€‚è€Œè¿™ä¸ªæ“ä½œæ­£å¥½ç¬¦åˆ<strong>å †ï¼ˆheapï¼‰</strong>çš„ä½¿ç”¨åœºæ™¯ï¼šç”¨å †ç»´æŠ¤â€œå½“å‰æœ€å¤§çš„ pairâ€ï¼Œå°±èƒ½æŠŠâ€œå–æœ€å¤§â€é™åˆ° <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>â¡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span>ï¼ˆä¸¥æ ¼æ¥è¯´æ˜¯ï¼šå–å †é¡¶æ˜¯ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span>ï¼Œä½†å¦‚æœåŒ…å« pop/push æ›´æ–°åˆ™æ˜¯ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>â¡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span>ï¼‰ã€‚</p>
<p>å…·ä½“åšæ³•æ˜¯æŠŠæ¯ä¸ª pair ä½œä¸ºå †å…ƒç´ ï¼Œå¹¶æŠŠæ’åºä¾æ®è®¾è®¡æˆï¼š</p>
<ul>
<li>é¢‘æ¬¡è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜</li>
<li>é¢‘æ¬¡ç›¸åŒæ—¶æŒ‰ pair çš„å­—å…¸åºæ›´å¤§è€…ä¼˜å…ˆ</li>
</ul>
<p>åœ¨ Python çš„ heapq æ˜¯æœ€å°å †ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç”¨è´Ÿå·æŠŠå®ƒå˜æˆâ€œæœ€å¤§å †â€ï¼Œä¾‹å¦‚å­˜æˆï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">key = (-freq, -a, -b)</span><br></pre></td></tr></table></figure></p>
<p>è¿™æ ·æ¯ä¸€è½®æˆ‘ä»¬éƒ½èƒ½å¿«é€Ÿæ‹¿åˆ°å€™é€‰çš„â€œæœ€å¸¸è§ pairâ€ã€‚</p>
<p>ä¸è¿‡è¦æ³¨æ„ä¸€ç‚¹ï¼šé¢‘æ¬¡åœ¨ merge ä¹‹åä¼šå‘ç”Ÿå˜åŒ–ï¼Œå› æ­¤å †é‡Œæ—§çš„æ¡ç›®å¯èƒ½å˜â€œè¿‡æœŸâ€ã€‚åœ¨ pop å †é¡¶æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ£€æŸ¥è¯¥ pair å½“å‰çš„é¢‘æ¬¡æ˜¯å¦å’Œå †é‡Œå­˜çš„é¢‘æ¬¡ä¸€è‡´ï¼›å¦‚æœä¸ä¸€è‡´ï¼Œè¯´æ˜å †é¡¶æ˜¯è¿‡æœŸçš„ï¼Œå°±ç»§ç»­ pop ç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªæœ‰æ•ˆçš„ pairã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cs336_basics/tokenizer/merge_fn.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HeapItem</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, neg_freq: <span class="built_in">int</span>, pair_bytes: <span class="built_in">tuple</span>[<span class="built_in">bytes</span>, <span class="built_in">bytes</span>], pair: <span class="built_in">tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>]</span>):</span><br><span class="line">        <span class="variable language_">self</span>.neg_freq = neg_freq</span><br><span class="line">        <span class="variable language_">self</span>.pair_bytes = pair_bytes</span><br><span class="line">        <span class="variable language_">self</span>.pair = pair</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__lt__</span>(<span class="params">self, other: <span class="string">&quot;HeapItem&quot;</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.neg_freq != other.neg_freq:</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.neg_freq &lt; other.neg_freq</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.pair_bytes &gt; other.pair_bytes  <span class="comment"># åå‘æ¯”è¾ƒé¡ºåºï¼Œç”¨äºå®ç°æœ€å¤§å †ï¼ˆmax-heapï¼‰</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_pair_heap</span>(<span class="params">pairs_freqs: Counter, vocab: <span class="built_in">dict</span>[<span class="built_in">int</span>, <span class="built_in">bytes</span>]</span>):</span><br><span class="line">    heap = []</span><br><span class="line">    <span class="keyword">for</span> (a, b), f <span class="keyword">in</span> pairs_freqs.items():</span><br><span class="line">        <span class="keyword">if</span> f &gt; <span class="number">0</span>:</span><br><span class="line">            item = HeapItem(-f, (vocab[a], vocab[b]), (a, b))</span><br><span class="line">            heapq.heappush(heap, item)</span><br><span class="line">    <span class="keyword">return</span> heap</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pop_most_frequent_pair</span>(<span class="params">heap, pairs_counter: Counter</span>) -&gt; <span class="built_in">tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>]:</span><br><span class="line">    <span class="keyword">while</span> heap:</span><br><span class="line">        item = heap[<span class="number">0</span>]  <span class="comment"># æŸ¥çœ‹å †é¡¶å…ƒç´ ï¼ˆä¸å¼¹å‡ºï¼‰</span></span><br><span class="line">        neg_f = item.neg_freq</span><br><span class="line">        pair = item.pair</span><br><span class="line">        cur_f = pairs_counter.get(pair, <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">if</span> cur_f &lt;= <span class="number">0</span> <span class="keyword">or</span> -neg_f != cur_f:   <span class="comment"># é¢‘æ¬¡å·²å˜åŒ–ï¼Œè¯´æ˜å †é‡Œå­˜çš„è¿™å¯¹ pair å·²ç»è¿‡æœŸï¼ˆæ—§æ•°æ®ï¼‰</span></span><br><span class="line">            heapq.heappop(heap)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">return</span> pair</span><br><span class="line"></span><br><span class="line">    <span class="keyword">raise</span> ValueError(<span class="string">&quot;æ²¡æœ‰å‰©ä½™é¢‘æ¬¡ä¸ºæ­£çš„ pair&quot;</span>)</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="2-5-BPE-V2-å †ä¼˜åŒ–-ç´¢å¼•ä¼˜åŒ–"><a href="#2-5-BPE-V2-å †ä¼˜åŒ–-ç´¢å¼•ä¼˜åŒ–" class="headerlink" title="2.5 BPE V2: å †ä¼˜åŒ– + ç´¢å¼•ä¼˜åŒ–"></a>2.5 BPE V2: å †ä¼˜åŒ– + ç´¢å¼•ä¼˜åŒ–</h2><p>é™¤äº†ç”¨ Heap åŠ é€Ÿâ€œé€‰å‡ºé¢‘ç‡æœ€é«˜çš„ pairâ€ï¼Œå¦ä¸€ä¸ªæ›´å…³é”®çš„ç“¶é¢ˆåœ¨äº merge æ›´æ–°é˜¶æ®µï¼šåœ¨ Version 0ï¼ˆSection 2.2ï¼‰é‡Œï¼Œæˆ‘ä»¬æ¯ä¸€è½®éƒ½ä¼šéå† word_counter é‡Œçš„æ‰€æœ‰ wordï¼Œæ£€æŸ¥è¿™ä¸ª word é‡Œæ˜¯å¦å‡ºç°äº†ç›®æ ‡ pairï¼›è¿™ä¸€æ­¥çš„ä»£ä»·é€šå¸¸éå¸¸é«˜ï¼Œå› ä¸ºç»å¤§å¤šæ•° word æ ¹æœ¬ä¸åŒ…å«å½“å‰è¦ merge çš„ pairï¼Œä½†æˆ‘ä»¬è¿˜æ˜¯æŠŠå®ƒä»¬éƒ½æ‰«äº†ä¸€éã€‚</p>
<p>å› æ­¤æˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªâ€œå€’æ’ç´¢å¼•â€æ¥åš<strong>ç©ºé—´æ¢æ—¶é—´</strong>ï¼šæå‰ç»´æŠ¤ä¸€ä¸ªæ˜ å°„ pair -&gt; {wordsâ€¦}ï¼Œè®°å½•æ¯ä¸ª pair å‡ºç°åœ¨å“ªäº› word ä¸­ã€‚è¿™æ ·å½“æˆ‘ä»¬å†³å®š merge æŸä¸ª pair æ—¶ï¼Œå°±åªéœ€è¦éå† pair_to_words[pair] é‡Œçš„é‚£ä¸€å°éƒ¨åˆ† wordï¼Œè€Œä¸å¿…å…¨é‡æ‰«ææ‰€æœ‰ wordã€‚</p>
<p>è¿™ä¹Ÿæ­£æ˜¯æˆ‘ä»¬æ­å»º pair_to_words çš„åŸå› ï¼š</p>
<ul>
<li>æ²¡æœ‰ç´¢å¼•ï¼šæ¯è½® merge éƒ½æ˜¯å…¨é‡æ‰«ææ‰€æœ‰ wordsï¼ˆæ…¢ï¼Œ<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>w</mi><mi>o</mi><mi>r</mi><mi>d</mi><mi>s</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(words)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord mathnormal" style="margin-right:0.02778em;">or</span><span class="mord mathnormal">d</span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span></span> çº§åˆ«ï¼‰ã€‚</li>
<li>æœ‰ç´¢å¼•ï¼šæ¯è½®åªå¤„ç†åŒ…å«è¯¥ pair çš„ words å­é›†ï¼ˆå¿«ï¼Œå¤æ‚åº¦å–å†³äºè¯¥ pair çš„è¦†ç›–èŒƒå›´ï¼Œé€šå¸¸è¿œå°äºå…¨é‡ï¼‰ã€‚</li>
</ul>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åœ¨ merge ä¹‹åï¼Œæ›´æ–°è¿™ä¸ªç´¢å¼•ï¼šå½“æŸä¸ª pair è¢« merge æˆä¸€ä¸ªæ–° token åï¼Œæ‰€æœ‰åŒ…å«è¯¥ pair çš„ word éƒ½ä¼šå‘ç”Ÿå˜åŒ–ï¼Œæˆ‘ä»¬éœ€è¦æŠŠè¿™äº› word ä»æ—§ pair çš„ç´¢å¼•é‡Œç§»é™¤ï¼Œå¹¶æŠŠå®ƒä»¬æ·»åŠ åˆ°æ–° pair çš„ç´¢å¼•é‡Œã€‚å…·ä½“å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cs336_basics/tokenizer/merge_fn.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge_pairs_with_heap_index</span>(<span class="params"></span></span><br><span class="line"><span class="params">    word_counter: <span class="built_in">dict</span>[<span class="built_in">tuple</span>[<span class="built_in">int</span>, ...], <span class="built_in">int</span>],</span></span><br><span class="line"><span class="params">    pair_counter: Counter,</span></span><br><span class="line"><span class="params">    target_pair: <span class="built_in">tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>],</span></span><br><span class="line"><span class="params">    new_id: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    vocab: <span class="built_in">dict</span>[<span class="built_in">int</span>, <span class="built_in">bytes</span>],</span></span><br><span class="line"><span class="params">    pair_heap,</span></span><br><span class="line"><span class="params">    pair_to_words: <span class="built_in">dict</span>[<span class="built_in">tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>], <span class="built_in">set</span>[<span class="built_in">tuple</span>[<span class="built_in">int</span>, ...]]],</span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="built_in">tuple</span>[</span><br><span class="line">    <span class="built_in">dict</span>[<span class="built_in">tuple</span>[<span class="built_in">int</span>, ...], <span class="built_in">int</span>],</span><br><span class="line">    Counter,</span><br><span class="line">    <span class="built_in">list</span>,</span><br><span class="line">    <span class="built_in">dict</span>[<span class="built_in">tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>], <span class="built_in">set</span>[<span class="built_in">tuple</span>[<span class="built_in">int</span>, ...]]],</span><br><span class="line">]:</span><br><span class="line">    <span class="comment"># ä» å®Œæ•´è®¡æ•°å™¨ æ‹·è´å¼€å§‹æ›´æ–°ï¼šè¿™æ ·æœªå—å½±å“çš„è¯ä¼šåŸæ ·ä¿ç•™</span></span><br><span class="line">    new_word_counter: Counter = Counter(word_counter)</span><br><span class="line">    updated_pair_counter: Counter = pair_counter.copy()</span><br><span class="line">    changed_pairs: <span class="built_in">set</span>[<span class="built_in">tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>]] = <span class="built_in">set</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å–å‡ºæ‰€æœ‰åŒ…å« target_pair çš„ wordï¼ˆé€šè¿‡ pair_to_words å€’æ’ç´¢å¼•ï¼‰</span></span><br><span class="line">    affected_words = <span class="built_in">list</span>(pair_to_words.get(target_pair, <span class="built_in">set</span>()))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> w <span class="keyword">in</span> affected_words:</span><br><span class="line">        freq = word_counter.get(w, <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">if</span> freq &lt;= <span class="number">0</span> <span class="keyword">or</span> <span class="built_in">len</span>(w) &lt; <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">         <span class="comment"># 1. ä»è¯­æ–™ç»Ÿè®¡ä¸­ç§»é™¤æ—§ wordï¼ˆå‡å°‘å…¶å‡ºç°æ¬¡æ•°ï¼‰</span></span><br><span class="line">        new_word_counter[w] -= freq</span><br><span class="line">        <span class="keyword">if</span> new_word_counter[w] &lt;= <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">del</span> new_word_counter[w]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 2. å¯¹è¯¥ word çš„â€œæ‰€æœ‰æ—§ç›¸é‚» pairâ€åšå‡é¢‘ï¼Œå¹¶å°†è¯¥ word ä»å€’æ’ç´¢å¼•ä¸­ç§»é™¤</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(w) - <span class="number">1</span>):</span><br><span class="line">            pair = (w[i], w[i + <span class="number">1</span>])</span><br><span class="line">            updated_pair_counter[pair] -= freq</span><br><span class="line">            changed_pairs.add(pair)</span><br><span class="line"></span><br><span class="line">            s = pair_to_words.get(pair)</span><br><span class="line">            <span class="keyword">if</span> s <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                s.discard(w)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> s:</span><br><span class="line">                    <span class="keyword">del</span> pair_to_words[pair]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3. æ„é€ åˆå¹¶åçš„æ–° wordï¼ˆä»å·¦åˆ°å³è´ªå¿ƒåˆå¹¶ï¼Œè¡Œä¸ºä¸æ ‡å‡† BPE ä¸€è‡´ï¼‰</span></span><br><span class="line">        new_word = get_new_word(w, target_pair, new_id)</span><br><span class="line">        new_word_counter[new_word] += freq</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 4. å¯¹æ–° word çš„â€œæ‰€æœ‰æ–°ç›¸é‚» pairâ€åšåŠ é¢‘ï¼Œå¹¶æŠŠæ–° word åŠ å›å€’æ’ç´¢å¼•</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(new_word) &gt;= <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(new_word) - <span class="number">1</span>):</span><br><span class="line">                pair = (new_word[i], new_word[i + <span class="number">1</span>])</span><br><span class="line">                updated_pair_counter[pair] += freq</span><br><span class="line">                changed_pairs.add(pair)</span><br><span class="line">                pair_to_words.setdefault(pair, <span class="built_in">set</span>()).add(new_word)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 5. å°†å‘ç”Ÿå˜åŒ–çš„ pair çš„æœ€æ–°é¢‘æ¬¡æ¨å…¥å †ï¼ˆé¢‘æ¬¡&lt;=0 çš„è·³è¿‡ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> pair_heap <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">for</span> p <span class="keyword">in</span> changed_pairs:</span><br><span class="line">            f = updated_pair_counter.get(p, <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">if</span> f &gt; <span class="number">0</span>:</span><br><span class="line">                heapq.heappush(pair_heap, HeapItem(-f, (vocab[p[<span class="number">0</span>]], vocab[p[<span class="number">1</span>]]), p))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">dict</span>(new_word_counter), updated_pair_counter, pair_heap, pair_to_words</span><br></pre></td></tr></table></figure>
<p>æœ‰äº†è¿™ä¸¤ä¸ªä¼˜åŒ–ç‚¹ï¼ŒBPE çš„è®­ç»ƒé€Ÿåº¦å¯ä»¥å¤§å¤§çš„æå‡ã€‚</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>ç‰ˆæœ¬</th>
<th>æ‰¾æœ€é¢‘ç¹ pair</th>
<th>æ›´æ–°è®¡æ•°</th>
<th>è®­ç»ƒä¸»å¾ªç¯ç“¶é¢ˆ</th>
</tr>
</thead>
<tbody>
<tr>
<td>v0</td>
<td>æ¯è½®æ‰«ä¸€é pairs (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>p</mi><mi>a</mi><mi>i</mi><mi>r</mi><mi>s</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(pairs)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mord mathnormal">ai</span><span class="mord mathnormal">rs</span><span class="mclose">)</span></span></span></span>)</td>
<td>æ¯è½®é‡ç®—</td>
<td>å¾ˆæ…¢</td>
</tr>
<tr>
<td>heap</td>
<td>pop <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>â¡</mo><mi>p</mi><mi>a</mi><mi>i</mi><mi>r</mi><mi>s</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log pairs)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">ai</span><span class="mord mathnormal">rs</span><span class="mclose">)</span></span></span></span></td>
<td>ä»å¯èƒ½æ‰«å¾ˆå¤š</td>
<td>æ›´å¿«</td>
</tr>
<tr>
<td>heap + pair_to_words</td>
<td>pop <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>log</mi><mo>â¡</mo><mi>p</mi><mi>a</mi><mi>i</mi><mi>r</mi><mi>s</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\log pairs)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">ai</span><span class="mord mathnormal">rs</span><span class="mclose">)</span></span></span></span></td>
<td>åªæ›´æ–°å—å½±å“çš„ words/pairs</td>
<td>æ˜æ˜¾æ›´å¿«</td>
</tr>
</tbody>
</table>
</div>
<hr>
<h2 id="2-6-è®­ç»ƒ-BPE"><a href="#2-6-è®­ç»ƒ-BPE" class="headerlink" title="2.6 è®­ç»ƒ BPE"></a>2.6 è®­ç»ƒ BPE</h2><p>å°†ä¸Šé¢çš„å®ç°æ•´åˆåï¼Œæˆ‘ä»¬å°±å¯ä»¥å®Œæˆå®Œæ•´çš„ BPE è®­ç»ƒç®—æ³•ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cs336_basics/tokenizer/tokenizer.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">train_bpe</span>(<span class="params"></span></span><br><span class="line"><span class="params">    input_path: <span class="built_in">str</span> | os.PathLike,</span></span><br><span class="line"><span class="params">    vocab_size: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    special_tokens: <span class="built_in">list</span>[<span class="built_in">str</span>] | <span class="literal">None</span> = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    verbose: <span class="built_in">bool</span> = <span class="literal">False</span>,</span></span><br><span class="line"><span class="params">    **kwargs,</span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="built_in">tuple</span>[<span class="built_in">dict</span>[<span class="built_in">int</span>, <span class="built_in">bytes</span>], <span class="built_in">list</span>[<span class="built_in">tuple</span>[<span class="built_in">bytes</span>, <span class="built_in">bytes</span>]]]:</span><br><span class="line">    num_merges = vocab_size - <span class="number">256</span> - (<span class="built_in">len</span>(special_tokens) <span class="keyword">if</span> special_tokens <span class="keyword">else</span> <span class="number">0</span>)</span><br><span class="line">    vocab: <span class="built_in">dict</span>[<span class="built_in">int</span>, <span class="built_in">bytes</span>] = init_vocab(special_tokens)</span><br><span class="line">    merges: <span class="built_in">list</span>[<span class="built_in">tuple</span>[<span class="built_in">bytes</span>, <span class="built_in">bytes</span>]] = []</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1. é¢„åˆ†è¯ï¼ˆPre-tokenizationï¼‰</span></span><br><span class="line">    <span class="comment"># 1.1 æŸ¥æ‰¾åˆ†ç‰‡è¾¹ç•Œï¼ˆchunk boundariesï¼‰</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(input_path, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        chunk_boundaries = find_chunk_boundaries(</span><br><span class="line">            f, desired_num_chunks=kwargs.get(<span class="string">&quot;desired_num_chunks&quot;</span>, NUM_PROCESSES), split_special_token=<span class="string">b&quot;\n&quot;</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> verbose:</span><br><span class="line">        print_color(<span class="string">f&quot;å·²è¯†åˆ« <span class="subst">&#123;<span class="built_in">len</span>(chunk_boundaries) - <span class="number">1</span>&#125;</span> ä¸ªåˆ†ç‰‡ç”¨äºé¢„åˆ†è¯&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1.2 ä½¿ç”¨å¤šè¿›ç¨‹å¯¹å„ä¸ªåˆ†ç‰‡ç»Ÿè®¡è¯é¢‘ï¼ˆword frequenciesï¼‰</span></span><br><span class="line">    manager = Manager()</span><br><span class="line">    queue = manager.Queue()</span><br><span class="line">    processes: <span class="built_in">list</span>[Process] = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> start, end <span class="keyword">in</span> <span class="built_in">zip</span>(chunk_boundaries[:-<span class="number">1</span>], chunk_boundaries[<span class="number">1</span>:]):</span><br><span class="line">        p = Process(</span><br><span class="line">            target=pre_tokenize_string_worker,</span><br><span class="line">            args=(input_path, special_tokens, queue, start, end, <span class="literal">False</span>),</span><br><span class="line">        )</span><br><span class="line">        processes.append(p)</span><br><span class="line">        p.start()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> verbose:</span><br><span class="line">        print_color(<span class="string">&quot;é¢„åˆ†è¯è¿›ç¨‹å·²å®Œæˆï¼Œæ­£åœ¨æ±‡æ€»ç»Ÿè®¡ç»“æœ...&quot;</span>)</span><br><span class="line"></span><br><span class="line">    word_counter = Counter()</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(processes)):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            partial_counter = queue.get(timeout=<span class="number">10</span>)</span><br><span class="line">            word_counter.update(partial_counter)</span><br><span class="line">        <span class="keyword">except</span> Empty:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> processes:</span><br><span class="line">        p.join()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> verbose:</span><br><span class="line">        print_color(<span class="string">f&quot;é¢„åˆ†è¯å®Œæˆã€‚è¯è¡¨å¤§å°ï¼š<span class="subst">&#123;<span class="built_in">len</span>(word_counter)&#125;</span> ä¸ªä¸åŒ token&quot;</span>)</span><br><span class="line"></span><br><span class="line">    pairs_counter = Counter()</span><br><span class="line">    pair_to_words: <span class="built_in">dict</span>[<span class="built_in">tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>], <span class="built_in">set</span>[<span class="built_in">tuple</span>[<span class="built_in">int</span>, ...]]] = defaultdict(<span class="built_in">set</span>)</span><br><span class="line">    <span class="keyword">for</span> word <span class="keyword">in</span> word_counter:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(word) - <span class="number">1</span>):</span><br><span class="line">            pair = (word[i], word[i + <span class="number">1</span>])</span><br><span class="line">            pair_to_words[pair].add(word)</span><br><span class="line">            pairs_counter[pair] += word_counter[word]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. BPE æ ¸å¿ƒå¾ªç¯</span></span><br><span class="line">    pair_heap = build_pair_heap(pairs_counter, vocab)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> trange(num_merges):</span><br><span class="line">        most_frequent_pair = pop_most_frequent_pair(pair_heap, pairs_counter)</span><br><span class="line">        new_id = update_vocab(vocab, most_frequent_pair)</span><br><span class="line"></span><br><span class="line">        word_counter, pairs_counter, pair_heap, pair_to_words = merge_pairs_with_heap_index(</span><br><span class="line">            word_counter, pairs_counter, most_frequent_pair, new_id, vocab, pair_heap, pair_to_words</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        merges.append((vocab[most_frequent_pair[<span class="number">0</span>]], vocab[most_frequent_pair[<span class="number">1</span>]]))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> kwargs.get(<span class="string">&quot;save_path&quot;</span>):</span><br><span class="line">        save_vocab_and_merges(vocab, merges, kwargs[<span class="string">&quot;save_path&quot;</span>])</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(os.path.join(kwargs[<span class="string">&quot;save_path&quot;</span>], <span class="string">&quot;special_tokens.txt&quot;</span>), <span class="string">&quot;w&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">if</span> special_tokens:</span><br><span class="line">                <span class="keyword">for</span> token <span class="keyword">in</span> special_tokens:</span><br><span class="line">                    f.write(<span class="string">f&quot;<span class="subst">&#123;token&#125;</span>\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> vocab, merges</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="è¿è¡Œä¸€ä¸‹æµ‹è¯•ä»£ç "><a href="#è¿è¡Œä¸€ä¸‹æµ‹è¯•ä»£ç " class="headerlink" title="è¿è¡Œä¸€ä¸‹æµ‹è¯•ä»£ç "></a>è¿è¡Œä¸€ä¸‹æµ‹è¯•ä»£ç </h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tests/adapters.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> cs336_basics.tokenizer.tokenizer <span class="keyword">import</span> train_bpe</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> train_bpe(</span><br><span class="line">        input_path=input_path,</span><br><span class="line">        vocab_size=vocab_size,</span><br><span class="line">        special_tokens=special_tokens,</span><br><span class="line">        **kwargs,</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œæµ‹è¯•å‘½ä»¤ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uv run pytest tests/test_train_bpe.py</span><br></pre></td></tr></table></figure></p>
<p>æµ‹è¯•ç»“æœï¼ˆå…¨éƒ¨é€šè¿‡ï¼‰ï¼š</p>
<p><img src="./test_train_bpe.png" alt="test_train_bpe æµ‹è¯•ç»“æœ"></p>
<hr>
<h3 id="2-7-BPE-on-TinyStory"><a href="#2-7-BPE-on-TinyStory" class="headerlink" title="2.7 BPE on TinyStory"></a>2.7 BPE on TinyStory</h3><p>åœ¨ TinyStory æ•°æ®é›†ä¸Šè®­ç»ƒ BPE ä»…éœ€çº¦ <strong>5 åˆ†é’Ÿ</strong>ï¼š</p>
<p><img src="./trainBPE.png" alt="train_bpe ç»“æœ"></p>
<hr>
<h3 id="2-8-BPE-Tokenizer"><a href="#2-8-BPE-Tokenizer" class="headerlink" title="2.8 BPE Tokenizer"></a>2.8 BPE Tokenizer</h3><p>æœ‰äº†è®­ç»ƒå¥½çš„ vocab å’Œ mergesï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ä¸€ä¸ªå®Œæ•´çš„ BPE Tokenizerï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cs336_basics/tokenizer/tokenizer.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BPETokenizer</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params"></span></span><br><span class="line"><span class="params">        self,</span></span><br><span class="line"><span class="params">        vocab: <span class="built_in">dict</span>[<span class="built_in">int</span>, <span class="built_in">bytes</span>],</span></span><br><span class="line"><span class="params">        merges: <span class="built_in">list</span>[<span class="built_in">tuple</span>[<span class="built_in">bytes</span>, <span class="built_in">bytes</span>]],</span></span><br><span class="line"><span class="params">        special_tokens: <span class="built_in">list</span>[<span class="built_in">str</span>] | <span class="literal">None</span> = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    </span>):</span><br><span class="line">        <span class="variable language_">self</span>.vocab = vocab</span><br><span class="line">        <span class="variable language_">self</span>.merges = merges</span><br><span class="line">        <span class="variable language_">self</span>.special_tokens = special_tokens <span class="keyword">if</span> special_tokens <span class="keyword">else</span> []</span><br><span class="line">        <span class="variable language_">self</span>.special_tokens_bytes = [t.encode(<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">for</span> t <span class="keyword">in</span> <span class="variable language_">self</span>.special_tokens]</span><br><span class="line">        <span class="variable language_">self</span>.special_set = <span class="built_in">set</span>(<span class="variable language_">self</span>.special_tokens_bytes)</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.vocab_inv = &#123;v: k <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="variable language_">self</span>.vocab.items()&#125;</span><br><span class="line"></span><br><span class="line">        rank: <span class="built_in">dict</span>[<span class="built_in">tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>], <span class="built_in">int</span>] = &#123;&#125;</span><br><span class="line">        merge_to_new_id: <span class="built_in">dict</span>[<span class="built_in">tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>], <span class="built_in">int</span>] = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> r, (a_bytes, b_bytes) <span class="keyword">in</span> <span class="built_in">enumerate</span>(<span class="variable language_">self</span>.merges):</span><br><span class="line">            a_id = <span class="variable language_">self</span>.vocab_inv.get(a_bytes)</span><br><span class="line">            b_id = <span class="variable language_">self</span>.vocab_inv.get(b_bytes)</span><br><span class="line">            <span class="comment"># åˆå¹¶åçš„ token åº”è¯¥å­˜åœ¨äº vocab ä¸­ï¼›å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™è·³è¿‡è¿™æ¡åˆå¹¶è§„åˆ™</span></span><br><span class="line">            new_id = <span class="variable language_">self</span>.vocab_inv.get(a_bytes + b_bytes)</span><br><span class="line">            <span class="keyword">if</span> a_id <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> b_id <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> new_id <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            pair = (a_id, b_id)</span><br><span class="line">            rank[pair] = r</span><br><span class="line">            merge_to_new_id[pair] = new_id</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.rank = rank</span><br><span class="line">        <span class="variable language_">self</span>.merge_to_new_id = merge_to_new_id</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.eos_token_id = <span class="variable language_">self</span>.vocab_inv.get(<span class="string">b&quot;&lt;|endoftext|&gt;&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">encode</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span> </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">encode_iterable</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decode</span>(<span class="params">self</span>):</span><br><span class="line">        tokens = <span class="string">b&quot;&quot;</span>.join(<span class="variable language_">self</span>.vocab.get(i, <span class="string">b&quot;\xef\xbf\xbd&quot;</span>) <span class="keyword">for</span> i <span class="keyword">in</span> ids)</span><br><span class="line">        <span class="keyword">return</span> tokens.decode(<span class="string">&quot;utf-8&quot;</span>, errors=<span class="string">&quot;replace&quot;</span>)</span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">from_files</span>(<span class="params"></span></span><br><span class="line"><span class="params">        cls, vocab_filepath: <span class="built_in">str</span>, merges_filepath: <span class="built_in">str</span>, special_tokens: <span class="built_in">list</span>[<span class="built_in">str</span>] | <span class="built_in">str</span> | <span class="literal">None</span> = <span class="literal">None</span></span></span><br><span class="line"><span class="params">    </span>) -&gt; <span class="string">&quot;BPETokenizer&quot;</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(vocab_filepath) <span class="keyword">as</span> vf:</span><br><span class="line">            vocab_data = json.load(vf)</span><br><span class="line">            vocab = &#123;<span class="built_in">int</span>(i): <span class="built_in">bytes</span>(v, <span class="string">&quot;latin1&quot;</span>) <span class="keyword">for</span> v, i <span class="keyword">in</span> vocab_data.items()&#125;</span><br><span class="line"></span><br><span class="line">        merges = []</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(merges_filepath) <span class="keyword">as</span> mf:</span><br><span class="line">            <span class="comment"># è·³è¿‡ç¬¬ä¸€è¡Œï¼ˆè¡¨å¤´/è¯´æ˜è¡Œï¼‰</span></span><br><span class="line">            <span class="built_in">next</span>(mf)</span><br><span class="line">            <span class="keyword">for</span> line <span class="keyword">in</span> mf:</span><br><span class="line">                <span class="keyword">if</span> line.strip() <span class="keyword">and</span> <span class="keyword">not</span> line.startswith(<span class="string">&quot;#&quot;</span>):</span><br><span class="line">                    parts = line.strip().split()</span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">len</span>(parts) == <span class="number">2</span>:</span><br><span class="line">                        merges.append((<span class="built_in">bytes</span>(parts[<span class="number">0</span>], <span class="string">&quot;latin1&quot;</span>), <span class="built_in">bytes</span>(parts[<span class="number">1</span>], <span class="string">&quot;latin1&quot;</span>)))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(special_tokens, <span class="built_in">str</span>):</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(special_tokens, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> stf:</span><br><span class="line">                special_tokens_list = [line.strip() <span class="keyword">for</span> line <span class="keyword">in</span> stf <span class="keyword">if</span> line.strip()]</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(special_tokens, <span class="built_in">list</span>):</span><br><span class="line">            special_tokens_list = special_tokens</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            special_tokens_list = []</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> cls(vocab, merges, special_tokens_list)</span><br></pre></td></tr></table></figure>
<h4 id="BPE-Tokenizer-æ ¸å¿ƒåŠŸèƒ½"><a href="#BPE-Tokenizer-æ ¸å¿ƒåŠŸèƒ½" class="headerlink" title="BPE Tokenizer æ ¸å¿ƒåŠŸèƒ½"></a>BPE Tokenizer æ ¸å¿ƒåŠŸèƒ½</h4><ol>
<li><strong>encode</strong>: æŠŠå­—ç¬¦ä¸²ç¼–ç æˆ token IDs åˆ—è¡¨</li>
<li><strong>encode_iterable</strong>: æŠŠå­—ç¬¦ä¸²åˆ—è¡¨ç¼–ç æˆ token IDs åˆ—è¡¨çš„ç”Ÿæˆå™¨</li>
<li><strong>decode</strong>: æŠŠ token IDs åˆ—è¡¨è§£ç æˆå­—ç¬¦ä¸²</li>
</ol>
<p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä¸»è¦ä»‹ç» encode çš„å®ç°ï¼›ç›¸æ¯”ä¹‹ä¸‹ï¼Œdecode çš„é€»è¾‘ç›¸å¯¹ç›´æ¥ï¼šæŠŠ token IDs ä¾æ¬¡æ˜ å°„åˆ°å¯¹åº”çš„ bytesï¼Œæ‹¼æ¥æˆå®Œæ•´çš„å­—èŠ‚åºåˆ—ï¼Œå†ç”¨ utf-8 è§£ç å¾—åˆ°å­—ç¬¦ä¸²ã€‚éœ€è¦ç‰¹åˆ«æ³¨æ„ bâ€\xef\xbf\xbdâ€ çš„å¤„ç†â€”â€”å®ƒæ˜¯ Unicode U+FFFDï¼ˆæ›¿æ¢å­—ç¬¦ï¼‰åœ¨ UTF-8 ä¸‹çš„å­—èŠ‚è¡¨ç¤ºï¼Œåœ¨ decode æ—¶ä¼šå¯¹æ¯ä¸ª token ID æ‰§è¡Œä¸€æ¬¡æŸ¥è¡¨ self.vocab.get(i, â€¦)ï¼š</p>
<ul>
<li>å¦‚æœåœ¨è¯è¡¨ä¸­æ‰¾åˆ°ï¼Œå°±å–å‡ºå¯¹åº”çš„ bytesï¼›</li>
<li>å¦‚æœæ²¡æ‰¾åˆ°ï¼ˆä¾‹å¦‚é‡åˆ°éæ³•/è¶Šç•Œçš„ IDï¼Œæˆ–è¯è¡¨ä¸å®Œæ•´ï¼‰ï¼Œå°±ç”¨ bâ€\xef\xbf\xbdâ€ ä½œä¸ºå…œåº•ã€‚<br>è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼šå³ä½¿è¾“å…¥ IDs ä¸­æ··å…¥äº†éæ³•å€¼ï¼Œdecode ä¹Ÿä¸ä¼šå´©æºƒï¼Œè€Œæ˜¯ç”¨ ï¿½ æ˜¾å¼æ ‡è®°æ— æ³•è¿˜åŸçš„éƒ¨åˆ†ï¼Œä¿è¯æ•´ä¸ªè§£ç è¿‡ç¨‹å§‹ç»ˆå¯è¿è¡Œã€è¾“å‡ºå§‹ç»ˆæ˜¯ä¸€ä¸ªåˆæ³•å­—ç¬¦ä¸²ã€‚</li>
</ul>
<hr>
<h4 id="2-8-1-BPETokenizer-ä¸­çš„ç¼–ç "><a href="#2-8-1-BPETokenizer-ä¸­çš„ç¼–ç " class="headerlink" title="2.8.1 BPETokenizer ä¸­çš„ç¼–ç "></a>2.8.1 BPETokenizer ä¸­çš„ç¼–ç </h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">encode</span>(<span class="params">self, text: <span class="built_in">str</span></span>) -&gt; <span class="built_in">list</span>[<span class="built_in">int</span>]:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">merge_one_pretoken</span>(<span class="params">ids: <span class="built_in">list</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="built_in">list</span>[<span class="built_in">int</span>]:</span><br><span class="line">        <span class="keyword">pass</span> </span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ç¬¬ä¸€æ­¥ï¼šé¢„åˆ†è¯ï¼ˆæŠŠåŸå§‹æ–‡æœ¬åˆ‡æˆè‹¥å¹²æ®µ byte tokenï¼›é€šå¸¸ä¼šæŠŠç‰¹æ®Š token å•ç‹¬åˆ‡å‡ºæ¥ï¼‰</span></span><br><span class="line">    byte_tokens = <span class="variable language_">self</span>._pre_tokenize(text)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ç¬¬äºŒæ­¥ï¼šé€æ®µç¼–ç å¹¶æ‹¼æ¥æˆæœ€ç»ˆçš„ token id åºåˆ—</span></span><br><span class="line">    token_ids: <span class="built_in">list</span>[<span class="built_in">int</span>] = []</span><br><span class="line">    <span class="keyword">for</span> btok <span class="keyword">in</span> byte_tokens:</span><br><span class="line">        <span class="keyword">if</span> btok <span class="keyword">in</span> <span class="variable language_">self</span>.special_set:</span><br><span class="line">            <span class="comment"># ç‰¹æ®Š tokenï¼šç›´æ¥æ˜ å°„æˆå¯¹åº”çš„ idï¼ˆä¸å‚ä¸ BPE åˆå¹¶ï¼‰</span></span><br><span class="line">            token_ids.append(<span class="variable language_">self</span>.vocab_inv[btok])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># æ™®é€šæ–‡æœ¬ï¼šå…ˆæŒ‰å­—èŠ‚åˆ‡åˆ†ï¼Œæ¯ä¸ªå­—èŠ‚æ˜ å°„åˆ°åˆå§‹ vocab id</span></span><br><span class="line">            ids = [<span class="variable language_">self</span>.vocab_inv[<span class="built_in">bytes</span>([b])] <span class="keyword">for</span> b <span class="keyword">in</span> btok]</span><br><span class="line">            <span class="comment"># å¯¹è¯¥æ®µæ‰§è¡Œ BPE åˆå¹¶ï¼ˆæ ¹æ® rank/merge_to_new_id åå¤åˆå¹¶æœ€ä½³ pairï¼‰</span></span><br><span class="line">            token_ids.extend(merge_one_pretoken(ids))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> token_ids</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>ğŸ§© ç®—æ³•å›¾è§£ï¼šåŒå‘é“¾è¡¨ä¸æƒ°æ€§åˆ é™¤</strong><br>åœ¨ merge_one_pretoken ä¸­ï¼Œæˆ‘ä»¬ç”¨æ•°ç»„æ¨¡æ‹Ÿäº†ä¸€ä¸ªåŒå‘é“¾è¡¨ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸é«˜æ•ˆçš„å·¥ç¨‹å®ç°æŠ€å·§ï¼š</p>
<ul>
<li><strong>ä¸ºä»€ä¹ˆä¸ç”¨ Python çš„ list.pop()?</strong> pop() æ“ä½œä¼šå¯¼è‡´åç»­å…ƒç´ å‰ç§»ï¼Œæ—¶é—´å¤æ‚åº¦æ˜¯ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span>ã€‚åœ¨é¢‘ç¹åˆå¹¶çš„åœºæ™¯ä¸‹å¤ªæ…¢ã€‚</li>
<li><strong>æƒ°æ€§åˆ é™¤ (Lazy Deletion)</strong>: æˆ‘ä»¬ä½¿ç”¨ alive æ•°ç»„æ ‡è®°èŠ‚ç‚¹æ˜¯å¦æœ‰æ•ˆã€‚å½“åˆå¹¶ (i, j) æ—¶ï¼Œæˆ‘ä»¬ä¸çœŸçš„åˆ é™¤å†…å­˜ï¼Œåªæ˜¯æŠŠ alive[j] = Falseï¼Œå¹¶ä¿®æ”¹ i çš„ nxt æŒ‡é’ˆè·¨è¿‡ jã€‚è¿™ä¿è¯äº†æ¯æ¬¡åˆå¹¶æ“ä½œçš„æ—¶é—´å¤æ‚åº¦ä¸¥æ ¼ä¸º <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span>ã€‚</li>
</ul>
</blockquote>
<p>encode ä¸»è¦å®Œæˆä¸¤ä»¶äº‹ï¼š</p>
<ol>
<li><strong>Pre-tokenization</strong>: å…ˆç²—ç²’åº¦åˆ‡åˆ†æ–‡æœ¬</li>
<li><strong>å¯¹æ¯ä¸ª pre-token åš BPE merge</strong></li>
</ol>
<p>ç¬¬ä¸€æ­¥å’Œæˆ‘ä»¬ä¹‹å‰å®ç°çš„ä¸€æ ·ï¼Œå¯¹äºç¬¬äºŒæ­¥ï¼Œä¸»è¦çš„å®ç°æ–¹æ³•åœ¨ merge_one_pretokenã€‚åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡<strong>å †ï¼ˆHeapï¼‰</strong>å’Œ<strong>åŒå‘é“¾è¡¨</strong>æ¥é«˜æ•ˆå®ç°ç¼–ç ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬ç”¨æ•°ç»„æ¥æ¨¡æ‹ŸåŒå‘é“¾è¡¨ï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">prev = [-<span class="number">1</span>] * n</span><br><span class="line">nxt  = [-<span class="number">1</span>] * n</span><br><span class="line">alive = [<span class="literal">True</span>] * n</span><br></pre></td></tr></table></figure><br>åˆå¹¶æ—¶å¹¶ä¸çœŸçš„åˆ é™¤å…ƒç´ ï¼Œè€Œæ˜¯ï¼š</p>
<ul>
<li>æ ‡è®°è¢«åˆå¹¶çš„èŠ‚ç‚¹ï¼šalive[j] = False</li>
<li>è°ƒæ•´æŒ‡é’ˆï¼šnxt[i] = nxt[j]; prev[nxt[j]] = i<br>è¿™æ ·æ¯æ¬¡åˆå¹¶éƒ½æ˜¯ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span> çš„æ—¶é—´å¤æ‚åº¦ã€‚</li>
</ul>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç”¨ä¸€ä¸ª min heap ï¼Œæ¥è·å–æˆ‘ä»¬æœ€å…ˆè¦å®ç°mergeçš„pairï¼Œä¹Ÿå°±æ˜¯åœ¨è®­ç»ƒé˜¶æ®µï¼Œå‡ºç°é¢‘ç‡æœ€é«˜çš„pairã€‚</p>
<p>å †é‡Œå­˜ (rank, i)ï¼Œè¡¨ç¤ºå½“å‰ä½ç½® i ä¸å…¶å³é‚»å±… nxt[i] çš„ pair åœ¨ merge è§„åˆ™ä¸­çš„ä¼˜å…ˆçº§ï¼ˆrank è¶Šå°è¶Šå…ˆåˆå¹¶ï¼‰ã€‚æ¯æ¬¡å–å‡ºæœ€å° rank çš„å€™é€‰ï¼Œåšä¸€æ¬¡åˆå¹¶ï¼Œç„¶ååªéœ€è¦é‡æ–°æ£€æŸ¥å±€éƒ¨çš„ä¸¤ä¸ª pairï¼š</p>
<ul>
<li>(prev[i], i)</li>
<li>(i, nxt[i])</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">heap: <span class="built_in">list</span>[<span class="built_in">tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>]] = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">push_if_valid</span>(<span class="params">i: <span class="built_in">int</span></span>):</span><br><span class="line">    cur_r = <span class="literal">None</span></span><br><span class="line">    j = nxt[i]</span><br><span class="line">    <span class="keyword">if</span> j == -<span class="number">1</span> <span class="keyword">or</span> <span class="keyword">not</span> alive[i] <span class="keyword">or</span> <span class="keyword">not</span> alive[j]:</span><br><span class="line">        cur_r = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        cur_r = <span class="variable language_">self</span>.rank.get((ids[i], ids[j]))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> cur_r <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        heapq.heappush(heap, (cur_r, i))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">    push_if_valid(i)</span><br></pre></td></tr></table></figure>
<p>ä¸ä¹‹å‰çš„heapä¸€æ ·ï¼Œheapé‡Œé¢çš„å†…å®¹ä¼šâ€œè¿‡æœŸâ€ï¼šå› ä¸ºåˆå¹¶ä¼šæ”¹å˜é‚»æ¥å…³ç³»ï¼Œå †ä¸­æ—§æ¡ç›®ä¼šè¿‡æœŸï¼Œæ‰€ä»¥æ¯æ¬¡ pop å‡ºæ¥éƒ½è¦éªŒè¯ã€‚</p>
<p>æ¥ä¸‹æ¥å°±æ˜¯éå†è¿™ä¸ªheapï¼Œå¦‚æœè¿™ä¸ªheapä¸æ˜¯ç©ºçš„ï¼Œæˆ‘ä»¬å°±å¼¹å‡ºï¼Œå¹¶ä¸”éªŒè¯ï¼š</p>
<p>è¿™æ®µ while heap: æ˜¯æ•´ä¸ª merge_one_pretoken çš„æ ¸å¿ƒï¼šå †é‡Œç»´æŠ¤â€œå½“å‰å¯åˆå¹¶çš„ç›¸é‚»pairâ€ï¼Œæ¯æ¬¡å–å‡º rank æœ€å°ï¼ˆæœ€ä¼˜å…ˆï¼‰çš„å€™é€‰è¿›è¡Œåˆå¹¶ï¼Œå¹¶åªæ›´æ–°åˆå¹¶ç‚¹é™„è¿‘çš„å€™é€‰ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> heap:  <span class="comment"># åªè¦è¿˜æœ‰å€™é€‰ pairï¼Œå°±ç»§ç»­å°è¯•åˆå¹¶</span></span><br><span class="line">    r, i = heapq.heappop(heap)  <span class="comment"># å–å‡ºå½“å‰ rank æœ€å°çš„å€™é€‰ï¼š(rank, å·¦ç«¯ç‚¹ä½ç½® i)</span></span><br><span class="line">    j = nxt[i]  <span class="comment"># å³ç«¯ç‚¹ä½ç½® j æ˜¯ i åœ¨é“¾è¡¨ä¸­çš„åç»§</span></span><br><span class="line">    <span class="keyword">if</span> j == -<span class="number">1</span> <span class="keyword">or</span> <span class="keyword">not</span> alive[i] <span class="keyword">or</span> <span class="keyword">not</span> alive[j]:  <span class="comment"># i/j æ— æ•ˆæˆ– i å·²åˆ°å°¾éƒ¨ï¼šè¿™æ˜¯è¿‡æœŸå€™é€‰</span></span><br><span class="line">        <span class="keyword">continue</span>  <span class="comment"># è·³è¿‡ï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªå †å…ƒç´ </span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># stale checkï¼šå †é‡Œçš„è®°å½•å¯èƒ½å·²è¿‡æœŸï¼ˆé‚»å±…å…³ç³»/ids å·²æ”¹å˜ï¼‰ï¼Œéœ€è¦é‡æ–°éªŒè¯</span></span><br><span class="line">    pair = (ids[i], ids[j])  <span class="comment"># å½“å‰æ—¶åˆ» i å’Œ j å¯¹åº”çš„ token id ç»„æˆçš„ç›¸é‚» pair</span></span><br><span class="line">    cur_r = <span class="variable language_">self</span>.rank.get(pair)  <span class="comment"># æŸ¥è¯¢è¿™ä¸ª pair åœ¨ merge è§„åˆ™ä¸­çš„ rankï¼ˆä¸å¯åˆå¹¶åˆ™ä¸º Noneï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> cur_r <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> cur_r != r:  <span class="comment"># ç°åœ¨ä¸å¯åˆå¹¶ï¼Œæˆ– rank å·²ä¸åŒ¹é…ï¼šè¯´æ˜å †å…ƒç´ è¿‡æœŸ</span></span><br><span class="line">        <span class="keyword">continue</span>  <span class="comment"># è·³è¿‡è¯¥å€™é€‰</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ‰§è¡Œåˆå¹¶ï¼šæŠŠ (ids[i], ids[j]) åˆæˆä¸€ä¸ªæ–° tokenï¼Œå¹¶å†™å›åˆ°ä½ç½® i</span></span><br><span class="line">    new_id = <span class="variable language_">self</span>.merge_to_new_id.get(pair)  <span class="comment"># æŸ¥æ‰¾è¯¥ pair åˆå¹¶åçš„ token id</span></span><br><span class="line">    <span class="keyword">if</span> new_id <span class="keyword">is</span> <span class="literal">None</span>:  <span class="comment"># ç†è®ºä¸Šä¸è¯¥å‘ç”Ÿï¼ˆrank æœ‰ä½†æ˜ å°„æ²¡å»ºå¥½ï¼‰ï¼Œå½“ä½œè¿‡æœŸ/å¼‚å¸¸å¤„ç†</span></span><br><span class="line">        <span class="keyword">continue</span>  <span class="comment"># è·³è¿‡</span></span><br><span class="line">    ids[i] = new_id  <span class="comment"># ç”¨æ–° token id è¦†ç›–å·¦ç«¯ç‚¹ iï¼ˆi æˆä¸ºåˆå¹¶åçš„èŠ‚ç‚¹ï¼‰</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä»é“¾è¡¨ä¸­åˆ é™¤ jï¼šj è¢« i åæ‰äº†</span></span><br><span class="line">    alive[j] = <span class="literal">False</span>  <span class="comment"># æ ‡è®° j èŠ‚ç‚¹è¢«åˆ é™¤</span></span><br><span class="line">    nj = nxt[j]  <span class="comment"># è®°ä½ j çš„åç»§èŠ‚ç‚¹</span></span><br><span class="line">    nxt[i] = nj  <span class="comment"># è®© i ç›´æ¥æŒ‡å‘ njï¼ˆè·³è¿‡ jï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> nj != -<span class="number">1</span>:  <span class="comment"># å¦‚æœ nj å­˜åœ¨</span></span><br><span class="line">        prev[nj] = i  <span class="comment"># æ›´æ–° nj çš„å‰é©±ä¸º iï¼Œä¿æŒé“¾è¡¨ä¸€è‡´</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># å±€éƒ¨æ›´æ–°ï¼šåˆå¹¶åªä¼šå½±å“ i é™„è¿‘çš„ä¸¤ä¸ªç›¸é‚» pair</span></span><br><span class="line">    pi = prev[i]  <span class="comment"># i çš„å‰é©±ä½ç½®</span></span><br><span class="line">    <span class="keyword">if</span> pi != -<span class="number">1</span>:  <span class="comment"># å¦‚æœå‰é©±å­˜åœ¨</span></span><br><span class="line">        push_if_valid(pi)  <span class="comment"># (pi, i) è¿™ä¸ª pair å¯èƒ½å˜å¾—å¯åˆå¹¶æˆ– rank æ”¹å˜</span></span><br><span class="line">    push_if_valid(i)  <span class="comment"># (i, nxt[i]) è¿™ä¸ª pair ä¹Ÿå¯èƒ½å˜å¾—å¯åˆå¹¶æˆ– rank æ”¹å˜</span></span><br></pre></td></tr></table></figure>
<p>æœ€åæˆ‘ä»¬åªéœ€è¦æŠŠé“¾è¡¨ç»“æ„è¿˜åŸæˆæœ€ç»ˆçš„tokenåºåˆ—å³å¯ï¼š</p>
<p>åœ¨ BPE åˆå¹¶é˜¶æ®µï¼Œæˆ‘ä»¬ç”¨ prev / nxt / alive ç»´æŠ¤äº†ä¸€ä¸ªâ€œæ•°ç»„æ¨¡æ‹Ÿçš„åŒå‘é“¾è¡¨â€ã€‚åˆå¹¶æ—¶å¹¶ä¸ä¼šçœŸçš„åˆ é™¤ ids é‡Œçš„å…ƒç´ ï¼Œè€Œæ˜¯æŠŠè¢«åæ‰çš„ä½ç½®æ ‡è®°ä¸º alive=Falseï¼Œå¹¶é€šè¿‡ nxt è·³è¿‡å®ƒä»¬ã€‚</p>
<p>å› æ­¤åœ¨æ‰€æœ‰åˆå¹¶å®Œæˆåï¼Œéœ€è¦æŠŠâ€œè¿˜æ´»ç€çš„èŠ‚ç‚¹â€æŒ‰é¡ºåºé‡æ–°æ”¶é›†æˆä¸€ä¸ªç´§å‡‘çš„è¾“å‡ºåºåˆ—ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">out: <span class="built_in">list</span>[<span class="built_in">int</span>] = []          <span class="comment"># æœ€ç»ˆåˆå¹¶åçš„ token id åºåˆ—</span></span><br><span class="line">k = <span class="number">0</span>                        <span class="comment"># ä»é“¾è¡¨å¤´ï¼ˆä½ç½® 0ï¼‰å¼€å§‹éå†</span></span><br><span class="line"><span class="keyword">while</span> k != -<span class="number">1</span>:               <span class="comment"># -1 è¡¨ç¤ºåˆ°è¾¾é“¾è¡¨æœ«å°¾</span></span><br><span class="line">    <span class="keyword">if</span> alive[k]:             <span class="comment"># å¦‚æœè¯¥ä½ç½®è¿˜æ²¡æœ‰è¢«åˆå¹¶åˆ é™¤</span></span><br><span class="line">        out.append(ids[k])   <span class="comment"># æŠŠå½“å‰ä½ç½®çš„ token id åŠ å…¥è¾“å‡º</span></span><br><span class="line">    k = nxt[k]               <span class="comment"># è·³åˆ°ä¸‹ä¸€ä¸ªâ€œä»åœ¨é“¾è¡¨ä¸­çš„â€ä½ç½®</span></span><br></pre></td></tr></table></figure>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†BPEé˜¶æ®µçš„æ‰€æœ‰çš„å†…å®¹ï¼Œæ¥ä¸‹æ¥å°±æ˜¯è¦è®­ç»ƒï¼Œå¹¶å­˜å‚¨æˆ‘ä»¬é¢„å…ˆTokenå¥½çš„å†…å®¹</p>
<hr>
<p>æ‰§è¡Œæµ‹è¯•å‘½ä»¤ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uv run pytest tests/test_tokenizer.py</span><br></pre></td></tr></table></figure></p>
<p>æµ‹è¯•ç»“æœï¼ˆå…¨éƒ¨é€šè¿‡ï¼‰ï¼š</p>
<p><img src="./test_tokenizer.png" alt="test_tokenizer æµ‹è¯•ç»“æœ"></p>
<hr>
<h2 id="2-9-åˆ†è¯ä¸æ•°æ®ä¿å­˜"><a href="#2-9-åˆ†è¯ä¸æ•°æ®ä¿å­˜" class="headerlink" title="2.9 åˆ†è¯ä¸æ•°æ®ä¿å­˜"></a>2.9 åˆ†è¯ä¸æ•°æ®ä¿å­˜</h2><p>æœ‰äº† tokenizer.encode() ä¹‹åï¼Œæˆ‘ä»¬é€šå¸¸ä¼šå¸Œæœ›æŠŠä¸€æ•´ä¸ªæ–‡æœ¬æ–‡ä»¶ç¼–ç æˆç´§å‡‘çš„äºŒè¿›åˆ¶ï¼ˆ.binï¼‰ï¼Œæ–¹ä¾¿åç»­è®­ç»ƒæ—¶ç”¨ np.memmap ä¹‹ç±»çš„æ–¹å¼é«˜æ•ˆåŠ è½½ï¼Œè€Œä¸æ˜¯æ¯æ¬¡éƒ½é‡æ–°åˆ†è¯ã€‚</p>
<p>ä¸‹é¢è¿™æ®µå‡½æ•°åšçš„äº‹æƒ…å¾ˆç®€å•ï¼šæŒ‰è¡Œè¯»å–æ–‡æœ¬ â†’ æŠŠæ¯è¡Œç¼–ç æˆ token ids â†’ ç”¨å›ºå®š dtype å†™å…¥äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">encode_file_to_bin</span>(<span class="params">tokenizer, text_path, out_bin_path, dtype=np.uint16</span>):</span><br><span class="line">    total_bytes = os.path.getsize(text_path)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(text_path, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f_in, <span class="built_in">open</span>(out_bin_path, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f_out:</span><br><span class="line">        p_bar = tqdm(total=total_bytes, desc=<span class="string">&quot;Encoding to binary&quot;</span>, unit=<span class="string">&quot;B&quot;</span>, unit_scale=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> f_in:</span><br><span class="line">            token_ids = tokenizer.encode(line)          <span class="comment"># 1) æŠŠä¸€è¡Œæ–‡æœ¬ç¼–ç æˆ token ids</span></span><br><span class="line">            arr = np.array(token_ids, dtype=dtype)      <span class="comment"># 2) è½¬æˆ numpy æ•°ç»„ï¼ˆæ›´é€‚åˆå†™äºŒè¿›åˆ¶ï¼‰</span></span><br><span class="line">            arr.tofile(f_out)                           <span class="comment"># 3) ç›´æ¥ä»¥äºŒè¿›åˆ¶å†™å…¥ .bin æ–‡ä»¶</span></span><br><span class="line"></span><br><span class="line">            p_bar.update(<span class="built_in">len</span>(line.encode(<span class="string">&quot;utf-8&quot;</span>)))     </span><br></pre></td></tr></table></figure>
<p>æ ¹æ®æˆ‘ä»¬çš„å®ç°ï¼Œåªéœ€è¦ä¸åˆ°30åˆ†é’Ÿå°±å¯ä»¥è®­ç»ƒå®ŒBPEã€‚<br>åœ¨è¿™é‡Œ .bin é‡Œä¸ä¿å­˜è¡Œè¾¹ç•Œ/æ ·æœ¬è¾¹ç•Œï¼Œè®­ç»ƒæ—¶æŠŠå®ƒå½“ä½œä¸€ä¸ªé•¿åºåˆ—åš next-token predictionï¼ˆGPTé£æ ¼ï¼‰ï¼Œç”¨ block samplingã€‚</p>
<blockquote>
<p><strong>Question 1</strong>: ä¸ºä»€ä¹ˆç”¨ uint16 å°±å¯ä»¥äº†ï¼Ÿ<br>ç­”ï¼šå› ä¸ºåœ¨BPEçš„è®­ç»ƒé˜¶æ®µï¼Œæˆ‘ä»¬å°†vocab sizeè®¾ç½®ä¸º 10,000 æˆ–è€… 32,000ï¼Œè¿œè¿œå°äº uint16 çš„æœ€å¤§å€¼ 65,535ï¼Œå› æ­¤ç”¨ uint16 æ˜¯å®‰å…¨çš„ã€‚</p>
</blockquote>
<p>æˆ‘ä»¬é€šè¿‡è¿è¡Œä»¥ä¸‹ä»£ç æ¥å®ŒæˆTinyStoryçš„Tokenizationä¸ä¿å­˜ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uv run python ./train_bpe.py</span><br></pre></td></tr></table></figure></p>
<p>åœ¨è®­ç»ƒå®Œä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°çš„ç›®å½•ç»“æ„ï¼š<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">datasets/</span><br><span class="line">â””â”€â”€ tiny_stories/</span><br><span class="line">    â”œâ”€â”€ eval.bin</span><br><span class="line">    â”œâ”€â”€ merges.txt</span><br><span class="line">    â”œâ”€â”€ special_tokens.txt</span><br><span class="line">    â”œâ”€â”€ train.bin</span><br><span class="line">    â””â”€â”€ vocab.json</span><br></pre></td></tr></table></figure></p>
<hr>
<h2 id="2-10-Part-01-æ€»ç»“"><a href="#2-10-Part-01-æ€»ç»“" class="headerlink" title="2.10 Part 01 æ€»ç»“"></a>2.10 Part 01 æ€»ç»“</h2><p>æ€»çš„æ¥è¯´ï¼ŒPart 01 ç›¸æ¯”å¤§å®¶æ›´æœŸå¾…çš„ã€ŒLLM è®­ç»ƒä¸æ¨¡å‹ç»“æ„ã€éƒ¨åˆ†ï¼Œæ›´åå‘å·¥ç¨‹å®ç°ä¸æ€§èƒ½ä¼˜åŒ–ï¼šé€šè¿‡åˆé€‚çš„æ•°æ®ç»“æ„ä¸ç®—æ³•è®¾è®¡ï¼ˆä¾‹å¦‚ heapã€ç´¢å¼•è¡¨ã€åŒå‘é“¾è¡¨ã€å¹¶è¡Œç»Ÿè®¡ç­‰ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸æ”¹å˜ç®—æ³•è¯­ä¹‰çš„å‰æä¸‹ï¼ŒæŠŠ BPE çš„è®­ç»ƒä¸æ¨ç†é€Ÿåº¦æå‡ä¸€ä¸ªæ•°é‡çº§ã€‚</p>
<p>å¾ˆå¤šè¯»è€…ï¼ˆåŒ…æ‹¬æˆ‘è‡ªå·±ï¼‰ä¼šè§‰å¾—è¿™ä¸€éƒ¨åˆ†â€œåˆé•¿åˆç»•â€ï¼Œä¸»è¦åŸå› å¾€å¾€ä¸æ˜¯å†…å®¹æœ¬èº«æœ‰å¤šéš¾ï¼Œè€Œæ˜¯å¯¹è¿™äº›å·¥ç¨‹ç»†èŠ‚è¿˜ä¸å¤Ÿç†Ÿæ‚‰ï¼šä¸€æ—¦æŠŠæ•°æ®ç»“æ„çš„ä½œç”¨ã€æ›´æ–°èŒƒå›´ã€ä»¥åŠ stale check çš„é€»è¾‘ä¸²èµ·æ¥ï¼Œæ•´ä½“ä¼šæ¸…æ™°å¾ˆå¤šã€‚æ‰€ä»¥å¦‚æœä½ ç¬¬ä¸€æ¬¡è¯»å®Œä»ç„¶è§‰å¾—æœ‰ç‚¹ä¹±ï¼Œè¿™æ˜¯éå¸¸æ­£å¸¸çš„â€”â€”è¯·ä¸è¦æ°”é¦ã€‚</p>
<p>æ›´é‡è¦çš„æ˜¯ï¼ŒTokenization æ˜¯è®­ç»ƒ LLM çš„ç¬¬ä¸€æ­¥ã€‚çœŸæ­£ç†è§£è¿™éƒ¨åˆ†ï¼Œä¼šç›´æ¥å¸®åŠ©ä½ åœ¨åç»­æ›´é¡ºç•…åœ°æŒæ¡ï¼š</p>
<ul>
<li>å¦‚ä½•é«˜æ•ˆåœ° encode / decode</li>
<li>å¦‚ä½•è¿›è¡Œæ•°æ®åŠ è½½ä¸é‡‡æ ·ï¼ˆä¾‹å¦‚ .bin + memmapï¼‰</li>
<li>ä»¥åŠåœ¨æ›´è¿›é˜¶çš„è¯é¢˜é‡Œï¼Œå¦‚ä½•å›´ç»• tokenizer ä¸åºåˆ—è¡¨ç¤ºå»æ‰©å±•æ¨¡å‹çš„ context length</li>
</ul>
<p>ä¸‹ä¸€éƒ¨åˆ†æˆ‘ä»¬å°†æŠŠ tokenizer ç”Ÿæˆçš„äºŒè¿›åˆ¶æ•°æ®æ¥å…¥è®­ç»ƒ pipelineï¼Œè¿›å…¥çœŸæ­£çš„ model training ç¯èŠ‚ã€‚</p>
<hr>
<h1 id="3-Part-02-è¯­è¨€æ¨¡å‹å®ç°"><a href="#3-Part-02-è¯­è¨€æ¨¡å‹å®ç°" class="headerlink" title="3 Part 02: è¯­è¨€æ¨¡å‹å®ç°"></a>3 Part 02: è¯­è¨€æ¨¡å‹å®ç°</h1><p>åœ¨æœ¬éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°†å®ç°ä¸€ä¸ªç®€å•çš„è¯­è¨€æ¨¡å‹ï¼Œä½¿ç”¨æˆ‘ä»¬åœ¨ç¬¬ä¸€éƒ¨åˆ†ä¸­å®ç°çš„BPEè¿›è¡Œtokenizationã€‚æˆ‘ä»¬å°†ä½¿ç”¨PyTorchæ¥å®šä¹‰å’Œè®­ç»ƒæ¨¡å‹ã€‚</p>
<p>ä¸‹å›¾æ˜¯Transformer Language Modelçš„æ•´ä½“æ¶æ„æ¦‚è§ˆï¼š</p>
<p><img src="./ass01-transformer-lm-overview.png" alt="Transformer Language Model æ•´ä½“æ¶æ„æ¦‚è§ˆ"><br>æ¥ä¸‹æ¥æˆ‘ä»¬å°†ä¸€æ­¥æ­¥å®ç°è¿™ä¸ªæ¨¡å‹çš„å„ä¸ªæ¨¡å—ã€‚é¦–å…ˆï¼Œå®ç°çš„æ˜¯Linear Module.</p>
<hr>
<h2 id="3-1-çº¿æ€§å±‚ï¼ˆLinear-Moduleï¼‰"><a href="#3-1-çº¿æ€§å±‚ï¼ˆLinear-Moduleï¼‰" class="headerlink" title="3.1 çº¿æ€§å±‚ï¼ˆLinear Moduleï¼‰"></a>3.1 çº¿æ€§å±‚ï¼ˆLinear Moduleï¼‰</h2><p>Linear Module æ˜¯åŸºæœ¬æ‰€æœ‰ç¥ç»ç½‘ç»œçš„èµ·å§‹ç‚¹ï¼Œå®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><mi>y</mi><mo>=</mo><mi>W</mi><mi>x</mi></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(1)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">y = Wx \tag{1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mord mathnormal">x</span></span><span class="tag"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">1</span></span><span class="mord">)</span></span></span></span></span></span><br>å…¶ä¸­ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi><mo>âˆˆ</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub><mo>Ã—</mo><msub><mi>d</mi><mrow><mi>i</mi><mi>n</mi></mrow></msub></mrow></msup><mo separator="true">,</mo><mtext>Â </mtext><mi>x</mi><mo>âˆˆ</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mrow><mi>i</mi><mi>n</mi></mrow></msub><mo>Ã—</mo><mn>1</mn></mrow></msup><mo separator="true">,</mo><mtext>Â </mtext><mi>y</mi><mo>âˆˆ</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub><mo>Ã—</mo><mn>1</mn></mrow></msup></mrow><annotation encoding="application/x-tex">W \in \mathbb{R}^{d_{out} \times d_{in}},\ x \in \mathbb{R}^{d_{in} \times 1},\ y \in \mathbb{R}^{d_{out} \times 1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0435em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2963em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mbin mtight">Ã—</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">in</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace">Â </span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0435em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">in</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mbin mtight">Ã—</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace">Â </span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2963em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mbin mtight">Ã—</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span></p>
<blockquote>
<p><strong>Note</strong><br>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å®ç°çš„Linear Module ä¸ä»»åŠ¡ä¸­è¦æ±‚çš„ç•¥æœ‰ä¸åŒï¼Œä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹ä¸¤ç‚¹ï¼š</p>
<ol>
<li>æˆ‘ä»¬å°†weightçš„shapeè®¾ä¸º (in_features, out_features)ï¼Œè¿™æ ·åœ¨ forward çš„æ—¶å€™ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ @ è¿ç®—ç¬¦è¿›è¡ŒçŸ©é˜µä¹˜æ³•ï¼Œä»£ç æ›´ç®€æ´ã€‚</li>
<li>æˆ‘ä»¬å°†biasè®¾ä¸ºå¯é€‰é¡¹ï¼Œé»˜è®¤ä¸ä½¿ç”¨biasï¼Œè¿™æ ·å¯ä»¥æ›´å¥½åœ°æ¨¡æ‹ŸTransformerä¸­çš„Linear Layerã€‚</li>
</ol>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Linear</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params"></span></span><br><span class="line"><span class="params">        self,</span></span><br><span class="line"><span class="params">        in_features,</span></span><br><span class="line"><span class="params">        out_features,</span></span><br><span class="line"><span class="params">        device: torch.device | <span class="literal">None</span> = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">        dtype: torch.dtype | <span class="literal">None</span> = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">        bias: <span class="built_in">bool</span> = <span class="literal">False</span>,</span></span><br><span class="line"><span class="params">    </span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.in_features = in_features</span><br><span class="line">        <span class="variable language_">self</span>.out_features = out_features</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.weight = nn.Parameter(torch.empty((in_features, out_features), device=device, dtype=dtype))</span><br><span class="line">        <span class="variable language_">self</span>.bias = nn.Parameter(torch.empty(out_features, device=device, dtype=dtype)) <span class="keyword">if</span> bias <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>._init_weight()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        o = x @ <span class="variable language_">self</span>.weight</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.bias <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            o = o + <span class="variable language_">self</span>.bias</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> o</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_init_weight</span>(<span class="params">self</span>):</span><br><span class="line">        mean = <span class="number">0.0</span></span><br><span class="line">        std = <span class="number">1.0</span> / (<span class="number">2</span> * (<span class="variable language_">self</span>.in_features + <span class="variable language_">self</span>.out_features) ** <span class="number">0.5</span>)</span><br><span class="line">        torch.nn.init.trunc_normal_(<span class="variable language_">self</span>.weight, mean=mean, std=std, a=-<span class="number">3</span> * std, b=<span class="number">3</span> * std)</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>âš™ï¸ PyTorch æ·±åº¦è§£æï¼šnn.Parameter</strong></p>
<ol>
<li><p><strong>ä¸ºä»€ä¹ˆæ˜¯ nn.Parameter è€Œä¸æ˜¯ torch.Tensor?</strong><br>å½“ä½ æŠŠä¸€ä¸ªå¼ é‡åŒ…è£…æˆ nn.Parameter å¹¶èµ‹å€¼ç»™ Module çš„å±æ€§ï¼ˆå¦‚ self.weightï¼‰æ—¶ï¼ŒPyTorch ä¼šè‡ªåŠ¨æŠŠå®ƒåŠ å…¥åˆ°æ¨¡å‹çš„<strong>å‚æ•°åˆ—è¡¨</strong>ä¸­ã€‚è¿™æ„å‘³ç€ï¼š</p>
<ul>
<li>è°ƒç”¨ model.parameters() æ—¶ä¼šåŒ…å«å®ƒã€‚</li>
<li>ä¼˜åŒ–å™¨ï¼ˆOptimizerï¼‰æ›´æ–°æ—¶ä¼šæ›´æ–°å®ƒã€‚</li>
<li>ä¿å­˜æ¨¡å‹ï¼ˆstate_dictï¼‰æ—¶ä¼šä¿å­˜å®ƒã€‚<br>å¦‚æœåªç”¨æ™®é€šçš„ torch.Tensorï¼Œè¿™ä¸ªæƒé‡å°†æ— æ³•è¢«è®­ç»ƒã€‚</li>
</ul>
</li>
<li><p><strong>Truncated Normal (æˆªæ–­æ­£æ€åˆ†å¸ƒ) åˆå§‹åŒ–</strong>:<br>ä»£ç ä¸­ä½¿ç”¨äº† torch.nn.init.trunc_normal_ã€‚ç›¸æ¯”äºæ ‡å‡†æ­£æ€åˆ†å¸ƒï¼Œæˆªæ–­åˆ†å¸ƒå»æ‰äº†å°¾éƒ¨æç«¯å€¼ï¼ˆå¤§äº <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn><mi>Ïƒ</mi></mrow><annotation encoding="application/x-tex">3\sigma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3</span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span></span></span></span> çš„å€¼ï¼‰ã€‚è¿™èƒ½é˜²æ­¢åˆå§‹åŒ–æ—¶å‡ºç°è¿‡å¤§æˆ–è¿‡å°çš„æƒé‡ï¼Œé¿å…å¯¼è‡´æ¢¯åº¦çˆ†ç‚¸æˆ–åç»­æ¿€æ´»å‡½æ•°é¥±å’Œï¼ˆå¦‚ Sigmoid/Tanhï¼‰ï¼Œæ˜¯è®­ç»ƒæ·±å±‚ç½‘ç»œçš„å¸¸ç”¨æŠ€å·§ã€‚</p>
</li>
</ol>
</blockquote>
<p>å…¶ä¸­ _init_weight() æ˜¯åˆå§‹åŒ–çš„æ–¹æ³•ï¼Œåœ¨Assignment 1 ä¸­ä¸ºï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="script">N</mi><mrow><mo fence="true">(</mo><mi>Î¼</mi><mo>=</mo><mn>0</mn><mo separator="true">,</mo><msup><mi>Ïƒ</mi><mn>2</mn></msup><mo>=</mo><mfrac><mn>2</mn><mrow><msub><mi>d</mi><mrow><mi>i</mi><mi>n</mi></mrow></msub><mo>+</mo><msub><mi>d</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub></mrow></mfrac><mo fence="true">)</mo></mrow><mspace width="1em"/><mtext>truncatedÂ at</mtext><mo stretchy="false">[</mo><mo>âˆ’</mo><mn>3</mn><mi>Ïƒ</mi><mo separator="true">,</mo><mn>3</mn><mi>Ïƒ</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">\mathcal{N} \left( \mu = 0, \sigma^2 = \frac{2}{d_{in} + d_{out}} \right) \quad \text{truncated at} [-3\sigma, 3\sigma]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="mord mathcal" style="margin-right:0.14736em;">N</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord mathnormal">Î¼</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">in</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord">truncatedÂ at</span></span><span class="mopen">[</span><span class="mord">âˆ’</span><span class="mord">3</span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">3</span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="mclose">]</span></span></span></span></span></p>
<p>è¿™ç§åˆå§‹åŒ–çš„æ–¹å¼æ˜¯æœ€å¸¸è§çš„ï¼Œä¹Ÿæ˜¯æ¯”è¾ƒrobustçš„ï¼Œå½“ç„¶ï¼Œå¤§å®¶è¿˜å¯ä»¥å°è¯•ä¸åŒçš„åˆå§‹åŒ–çš„æ–¹å¼ï¼Œä¾‹å¦‚Xavier-initialization, Kaiming-initializationç­‰ã€‚</p>
<hr>
<h2 id="3-2-åµŒå…¥æ¨¡å‹ï¼ˆEmbedding-Modelï¼‰"><a href="#3-2-åµŒå…¥æ¨¡å‹ï¼ˆEmbedding-Modelï¼‰" class="headerlink" title="3.2 åµŒå…¥æ¨¡å‹ï¼ˆEmbedding Modelï¼‰"></a>3.2 åµŒå…¥æ¨¡å‹ï¼ˆEmbedding Modelï¼‰</h2><p>è®°å¾—æˆ‘ä»¬åœ¨å‰é¢ç¬¬ä¸€ç« å°±å®ç°äº†BPEçš„Tokenizationï¼Œå›é¡¾ä¸€ä¸‹ï¼š<br>Tokenizationçš„æ ¸å¿ƒå°±æ˜¯ï¼ŒæŠŠæ–‡å­—ï¼Œè½¬åŒ–æˆä¸€ä¸ªä¸ªçš„IDsã€‚ä½†æ˜¯è¿™ä¸ªIDsæ˜¯ä¸èƒ½è¢«æ¨¡å‹å¤„ç†çš„ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶è½¬åŒ–æˆä¸€ä¸ªä¸ªçš„Dense Vectorï¼Œè¿™ä¸ªå°±æ˜¯æ‰€è°“çš„ Embedding Layerã€‚</p>
<p>é€šè¿‡ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰Embedding Layerï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Embedding</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params"></span></span><br><span class="line"><span class="params">        self,</span></span><br><span class="line"><span class="params">        num_embeddings: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">        embedding_dim: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">        device: torch.device | <span class="literal">None</span> = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">        dtype: torch.dtype | <span class="literal">None</span> = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    </span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.num_embeddings = num_embeddings</span><br><span class="line">        <span class="variable language_">self</span>.embedding_dim = embedding_dim</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.weight = nn.Parameter(torch.empty((num_embeddings, embedding_dim), device=device, dtype=dtype))</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>._init_weight()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x: torch.Tensor</span>) -&gt; torch.Tensor:</span><br><span class="line">        B, L = x.shape  <span class="comment"># x: (B, L)</span></span><br><span class="line">        out = x.reshape(-<span class="number">1</span>)  <span class="comment"># (B*L,)</span></span><br><span class="line">        out = <span class="variable language_">self</span>.weight.index_select(<span class="number">0</span>, out)  <span class="comment"># (B*L, D)</span></span><br><span class="line">        out = out.reshape(B, L, <span class="variable language_">self</span>.embedding_dim)  <span class="comment"># (B, L, D)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> out</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>ğŸ§ æ·±åº¦ç†è§£ï¼šEmbedding æœ¬è´¨ä¸Šæ˜¯ä»€ä¹ˆï¼Ÿ</strong></p>
<p>è™½ç„¶æˆ‘ä»¬åœ¨ä»£ç ä¸­å†™çš„æ˜¯ out = self.weight.index_select(0, out)ï¼Œä½†ä»æ•°å­¦è§’åº¦çœ‹ï¼ŒEmbedding å±‚ç­‰ä»·äº<strong>ä¸€ä¸ªæ²¡æœ‰ Bias çš„ Linear å±‚ï¼Œè¾“å…¥æ˜¯ One-Hot å‘é‡</strong>ã€‚</p>
<ul>
<li>æƒ³è±¡è¾“å…¥ token ID æ˜¯ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span>ã€‚</li>
<li>å°†å…¶è½¬ä¸º One-Hot å‘é‡ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">e_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>ï¼ˆé•¿åº¦ä¸º Vocab Sizeï¼Œåªæœ‰ç¬¬ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> ä½æ˜¯ 1ï¼Œå…¶ä½™æ˜¯ 0ï¼‰ã€‚</li>
<li>è®¡ç®— <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mi>i</mi></msub><mo>Ã—</mo><mi>W</mi></mrow><annotation encoding="application/x-tex">e_i \times W</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span></span></span>ã€‚</li>
<li>ç»“æœæ­£æ˜¯æƒé‡çŸ©é˜µ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi></mrow><annotation encoding="application/x-tex">W</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span></span></span></span> çš„ç¬¬ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> è¡Œã€‚</li>
</ul>
<p><strong>å…³äº reshape</strong>:<br>ä»£ç ä¸­ x.reshape(-1) å°† (Batch_Size, Seq_Len) å±•å¹³æˆä¸€ç»´ï¼Œå˜æˆ (Batch_Size * Seq_Len)ï¼Œè¿™æ˜¯å› ä¸º index_select åªèƒ½å¤„ç†ä¸€ç»´çš„ç´¢å¼•åˆ—è¡¨ã€‚æŸ¥è¡¨å®Œæˆåï¼Œå† reshape(B, L, D) æ¢å¤å½¢çŠ¶ã€‚è¿™æ˜¯å¤„ç†åºåˆ—æ•°æ®çš„æ ‡å‡†æ“ä½œæµç¨‹ã€‚</p>
</blockquote>
<p>å¾ˆç®€å•çš„ä¹Ÿå¾ˆç›´è§‚ï¼Œå®ƒçš„æƒé‡åˆå§‹åŒ–çš„æ–¹å¼ä¸ºï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="script">N</mi><mrow><mo fence="true">(</mo><mi>Î¼</mi><mo>=</mo><mn>0</mn><mo separator="true">,</mo><msup><mi>Ïƒ</mi><mn>2</mn></msup><mo>=</mo><mn>1</mn><mo fence="true">)</mo></mrow><mspace width="1em"/><mtext>truncatedÂ at</mtext><mo stretchy="false">[</mo><mo>âˆ’</mo><mn>3</mn><mo separator="true">,</mo><mn>3</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">\mathcal{N} \left( \mu = 0, \sigma^2 = 1 \right) \quad \text{truncated at} [-3, 3]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2141em;vertical-align:-0.35em;"></span><span class="mord mathcal" style="margin-right:0.14736em;">N</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord mathnormal">Î¼</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">1</span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span><span class="mspace" style="margin-right:1em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord">truncatedÂ at</span></span><span class="mopen">[</span><span class="mord">âˆ’</span><span class="mord">3</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">3</span><span class="mclose">]</span></span></span></span></span></p>
<blockquote>
<p><strong>Note</strong><br>å…¶å®åœ¨forwardä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨ self.weight[x] è¿™ä¸€è¡Œä»£ç ï¼Œå°±å¯ä»¥å®ç° Embedding çš„åŠŸèƒ½ï¼Œä½†æ˜¯ä¸ºäº†æ›´æ¸…æ™°åœ°å±•ç¤º Embedding çš„å·¥ä½œåŸç†ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† index_select æ¥å®ç°ã€‚</p>
</blockquote>
<hr>
<h2 id="3-3-RMSå½’ä¸€åŒ–ï¼ˆRMS-Normï¼‰"><a href="#3-3-RMSå½’ä¸€åŒ–ï¼ˆRMS-Normï¼‰" class="headerlink" title="3.3 RMSå½’ä¸€åŒ–ï¼ˆRMS-Normï¼‰"></a>3.3 RMSå½’ä¸€åŒ–ï¼ˆRMS-Normï¼‰</h2><p>åœ¨ç°ä»£çš„Language Modelä¸­ï¼Œå¸¸è§çš„Normalizationçš„æ–¹æ³•æ˜¯ RMS-Norm(Zhang and Senrich 2019)ï¼Œå…¶æ•°å­¦å®šä¹‰å¦‚ä¸‹ï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>RMSNorm</mtext><mo stretchy="false">(</mo><msub><mi>a</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mfrac><msub><mi>a</mi><mi>i</mi></msub><mrow><mtext>RMS</mtext><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">)</mo></mrow></mfrac><msub><mi>g</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\text{RMSNorm}(a_i) = \frac{a_i}{\text{RMS}(a)} g_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">RMSNorm</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0436em;vertical-align:-0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord text"><span class="mord">RMS</span></span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>where</mtext><mspace width="1em"/><mtext>RMS</mtext><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">)</mo><mo>=</mo><msqrt><mrow><mfrac><mn>1</mn><msub><mi>d</mi><mtext>model</mtext></msub></mfrac><munderover><mo>âˆ‘</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><msub><mi>d</mi><mtext>model</mtext></msub></munderover><msubsup><mi>a</mi><mi>i</mi><mn>2</mn></msubsup><mo>+</mo><mi>Ïµ</mi></mrow></msqrt></mrow><annotation encoding="application/x-tex">\text{where}\quad \text{RMS}(a) = \sqrt{\frac{1}{d_{\text{model}}} \sum_{i=1}^{d_{\text{model}}} a_i^2 + \epsilon}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">where</span></span><span class="mspace" style="margin-right:1em;"></span><span class="mord text"><span class="mord">RMS</span></span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.3584em;vertical-align:-1.2777em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.0807em;"><span class="svg-align" style="top:-5.3184em;"><span class="pstrut" style="height:5.3184em;"></span><span class="mord" style="padding-left:1.056em;"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">model</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.853em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span><span style="top:-4.3169em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">model</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7959em;"><span style="top:-2.4231em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.0448em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2769em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">Ïµ</span></span></span><span style="top:-4.0407em;"><span class="pstrut" style="height:5.3184em;"></span><span class="hide-tail" style="min-width:0.742em;height:3.3984em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="3.3984em" viewBox="0 0 400000 3398" preserveAspectRatio="xMinYMin slice"><path d="M702 80H40000040
H742v3264l-4 4-4 4c-.667.7 -2 1.5-4 2.5s-4.167 1.833-6.5 2.5-5.5 1-9.5 1
h-12l-28-84c-16.667-52-96.667 -294.333-240-727l-212 -643 -85 170
c-4-3.333-8.333-7.667-13 -13l-13-13l77-155 77-156c66 199.333 139 419.667
219 661 l218 661zM702 80H400000v40H742z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span></span></span></span></span></p>
<p>å…¶ä¸­ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi></mrow><annotation encoding="application/x-tex">g</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span></span></span></span> æ˜¯å¯å­¦ä¹ çš„ç¼©æ”¾å‚æ•°ï¼Œå®ƒçš„ç»´åº¦ä¸è¾“å…¥ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">a</span></span></span></span> ç›¸åŒï¼Œ<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Ïµ</mi></mrow><annotation encoding="application/x-tex">\epsilon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">Ïµ</span></span></span></span> æ˜¯ä¸€ä¸ªå¾ˆå°çš„æ•°å€¼ï¼Œé˜²æ­¢é™¤ä»¥0ã€‚</p>
<blockquote>
<p><strong>ğŸ†š é¢è¯•å¿…è€ƒï¼šRMSNorm vs LayerNorm</strong></p>
<ul>
<li><strong>LayerNorm</strong>: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>LN</mtext><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mi>x</mi><mo>âˆ’</mo><mi>Î¼</mi></mrow><mi>Ïƒ</mi></mfrac><mo>â‹…</mo><mi>Î³</mi><mo>+</mo><mi>Î²</mi></mrow><annotation encoding="application/x-tex">\text{LN}(x) = \frac{x - \mu}{\sigma} \cdot \gamma + \beta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">LN</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1994em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8544em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">Ïƒ</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.4461em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="mbin mtight">âˆ’</span><span class="mord mathnormal mtight">Î¼</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">Î³</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05278em;">Î²</span></span></span></span>ã€‚å®ƒæ—¢å‡å»å‡å€¼ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Î¼</mi></mrow><annotation encoding="application/x-tex">\mu</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Î¼</span></span></span></span>ï¼ˆCenterï¼‰ï¼Œåˆé™¤ä»¥æ ‡å‡†å·® <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Ïƒ</mi></mrow><annotation encoding="application/x-tex">\sigma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span></span></span></span>ï¼ˆScaleï¼‰ã€‚</li>
<li><strong>RMSNorm</strong>: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>RMS</mtext><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mi>x</mi><mrow><mtext>RMS</mtext><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></mfrac><mo>â‹…</mo><mi>Î³</mi></mrow><annotation encoding="application/x-tex">\text{RMS}(x) = \frac{x}{\text{RMS}(x)} \cdot \gamma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">RMS</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2154em;vertical-align:-0.52em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6954em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">RMS</span></span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">x</span><span class="mclose mtight">)</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.52em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">Î³</span></span></span></span>ã€‚å®ƒ<strong>ä¸å‡å‡å€¼</strong>ï¼Œä»…æ ¹æ®å‡æ–¹æ ¹è¿›è¡Œç¼©æ”¾ã€‚</li>
</ul>
<p><strong>ä¸ºä»€ä¹ˆè¦ç”¨ RMSNorm?</strong></p>
<ol>
<li><strong>è®¡ç®—æ•ˆç‡</strong>: å°‘äº†è®¡ç®—å‡å€¼å’Œå‡å‡å€¼çš„æ­¥éª¤ï¼Œåœ¨å¤§æ¨¡å‹è®­ç»ƒä¸­èƒ½èŠ‚çœå¯è§‚çš„è®¡ç®—å¼€é”€ã€‚</li>
<li><strong>æ•ˆæœç›¸å½“</strong>: ç ”ç©¶è¡¨æ˜ï¼ŒLayerNorm çš„æˆåŠŸä¸»è¦å½’åŠŸäºç¼©æ”¾ï¼ˆRescalingï¼‰å¸¦æ¥çš„æ¢¯åº¦ç¨³å®šæ€§ï¼Œå¹³ç§»ï¼ˆRe-centeringï¼‰è´¡çŒ®ä¸å¤§ã€‚</li>
<li><strong>Llama/GPT-3 çš„é€‰æ‹©</strong>: å®ƒæ˜¯å½“å‰ä¸»æµ LLM çš„æ ‡é…ã€‚</li>
</ol>
</blockquote>
<p>å®ç°RMS-Normçš„æ–¹å¼ä¹Ÿå¾ˆç®€å•ï¼Œä¸è¿‡æœ‰ä¸€ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹å°±æ˜¯ï¼šå¦‚æœæˆ‘ä»¬ç”¨äº†Mixed Precision Trainingï¼Œå½“ç”¨ sqrt() æ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´Underflowã€‚ä¸ºäº†é¿å…è¿™ä¸€ç‚¹ï¼Œåœ¨è®­ç»ƒçš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå°† activation upcaståˆ° float32ï¼Œç»“æŸçš„æ—¶å€™å†è¿”å›åŸæ¥çš„æ•°æ®ç±»å‹ã€‚å…·ä½“çš„è¯·çœ‹ä»£ç ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cs336_basics/modules/norm.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RMSNorm</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params"></span></span><br><span class="line"><span class="params">        self,</span></span><br><span class="line"><span class="params">        d_model: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">        eps: <span class="built_in">float</span> = <span class="number">1e-5</span>,</span></span><br><span class="line"><span class="params">        device: torch.device | <span class="literal">None</span> = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">        dtype: torch.dtype | <span class="literal">None</span> = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    </span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.d_model = d_model</span><br><span class="line">        <span class="variable language_">self</span>.eps = eps</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.weight = nn.Parameter(torch.ones(d_model, device=device, dtype=dtype))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_rms</span>(<span class="params">self, x: torch.Tensor</span>) -&gt; torch.Tensor:</span><br><span class="line">        <span class="keyword">return</span> torch.sqrt(torch.mean(x**<span class="number">2</span>, dim=-<span class="number">1</span>, keepdim=<span class="literal">True</span>) + <span class="variable language_">self</span>.eps)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x: torch.Tensor</span>) -&gt; torch.Tensor:</span><br><span class="line">        input_dtype = x.dtype</span><br><span class="line">        x = x.to(torch.float32)</span><br><span class="line"></span><br><span class="line">        rms = <span class="variable language_">self</span>._rms(x)</span><br><span class="line">        x_normed = x / rms</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (x_normed * <span class="variable language_">self</span>.weight).to(input_dtype)</span><br></pre></td></tr></table></figure>
<p>å½“ç„¶ï¼ŒNormalizationçš„ä½ç½®ä¹Ÿæ˜¯å¾ˆæœ‰è®²ç©¶çš„ï¼Œåœ¨ç°ä»£çš„LMä¸­ï¼Œé€šå¸¸ç”¨Pre-Normï¼Œè¿™ä¸€éƒ¨åˆ†ï¼Œç­‰æˆ‘ä»¬ä»‹ç»å®Œäº†æ‰€æœ‰çš„æ¨¡å—ä¹‹åå†æ¥ä»‹ç»ã€‚</p>
<hr>
<h2 id="3-4-é€ç‚¹å‰é¦ˆç½‘ç»œï¼ˆPointWise-Feed-Forward-Networkï¼‰"><a href="#3-4-é€ç‚¹å‰é¦ˆç½‘ç»œï¼ˆPointWise-Feed-Forward-Networkï¼‰" class="headerlink" title="3.4 é€ç‚¹å‰é¦ˆç½‘ç»œï¼ˆPointWise Feed Forward Networkï¼‰"></a>3.4 é€ç‚¹å‰é¦ˆç½‘ç»œï¼ˆPointWise Feed Forward Networkï¼‰</h2><p>åœ¨åŸå§‹Transformer (Vaswani et al. 2023)é‡Œï¼ŒFFN æ˜¯ä¸€ä¸ªéå¸¸ç»å…¸çš„ä¸¤å±‚ç»“æ„ï¼šLinear â†’ ReLU â†’ Linearï¼Œå¹¶ä¸”ä¸­é—´éšå±‚ç»´åº¦é€šå¸¸å– d_ff = 4 * d_modelã€‚ä½†åˆ°äº†ç°ä»£å¤§è¯­è¨€æ¨¡å‹ï¼ˆä¾‹å¦‚ Llama 3, Qwen 2.5ï¼‰ï¼ŒFFN çš„è®¾è®¡å‡ºç°äº†ä¸¤ä¸ªå‡ ä¹â€œæ ‡é…â€çš„å˜åŒ–ï¼š</p>
<ol>
<li>æ¢æ¿€æ´»å‡½æ•°ï¼ˆgatingï¼‰</li>
<li>å¼•å…¥é—¨æ§ï¼ˆgatingï¼‰æœºåˆ¶ã€‚</li>
</ol>
<p>ä¸€ä¸ªå…¸å‹ä»£è¡¨å°±æ˜¯ SwiGLUï¼šå®ƒæŠŠ <strong>SiLU/Swish</strong> çš„å¹³æ»‘æ¿€æ´»å’Œ <strong>GLU</strong> çš„é—¨æ§ç›¸ä¹˜ç»“åˆèµ·æ¥ï¼Œå¹¶ä¸”å¾ˆå¤šå®ç°ä¼šåƒ PaLM, LLaMA ä¸€æ ·å»æ‰çº¿æ€§å±‚ï¼ˆbiasï¼‰æ›´ç®€æ´ï¼Œä¹Ÿæ›´è´´è¿‘ä¸»æµè®­ç»ƒé…æ–¹ã€‚</p>
<p>å…ˆçœ‹ SiLUï¼ˆä¹Ÿå« Swishï¼‰ï¼Œå®šä¹‰å¾ˆç®€å•ï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><mtext>SiLU</mtext><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mi>x</mi><mo>â‹…</mo><mi>Ïƒ</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mi>x</mi><mrow><mn>1</mn><mo>+</mo><msup><mi>e</mi><mrow><mo>âˆ’</mo><mi>x</mi></mrow></msup></mrow></mfrac></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(2)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">\text{SiLU}(x) = x \cdot \sigma(x) = \frac{x}{1 + e^{-x}} \tag{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">SiLU</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4445em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.8769em;vertical-align:-0.7693em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6973em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">âˆ’</span><span class="mord mathnormal mtight">x</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">x</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span><span class="tag"><span class="strut" style="height:1.8769em;vertical-align:-0.7693em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">2</span></span><span class="mord">)</span></span></span></span></span></span><br>å®ƒå’Œ ReLU ä¸€æ ·èƒ½æä¾›éçº¿æ€§ï¼Œä½†åœ¨ 0 é™„è¿‘æ˜¯å¹³æ»‘çš„ï¼Œæ¢¯åº¦è¡Œä¸ºæ›´è¿ç»­ã€‚å†çœ‹ GLUï¼Œå®ƒç”¨ä¸€ä¸ª sigmoid åˆ†æ”¯å……å½“â€œé—¨â€ï¼Œå»è°ƒèŠ‚å¦ä¸€çº¿æ€§åˆ†æ”¯ï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><mtext>GLU</mtext><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><msub><mi>W</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>W</mi><mn>2</mn></msub><mo stretchy="false">)</mo><mo>=</mo><mi>Ïƒ</mi><mo stretchy="false">(</mo><msub><mi>W</mi><mn>1</mn></msub><mi>x</mi><mo stretchy="false">)</mo><mo>âŠ™</mo><mo stretchy="false">(</mo><msub><mi>W</mi><mn>2</mn></msub><mi>x</mi><mo stretchy="false">)</mo></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(3)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">\text{GLU}(x, W_1, W_2) = \sigma(W_1 x) \odot (W_2 x) \tag{3}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">GLU</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ïƒ</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âŠ™</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal">x</span><span class="mclose">)</span></span><span class="tag"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">3</span></span><span class="mord">)</span></span></span></span></span></span><br>ç›´è§‰ä¸Šï¼Œè¿™ç§é—¨æ§èƒ½ç»™æ¢¯åº¦æä¾›ä¸€æ¡æ›´â€œçº¿æ€§â€çš„é€šè·¯ï¼ŒåŒæ—¶ä¿ç•™éçº¿æ€§è¡¨è¾¾èƒ½åŠ›ã€‚æŠŠä¸¤è€…æ‹¼èµ·æ¥å°±æ˜¯ SwiGLU åœ¨ FFN ä¸­çš„å†™æ³•ï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><mtext>FFN</mtext><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mi>W</mi><mn>2</mn></msub><mrow><mo fence="true">(</mo><mtext>SiLU</mtext><mo stretchy="false">(</mo><msub><mi>W</mi><mn>1</mn></msub><mi>x</mi><mo stretchy="false">)</mo><mo>âŠ™</mo><mo stretchy="false">(</mo><msub><mi>W</mi><mn>3</mn></msub><mi>x</mi><mo stretchy="false">)</mo><mo fence="true">)</mo></mrow></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(4)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">\text{FFN}(x) = W_2 \left( \text{SiLU}(W_1 x) \odot (W_3 x) \right) \tag{4}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">FFN</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord text"><span class="mord">SiLU</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âŠ™</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mclose delimcenter" style="top:0em;">)</span></span></span><span class="tag"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">4</span></span><span class="mord">)</span></span></span></span></span></span><br>å…¶ä¸­ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>âˆˆ</mo><msup><mi mathvariant="double-struck">R</mi><msub><mi>d</mi><mtext>model</mtext></msub></msup><mo separator="true">,</mo><mtext>Â </mtext><msub><mi>W</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>W</mi><mn>3</mn></msub><mo>âˆˆ</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mtext>ff</mtext></msub><mo>Ã—</mo><msub><mi>d</mi><mtext>model</mtext></msub></mrow></msup><mo separator="true">,</mo><mtext>Â </mtext><msub><mi>W</mi><mn>2</mn></msub><mo>âˆˆ</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mtext>model</mtext></msub><mo>Ã—</mo><msub><mi>d</mi><mtext>ff</mtext></msub></mrow></msup></mrow><annotation encoding="application/x-tex">x \in \mathbb{R}^{d_{\text{model}}},\ W_1, W_3 \in \mathbb{R}^{d_{\text{ff}} \times d_{\text{model}}},\ W_2 \in \mathbb{R}^{d_{\text{model}} \times d_{\text{ff}}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0435em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">model</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace">Â </span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0435em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">ff</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span><span class="mbin mtight">Ã—</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">model</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace">Â </span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">model</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span><span class="mbin mtight">Ã—</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">ff</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>ã€‚å®è·µé‡Œå¸¸è§çš„ç»éªŒè®¾å®šæ˜¯ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mtext>ff</mtext></msub><mo>=</mo><mfrac><mn>8</mn><mn>3</mn></mfrac><msub><mi>d</mi><mtext>model</mtext></msub></mrow><annotation encoding="application/x-tex">d_{\text{ff}} = \frac{8}{3} d_{\text{model}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">ff</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1901em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">8</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">model</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>ã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œç›¸æ¯”æ—©æœŸçš„ 4xï¼Œç°ä»£ LLM ç»å¸¸ç”¨ä¸€ä¸ªæ›´â€œæ€§ä»·æ¯”â€æ›´å¥½çš„å®½åº¦é…åˆé—¨æ§ç»“æ„ã€‚Shazeer (Shazeer 2020) çš„å®éªŒä¹Ÿè¡¨æ˜ï¼ŒSwiGLU å¾€å¾€èƒ½åœ¨è¯­è¨€å»ºæ¨¡ä»»åŠ¡ä¸Šä¼˜äº ReLU æˆ–ä»… SiLUï¼ˆæ— é—¨æ§ï¼‰çš„åŸºçº¿â€”â€”å½“ç„¶ï¼Œæœ€ç»ˆè¿˜æ˜¯è¦å›åˆ°å®éªŒï¼šåœ¨åç»­å¯¹æ¯”ä¸åŒ FFN å˜ä½“æ—¶ï¼Œä½ ä¼šæ›´ç›´è§‚åœ°çœ‹åˆ°è¿™äº›è®¾è®¡åœ¨ lossã€æ”¶æ•›é€Ÿåº¦ä¸æœ€ç»ˆæŒ‡æ ‡ä¸Šçš„å·®å¼‚ã€‚</p>
<p><img src="./ass01-act-fns.png" alt="ä¸åŒæ¿€æ´»å‡½æ•°å¯¹æ¯”"></p>
<p>ä»£ç çš„å®ç°è¿˜æ˜¯å¾ˆç®€å•çš„ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cs336_basics/modules/ffn.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">silu</span>(<span class="params">x: torch.Tensor</span>) -&gt; torch.Tensor:</span><br><span class="line">    <span class="keyword">return</span> x * torch.sigmoid(x)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FFN</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params"></span></span><br><span class="line"><span class="params">        self,</span></span><br><span class="line"><span class="params">        d_model: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">        d_ff: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">        device: torch.device | <span class="literal">None</span> = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">        dtype: torch.dtype | <span class="literal">None</span> = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    </span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">from</span> cs336_basics.modules.linear <span class="keyword">import</span> Linear</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.up = Linear(d_model, d_ff, device=device, dtype=dtype)</span><br><span class="line">        <span class="variable language_">self</span>.down = Linear(d_ff, d_model, device=device, dtype=dtype)</span><br><span class="line">        <span class="variable language_">self</span>.gate = Linear(d_model, d_ff, device=device, dtype=dtype)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x: torch.Tensor</span>) -&gt; torch.Tensor:</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.down(silu(<span class="variable language_">self</span>.up(x)) * <span class="variable language_">self</span>.gate(x))</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="3-5-RoPE"><a href="#3-5-RoPE" class="headerlink" title="3.5 RoPE"></a>3.5 RoPE</h2><p>Transformer æœ¬èº«å¯¹åºåˆ—çš„é¡ºåºå¹¶ä¸æ•æ„Ÿï¼Œå› æ­¤éœ€è¦æŠŠä½ç½®ä¿¡æ¯æ³¨å…¥åˆ°æ³¨æ„åŠ›æœºåˆ¶é‡Œã€‚é™¤äº†å¸¸è§çš„ç»å¯¹ä½ç½®ç¼–ç ï¼ˆabsolute embeddingï¼‰ï¼Œç°ä»£ LLM æ›´å¸¸ç”¨çš„ä¸€ç±»æ–¹æ³•æ˜¯ <strong>Rotary Position Embeddings (RoPE)</strong> (Su et al. 2023)ï¼šå®ƒä¸æ˜¯æŠŠä½ç½®å‘é‡â€œåŠ åˆ°â€embedding ä¸Šï¼Œè€Œæ˜¯å¯¹ Q/K å‘é‡åš<strong>ç»´åº¦æˆå¯¹çš„æ—‹è½¬</strong>ï¼Œä»è€Œè®©æ³¨æ„åŠ›å¤©ç„¶å…·å¤‡ç›¸å¯¹ä½ç½®ä¿¡æ¯ã€‚</p>
<p>RoPE çš„æ€æƒ³ä¹Ÿå¾ˆç®€å•ï¼šå¯¹ç¬¬ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> ä¸ª token çš„ queryï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><msup><mi>q</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>=</mo><msub><mi>W</mi><mi>q</mi></msub><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>âˆˆ</mo><msup><mi mathvariant="double-struck">R</mi><mi>d</mi></msup></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(5)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">q^{(i)} = W_q x^{(i)} \in \mathbb{R}^d \tag{5}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1324em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2241em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8991em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span></span><span class="tag"><span class="strut" style="height:1.2241em;vertical-align:-0.2861em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">5</span></span><span class="mord">)</span></span></span></span></span></span><br>RoPE ä¼šä¹˜ä¸Šä¸€ä¸ªä½ç½®ç›¸å…³çš„æ—‹è½¬çŸ©é˜µ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">R_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>ï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><msup><mi>q</mi><mrow><mo mathvariant="normal">â€²</mo><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></mrow></msup><mo>=</mo><msub><mi>R</mi><mi>i</mi></msub><msup><mi>q</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(6)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">q&#x27;^{(i)} = R_i q^{(i)} \tag{6}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1324em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1324em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span><span class="tag"><span class="strut" style="height:1.188em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">6</span></span><span class="mord">)</span></span></span></span></span></span><br>å…¶ä¸­ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">R_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¼šæŠŠå‘é‡æŒ‰ç»´åº¦ä¸¤ä¸¤åˆ†ç»„ï¼š<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>q</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>q</mi><mn>2</mn></msub><mo stretchy="false">)</mo><mo separator="true">,</mo><mo stretchy="false">(</mo><msub><mi>q</mi><mn>3</mn></msub><mo separator="true">,</mo><msub><mi>q</mi><mn>4</mn></msub><mo stretchy="false">)</mo><mo separator="true">,</mo><mo>â€¦</mo></mrow><annotation encoding="application/x-tex">(q_1, q_2), (q_3, q_4), \dots</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">â€¦</span></span></span></span>ï¼ŒæŠŠæ¯ä¸€å¯¹çœ‹ä½œä¸€ä¸ª 2D å‘é‡ï¼Œåœ¨å¹³é¢é‡Œæ—‹è½¬ä¸€ä¸ªè§’åº¦ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Î¸</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>k</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\theta_{i,k}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>ã€‚</p>
<p><img src="./rope.png" alt="RoPEæ—‹è½¬ç¤ºæ„å›¾ï¼šå¯¹æ¯ä¸€å¯¹ç»´åº¦$(q_{2k-1},q_{2k})$ï¼ŒæŒ‰ä½ç½®$i$æ—‹è½¬è§’åº¦$\theta_{i,k}$ã€‚"></p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹å¦‚ä½•å®šä¹‰æ—‹è½¬è§’åº¦ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Î¸</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>k</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\theta_{i,k}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>ï¼Œä»¥åŠå¦‚ä½•æ„å»ºæ—‹è½¬çŸ©é˜µ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">R_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>ã€‚</p>
<h3 id="å®šä¹‰æ—‹è½¬è§’åº¦"><a href="#å®šä¹‰æ—‹è½¬è§’åº¦" class="headerlink" title="å®šä¹‰æ—‹è½¬è§’åº¦ "></a>å®šä¹‰æ—‹è½¬è§’åº¦ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Î¸</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>k</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\theta_{i,k}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span></h3><p>æ ¹æ®RoPE(Su et al. 2023) çš„è®¾å®šï¼Œå¯¹ç¬¬ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> å¯¹ç»´åº¦ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>âˆˆ</mo><mo stretchy="false">{</mo><mn>1</mn><mo separator="true">,</mo><mo>â€¦</mo><mo separator="true">,</mo><mi>d</mi><mi mathvariant="normal">/</mi><mn>2</mn><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">k \in \{1,\dots,d/2\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7335em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">â€¦</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">d</span><span class="mord">/2</span><span class="mclose">}</span></span></span></span>ï¼Œæ—‹è½¬è§’åº¦å®šä¹‰ä¸ºï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><msub><mi>Î¸</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>k</mi></mrow></msub><mo>=</mo><mi>i</mi><mo>â‹…</mo><msup><mi mathvariant="normal">Î˜</mi><mrow><mo>âˆ’</mo><mfrac><mrow><mn>2</mn><mi>k</mi><mo>âˆ’</mo><mn>2</mn></mrow><mi>d</mi></mfrac></mrow></msup></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(7)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">\theta_{i,k} = i \cdot \Theta^{-\frac{2k-2}{d}} \tag{7}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.029em;"></span><span class="mord"><span class="mord">Î˜</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.029em;"><span style="top:-3.413em;margin-right:0.05em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">âˆ’</span><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.88em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span style="top:-3.2255em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span></span></span></span></span></span></span></span></span></span><span class="tag"><span class="strut" style="height:1.3151em;vertical-align:-0.2861em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">7</span></span><span class="mord">)</span></span></span></span></span></span><br>è¿™é‡Œ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Î˜</mi></mrow><annotation encoding="application/x-tex">\Theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">Î˜</span></span></span></span> æ˜¯ä¸€ä¸ªå¸¸æ•°æˆ‘ä»¬é€šå¸¸æŠŠ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Î˜</mi></mrow><annotation encoding="application/x-tex">\Theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">Î˜</span></span></span></span> è®¾ä¸º 10,000ï¼Œè¿™æ ·ç¬¬ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> å¯¹ç»´åº¦çš„é¢‘ç‡æ˜¯ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mn>1</mn><msup><mn>10000</mn><mfrac><mrow><mn>2</mn><mi>k</mi><mo>âˆ’</mo><mn>2</mn></mrow><mi>d</mi></mfrac></msup></mfrac></mrow><annotation encoding="application/x-tex">\frac{1}{10000^{\frac{2k-2}{d}}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.5472em;vertical-align:-0.7021em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.2979em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1000</span><span class="mord mtight"><span class="mord mtight">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.2744em;"><span style="top:-3.4878em;margin-right:0.0714em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size1 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1013em;"><span style="top:-2.468em;"><span class="pstrut" style="height:3em;"></span><span class="mord mtight"><span class="mord mathnormal mtight">d</span></span></span><span style="top:-3.2255em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.4068em;"><span class="pstrut" style="height:3em;"></span><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.532em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size1 size6"></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.7021em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>ï¼Œå’Œ Transformer ç»å¯¹ä½ç½®ç¼–ç é‡Œçš„é¢‘ç‡è®¾è®¡æ˜¯ä¸€è‡´çš„ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inv_freq = <span class="number">1.0</span> / (<span class="number">10000.0</span> ** (torch.arange(<span class="number">0</span>, d_model, <span class="number">2</span>, dtype=torch.<span class="built_in">float</span>) / d_model))</span><br></pre></td></tr></table></figure>
<p>ç›´è§‰ä¸Šï¼š</p>
<ul>
<li>ä¸åŒç»´åº¦å¯¹åº”ä¸åŒâ€œæ—‹è½¬é¢‘ç‡â€ï¼ˆåƒä¸€ç»„ä¸åŒæ³¢é•¿çš„æ­£å¼¦/ä½™å¼¦ï¼‰</li>
<li>ä½ç½®è¶Šé åï¼Œæ—‹è½¬è§’åº¦è¶Šå¤§ï¼Œç”¨äºç¼–ç æ›´é•¿è·ç¦»çš„ç›¸å¯¹ä½ç½®å…³ç³»</li>
<li>æœ€ç»ˆè®©æ³¨æ„åŠ›å¯ä»¥é€šè¿‡ Q/K çš„ç›¸å¯¹æ—‹è½¬ï¼Œç¼–ç ç›¸å¯¹ä½ç½®ä¿¡æ¯</li>
</ul>
<h3 id="å®šä¹‰æ—‹è½¬å—"><a href="#å®šä¹‰æ—‹è½¬å—" class="headerlink" title="å®šä¹‰æ—‹è½¬å— "></a>å®šä¹‰æ—‹è½¬å— <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>R</mi><mi>k</mi><mi>i</mi></msubsup></mrow><annotation encoding="application/x-tex">R_k^i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1078em;vertical-align:-0.2831em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8247em;"><span style="top:-2.4169em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2831em;"><span></span></span></span></span></span></span></span></span></span></h3><p>å…¶ä¸­ï¼Œæ¯ä¸€å¯¹ç»´åº¦ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>q</mi><mrow><mn>2</mn><mi>k</mi><mo>âˆ’</mo><mn>1</mn></mrow></msub><mo separator="true">,</mo><msub><mi>q</mi><mrow><mn>2</mn><mi>k</mi></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(q_{2k-1}, q_{2k})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> å¯¹åº”ä¸€ä¸ª <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mo>Ã—</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">2 \times 2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span></span></span></span> æ—‹è½¬å—ï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><msubsup><mi>R</mi><mi>k</mi><mi>i</mi></msubsup><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>cos</mi><mo>â¡</mo><mo stretchy="false">(</mo><msub><mi>Î¸</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>k</mi></mrow></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>âˆ’</mo><mi>sin</mi><mo>â¡</mo><mo stretchy="false">(</mo><msub><mi>Î¸</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>k</mi></mrow></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>sin</mi><mo>â¡</mo><mo stretchy="false">(</mo><msub><mi>Î¸</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>k</mi></mrow></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>cos</mi><mo>â¡</mo><mo stretchy="false">(</mo><msub><mi>Î¸</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>k</mi></mrow></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(8)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">R_k^i = \begin{bmatrix} \cos(\theta_{i,k}) &amp; -\sin(\theta_{i,k}) \\ \sin(\theta_{i,k}) &amp; \cos(\theta_{i,k}) \end{bmatrix} \tag{8}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1217em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8747em;"><span style="top:-2.453em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop">cos</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop">sin</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">âˆ’</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">sin</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop">cos</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span><span class="tag"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">8</span></span><span class="mord">)</span></span></span></span></span></span></p>
<h3 id="æ•´ä½“æ—‹è½¬çŸ©é˜µ"><a href="#æ•´ä½“æ—‹è½¬çŸ©é˜µ" class="headerlink" title="æ•´ä½“æ—‹è½¬çŸ©é˜µ "></a>æ•´ä½“æ—‹è½¬çŸ©é˜µ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">R_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></h3><p>æ•´ä½“ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">R_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> æ˜¯ä¸€ä¸ª <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo>Ã—</mo><mi>d</mi></mrow><annotation encoding="application/x-tex">d \times d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span> çš„å—å¯¹è§’çŸ©é˜µï¼Œç”± <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">d/2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mord">/2</span></span></span></span> ä¸ª <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mo>Ã—</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">2 \times 2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span></span></span></span> å—ç»„æˆï¼ˆå…¶å®ƒä½ç½®ä¸º 0ï¼‰ã€‚æ•°å­¦ä¸Šå†™æˆï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><msub><mi>R</mi><mi>i</mi></msub><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi>R</mi><mn>1</mn><mi>i</mi></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">â‹¯</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi>R</mi><mn>2</mn><mi>i</mi></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">â‹¯</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi>R</mi><mn>3</mn><mi>i</mi></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">â‹¯</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">â‹®</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">â‹®</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">â‹®</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">â‹±</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">â‹®</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">â‹¯</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi>R</mi><mrow><mi>d</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow><mi>i</mi></msubsup></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(9)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">R_i = \begin{bmatrix}
R_1^i &amp; 0 &amp; 0 &amp; \cdots &amp; 0 \\
0 &amp; R_2^i &amp; 0 &amp; \cdots &amp; 0 \\
0 &amp; 0 &amp; R_3^i &amp; \cdots &amp; 0 \\
\vdots &amp; \vdots &amp; \vdots &amp; \ddots &amp; \vdots \\
0 &amp; 0 &amp; 0 &amp; \cdots &amp; R_{d/2}^i
\end{bmatrix} \tag{9}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:6.797em;vertical-align:-3.1485em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.55em;"><span style="top:-5.55em;"><span class="pstrut" style="height:8.6em;"></span><span style="width:0.667em;height:6.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="6.600em" viewBox="0 0 667 6600"><path d="M403 1759 V84 H666 V0 H319 V1759 v3000 v1759 h347 v-84
H403z M403 1759 V0 H319 V1759 v3000 v1759 h84z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:3.05em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.6485em;"><span style="top:-6.496em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8247em;"><span style="top:-2.4519em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2481em;"><span></span></span></span></span></span></span></span></span><span style="top:-5.296em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-4.096em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.236em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">â‹®</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-1.036em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:3.1485em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.6485em;"><span style="top:-6.496em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-5.296em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8247em;"><span style="top:-2.4519em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2481em;"><span></span></span></span></span></span></span></span></span><span style="top:-4.096em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.236em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">â‹®</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-1.036em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:3.1485em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.6485em;"><span style="top:-6.496em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-5.296em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-4.096em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8247em;"><span style="top:-2.4519em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2481em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.236em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">â‹®</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-1.036em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:3.1485em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.6485em;"><span style="top:-6.3085em;"><span class="pstrut" style="height:3.5em;"></span><span class="mord"><span class="minner">â‹¯</span></span></span><span style="top:-5.1085em;"><span class="pstrut" style="height:3.5em;"></span><span class="mord"><span class="minner">â‹¯</span></span></span><span style="top:-3.9085em;"><span class="pstrut" style="height:3.5em;"></span><span class="mord"><span class="minner">â‹¯</span></span></span><span style="top:-2.0485em;"><span class="pstrut" style="height:3.5em;"></span><span class="mord"><span class="minner">â‹±</span></span></span><span style="top:-0.8485em;"><span class="pstrut" style="height:3.5em;"></span><span class="mord"><span class="minner">â‹¯</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:3.1485em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.6485em;"><span style="top:-6.496em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-5.296em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-4.096em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.236em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">â‹®</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-1.036em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8247em;"><span style="top:-2.378em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mtight">/2</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.497em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:3.1485em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.55em;"><span style="top:-5.55em;"><span class="pstrut" style="height:8.6em;"></span><span style="width:0.667em;height:6.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="6.600em" viewBox="0 0 667 6600"><path d="M347 1759 V0 H0 V84 H263 V1759 v3000 v1759 H0 v84 H347z
M347 1759 V0 H263 V1759 v3000 v1759 h84z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:3.05em;"><span></span></span></span></span></span></span></span></span><span class="tag"><span class="strut" style="height:6.797em;vertical-align:-3.1485em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">9</span></span><span class="mord">)</span></span></span></span></span></span></p>
<p>è¿™æ ·ï¼Œå¯¹äºç¬¬ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span> ä¸ª token çš„ key å‘é‡ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>k</mi><mrow><mo stretchy="false">(</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></msup></mrow><annotation encoding="application/x-tex">k^{(j)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.888em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span>ï¼ŒRoPE ä¹Ÿä¼šåšç±»ä¼¼çš„æ—‹è½¬ï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><msup><mi>k</mi><mrow><mo mathvariant="normal">â€²</mo><mrow><mo stretchy="false">(</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></mrow></msup><mo>=</mo><msub><mi>R</mi><mi>j</mi></msub><msup><mi>k</mi><mrow><mo stretchy="false">(</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></msup></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(10)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">k&#x27;^{(j)} = R_j k^{(j)} \tag{10}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.938em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2241em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span><span class="tag"><span class="strut" style="height:1.2241em;vertical-align:-0.2861em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">10</span></span><span class="mord">)</span></span></span></span></span></span><br>è¿™æ ·åœ¨è®¡ç®—æ³¨æ„åŠ›åˆ†æ•° <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>q</mi><mrow><mo mathvariant="normal">â€²</mo><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></mrow></msup><mo>â‹…</mo><msup><mi>k</mi><mrow><mo mathvariant="normal">â€²</mo><mrow><mo stretchy="false">(</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></mrow></msup></mrow><annotation encoding="application/x-tex">q&#x27;^{(i)} \cdot k&#x27;^{(j)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0824em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.888em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span></span> æ—¶ï¼Œä½ç½®å·®å¼‚ä¼šä»¥<strong>ç›¸å¯¹æ—‹è½¬</strong>çš„å½¢å¼ä½“ç°å‡ºæ¥ï¼Œè¿™ä¹Ÿæ˜¯ RoPE åœ¨é•¿ä¸Šä¸‹æ–‡å»ºæ¨¡ä¸­éå¸¸å¸¸ç”¨çš„åŸå› ä¹‹ä¸€ã€‚<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><msup><mi>q</mi><mrow><mo mathvariant="normal">â€²</mo><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></mrow></msup><mo>â‹…</mo><msup><mi>k</mi><mrow><mo mathvariant="normal">â€²</mo><mrow><mo stretchy="false">(</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></mrow></msup><mo>=</mo><mrow><mo fence="true">(</mo><msub><mi>R</mi><mi>i</mi></msub><msup><mi>q</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo fence="true">)</mo></mrow><mo>â‹…</mo><mrow><mo fence="true">(</mo><msub><mi>R</mi><mi>j</mi></msub><msup><mi>k</mi><mrow><mo stretchy="false">(</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></msup><mo fence="true">)</mo></mrow><mo>=</mo><msup><mi>q</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>â‹…</mo><mrow><mo fence="true">(</mo><msubsup><mi>R</mi><mi>i</mi><mi>T</mi></msubsup><msub><mi>R</mi><mi>j</mi></msub><msup><mi>k</mi><mrow><mo stretchy="false">(</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></msup><mo fence="true">)</mo></mrow></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(11)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">q&#x27;^{(i)} \cdot k&#x27;^{(j)} = \left(R_i q^{(i)}\right) \cdot \left(R_j k^{(j)}\right) = q^{(i)} \cdot \left(R_i^T R_j k^{(j)}\right) \tag{11}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1324em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.938em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.8em;vertical-align:-0.65em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size2">(</span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size2">)</span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.8em;vertical-align:-0.65em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size2">(</span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size2">)</span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1324em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.8em;vertical-align:-0.65em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size2">(</span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.453em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size2">)</span></span></span></span><span class="tag"><span class="strut" style="height:1.8em;vertical-align:-0.65em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">11</span></span><span class="mord">)</span></span></span></span></span></span></p>
<hr>
<h3 id="3-5-1-RoPE-çš„å®ç°ç»†èŠ‚"><a href="#3-5-1-RoPE-çš„å®ç°ç»†èŠ‚" class="headerlink" title="3.5.1 RoPE çš„å®ç°ç»†èŠ‚"></a>3.5.1 RoPE çš„å®ç°ç»†èŠ‚</h3><p>RoPE å±‚æ²¡æœ‰å¯å­¦ä¹ å‚æ•°ã€‚ä¸ºäº†æ•ˆç‡ï¼Œé€šå¸¸ä¼šï¼š</p>
<ul>
<li>é¢„è®¡ç®—æ‰€æœ‰ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>cos</mi><mo>â¡</mo><mo stretchy="false">(</mo><msub><mi>Î¸</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>k</mi></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\cos(\theta_{i,k})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mop">cos</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> ä¸ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>sin</mi><mo>â¡</mo><mo stretchy="false">(</mo><msub><mi>Î¸</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>k</mi></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\sin(\theta_{i,k})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mop">sin</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></li>
<li>ä½œä¸º buffer ç¼“å­˜åœ¨æ¨¡å—é‡Œï¼Œè€Œä¸æ˜¯ nn.Parameterï¼ˆå› ä¸ºå®ƒä»¬æ˜¯å›ºå®šçš„ï¼‰</li>
<li>ç”šè‡³å¯ä»¥è®©æ‰€æœ‰ Transformer å±‚å…±äº«åŒä¸€ä¸ª RoPE æ¨¡å—ï¼ˆè·¨å±‚å¤ç”¨ç¼“å­˜ï¼‰</li>
</ul>
<p>å®ç°ä¸Šå¸¸ç”¨ï¼š</p>
<ul>
<li>self.register_buffer(â€¦, persistent=False) æ¥ä¿å­˜é¢„è®¡ç®—å¥½çš„ sin/cosï¼ˆä¸è¿› state_dict æˆ–ä¸ä½œä¸ºè®­ç»ƒå‚æ•°ï¼‰</li>
<li>åªè¦åºåˆ—é•¿åº¦ä¸å˜ï¼Œè¿™äº›å€¼å¯ä»¥åœ¨ä¸åŒ batchã€ä¸åŒ layer é—´å¤ç”¨</li>
</ul>
<p>ä¸è¿‡ï¼Œåœ¨å®é™…å®ç° RoPE æ—‹è½¬æ—¶ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦æ˜¾å¼æ„å»ºå¤§å—å¯¹è§’çŸ©é˜µ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">R_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>ï¼Œè€Œæ˜¯æŠŠå‘é‡æŒ‰ 2 ç»´ä¸€ç»„é…å¯¹ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>x</mi><mrow><mn>2</mn><mi>k</mi><mo>âˆ’</mo><mn>1</mn></mrow></msub><mo separator="true">,</mo><msub><mi>x</mi><mrow><mn>2</mn><mi>k</mi></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(x_{2k-1},x_{2k})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>ï¼Œå¯¹æ¯ä¸€ç»„åšä¸€ä¸ªå¹³é¢æ—‹è½¬ï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msubsup><mi>R</mi><mrow><mi>Î¸</mi><mo separator="true">,</mo><mi>m</mi></mrow><mi>d</mi></msubsup><mi mathvariant="bold">x</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>1</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>2</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>3</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>4</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">â‹®</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mrow><mi>d</mi><mo>âˆ’</mo><mn>1</mn></mrow></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mi>d</mi></msub></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>âŠ—</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>cos</mi><mo>â¡</mo><mo stretchy="false">(</mo><mi>m</mi><msub><mi>Î¸</mi><mn>1</mn></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>cos</mi><mo>â¡</mo><mo stretchy="false">(</mo><mi>m</mi><msub><mi>Î¸</mi><mn>1</mn></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>cos</mi><mo>â¡</mo><mo stretchy="false">(</mo><mi>m</mi><msub><mi>Î¸</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>cos</mi><mo>â¡</mo><mo stretchy="false">(</mo><mi>m</mi><msub><mi>Î¸</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">â‹®</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>cos</mi><mo>â¡</mo><mo stretchy="false">(</mo><mi>m</mi><msub><mi>Î¸</mi><mrow><mi>d</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>cos</mi><mo>â¡</mo><mo stretchy="false">(</mo><mi>m</mi><msub><mi>Î¸</mi><mrow><mi>d</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>+</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>âˆ’</mo><msub><mi>x</mi><mn>2</mn></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>1</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>âˆ’</mo><msub><mi>x</mi><mn>4</mn></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>3</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">â‹®</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>âˆ’</mo><msub><mi>x</mi><mi>d</mi></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mrow><mi>d</mi><mo>âˆ’</mo><mn>1</mn></mrow></msub></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>âŠ—</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>sin</mi><mo>â¡</mo><mo stretchy="false">(</mo><mi>m</mi><msub><mi>Î¸</mi><mn>1</mn></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>sin</mi><mo>â¡</mo><mo stretchy="false">(</mo><mi>m</mi><msub><mi>Î¸</mi><mn>1</mn></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>sin</mi><mo>â¡</mo><mo stretchy="false">(</mo><mi>m</mi><msub><mi>Î¸</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>sin</mi><mo>â¡</mo><mo stretchy="false">(</mo><mi>m</mi><msub><mi>Î¸</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">â‹®</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>sin</mi><mo>â¡</mo><mo stretchy="false">(</mo><mi>m</mi><msub><mi>Î¸</mi><mrow><mi>d</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>sin</mi><mo>â¡</mo><mo stretchy="false">(</mo><mi>m</mi><msub><mi>Î¸</mi><mrow><mi>d</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>x</mi><mn>1</mn></msub><mi>cos</mi><mo>â¡</mo><mo stretchy="false">(</mo><mi>m</mi><msub><mi>Î¸</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo>âˆ’</mo><msub><mi>x</mi><mn>2</mn></msub><mi>sin</mi><mo>â¡</mo><mo stretchy="false">(</mo><mi>m</mi><msub><mi>Î¸</mi><mn>1</mn></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>x</mi><mn>2</mn></msub><mi>cos</mi><mo>â¡</mo><mo stretchy="false">(</mo><mi>m</mi><msub><mi>Î¸</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo>+</mo><msub><mi>x</mi><mn>1</mn></msub><mi>sin</mi><mo>â¡</mo><mo stretchy="false">(</mo><mi>m</mi><msub><mi>Î¸</mi><mn>1</mn></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>x</mi><mn>3</mn></msub><mi>cos</mi><mo>â¡</mo><mo stretchy="false">(</mo><mi>m</mi><msub><mi>Î¸</mi><mn>2</mn></msub><mo stretchy="false">)</mo><mo>âˆ’</mo><msub><mi>x</mi><mn>4</mn></msub><mi>sin</mi><mo>â¡</mo><mo stretchy="false">(</mo><mi>m</mi><msub><mi>Î¸</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>x</mi><mn>4</mn></msub><mi>cos</mi><mo>â¡</mo><mo stretchy="false">(</mo><mi>m</mi><msub><mi>Î¸</mi><mn>2</mn></msub><mo stretchy="false">)</mo><mo>+</mo><msub><mi>x</mi><mn>3</mn></msub><mi>sin</mi><mo>â¡</mo><mo stretchy="false">(</mo><mi>m</mi><msub><mi>Î¸</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">â‹®</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>x</mi><mrow><mi>d</mi><mo>âˆ’</mo><mn>1</mn></mrow></msub><mi>cos</mi><mo>â¡</mo><mo stretchy="false">(</mo><mi>m</mi><msub><mi>Î¸</mi><mrow><mi>d</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></msub><mo stretchy="false">)</mo><mo>âˆ’</mo><msub><mi>x</mi><mi>d</mi></msub><mi>sin</mi><mo>â¡</mo><mo stretchy="false">(</mo><mi>m</mi><msub><mi>Î¸</mi><mrow><mi>d</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>x</mi><mi>d</mi></msub><mi>cos</mi><mo>â¡</mo><mo stretchy="false">(</mo><mi>m</mi><msub><mi>Î¸</mi><mrow><mi>d</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></msub><mo stretchy="false">)</mo><mo>+</mo><msub><mi>x</mi><mrow><mi>d</mi><mo>âˆ’</mo><mn>1</mn></mrow></msub><mi>sin</mi><mo>â¡</mo><mo stretchy="false">(</mo><mi>m</mi><msub><mi>Î¸</mi><mrow><mi>d</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">
R_{\theta,m}^d \mathbf{x} = \begin{bmatrix} x_1 \\ x_2 \\ x_3 \\ x_4 \\ \vdots \\ x_{d-1} \\ x_d \end{bmatrix} \otimes \begin{bmatrix} \cos(m\theta_1) \\ \cos(m\theta_1) \\ \cos(m\theta_2) \\ \cos(m\theta_2) \\ \vdots \\ \cos(m\theta_{d/2}) \\ \cos(m\theta_{d/2}) \end{bmatrix} + \begin{bmatrix} -x_2 \\ x_1 \\ -x_4 \\ x_3 \\ \vdots \\ -x_d \\ x_{d-1} \end{bmatrix} \otimes \begin{bmatrix} \sin(m\theta_1) \\ \sin(m\theta_1) \\ \sin(m\theta_2) \\ \sin(m\theta_2) \\ \vdots \\ \sin(m\theta_{d/2}) \\ \sin(m\theta_{d/2}) \end{bmatrix} = \begin{bmatrix} x_1 \cos(m\theta_1) - x_2 \sin(m\theta_1) \\ x_2 \cos(m\theta_1) + x_1 \sin(m\theta_1) \\ x_3 \cos(m\theta_2) - x_4 \sin(m\theta_2) \\ x_4 \cos(m\theta_2) + x_3 \sin(m\theta_2) \\ \vdots \\ x_{d-1} \cos(m\theta_{d/2}) - x_d \sin(m\theta_{d/2}) \\ x_d \cos(m\theta_{d/2}) + x_{d-1} \sin(m\theta_{d/2}) \end{bmatrix}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2822em;vertical-align:-0.3831em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-2.453em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">Î¸</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">m</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3831em;"><span></span></span></span></span></span></span><span class="mord mathbf">x</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:9.06em;vertical-align:-4.28em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.7499em;"><span style="top:-6.7499em;"><span class="pstrut" style="height:11em;"></span><span style="width:0.667em;height:9.000em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="9.000em" viewBox="0 0 667 9000"><path d="M403 1759 V84 H666 V0 H319 V1759 v5400 v1759 h347 v-84
H403z M403 1759 V0 H319 V1759 v5400 v1759 h84z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:4.2501em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.78em;"><span style="top:-7.6275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-6.4275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-5.2275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-4.0275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.1675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">â‹®</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-0.9675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span></span></span><span style="top:0.2325em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:4.28em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.7499em;"><span style="top:-6.7499em;"><span class="pstrut" style="height:11em;"></span><span style="width:0.667em;height:9.000em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="9.000em" viewBox="0 0 667 9000"><path d="M347 1759 V0 H0 V84 H263 V1759 v5400 v1759 H0 v84 H347z
M347 1759 V0 H263 V1759 v5400 v1759 h84z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:4.2501em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âŠ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:9.06em;vertical-align:-4.28em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.7499em;"><span style="top:-6.7499em;"><span class="pstrut" style="height:11em;"></span><span style="width:0.667em;height:9.000em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="9.000em" viewBox="0 0 667 9000"><path d="M403 1759 V84 H666 V0 H319 V1759 v5400 v1759 h347 v-84
H403z M403 1759 V0 H319 V1759 v5400 v1759 h84z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:4.2501em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.78em;"><span style="top:-7.6275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mop">cos</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-6.4275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mop">cos</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-5.2275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mop">cos</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-4.0275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mop">cos</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-2.1675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">â‹®</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-0.9675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mop">cos</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mtight">/2</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:0.2325em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mop">cos</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mtight">/2</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:4.28em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.7499em;"><span style="top:-6.7499em;"><span class="pstrut" style="height:11em;"></span><span style="width:0.667em;height:9.000em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="9.000em" viewBox="0 0 667 9000"><path d="M347 1759 V0 H0 V84 H263 V1759 v5400 v1759 H0 v84 H347z
M347 1759 V0 H263 V1759 v5400 v1759 h84z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:4.2501em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:9.06em;vertical-align:-4.28em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.7499em;"><span style="top:-6.7499em;"><span class="pstrut" style="height:11em;"></span><span style="width:0.667em;height:9.000em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="9.000em" viewBox="0 0 667 9000"><path d="M403 1759 V84 H666 V0 H319 V1759 v5400 v1759 h347 v-84
H403z M403 1759 V0 H319 V1759 v5400 v1759 h84z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:4.2501em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.78em;"><span style="top:-7.6275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord">âˆ’</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-6.4275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-5.2275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord">âˆ’</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-4.0275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.1675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">â‹®</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-0.9675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord">âˆ’</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:0.2325em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:4.28em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.7499em;"><span style="top:-6.7499em;"><span class="pstrut" style="height:11em;"></span><span style="width:0.667em;height:9.000em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="9.000em" viewBox="0 0 667 9000"><path d="M347 1759 V0 H0 V84 H263 V1759 v5400 v1759 H0 v84 H347z
M347 1759 V0 H263 V1759 v5400 v1759 h84z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:4.2501em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âŠ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:9.06em;vertical-align:-4.28em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.7499em;"><span style="top:-6.7499em;"><span class="pstrut" style="height:11em;"></span><span style="width:0.667em;height:9.000em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="9.000em" viewBox="0 0 667 9000"><path d="M403 1759 V84 H666 V0 H319 V1759 v5400 v1759 h347 v-84
H403z M403 1759 V0 H319 V1759 v5400 v1759 h84z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:4.2501em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.78em;"><span style="top:-7.6275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mop">sin</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-6.4275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mop">sin</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-5.2275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mop">sin</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-4.0275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mop">sin</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-2.1675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">â‹®</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-0.9675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mop">sin</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mtight">/2</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:0.2325em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mop">sin</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mtight">/2</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:4.28em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.7499em;"><span style="top:-6.7499em;"><span class="pstrut" style="height:11em;"></span><span style="width:0.667em;height:9.000em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="9.000em" viewBox="0 0 667 9000"><path d="M347 1759 V0 H0 V84 H263 V1759 v5400 v1759 H0 v84 H347z
M347 1759 V0 H263 V1759 v5400 v1759 h84z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:4.2501em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:9.06em;vertical-align:-4.28em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.7499em;"><span style="top:-6.7499em;"><span class="pstrut" style="height:11em;"></span><span style="width:0.667em;height:9.000em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="9.000em" viewBox="0 0 667 9000"><path d="M403 1759 V84 H666 V0 H319 V1759 v5400 v1759 h347 v-84
H403z M403 1759 V0 H319 V1759 v5400 v1759 h84z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:4.2501em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.78em;"><span style="top:-7.6275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">cos</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">sin</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-6.4275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">cos</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">sin</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-5.2275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">cos</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">sin</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-4.0275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">cos</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">sin</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-2.1675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">â‹®</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-0.9675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">cos</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mtight">/2</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">sin</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mtight">/2</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:0.2325em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">cos</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mtight">/2</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">sin</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mtight">/2</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:4.28em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.7499em;"><span style="top:-6.7499em;"><span class="pstrut" style="height:11em;"></span><span style="width:0.667em;height:9.000em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="9.000em" viewBox="0 0 667 9000"><path d="M347 1759 V0 H0 V84 H263 V1759 v5400 v1759 H0 v84 H347z
M347 1759 V0 H263 V1759 v5400 v1759 h84z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:4.2501em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>ä»£ç çš„å®ç°ä¹Ÿå¾ˆç®€å•ï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cs336_basics/modules/rope.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RoPEEmbedding</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params"></span></span><br><span class="line"><span class="params">        self,</span></span><br><span class="line"><span class="params">        theta: <span class="built_in">float</span>,</span></span><br><span class="line"><span class="params">        d_k: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">        max_seq_len: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">        device: torch.device | <span class="literal">None</span> = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    </span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.theta = theta</span><br><span class="line">        <span class="variable language_">self</span>.d_k = d_k</span><br><span class="line">        <span class="variable language_">self</span>.max_seq_len = max_seq_len</span><br><span class="line"></span><br><span class="line">        inv_freq = <span class="number">1.0</span> / (theta ** (torch.arange(<span class="number">0</span>, d_k, <span class="number">2</span>, device=device, dtype=torch.float32) / d_k)) </span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.register_buffer(<span class="string">&quot;inv_freq&quot;</span>, inv_freq, persistent=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_rotate_half</span>(<span class="params">self, x</span>):</span><br><span class="line">        x = einops.rearrange(x, <span class="string">&quot;... (d j) -&gt; ... d j&quot;</span>, j=<span class="number">2</span>) </span><br><span class="line">        x1, x2 = x.unbind(dim=-<span class="number">1</span>) </span><br><span class="line">        <span class="keyword">return</span> einops.rearrange(torch.stack((-x2, x1), dim=-<span class="number">1</span>), <span class="string">&quot;... d j-&gt; ... (d j)&quot;</span>) </span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x: torch.Tensor, token_positions: <span class="built_in">int</span> | <span class="literal">None</span> = <span class="literal">None</span></span>) -&gt; torch.Tensor:</span><br><span class="line">        <span class="keyword">if</span> token_positions <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            seq_len = x.shape[-<span class="number">2</span>]</span><br><span class="line">            token_positions = torch.arange(seq_len, device=x.device)</span><br><span class="line">            token_positions = token_positions.unsqueeze(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        theta = torch.einsum(<span class="string">&quot;...i , j -&gt; ... i j&quot;</span>, token_positions, <span class="variable language_">self</span>.inv_freq)</span><br><span class="line">        cos = torch.cos(theta).repeat_interleave(<span class="number">2</span>, dim=-<span class="number">1</span>) </span><br><span class="line">        sin = torch.sin(theta).repeat_interleave(<span class="number">2</span>, dim=-<span class="number">1</span>) </span><br><span class="line"></span><br><span class="line">        x_rotated = (x * cos) + (<span class="variable language_">self</span>._rotate_half(x) * sin)</span><br><span class="line">        <span class="keyword">return</span> x_rotated</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p><strong>ğŸ› ï¸ å·¥å…·ç®±ï¼šeinops ä¸ Tensor æ“ä½œè¯¦è§£</strong></p>
<p>ä»£ç ä¸­çš„ einops.rearrange(x, â€œâ€¦ (d j) -&gt; â€¦ d jâ€, j=2) æ˜¯æå…¶å¼ºå¤§çš„å¼ é‡é‡æ’å·¥å…·ï¼š</p>
<ul>
<li>â€¦: ä»£è¡¨å‰é¢ä»»æ„ç»´åº¦çš„ Batch å’Œ Sequence Lengthï¼Œä¿æŒä¸å˜ã€‚</li>
<li>(d j): ä»£è¡¨è¾“å…¥çš„æœ€åä¸€ç»´ head_dimã€‚</li>
<li>-&gt; â€¦ d j: æ„å‘³ç€æˆ‘ä»¬å°†æœ€åä¸€ç»´æ‹†åˆ†ä¸ºä¸¤ç»´ï¼Œå…¶ä¸­ j=2ã€‚</li>
<li><strong>ç›®çš„</strong>: å°†å‘é‡ä¸­ç›¸é‚»çš„ä¸¤ä¸ªå…ƒç´  <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>x</mi><mrow><mn>2</mn><mi>k</mi></mrow></msub><mo separator="true">,</mo><msub><mi>x</mi><mrow><mn>2</mn><mi>k</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(x_{2k}, x_{2k+1})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> æ˜¾å¼åœ°æ‹†åˆ†å‡ºæ¥ï¼Œå½¢æˆä¸€ä¸ªæ–°çš„ç»´åº¦ï¼Œæ–¹ä¾¿åç»­åˆ†åˆ«èµ‹å€¼ç»™ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>cos</mi><mo>â¡</mo></mrow><annotation encoding="application/x-tex">\cos</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mop">cos</span></span></span></span> å’Œ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>sin</mi><mo>â¡</mo></mrow><annotation encoding="application/x-tex">\sin</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6679em;"></span><span class="mop">sin</span></span></span></span> è¿›è¡Œæ—‹è½¬è®¡ç®—ã€‚</li>
</ul>
<p>x.unbind(dim=-1): åˆ™æ˜¯æ²¿ç€æœ€åä¸€ä¸ªç»´åº¦å°†å¼ é‡â€œåˆ‡ç‰‡â€ï¼Œå¦‚æœä¸ä½¿ç”¨ einopsï¼Œè¿™ç›¸å½“äºæŠŠé…å¯¹çš„å¶æ•°ä½å’Œå¥‡æ•°ä½æ•°å­—åˆ†å¼€ã€‚</p>
</blockquote>
<hr>
<blockquote>
<p><strong>Note</strong><br>åœ¨é˜…è¯»å…¶ä»–LMçš„æºä»£ç æ—¶ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šç¢°åˆ°ä»¥ä¸‹å½¢å¼çš„å®ç°ï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">rotate_half</span>(<span class="params">x: torch.Tensor</span>) -&gt; torch.Tensor:</span><br><span class="line">    x1, x2 = x.chunk(<span class="number">2</span>, dim=-<span class="number">1</span>) </span><br><span class="line">    <span class="keyword">return</span> torch.cat((-x2, x1), dim=-<span class="number">1</span>) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x: torch.Tensor, token_positions: <span class="built_in">int</span> | <span class="literal">None</span> = <span class="literal">None</span></span>) -&gt; torch.Tensor:</span><br><span class="line">    <span class="keyword">if</span> token_positions <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        seq_len = x.shape[-<span class="number">2</span>]</span><br><span class="line">        token_positions = torch.arange(seq_len, device=x.device)</span><br><span class="line">        token_positions = token_positions.unsqueeze(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    theta = torch.einsum(<span class="string">&quot;...i , j -&gt; ... i j&quot;</span>, token_positions, <span class="variable language_">self</span>.inv_freq)</span><br><span class="line">    theta = torch.cat([theta, theta], dim=-<span class="number">1</span>) </span><br><span class="line">    cos = torch.cos(theta)</span><br><span class="line">    sin = torch.sin(theta)</span><br><span class="line">    x_rotated = (x * cos) + (<span class="variable language_">self</span>._rotate_half(x) * sin)</span><br><span class="line">    <span class="keyword">return</span> x_rotated</span><br></pre></td></tr></table></figure><br>è¿™æ˜¯å®ç°çœ‹èµ·æ¥å’Œè®ºæ–‡é‡Œçš„ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">R_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> å—å¯¹è§’çŸ©é˜µå…¬å¼ä¸ä¸€æ ·ï¼šè®ºæ–‡å†™çš„æ˜¯â€œæ¯ä¸¤ç»´ä¸€ç»„åš 2D æ—‹è½¬â€ï¼Œè€Œè¿™é‡ŒæŠŠå‘é‡æ‹†æˆä¸¤åŠï¼ˆx1, x2ï¼‰ï¼Œå†ç”¨ rotate_half åšæ‹¼æ¥ã€‚</p>
<p>è¿™å¯¹åº”çš„å°±æ˜¯â€œäºŒç»´æ—‹è½¬é‡Œé‚£ä¸ªæŠŠ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(a,b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span> å˜æˆ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mo>âˆ’</mo><mi>b</mi><mo separator="true">,</mo><mi>a</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(-b,a)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">âˆ’</span><span class="mord mathnormal">b</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">a</span><span class="mclose">)</span></span></span></span> çš„æ“ä½œâ€ï¼Œåªä¸è¿‡å®ƒæŠŠé…å¯¹æ–¹å¼ä»è®ºæ–‡é‡Œçš„ (1,2),(3,4)â€¦é‚»æ¥é…å¯¹ï¼Œæ¢æˆäº†â€œå‰åŠï¼ŒååŠâ€çš„é…å¯¹ã€‚åªè¦ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>cos</mi><mo>â¡</mo><mi mathvariant="normal">/</mi><mi>sin</mi><mo>â¡</mo></mrow><annotation encoding="application/x-tex">\cos/\sin</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">cos</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">/</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">sin</span></span></span></span> çš„é‡å¤æ–¹å¼å’Œ rotate çš„é…å¯¹æ–¹å¼ä¸€è‡´ï¼Œé…å¯¹æ˜¯é‚»æ¥è¿˜æ˜¯ååŠï¼Œæœ¬è´¨éƒ½åœ¨åšåŒä¸€ä¸ª block-rotationã€‚</p>
<p>è¿™ä¸¤ç§åªæ˜¯åæ ‡é‡æ’ï¼ˆpermutationï¼‰ä¸åŒï¼šå­˜åœ¨ä¸€ä¸ªç½®æ¢çŸ©é˜µ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span>ï¼Œä½¿å¾—<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>R</mi><mtext>half-rotate</mtext></msub><mo>=</mo><msup><mi>P</mi><mi>T</mi></msup><msub><mi>R</mi><mtext>adjacent</mtext></msub><mi>P</mi></mrow><annotation encoding="application/x-tex">R_{\text{half-rotate}} = P^T R_{\text{adjacent}} P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">half-rotate</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1774em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">adjacent</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span></span><br>å‡ ä½•ä¸Šä»ç„¶æ˜¯å¯¹æ¯ä¸ª 2D å­ç©ºé—´åšæ—‹è½¬ï¼Œæ‰€ä»¥åœ¨æ•°å­¦ä¸Šä¸€æ ·å¯è¡Œã€‚</p>
<p>å½“ç„¶ï¼Œé™¤äº†ä¸Šé¢çš„è¿™ç§å½¢å¼ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡æ„é€ Complex Numberçš„å½¢å¼æ¥å®ŒæˆVectorçš„æ—‹è½¬ï¼Œåœ¨è¿™é‡Œå°±ä¸å±•å¼€äº†ã€‚æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å‚è€ƒLlamaçš„<a target="_blank" rel="noopener" href="https://github.com/facebookresearch/llama">inference Code</a>ã€‚</p>
</blockquote>
<hr>
<h2 id="3-6-å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶ï¼ˆMulti-Headed-Attentionï¼‰"><a href="#3-6-å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶ï¼ˆMulti-Headed-Attentionï¼‰" class="headerlink" title="3.6 å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶ï¼ˆMulti-Headed Attentionï¼‰"></a>3.6 å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶ï¼ˆMulti-Headed Attentionï¼‰</h2><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥å®ç°Transformerä¸­ï¼Œæœ€é‡è¦ä¹Ÿæ˜¯ç›¸å¯¹æ¯”è¾ƒå¤æ‚çš„éƒ¨åˆ†ï¼ŒAttentionï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ä»€ä¹ˆæ˜¯Scaled Dot Product Attentionã€‚</p>
<hr>
<h3 id="3-6-1-ç¼©æ”¾ç‚¹ç§¯æ³¨æ„åŠ›æœºåˆ¶ï¼ˆScaled-Dot-Product-Attentionï¼‰"><a href="#3-6-1-ç¼©æ”¾ç‚¹ç§¯æ³¨æ„åŠ›æœºåˆ¶ï¼ˆScaled-Dot-Product-Attentionï¼‰" class="headerlink" title="3.6.1 ç¼©æ”¾ç‚¹ç§¯æ³¨æ„åŠ›æœºåˆ¶ï¼ˆScaled Dot-Product Attentionï¼‰"></a>3.6.1 ç¼©æ”¾ç‚¹ç§¯æ³¨æ„åŠ›æœºåˆ¶ï¼ˆScaled Dot-Product Attentionï¼‰</h3><p>åœ¨Transformer(Vaswani et al. 2023)ä¸­ï¼Œæœ€æ ¸å¿ƒçš„è®¡ç®—ä¹‹ä¸€å°±æ˜¯ <strong>scaled dot-product attention</strong>ã€‚å®ƒå¯ä»¥çœ‹ä½œï¼š</p>
<ol>
<li>è®¡ç®— query å’Œ key çš„ç›¸ä¼¼åº¦ï¼ˆæ‰“åˆ†ï¼‰ã€‚</li>
<li>æŠŠè¿™äº›åˆ†æ•°ï¼ˆlogitsï¼‰å½’ä¸€åŒ–æˆæ¦‚ç‡åˆ†å¸ƒã€‚</li>
<li>æœ€åç”¨è¿™ä¸ªåˆ†å¸ƒå¯¹ value åšåŠ æƒæ±‚å’Œã€‚</li>
</ol>
<p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹å¦‚ä½•å°†åˆ†æ•°ï¼ˆlogitsï¼‰å½’ä¸€åŒ–ä¸ºæ¦‚ç‡åˆ†å¸ƒï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬éœ€è¦ç”¨åˆ°çš„å°±æ˜¯ Softmax å‡½æ•°ã€‚</p>
<h4 id="3-6-1-1-Softmax-å‡½æ•°"><a href="#3-6-1-1-Softmax-å‡½æ•°" class="headerlink" title="3.6.1.1 Softmax å‡½æ•°"></a>3.6.1.1 Softmax å‡½æ•°</h4><p>Softmax çš„å®šä¹‰æ˜¯ï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><mtext>softmax</mtext><mo stretchy="false">(</mo><mi>v</mi><msub><mo stretchy="false">)</mo><mi>i</mi></msub><mo>=</mo><mfrac><mrow><mi>exp</mi><mo>â¡</mo><mo stretchy="false">(</mo><msub><mi>v</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><mrow><munder><mo>âˆ‘</mo><mi>j</mi></munder><mi>exp</mi><mo>â¡</mo><mo stretchy="false">(</mo><msub><mi>v</mi><mi>j</mi></msub><mo stretchy="false">)</mo></mrow></mfrac></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(12)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">\text{softmax}(v)_i = \frac{\exp(v_i)}{\sum_j \exp(v_j)} \tag{12}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.5488em;vertical-align:-1.1218em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">âˆ‘</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.162em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.4358em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">exp</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop">exp</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.1218em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span><span class="tag"><span class="strut" style="height:2.5488em;vertical-align:-1.1218em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">12</span></span><span class="mord">)</span></span></span></span></span></span></p>
<p>ç›´è§‰ä¸Šï¼Œsoftmax ä¼šæŠŠä»»æ„å®æ•°å‘é‡å˜æˆä¸€ä¸ªéè´Ÿã€å’Œä¸º 1 çš„åˆ†å¸ƒï¼Œå› æ­¤å¸¸ç”¨äºæ³¨æ„åŠ›é‡Œçš„â€œæƒé‡å½’ä¸€åŒ–â€ã€‚ç„¶è€Œï¼Œç›´æ¥ç®— softmax æœ‰ä¸€ä¸ª<strong>æ•°å€¼ç¨³å®šé—®é¢˜</strong>ï¼šå½“ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">v_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> å¾ˆå¤§æ—¶ï¼Œ<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>exp</mi><mo>â¡</mo><mo stretchy="false">(</mo><msub><mi>v</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\exp(v_i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">exp</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> å¯èƒ½æº¢å‡ºå˜æˆ infï¼Œä»è€Œå¯¼è‡´ inf/inf = NaNã€‚ä»”ç»†è§‚å¯Ÿæˆ‘ä»¬å¯ä»¥å‘ç° softmax å¯¹æ‰€æœ‰è¾“å…¥åŒæ—¶åŠ åŒä¸€ä¸ªå¸¸æ•°ä¸å˜ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹ä»»æ„å¸¸æ•° <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">c</span></span></span></span>ï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><mtext>softmax</mtext><mo stretchy="false">(</mo><mi>v</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>softmax</mtext><mo stretchy="false">(</mo><mi>v</mi><mo>+</mo><mi>c</mi><mo stretchy="false">)</mo><mi mathvariant="normal">.</mi></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(13)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">\text{softmax}(v) = \text{softmax}(v + c). \tag{13}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">c</span><span class="mclose">)</span><span class="mord">.</span></span><span class="tag"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">13</span></span><span class="mord">)</span></span></span></span></span></span><br>è¯æ˜å¾ˆç®€å•ï¼šåˆ†å­åˆ†æ¯éƒ½ä¼šå¤šä¹˜ä¸€ä¸ª <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>exp</mi><mo>â¡</mo><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\exp(c)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">exp</span><span class="mopen">(</span><span class="mord mathnormal">c</span><span class="mclose">)</span></span></span></span>ï¼Œä¼šæŠµæ¶ˆæ‰ã€‚å› æ­¤å·¥ç¨‹å®ç°é‡Œé€šå¸¸å–ï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><mi>c</mi><mo>=</mo><mo>âˆ’</mo><mi>max</mi><mo>â¡</mo><msub><mi>v</mi><mi>i</mi></msub><mo separator="true">,</mo></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(14)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">c = -\max v_i, \tag{14}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em;"></span><span class="mord">âˆ’</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">max</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span></span><span class="tag"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">14</span></span><span class="mord">)</span></span></span></span></span></span><br>ä¹Ÿå°±æ˜¯æŠŠæœ€å¤§å€¼å‡åˆ° 0ï¼Œè¿™æ · <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>exp</mi><mo>â¡</mo><mo stretchy="false">(</mo><mo>â‹…</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\exp(\cdot)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">exp</span><span class="mopen">(</span><span class="mord">â‹…</span><span class="mclose">)</span></span></span></span> çš„æœ€å¤§è¾“å…¥ä¸º 0ï¼Œä¸ä¼šçˆ†ç‚¸ï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><mtext>softmax</mtext><mo stretchy="false">(</mo><mi>v</mi><msub><mo stretchy="false">)</mo><mi>i</mi></msub><mo>=</mo><mfrac><mrow><mi>exp</mi><mo>â¡</mo><mo stretchy="false">(</mo><msub><mi>v</mi><mi>i</mi></msub><mo>âˆ’</mo><mi>max</mi><mo>â¡</mo><mo stretchy="false">(</mo><mi>v</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><mrow><munder><mo>âˆ‘</mo><mi>j</mi></munder><mi>exp</mi><mo>â¡</mo><mo stretchy="false">(</mo><msub><mi>v</mi><mi>j</mi></msub><mo>âˆ’</mo><mi>max</mi><mo>â¡</mo><mo stretchy="false">(</mo><mi>v</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow></mfrac><mi mathvariant="normal">.</mi></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(15)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">\text{softmax}(v)_i = \frac{\exp(v_i - \max(v))}{\sum_j \exp(v_j - \max(v))}. \tag{15}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.5488em;vertical-align:-1.1218em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">âˆ‘</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.162em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.4358em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">exp</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mop">max</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">))</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop">exp</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mop">max</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">))</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.1218em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord">.</span></span><span class="tag"><span class="strut" style="height:2.5488em;vertical-align:-1.1218em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">15</span></span><span class="mord">)</span></span></span></span></span></span></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cs336_basics/modules/attention.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">stable_softmax</span>(<span class="params"></span></span><br><span class="line"><span class="params">    logits: torch.Tensor,</span></span><br><span class="line"><span class="params">    dim: <span class="built_in">int</span> = -<span class="number">1</span>,</span></span><br><span class="line"><span class="params"></span>) -&gt; torch.Tensor:</span><br><span class="line">    max_logits = torch.<span class="built_in">max</span>(logits, dim=dim, keepdim=<span class="literal">True</span>).values</span><br><span class="line">    exp_logits = torch.exp(logits - max_logits)</span><br><span class="line">    sum_exp_logits = torch.<span class="built_in">sum</span>(exp_logits, dim=dim, keepdim=<span class="literal">True</span>)</span><br><span class="line">    softmax = exp_logits / sum_exp_logits</span><br><span class="line">    <span class="keyword">return</span> softmax</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="3-6-1-2-ç¼©æ”¾ç‚¹ç§¯æ³¨æ„åŠ›æœºåˆ¶ï¼ˆScaled-Dot-Product-Attentionï¼‰"><a href="#3-6-1-2-ç¼©æ”¾ç‚¹ç§¯æ³¨æ„åŠ›æœºåˆ¶ï¼ˆScaled-Dot-Product-Attentionï¼‰" class="headerlink" title="3.6.1.2 ç¼©æ”¾ç‚¹ç§¯æ³¨æ„åŠ›æœºåˆ¶ï¼ˆScaled Dot Product Attentionï¼‰"></a>3.6.1.2 ç¼©æ”¾ç‚¹ç§¯æ³¨æ„åŠ›æœºåˆ¶ï¼ˆScaled Dot Product Attentionï¼‰</h4><p>æ¥ç€ï¼Œæˆ‘ä»¬æ¥çœ‹Scaled Dot-Product Attentionï¼Œå…¶æ•°å­¦å®šä¹‰ä¸ºï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><mtext>Attention</mtext><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>softmax</mtext><mrow><mo fence="true">(</mo><mfrac><mrow><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup></mrow><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt></mfrac><mo fence="true">)</mo></mrow><mi>V</mi><mo separator="true">,</mo></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(16)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">\text{Attention}(Q, K, V) = \text{softmax}\left(\frac{Q K^T}{\sqrt{d_k}}\right) V, \tag{16}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Attention</span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4684em;vertical-align:-0.95em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.2528em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mpunct">,</span></span><span class="tag"><span class="strut" style="height:2.4684em;vertical-align:-0.95em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">16</span></span><span class="mord">)</span></span></span></span></span></span></p>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mo>âˆˆ</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>n</mi><mo>Ã—</mo><msub><mi>d</mi><mi>k</mi></msub></mrow></msup></mrow><annotation encoding="application/x-tex">Q \in \mathbb{R}^{n \times d_k}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">Ã—</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>ï¼š<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> ä¸ª query</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mo>âˆˆ</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>m</mi><mo>Ã—</mo><msub><mi>d</mi><mi>k</mi></msub></mrow></msup></mrow><annotation encoding="application/x-tex">K \in \mathbb{R}^{m \times d_k}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mbin mtight">Ã—</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>ï¼š<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span> ä¸ª keyï¼ˆä¸ query ä¸€ä¸€å¯¹åº”ï¼‰</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mo>âˆˆ</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>m</mi><mo>Ã—</mo><msub><mi>d</mi><mi>v</mi></msub></mrow></msup></mrow><annotation encoding="application/x-tex">V \in \mathbb{R}^{m \times d_v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mbin mtight">Ã—</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>ï¼š<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span> ä¸ª valueï¼ˆä¸ key ä¸€ä¸€å¯¹åº”ï¼‰</li>
</ul>
<p>è¿™é‡Œçš„ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mn>1</mn><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt></mfrac></mrow><annotation encoding="application/x-tex">\frac{1}{\sqrt{d_k}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.3831em;vertical-align:-0.538em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.5864em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord sqrt mtight"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8622em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mtight" style="padding-left:0.833em;"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8222em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail mtight" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1778em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.538em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span> æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„ç¼©æ”¾é¡¹ï¼šå½“ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">d_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> å˜å¤§æ—¶ï¼Œç‚¹ç§¯çš„æ–¹å·®ä¼šå˜å¤§ï¼Œsoftmax ä¼šæ›´å®¹æ˜“é¥±å’Œï¼ˆå˜å¾—æç«¯å°–é”ï¼‰ï¼Œç¼©æ”¾èƒ½è®©è®­ç»ƒæ›´ç¨³å®šã€‚</p>
<blockquote>
<p><em>We suspect that for large values of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">d_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, the dot products grow large in magnitude, pushing the softmax function into regions where it has extremely small gradients. To counteract this effect, we scale the dot products by <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mn>1</mn><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt></mfrac></mrow><annotation encoding="application/x-tex">\frac{1}{\sqrt{d_k}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.3831em;vertical-align:-0.538em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.5864em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord sqrt mtight"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8622em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mtight" style="padding-left:0.833em;"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8222em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail mtight" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1778em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.538em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>.</em><br>â€”â€” <em>Attention Is All You Need</em>, p.4</p>
</blockquote>
<p>æˆ‘ä»¬æ¥çœ‹ä¸‹é¢çš„å›¾ï¼Œå±•ç¤ºäº†ä¸åŒç¼©æ”¾å› å­å¯¹ softmax åˆ†å¸ƒçš„å½±å“ï¼š</p>
<p><img src="./attention-scaling-factor.png" alt="Attentionçš„ç¼©æ”¾å› å­å¯¹softmaxåˆ†å¸ƒçš„å½±å“ï¼Œå½“$d_k$è¾ƒå¤§æ—¶ï¼Œç¼©æ”¾èƒ½é˜²æ­¢softmaxè¿‡äºå°–é”ã€‚"></p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹ä»£ç å®ç°ï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">scaled_dot_product_attention</span>(<span class="params"></span></span><br><span class="line"><span class="params">    query: torch.Tensor,</span></span><br><span class="line"><span class="params">    key: torch.Tensor,</span></span><br><span class="line"><span class="params">    value: torch.Tensor,</span></span><br><span class="line"><span class="params">    mask: torch.Tensor | <span class="literal">None</span> = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params"></span>) -&gt; torch.Tensor:</span><br><span class="line">    d_k = query.size(-<span class="number">1</span>)</span><br><span class="line">    scores = torch.matmul(query, key.transpose(-<span class="number">2</span>, -<span class="number">1</span>)) / (d_k**<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> mask <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        scores = scores.masked_fill(mask == <span class="number">0</span>, <span class="built_in">float</span>(<span class="string">&quot;-inf&quot;</span>))</span><br><span class="line"></span><br><span class="line">    attn_weights = stable_softmax(scores, dim=-<span class="number">1</span>)</span><br><span class="line">    output = torch.matmul(attn_weights, value)</span><br><span class="line">    <span class="keyword">return</span> output</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p><strong>ğŸ§ª æ ¸å¿ƒåŸç†ï¼šä¸ºä»€ä¹ˆè¦é™¤ä»¥ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt></mrow><annotation encoding="application/x-tex">\sqrt{d_k}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.04em;vertical-align:-0.1828em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span></span></span></span></span></span></span></span></span>?</strong></p>
<p>å‡è®¾ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span></span></span></span> å’Œ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span> ä¸­çš„å…ƒç´ æ˜¯å‡å€¼ä¸º0ã€æ–¹å·®ä¸º1çš„ç‹¬ç«‹éšæœºå˜é‡ã€‚<br>é‚£ä¹ˆå®ƒä»¬çš„ç‚¹ç§¯ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mo>â‹…</mo><msup><mi>K</mi><mi>T</mi></msup><mo>=</mo><msubsup><mo>âˆ‘</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><msub><mi>d</mi><mi>k</mi></msub></msubsup><msub><mi>q</mi><mi>i</mi></msub><msub><mi>k</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">Q \cdot K^T = \sum_{i=1}^{d_k} q_i k_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8413em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2887em;vertical-align:-0.2997em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">âˆ‘</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.989em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> çš„å‡å€¼ä»ä¸º0ï¼Œä½†æ–¹å·®ä¼šå˜æˆ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">d_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>ã€‚</p>
<ul>
<li>å¦‚æœä¸ç¼©æ”¾ï¼Œå½“ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">d_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> å¾ˆå¤§æ—¶ï¼ˆå¦‚ 128 æˆ–æ›´å¤§ï¼‰ï¼Œç‚¹ç§¯çš„ç»“æœæ•°å€¼èŒƒå›´ä¼šéå¸¸å¤§ï¼ˆæ¯”å¦‚è¾¾åˆ°å‡ åç”šè‡³ä¸Šç™¾ï¼‰ã€‚</li>
<li>å°†è¿™äº›å¤§æ•°å€¼è¾“å…¥ Softmaxï¼Œä¼šå¯¼è‡´<strong>æ¢¯åº¦æ¶ˆå¤±</strong>ã€‚å› ä¸º Softmax åœ¨è¾“å…¥å€¼æå¤§æˆ–æå°æ—¶ï¼Œæ¢¯åº¦è¶‹è¿‘äº 0ï¼ˆåˆ†å¸ƒå˜å¾—åƒ One-Hot ä¸€æ ·å°–é”ï¼‰ã€‚</li>
<li>é™¤ä»¥ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt></mrow><annotation encoding="application/x-tex">\sqrt{d_k}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.04em;vertical-align:-0.1828em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span></span></span></span></span></span></span></span></span> å°†æ–¹å·®é‡æ–°æ‹‰å›åˆ° 1ï¼Œä¿è¯äº† Softmax å¤„äºæ¢¯åº¦æ•æ„Ÿçš„åŒºåŸŸï¼Œä»è€Œè®©æ¨¡å‹èƒ½å¤Ÿæ­£å¸¸è®­ç»ƒã€‚</li>
</ul>
</blockquote>
<p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬çœ‹åˆ°æœ‰ä¸€ä¸ª Maskingï¼Œè¿™ä¸ª mask çš„ä½œç”¨æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<hr>
<h4 id="3-6-1-3-å› æœæ©ç ï¼ˆCausal-Maskingï¼‰"><a href="#3-6-1-3-å› æœæ©ç ï¼ˆCausal-Maskingï¼‰" class="headerlink" title="3.6.1.3 å› æœæ©ç ï¼ˆCausal Maskingï¼‰"></a>3.6.1.3 å› æœæ©ç ï¼ˆCausal Maskingï¼‰</h4><p>åœ¨å¾ˆå¤šåœºæ™¯ä¸‹æˆ‘ä»¬éœ€è¦ maskï¼ˆä¾‹å¦‚ causal LM ä¸­ä¸å…è®¸çœ‹æœªæ¥ tokenï¼Œæˆ– padding ä½ç½®ä¸å‚ä¸æ³¨æ„åŠ›ï¼‰ã€‚mask çš„å½¢çŠ¶æ˜¯ï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>M</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>True</mtext></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>False</mtext></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">â€¦</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>False</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>True</mtext></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>True</mtext></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">â€¦</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>False</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">â‹®</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">â‹®</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">â‹±</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">â‹®</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>True</mtext></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>True</mtext></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">â€¦</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>True</mtext></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">
M =
\begin{bmatrix}
\text{True} &amp; \text{False} &amp; \dots &amp; \text{False} \\
\text{True} &amp; \text{True} &amp; \dots &amp; \text{False} \\
\vdots &amp; \vdots &amp; \ddots &amp; \vdots \\
\text{True} &amp; \text{True} &amp; \dots &amp; \text{True}
\end{bmatrix}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:5.46em;vertical-align:-2.48em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.95em;"><span style="top:-4.95em;"><span class="pstrut" style="height:7.4em;"></span><span style="width:0.667em;height:5.400em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="5.400em" viewBox="0 0 667 5400"><path d="M403 1759 V84 H666 V0 H319 V1759 v1800 v1759 h347 v-84
H403z M403 1759 V0 H319 V1759 v1800 v1759 h84z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:2.45em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.98em;"><span style="top:-5.8275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord text"><span class="mord">True</span></span></span></span><span style="top:-4.6275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord text"><span class="mord">True</span></span></span></span><span style="top:-2.7675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">â‹®</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-1.5675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord text"><span class="mord">True</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:2.48em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.98em;"><span style="top:-5.8275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord text"><span class="mord">False</span></span></span></span><span style="top:-4.6275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord text"><span class="mord">True</span></span></span></span><span style="top:-2.7675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">â‹®</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-1.5675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord text"><span class="mord">True</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:2.48em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.98em;"><span style="top:-5.64em;"><span class="pstrut" style="height:3.5em;"></span><span class="mord"><span class="minner">â€¦</span></span></span><span style="top:-4.44em;"><span class="pstrut" style="height:3.5em;"></span><span class="mord"><span class="minner">â€¦</span></span></span><span style="top:-2.58em;"><span class="pstrut" style="height:3.5em;"></span><span class="mord"><span class="minner">â‹±</span></span></span><span style="top:-1.38em;"><span class="pstrut" style="height:3.5em;"></span><span class="mord"><span class="minner">â€¦</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:2.48em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.98em;"><span style="top:-5.8275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord text"><span class="mord">False</span></span></span></span><span style="top:-4.6275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord text"><span class="mord">False</span></span></span></span><span style="top:-2.7675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">â‹®</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-1.5675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord text"><span class="mord">True</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:2.48em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.95em;"><span style="top:-4.95em;"><span class="pstrut" style="height:7.4em;"></span><span style="width:0.667em;height:5.400em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="5.400em" viewBox="0 0 667 5400"><path d="M347 1759 V0 H0 V84 H263 V1759 v1800 v1759 H0 v84 H347z
M347 1759 V0 H263 V1759 v1800 v1759 h84z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:2.45em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>æ³¨æ„è¿™é‡Œæœ‰ä¸ªå°çº¦å®šï¼ˆå®¹æ˜“æ··æ·†ï¼‰ï¼š</p>
<ul>
<li><strong>True</strong> è¡¨ç¤ºå…è®¸ attendï¼ˆä¿¡æ¯æµé€šï¼‰</li>
<li><strong>False</strong> è¡¨ç¤ºä¸å…è®¸ attendï¼ˆéœ€è¦å±è”½ï¼‰</li>
</ul>
<p><img src="./causal_mask.png" alt="Causal Maskç¤ºä¾‹å›¾"></p>
<p>è®¡ç®—ä¸Šï¼Œæˆ‘ä»¬ä¸ä¼šçœŸçš„åˆ æ‰è¢«å±è”½çš„ key/valueï¼ˆé‚£æ ·æ•ˆç‡ä½ï¼‰ï¼Œè€Œæ˜¯åœ¨ softmax ä¹‹å‰çš„æ‰“åˆ†çŸ©é˜µä¸ŠåŠ¨æ‰‹è„šï¼šå¯¹æ‰€æœ‰ mask ä¸º False çš„ä½ç½®åŠ ä¸Š <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>âˆ’</mo><mi mathvariant="normal">âˆ</mi></mrow><annotation encoding="application/x-tex">-\infty</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord">âˆ’</span><span class="mord">âˆ</span></span></span></span>ï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><msub><mi>S</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>S</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo separator="true">,</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>M</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mtext>True</mtext></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>âˆ’</mo><mi mathvariant="normal">âˆ</mi><mo separator="true">,</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>M</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mtext>False</mtext></mrow></mstyle></mtd></mtr></mtable></mrow></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(17)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">
S_{ij} =
\begin{cases}
S_{ij}, &amp; M_{ij} = \text{True} \\
-\infty, &amp; M_{ij} = \text{False}
\end{cases}
\tag{17}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mpunct">,</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord">âˆ’</span><span class="mord">âˆ</span><span class="mpunct">,</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord text"><span class="mord">True</span></span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord text"><span class="mord">False</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span><span class="tag"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">17</span></span><span class="mord">)</span></span></span></span></span></span><br>è¿™æ · softmax åï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><mi>exp</mi><mo>â¡</mo><mo stretchy="false">(</mo><mo>âˆ’</mo><mi mathvariant="normal">âˆ</mi><mo stretchy="false">)</mo><mo>=</mo><mn>0</mn></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(18)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">\exp(-\infty) = 0 \tag{18}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">exp</span><span class="mopen">(</span><span class="mord">âˆ’</span><span class="mord">âˆ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span><span class="tag"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">18</span></span><span class="mord">)</span></span></span></span></span></span><br>å¯¹åº”æƒé‡ä¸¥æ ¼ä¸º 0ï¼Œè¢«å±è”½çš„ä½ç½®è‡ªç„¶ä¸ä¼šå¯¹è¾“å‡ºäº§ç”Ÿè´¡çŒ®ã€‚æœ€ç»ˆè¾“å‡ºæ˜¯ï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><mtext>Attention</mtext><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>softmax</mtext><mo stretchy="false">(</mo><mi>S</mi><mo stretchy="false">)</mo><mi>V</mi></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(19)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">\text{Attention}(Q, K, V) = \text{softmax}(S) V \tag{19}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Attention</span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mclose">)</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span><span class="tag"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">19</span></span><span class="mord">)</span></span></span></span></span></span></p>
<p>åœ¨è¯­è¨€æ¨¡å‹é‡Œï¼Œtoken <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> é¢„æµ‹ä¸‹ä¸€ä¸ªè¯æ—¶ä¸åº”è¯¥è®¿é—® <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> ä¹‹åçš„ token è¡¨ç¤ºï¼Œå¦åˆ™ä¼šæ³„éœ²ç­”æ¡ˆï¼Œè®­ç»ƒç›®æ ‡ä¼šè¢«â€œä½œå¼Šâ€è½»æ˜“å®Œæˆã€‚<br>å®ç°ä¸Šå¯ä»¥ï¼š</p>
<ol>
<li>ç”¨ torch.triuï¼ˆä¸Šä¸‰è§’ï¼‰æ„é€  False åŒºåŸŸï¼Œ</li>
<li>ç”¨å¹¿æ’­æ¯”è¾ƒ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><mo>&lt;</mo><mi>i</mi></mrow><annotation encoding="application/x-tex">j &lt; i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span>ã€‚</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cs336_basics/modules/attention.py</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ©ç”¨ torch.tril åˆ›å»ºå› æœæ©ç </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_create_causal_mask</span>(<span class="params">self, seq_len: <span class="built_in">int</span>, device: torch.device</span>) -&gt; torch.Tensor:</span><br><span class="line">    mask = torch.tril(torch.ones(seq_len, seq_len, device=device)).<span class="built_in">bool</span>()</span><br><span class="line">    <span class="keyword">return</span> mask.unsqueeze(<span class="number">0</span>).unsqueeze(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ©ç”¨å¹¿æ’­æ¯”è¾ƒåˆ›å»ºå› æœæ©ç </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_create_causal_mask</span>(<span class="params">self, seq_len: <span class="built_in">int</span>, device: torch.device</span>) -&gt; torch.Tensor:</span><br><span class="line">    positions = torch.arange(seq_len, device=device)</span><br><span class="line">    mask = positions.unsqueeze(<span class="number">0</span>) &lt;= positions.unsqueeze(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> mask.unsqueeze(<span class="number">0</span>).unsqueeze(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">scaled_dot_product_attention</span>(<span class="params"></span></span><br><span class="line"><span class="params">    query: torch.Tensor,</span></span><br><span class="line"><span class="params">    key: torch.Tensor,</span></span><br><span class="line"><span class="params">    value: torch.Tensor,</span></span><br><span class="line"><span class="params">    mask: torch.Tensor | <span class="literal">None</span> = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params"></span>) -&gt; torch.Tensor:</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> mask <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        scores = scores.masked_fill(mask == <span class="number">0</span>, <span class="built_in">float</span>(<span class="string">&quot;-inf&quot;</span>))</span><br><span class="line"></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Attention çš„æœ¬è´¨ï¼š</strong><br>æ˜¯â€œç›¸ä¼¼åº¦æ‰“åˆ† + softmax å½’ä¸€åŒ– + å¯¹ V åŠ æƒæ±‚å’Œâ€ã€‚å·¥ç¨‹å®ç°æ—¶è¦ç‰¹åˆ«æ³¨æ„ softmax çš„<strong>æ•°å€¼ç¨³å®šæ€§</strong>ï¼ˆå‡æœ€å¤§å€¼ï¼‰å’Œ <strong>masking</strong>ï¼ˆsoftmax å‰åŠ  <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>âˆ’</mo><mi mathvariant="normal">âˆ</mi></mrow><annotation encoding="application/x-tex">-\infty</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord">âˆ’</span><span class="mord">âˆ</span></span></span></span>ï¼‰ï¼Œè¿™ä¸¤ç‚¹å‡ ä¹å†³å®šäº†æ³¨æ„åŠ›å®ç°æ˜¯å¦ç¨³å®šã€æ˜¯å¦é«˜æ•ˆã€‚</p>
</blockquote>
<hr>
<h2 id="3-6-2-å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶ï¼ˆMulti-Headed-Attentionï¼‰"><a href="#3-6-2-å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶ï¼ˆMulti-Headed-Attentionï¼‰" class="headerlink" title="3.6.2 å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶ï¼ˆMulti Headed Attentionï¼‰"></a>3.6.2 å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶ï¼ˆMulti Headed Attentionï¼‰</h2><p>åœ¨å®Œæˆäº†å•ä¸ªAttentionæ¨¡å—ä¹‹åï¼Œæˆ‘ä»¬çœ‹çœ‹è¿™äº›å¦‚ä½•ç»„åˆåœ¨ä¸€èµ·ï¼Œå®ç°æˆ‘ä»¬çš„Multi Headed Attentionã€‚</p>
<blockquote>
<p><em>Instead of performing a single attention function with <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mtext>model</mtext></msub></mrow><annotation encoding="application/x-tex">d_{\text{model}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">model</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>-dimensional keys, values and queries, we found it beneficial to linearly project the queries, keys and values <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">h</span></span></span></span> times with different, learned linear projections to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">d_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">d_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">d_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> dimensions, respectively.</em><br>â€”â€” <em>Attention Is All You Need</em>, p.4</p>
</blockquote>
<p>Multi-head attention çš„å®šä¹‰æ˜¯ï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><mtext>MultiHead</mtext><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>Concat</mtext><mo stretchy="false">(</mo><msub><mtext>head</mtext><mn>1</mn></msub><mo separator="true">,</mo><mo>â€¦</mo><mo separator="true">,</mo><msub><mtext>head</mtext><mi>h</mi></msub><mo stretchy="false">)</mo></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(20)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">\text{MultiHead}(Q, K, V) = \text{Concat}(\text{head}_1, \dots, \text{head}_h) \tag{20}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">MultiHead</span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Concat</span></span><span class="mopen">(</span><span class="mord"><span class="mord text"><span class="mord">head</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">â€¦</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord text"><span class="mord">head</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">h</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span><span class="tag"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">20</span></span><span class="mord">)</span></span></span></span></span></span><br>å…¶ä¸­æ¯ä¸ª head éƒ½æ˜¯ä¸€æ¬¡æ ‡å‡† scaled dot-product attentionï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><msub><mtext>head</mtext><mi>i</mi></msub><mo>=</mo><mtext>Attention</mtext><mo stretchy="false">(</mo><msub><mi>Q</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>K</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>V</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(21)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">\text{head}_i = \text{Attention}(Q_i, K_i, V_i) \tag{21}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord text"><span class="mord">head</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Attention</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span><span class="tag"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">21</span></span><span class="mord">)</span></span></span></span></span></span></p>
<p>è¿™é‡Œçš„ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Q</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>K</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>V</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">Q_i, K_i, V_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> æ˜¯æŠŠ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi></mrow><annotation encoding="application/x-tex">Q, K, V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span> æ²¿ embedding ç»´åº¦åˆ‡åˆ†å¾—åˆ°çš„ç¬¬ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> ä¸ª sliceï¼ˆæ¯ä¸ª head çš„ç»´åº¦æ˜¯ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">d_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> æˆ– <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">d_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>ï¼‰ã€‚</p>
<p>åœ¨ self-attention åœºæ™¯ä¸­ï¼Œ<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi></mrow><annotation encoding="application/x-tex">Q, K, V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span> éƒ½ç”±åŒä¸€ä¸ªè¾“å…¥ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> æŠ•å½±å¾—åˆ°ï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><mtext>MultiHeadSelfAttention</mtext><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mi>W</mi><mi>O</mi></msub><mo>â‹…</mo><mtext>MultiHead</mtext><mo stretchy="false">(</mo><msub><mi>W</mi><mi>Q</mi></msub><mi>x</mi><mo separator="true">,</mo><msub><mi>W</mi><mi>K</mi></msub><mi>x</mi><mo separator="true">,</mo><msub><mi>W</mi><mi>V</mi></msub><mi>x</mi><mo stretchy="false">)</mo></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(22)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">\text{MultiHeadSelfAttention}(x) = W_O \cdot \text{MultiHead}(W_Q x, W_K x, W_V x) \tag{22}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">MultiHeadSelfAttention</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">O</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord text"><span class="mord">MultiHead</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal">x</span><span class="mclose">)</span></span><span class="tag"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">22</span></span><span class="mord">)</span></span></span></span></span></span></p>
<p>å¯å­¦ä¹ å‚æ•°ä¸ºï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><msub><mi>W</mi><mi>Q</mi></msub><mo>âˆˆ</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>h</mi><msub><mi>d</mi><mi>k</mi></msub><mo>Ã—</mo><msub><mi>d</mi><mtext>model</mtext></msub></mrow></msup><mo separator="true">,</mo><mtext>Â </mtext><msub><mi>W</mi><mi>K</mi></msub><mo>âˆˆ</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>h</mi><msub><mi>d</mi><mi>k</mi></msub><mo>Ã—</mo><msub><mi>d</mi><mtext>model</mtext></msub></mrow></msup><mo separator="true">,</mo><mtext>Â </mtext><msub><mi>W</mi><mi>V</mi></msub><mo>âˆˆ</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>h</mi><msub><mi>d</mi><mi>v</mi></msub><mo>Ã—</mo><msub><mi>d</mi><mtext>model</mtext></msub></mrow></msup><mo separator="true">,</mo><mtext>Â </mtext><msub><mi>W</mi><mi>O</mi></msub><mo>âˆˆ</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mtext>model</mtext></msub><mo>Ã—</mo><mi>h</mi><msub><mi>d</mi><mi>v</mi></msub></mrow></msup><mi mathvariant="normal">.</mi></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(23)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">W_Q \in \mathbb{R}^{h d_k \times d_{\text{model}}},\ W_K \in \mathbb{R}^{h d_k \times d_{\text{model}}},\ W_V \in \mathbb{R}^{h d_v \times d_{\text{model}}},\ W_O \in \mathbb{R}^{d_{\text{model}} \times h d_v}. \tag{23}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0935em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span><span class="mbin mtight">Ã—</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">model</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace">Â </span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0935em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span><span class="mbin mtight">Ã—</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">model</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace">Â </span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0935em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mbin mtight">Ã—</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">model</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace">Â </span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">O</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8991em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">model</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span><span class="mbin mtight">Ã—</span><span class="mord mathnormal mtight">h</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mord">.</span></span><span class="tag"><span class="strut" style="height:1.1852em;vertical-align:-0.2861em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">23</span></span><span class="mord">)</span></span></span></span></span></span></p>
<p>ä¸€ä¸ªå¾ˆé‡è¦çš„å·¥ç¨‹è§†è§’æ˜¯ï¼šå› ä¸ºåé¢ä¼šæŠŠè¾“å‡ºç»´åº¦ reshape æˆ (h, head_dim)ï¼Œæ‰€ä»¥ä½ å¯ä»¥æŠŠ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>Q</mi></msub><mo separator="true">,</mo><msub><mi>W</mi><mi>K</mi></msub><mo separator="true">,</mo><msub><mi>W</mi><mi>V</mi></msub></mrow><annotation encoding="application/x-tex">W_Q, W_K, W_V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> çœ‹æˆâ€œæ¯ä¸ª head å„æœ‰ä¸€ä»½æŠ•å½±çŸ©é˜µâ€ï¼Œåªä¸è¿‡å®ƒä»¬åœ¨å®ç°ä¸Šè¢«æ‹¼åˆ°åŒä¸€ä¸ªå¤§çŸ©é˜µé‡Œã€‚</p>
<hr>
<h3 id="3-6-3-å¼ é‡å½¢çŠ¶å˜æ¢"><a href="#3-6-3-å¼ é‡å½¢çŠ¶å˜æ¢" class="headerlink" title="3.6.3 å¼ é‡å½¢çŠ¶å˜æ¢"></a>3.6.3 å¼ é‡å½¢çŠ¶å˜æ¢</h3><p>åœ¨ç»§ç»­å®Œæˆ MHA ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆç†æ¸…æ¥š <strong>shape å˜åŒ–</strong>ã€‚å‡è®¾ï¼š</p>
<ul>
<li>è¾“å…¥ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> çš„ shape æ˜¯ (batch_size, seq_len, d_model)</li>
<li>head æ•°é‡æ˜¯ num_heads</li>
<li>æ¯ä¸ª head çš„ç»´åº¦æ˜¯ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>k</mi></msub><mo>=</mo><msub><mi>d</mi><mtext>model</mtext></msub><mi mathvariant="normal">/</mi><mi mathvariant="normal">/</mi><mtext>num_heads</mtext></mrow><annotation encoding="application/x-tex">d_k = d_{\text{model}} // \text{num\_heads}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">model</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">//</span><span class="mord text"><span class="mord">num_heads</span></span></span></span></span></li>
</ul>
<p>é‚£ä¹ˆï¼Œè®¡ç®— <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi></mrow><annotation encoding="application/x-tex">Q, K, V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span> çš„çº¿æ€§æŠ•å½±åï¼Œæˆ‘ä»¬éœ€è¦æŠŠå®ƒä»¬ reshape æˆ (batch_size, num_heads, seq_len, d_k)ï¼Œä»¥ä¾¿æ¯ä¸ª head ç‹¬ç«‹è®¡ç®—æ³¨æ„åŠ›ã€‚å®ç°ä¸Šé€šå¸¸ç”¨ä»¥ä¸‹ä¸¤æ­¥ï¼š</p>
<ol>
<li>å…ˆç”¨ view æŠŠæœ€åä¸€ç»´æ‹†æˆ (num_heads, d_k)ï¼Œå˜æˆ (batch_size, seq_len, num_heads, d_k)</li>
<li>å†ç”¨ transpose æŠŠ num_heads ç»´åº¦ç§»åˆ°ç¬¬äºŒç»´ï¼Œå˜æˆ (batch_size, num_heads, seq_len, d_k)</li>
</ol>
<p>ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—å®ƒä»¬çš„ scoresï¼š<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Q (batch_size, seq_len, num_heads, d_k) @ K^T (batch_size, num_heads, d_k, seq_len)  -&gt; Score (batch_size, num_heads, seq_len, seq_len)</span><br></pre></td></tr></table></figure></p>
<p>softmax å’Œ mask ä¸ä¼šæ”¹å˜ shapeï¼Œæœ€åå¯¹ V åšåŠ æƒæ±‚å’Œåï¼Œè¾“å‡º shape æ˜¯ (batch_size, num_heads, seq_len, d_v)ã€‚æœ€åä¸€æ­¥æ˜¯æŠŠå¤šå¤´è¾“å‡ºæ‹¼å›åŸå§‹ç»´åº¦ï¼š</p>
<ol>
<li>å…ˆç”¨ transpose æŠŠ num_heads ç»´åº¦ç§»å›ç¬¬ä¸‰ç»´ï¼Œå˜æˆ (batch_size, seq_len, num_heads, d_v)</li>
<li>å†ç”¨ contiguous().view æŠŠæœ€åä¸¤ç»´åˆå¹¶ï¼Œå˜æˆ (batch_size, seq_len, d_model)</li>
<li>æœ€åé€šè¿‡ä¸€ä¸ªçº¿æ€§å±‚ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>O</mi></msub></mrow><annotation encoding="application/x-tex">W_O</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">O</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> æŠ•å½±å›åŸå§‹ç»´åº¦</li>
</ol>
<p>æœ€ç»ˆè¾“å‡º shape æ˜¯ (batch_size, seq_len, d_model)ã€‚</p>
<blockquote>
<p><strong>âš ï¸ è¸©å‘é¢„è­¦ï¼šview, transpose ä¸ contiguous</strong></p>
<ol>
<li><strong>transpose (è½¬ç½®)</strong>: åœ¨ PyTorch ä¸­ï¼Œtranspose æ“ä½œä»…ä»…æ˜¯æ”¹å˜äº†å¼ é‡çš„â€œæ­¥é•¿ (stride)â€å’Œâ€œå½¢çŠ¶ (shape)â€ï¼Œ<strong>å¹¶æ²¡æœ‰çœŸæ­£æ”¹å˜å†…å­˜ä¸­æ•°æ®çš„å­˜å‚¨é¡ºåº</strong>ã€‚</li>
<li><strong>view</strong>: view æ“ä½œè¦æ±‚å¼ é‡åœ¨å†…å­˜ä¸­å¿…é¡»æ˜¯<strong>è¿ç»­ (contiguous)</strong> çš„ã€‚</li>
<li><strong>Crash åŸå› </strong>: å¦‚æœä½ å¯¹ä¸€ä¸ªåˆš transpose è¿‡çš„å¼ é‡ç›´æ¥è°ƒç”¨ viewï¼Œç¨‹åºä¼šæŠ¥é”™ï¼Œå› ä¸ºå†…å­˜æ­¤æ—¶æ˜¯ä¸è¿ç»­çš„ã€‚</li>
<li><strong>contiguous()</strong>: è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯<strong>é‡æ–°å¼€è¾Ÿä¸€å—å†…å­˜</strong>ï¼Œå°†æ•°æ®æŒ‰ç°åœ¨çš„å½¢çŠ¶é¡ºåºå¤åˆ¶è¿›å»ï¼Œä½¿å…¶å˜å›è¿ç»­å­˜å‚¨ã€‚</li>
</ol>
<p><em>ç®€è€Œè¨€ä¹‹ï¼šå…¬å¼ x.transpose(â€¦).contiguous().view(â€¦) æ˜¯æ”¹å˜ç»´åº¦çš„æ ‡å‡†è¿æ‹›ã€‚</em></p>
</blockquote>
<p>shape å˜åŒ–ç¤ºæ„ï¼š<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">x : (B, S, D)</span><br><span class="line">    +--&gt; Q = x W_Q : (B,S,D) --&gt; view (B,S,H,d_k) --&gt; transpose -&gt; (B,H,S,d_k)</span><br><span class="line">    |</span><br><span class="line">    +--&gt; K = x W_K : (B,S,D) --&gt; view (B,S,H,d_k) --&gt; transpose -&gt; (B,H,S,d_k)</span><br><span class="line">    |</span><br><span class="line">    +--&gt; V = x W_V : (B,S,D) --&gt; view (B,S,H,d_k) --&gt; transpose -&gt; (B,H,S,d_k)</span><br><span class="line"></span><br><span class="line">             K^T : (B,H,d_k,S)</span><br><span class="line">scores = Q @ K^T  -----------------&gt; scores : (B,H,S,S)</span><br><span class="line">        (B,H,S,d_k) @ (B,H,d_k,S)</span><br><span class="line"></span><br><span class="line">scores / sqrt(d_k) ----------------&gt; (B,H,S,S)</span><br><span class="line">+ mask (add -inf) -----------------&gt; (B,H,S,S)</span><br><span class="line">softmax (last dim) ----------------&gt; attn : (B,H,S,S)</span><br><span class="line"></span><br><span class="line">out_heads = attn @ V  -------------&gt; out_heads : (B,H,S,d_k)</span><br><span class="line">            (B,H,S,S) @ (B,H,S,d_k)</span><br><span class="line"></span><br><span class="line">transpose(1,2) --------------------&gt; (B,S,H,d_k)</span><br><span class="line">contiguous().view(B,S,D) ----------&gt; out : (B,S,D)</span><br><span class="line">W_O (Linear) ----------------------&gt; y : (B,S,D)</span><br></pre></td></tr></table></figure></p>
<hr>
<h3 id="3-6-4-RoPE-in-Attention"><a href="#3-6-4-RoPE-in-Attention" class="headerlink" title="3.6.4 RoPE in Attention"></a>3.6.4 RoPE in Attention</h3><p>åœ¨ä½¿ç”¨ RoPE çš„ç‰ˆæœ¬ä¸­ï¼Œéœ€è¦å¯¹ Q å’Œ K åšåŒæ ·çš„ä½ç½®æ—‹è½¬ï¼š</p>
<ul>
<li>å¯¹æ¯ä¸ª head çš„ Q åº”ç”¨ RoPE</li>
<li>å¯¹æ¯ä¸ª head çš„ K åº”ç”¨ RoPE</li>
<li><strong>ä¸è¦å¯¹ V åº”ç”¨ RoPE</strong></li>
</ul>
<p>åŸå› æ˜¯ï¼šRoPE å½±å“çš„æ˜¯â€œç›¸ä¼¼åº¦æ‰“åˆ†â€ï¼ˆ<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">Q K^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0358em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span>ï¼‰çš„ç›¸å¯¹ä½ç½®ä¿¡æ¯ï¼›è€Œ V æ˜¯åŠ æƒæ±‡èšçš„å†…å®¹æœ¬èº«ï¼Œé€šå¸¸ä¸éœ€è¦åšæ—‹è½¬ã€‚</p>
<p>å¦å¤–ï¼ŒRoPE çš„ä¸€ä¸ªå®ç°ç»†èŠ‚æ˜¯ï¼šåœ¨ multi-head ä¸­ï¼Œhead ç»´å¯ä»¥è§†ä¸º batch ç»´æ¥å¤„ç†ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒåŒä¸€ä¸ªä½ç½® <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> å¯¹åº”çš„æ—‹è½¬ï¼ˆ<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>cos</mi><mo>â¡</mo><mi mathvariant="normal">/</mi><mi>sin</mi><mo>â¡</mo></mrow><annotation encoding="application/x-tex">\cos/\sin</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">cos</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">/</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">sin</span></span></span></span>ï¼‰åº”è¯¥å¯¹æ‰€æœ‰ head å…±äº«ï¼Œæ¯ä¸ª head ç‹¬ç«‹åš attentionï¼Œä½†æ—‹è½¬è§„åˆ™ä¸€è‡´ã€‚</p>
<p>æœ‰äº†è¿™äº›æ¨¡å—ï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº†æœ€ç»ˆçš„MHAï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cs336_basics/modules/attention.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MHA</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params"></span></span><br><span class="line"><span class="params">        self,</span></span><br><span class="line"><span class="params">        d_model: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">        num_heads: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">        use_rope: <span class="built_in">bool</span> = <span class="literal">False</span>,</span></span><br><span class="line"><span class="params">        theta: <span class="built_in">float</span> = <span class="number">10000.0</span>,</span></span><br><span class="line"><span class="params">        max_seq_len: <span class="built_in">int</span> = <span class="number">2048</span>,</span></span><br><span class="line"><span class="params">        device: torch.device | <span class="literal">None</span> = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">        dtype: torch.dtype | <span class="literal">None</span> = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    </span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">from</span> cs336_basics.modules.linear <span class="keyword">import</span> Linear</span><br><span class="line">        <span class="keyword">from</span> cs336_basics.modules.rope <span class="keyword">import</span> RoPEEmbedding</span><br><span class="line"></span><br><span class="line">        <span class="keyword">assert</span> d_model % num_heads == <span class="number">0</span>, <span class="string">&quot;d_model must be divisible by num_heads&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.d_model = d_model</span><br><span class="line">        <span class="variable language_">self</span>.num_heads = num_heads</span><br><span class="line">        <span class="variable language_">self</span>.d_k = d_model // num_heads</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.q_linear = Linear(d_model, d_model, device=device, dtype=dtype)</span><br><span class="line">        <span class="variable language_">self</span>.k_linear = Linear(d_model, d_model, device=device, dtype=dtype)</span><br><span class="line">        <span class="variable language_">self</span>.v_linear = Linear(d_model, d_model, device=device, dtype=dtype)</span><br><span class="line">        <span class="variable language_">self</span>.out_linear = Linear(d_model, d_model, device=device, dtype=dtype)</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.use_rope = use_rope</span><br><span class="line">        <span class="keyword">if</span> use_rope:</span><br><span class="line">            <span class="variable language_">self</span>.rope = RoPEEmbedding(</span><br><span class="line">                theta=theta,</span><br><span class="line">                d_k=<span class="variable language_">self</span>.d_k,</span><br><span class="line">                max_seq_len=max_seq_len,</span><br><span class="line">                device=device,</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_create_causal_mask</span>(<span class="params">self, seq_len: <span class="built_in">int</span>, device: torch.device</span>) -&gt; torch.Tensor:</span><br><span class="line">        mask = torch.tril(torch.ones(seq_len, seq_len, device=device)).<span class="built_in">bool</span>()</span><br><span class="line">        <span class="keyword">return</span> mask.unsqueeze(<span class="number">0</span>).unsqueeze(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params"></span></span><br><span class="line"><span class="params">        self,</span></span><br><span class="line"><span class="params">        x: torch.Tensor,</span></span><br><span class="line"><span class="params">        token_positions: torch.Tensor | <span class="literal">None</span> = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    </span>) -&gt; torch.Tensor:</span><br><span class="line">        batch_size, seq_len, _ = x.size()</span><br><span class="line">        causal_mask = <span class="variable language_">self</span>._create_causal_mask(seq_len, x.device)</span><br><span class="line"></span><br><span class="line">        Q = <span class="variable language_">self</span>.q_linear(x).view(batch_size, -<span class="number">1</span>, <span class="variable language_">self</span>.num_heads, <span class="variable language_">self</span>.d_k).transpose(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">        K = <span class="variable language_">self</span>.k_linear(x).view(batch_size, -<span class="number">1</span>, <span class="variable language_">self</span>.num_heads, <span class="variable language_">self</span>.d_k).transpose(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">        V = <span class="variable language_">self</span>.v_linear(x).view(batch_size, -<span class="number">1</span>, <span class="variable language_">self</span>.num_heads, <span class="variable language_">self</span>.d_k).transpose(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.use_rope:</span><br><span class="line">            Q, K = <span class="variable language_">self</span>.rope(Q, token_positions), <span class="variable language_">self</span>.rope(K, token_positions)</span><br><span class="line"></span><br><span class="line">        attn_output = scaled_dot_product_attention(Q, K, V, mask=causal_mask)</span><br><span class="line"></span><br><span class="line">        attn_output = attn_output.transpose(<span class="number">1</span>, <span class="number">2</span>).contiguous().view(batch_size, -<span class="number">1</span>, <span class="variable language_">self</span>.d_model)</span><br><span class="line"></span><br><span class="line">        output = <span class="variable language_">self</span>.out_linear(attn_output)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> output</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="3-7-Transformer-å—"><a href="#3-7-Transformer-å—" class="headerlink" title="3.7 Transformer å—"></a>3.7 Transformer å—</h2><p>æœ‰äº†è¿™äº›æ¨¡å—ï¼Œæˆ‘ä»¬å°±å¯ä»¥å’Œæ­ç§¯æœ¨ä¸€æ ·ï¼Œæ­å»ºæˆ‘ä»¬Transformerã€‚</p>
<p>å¯¹è¾“å…¥ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span>ï¼Œç¬¬ä¸€å±‚çš„æ›´æ–°è§„åˆ™æ˜¯ï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><mi>y</mi><mo>=</mo><mi>x</mi><mo>+</mo><mtext>MHA</mtext><mrow><mo fence="true">(</mo><mtext>RMSNorm</mtext><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo fence="true">)</mo></mrow><mi mathvariant="normal">.</mi></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(24)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">y = x + \text{MHA}\left(\text{RMSNorm}(x)\right). \tag{24}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">MHA</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord text"><span class="mord">RMSNorm</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">.</span></span><span class="tag"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">24</span></span><span class="mord">)</span></span></span></span></span></span><br>è¿™å¥è¯å¯ä»¥æ‹†å¼€ç†è§£ä¸ºä¸‰æ­¥ï¼š</p>
<ol>
<li><strong>å½’ä¸€åŒ–</strong>ï¼šå…ˆæŠŠè¾“å…¥ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> åš RMSNormï¼Œå¾—åˆ°æ›´ç¨³å®šçš„è¾“å…¥åˆ†å¸ƒ</li>
<li><strong>ä¸»æ“ä½œ</strong>ï¼šæŠŠå½’ä¸€åŒ–åçš„å‘é‡é€å…¥ MHAï¼Œè®¡ç®—æ³¨æ„åŠ›è¾“å‡º</li>
<li><strong>æ®‹å·®</strong>ï¼šæŠŠæ³¨æ„åŠ›è¾“å‡ºåŠ å›åŸè¾“å…¥ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span>ï¼Œå½¢æˆ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span></li>
</ol>
<h3 id="3-7-0-1-å‰ç½®å½’ä¸€åŒ–ï¼ˆPre-Normï¼‰"><a href="#3-7-0-1-å‰ç½®å½’ä¸€åŒ–ï¼ˆPre-Normï¼‰" class="headerlink" title="3.7.0.1 å‰ç½®å½’ä¸€åŒ–ï¼ˆPre-Normï¼‰"></a>3.7.0.1 å‰ç½®å½’ä¸€åŒ–ï¼ˆPre-Normï¼‰</h3><p>è¿™é‡Œæˆ‘ä»¬é‡‡ç”¨çš„æ˜¯ <strong>Pre-Norm</strong> ç»“æ„ï¼Œä¹Ÿå°±æ˜¯åœ¨æ¯ä¸ªå­å±‚ï¼ˆMHA æˆ– FFNï¼‰å‰åšå½’ä¸€åŒ–ã€‚Pre-Norm ç›¸å¯¹äº Post-Normï¼ˆå…ˆåšå­å±‚å†å½’ä¸€åŒ–ï¼‰æœ‰å‡ ä¸ªä¼˜ç‚¹ï¼š</p>
<ol>
<li><strong>è®­ç»ƒæ›´ç¨³å®š</strong>ï¼šPre-Norm å¯ä»¥ç¼“è§£æ·±å±‚ Transformer çš„æ¢¯åº¦æ¶ˆå¤±é—®é¢˜ï¼Œä½¿å¾—è®­ç»ƒæ›´ç¨³å®šã€‚</li>
<li><strong>æ›´æ·±çš„æ¨¡å‹</strong>ï¼šPre-Norm å…è®¸æˆ‘ä»¬è®­ç»ƒæ›´æ·±çš„ Transformerï¼Œå› ä¸ºæ¯ä¸ªå­å±‚çš„è¾“å…¥éƒ½ç»è¿‡å½’ä¸€åŒ–ï¼Œå‡å°‘äº†å†…éƒ¨åå˜é‡åç§»ã€‚</li>
<li><strong>å¯¹ Learning Rate æ›´ä¸æ•æ„Ÿ</strong>ï¼šPre-Norm ç»“æ„å¯¹å­¦ä¹ ç‡çš„é€‰æ‹©ä¸é‚£ä¹ˆæ•æ„Ÿï¼Œå…è®¸ä½¿ç”¨æ›´å¤§çš„å­¦ä¹ ç‡è¿›è¡Œè®­ç»ƒã€‚</li>
</ol>
<blockquote>
<p><strong>ä¸åŒå½’ä¸€åŒ–ç»“æ„å¯¹æ¯”</strong><br>å½“ç„¶ï¼Œé™¤äº†Pre-Normä¹‹å¤–ï¼Œç°åœ¨ä¹Ÿæœ‰ä¸€äº›å˜ä½“ç»“æ„ï¼Œæ¯”å¦‚ Hybrid Norm(Zhuo et al. 2025)ï¼ˆç»“åˆ Pre-Norm å’Œ Post-Norm çš„ä¼˜ç‚¹ï¼‰ã€‚ä¸‹å›¾æ¯”è¾ƒå±•ç¤ºäº†ä¸åŒç»“æ„ï¼š</p>
</blockquote>
<p><img src="./hybird-norm.png" alt="æ¯”è¾ƒä¸åŒçš„Normalizationç»“æ„ã€‚(a) Post-Normç»“æ„ï¼›(b) Pre-Normç»“æ„ï¼›(c) å¸¦ QK-Norm çš„ Pre-Norm ç»“æ„ï¼›(d) HybridNorm ç»“æ„"></p>
<p>Transformer Block çš„ä»£ç å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cs336_basics/model.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TransformerBlock</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config: ModelConfig</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.config = config</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.mha = MHA(</span><br><span class="line">            d_model=config.d_model,</span><br><span class="line">            num_heads=config.num_heads,</span><br><span class="line">            use_rope=config.use_rope,</span><br><span class="line">            theta=config.rope_theta,</span><br><span class="line">            max_seq_len=config.max_seq_len,</span><br><span class="line">        )</span><br><span class="line">        <span class="variable language_">self</span>.ffn = FFN(</span><br><span class="line">            d_model=config.d_model,</span><br><span class="line">            d_ff=config.d_ff,</span><br><span class="line">        )</span><br><span class="line">        <span class="variable language_">self</span>.norm1 = RMSNorm(config.d_model)</span><br><span class="line">        <span class="variable language_">self</span>.norm2 = RMSNorm(config.d_model)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x: torch.Tensor, token_positions: torch.Tensor | <span class="literal">None</span> = <span class="literal">None</span></span>) -&gt; torch.Tensor:</span><br><span class="line">        x = x + <span class="variable language_">self</span>.mha(<span class="variable language_">self</span>.norm1(x), token_positions=token_positions) </span><br><span class="line">        x = x + <span class="variable language_">self</span>.ffn(<span class="variable language_">self</span>.norm2(x)) </span><br><span class="line">        <span class="keyword">return</span> x</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="3-8-è¾“å‡ºå±‚ï¼ˆOutput-Layerï¼‰"><a href="#3-8-è¾“å‡ºå±‚ï¼ˆOutput-Layerï¼‰" class="headerlink" title="3.8 è¾“å‡ºå±‚ï¼ˆOutput Layerï¼‰"></a>3.8 è¾“å‡ºå±‚ï¼ˆOutput Layerï¼‰</h2><p>åœ¨å †å å®Œè‹¥å¹²ä¸ª Transformer blocks ä¹‹åï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°æ¯ä¸ªä½ç½®çš„æœ€ç»ˆ hidden statesï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><mi>H</mi><mo>âˆˆ</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>B</mi><mo>Ã—</mo><mi>T</mi><mo>Ã—</mo><msub><mi>d</mi><mtext>model</mtext></msub></mrow></msup></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(25)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">H \in \mathbb{R}^{B \times T \times d_{\text{model}}} \tag{25}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8991em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span><span class="mbin mtight">Ã—</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span><span class="mbin mtight">Ã—</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">model</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="tag"><span class="strut" style="height:1.1491em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">25</span></span><span class="mord">)</span></span></span></span></span></span></p>
<p>æ¥ä¸‹æ¥éœ€è¦ä¸€ä¸ª <strong>Output Layer (LM Head)</strong> æŠŠ hidden states æ˜ å°„åˆ°è¯è¡¨å¤§å°çš„ logitsï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><mtext>logits</mtext><mo>=</mo><mi>H</mi><msub><mi>W</mi><mtext>out</mtext></msub></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(26)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">\text{logits} = H W_{\text{out}} \tag{26}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">logits</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">out</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="tag"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">26</span></span><span class="mord">)</span></span></span></span></span></span></p>
<p>å…¶ä¸­ï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><msub><mi>W</mi><mtext>out</mtext></msub><mo>âˆˆ</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mtext>model</mtext></msub><mo>Ã—</mo><mi mathvariant="normal">âˆ£</mi><mi>V</mi><mi mathvariant="normal">âˆ£</mi></mrow></msup><mo separator="true">,</mo><mtext>Â logits</mtext><mo>âˆˆ</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>B</mi><mo>Ã—</mo><mi>T</mi><mo>Ã—</mo><mi mathvariant="normal">âˆ£</mi><mi>V</mi><mi mathvariant="normal">âˆ£</mi></mrow></msup><mi mathvariant="normal">.</mi></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(27)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">W_{\text{out}} \in \mathbb{R}^{d_{\text{model}} \times |V|},\ \text{logits} \in \mathbb{R}^{B \times T \times |V|}. \tag{27}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">out</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1324em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">model</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span><span class="mbin mtight">Ã—</span><span class="mord mtight">âˆ£</span><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span><span class="mord mtight">âˆ£</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace">Â </span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord">logits</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.938em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span><span class="mbin mtight">Ã—</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span><span class="mbin mtight">Ã—</span><span class="mord mtight">âˆ£</span><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span><span class="mord mtight">âˆ£</span></span></span></span></span></span></span></span></span><span class="mord">.</span></span><span class="tag"><span class="strut" style="height:1.188em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">27</span></span><span class="mord">)</span></span></span></span></span></span></p>
<p>åœ¨å¾ˆå¤šç°ä»£ LLM ä¸­ï¼Œé€šå¸¸è¿˜ä¼šåœ¨è¾“å‡ºå±‚å‰åŠ ä¸€ä¸ªæœ€ç»ˆå½’ä¸€åŒ–ï¼ˆåŒæ ·æ˜¯ Pre-Norm é£æ ¼ï¼‰ï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><mtext>logits</mtext><mo>=</mo><mtext>RMSNorm</mtext><mo stretchy="false">(</mo><mi>H</mi><mo stretchy="false">)</mo><msub><mi>W</mi><mtext>out</mtext></msub><mi mathvariant="normal">.</mi></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(28)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">\text{logits} = \text{RMSNorm}(H) W_{\text{out}}. \tag{28}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">logits</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">RMSNorm</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">out</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">.</span></span><span class="tag"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">28</span></span><span class="mord">)</span></span></span></span></span></span></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cs336_basics/model.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OutputLayer</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, d_model, vocab_size, use_norm: <span class="built_in">bool</span> = <span class="literal">False</span></span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="variable language_">self</span>.linear = Linear(d_model, vocab_size)</span><br><span class="line">        <span class="variable language_">self</span>.norm = RMSNorm(d_model) <span class="keyword">if</span> use_norm <span class="keyword">else</span> nn.Identity()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x: torch.Tensor</span>) -&gt; torch.Tensor:</span><br><span class="line">        x = <span class="variable language_">self</span>.norm(x)</span><br><span class="line">        logits = <span class="variable language_">self</span>.linear(x)</span><br><span class="line">        <span class="keyword">return</span> logits</span><br></pre></td></tr></table></figure>
<h3 id="3-8-1-æƒé‡å…±äº«ï¼ˆWeight-Tyingï¼‰"><a href="#3-8-1-æƒé‡å…±äº«ï¼ˆWeight-Tyingï¼‰" class="headerlink" title="3.8.1 æƒé‡å…±äº«ï¼ˆWeight Tyingï¼‰"></a>3.8.1 æƒé‡å…±äº«ï¼ˆWeight Tyingï¼‰</h3><p>å¦‚æœæ¨¡å‹é‡Œæœ‰ token embedding çŸ©é˜µ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi><mo>âˆˆ</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi mathvariant="normal">âˆ£</mi><mi>V</mi><mi mathvariant="normal">âˆ£</mi><mo>Ã—</mo><msub><mi>d</mi><mtext>model</mtext></msub></mrow></msup></mrow><annotation encoding="application/x-tex">E \in \mathbb{R}^{|V| \times d_{\text{model}}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.888em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">âˆ£</span><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span><span class="mord mtight">âˆ£</span><span class="mbin mtight">Ã—</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">model</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>ï¼Œé‚£ä¹ˆå¸¸è§çš„åšæ³•æ˜¯<strong>å…±äº«è¾“å…¥ embedding å’Œè¾“å‡ºæŠ•å½±æƒé‡ï¼ˆweight tyingï¼‰</strong>ï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><msub><mi>W</mi><mtext>out</mtext></msub><mo>=</mo><msup><mi>E</mi><mi>T</mi></msup><mi mathvariant="normal">.</mi></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(29)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">W_{\text{out}} = E^T. \tag{29}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">out</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8913em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mord">.</span></span><span class="tag"><span class="strut" style="height:1.1413em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">29</span></span><span class="mord">)</span></span></span></span></span></span></p>
<p>è¿™æ ·å¯ä»¥å‡å°‘å‚æ•°é‡ï¼Œå¹¶ä¸”ç»å¸¸å¸¦æ¥æ›´å¥½çš„è®­ç»ƒç¨³å®šæ€§ä¸æ³›åŒ–æ•ˆæœã€‚</p>
<hr>
<h2 id="3-9-å®Œæ•´-Transformer-æ¨¡å‹"><a href="#3-9-å®Œæ•´-Transformer-æ¨¡å‹" class="headerlink" title="3.9 å®Œæ•´ Transformer æ¨¡å‹"></a>3.9 å®Œæ•´ Transformer æ¨¡å‹</h2><p>å½“æˆ‘ä»¬å®ç°å®Œ embeddingã€Transformer blockï¼ˆMHA + FFNï¼‰ã€ä»¥åŠè¾“å‡ºå±‚ä¹‹åï¼Œå°±å¯ä»¥æŒ‰ç…§ Figure 1 çš„é«˜å±‚ç»“æ„æŠŠæ•´ä¸ªè¯­è¨€æ¨¡å‹ä¸²èµ·æ¥äº†ã€‚æ•´ä½“æµç¨‹å¯ä»¥æ¦‚æ‹¬ä¸ºä¸‰æ­¥ï¼š</p>
<ol>
<li><strong>Token Embedding</strong>ï¼šæŠŠ token id æ˜ å°„åˆ°å‘é‡è¡¨ç¤º</li>
<li><strong>å †å  num_layers ä¸ª Transformer Blocks</strong></li>
<li><strong>Output Layers</strong>ï¼šæ˜ å°„åˆ°è¯è¡¨åˆ†å¸ƒ</li>
</ol>
<p>å…·ä½“çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cs336_basics/model.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TransformerLM</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config: ModelConfig</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.config = config</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.token_embedding = nn.Embedding(config.vocab_size, config.d_model)</span><br><span class="line">        <span class="variable language_">self</span>.layers = nn.ModuleList([TransformerBlock(config) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(config.num_layers)])</span><br><span class="line">        <span class="variable language_">self</span>.final_norm = RMSNorm(config.d_model)</span><br><span class="line">        <span class="variable language_">self</span>.output_layer = OutputLayer(config.d_model, config.vocab_size, use_norm=config.use_final_norm)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> config.tie_weights:</span><br><span class="line">            <span class="variable language_">self</span>._tie_weights()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x: torch.Tensor, token_positions: torch.Tensor | <span class="literal">None</span> = <span class="literal">None</span></span>) -&gt; torch.Tensor:</span><br><span class="line">        x = <span class="variable language_">self</span>.token_embedding(x)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> layer <span class="keyword">in</span> <span class="variable language_">self</span>.layers:</span><br><span class="line">            x = layer(x, token_positions=token_positions)</span><br><span class="line"></span><br><span class="line">        x = <span class="variable language_">self</span>.final_norm(x)</span><br><span class="line">        logits = <span class="variable language_">self</span>.output_layer(x)</span><br><span class="line">        <span class="keyword">return</span> logits</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_tie_weights</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.output_layer.linear.weight = <span class="variable language_">self</span>.token_embedding.weight</span><br></pre></td></tr></table></figure>
<p>token ids â†’ embedding å¾—åˆ° <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">X_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> â†’ ç»è¿‡ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi></mrow><annotation encoding="application/x-tex">L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">L</span></span></span></span> ä¸ª Transformer blocks å¾—åˆ° <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>H</mi></mrow><annotation encoding="application/x-tex">H</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span></span></span></span> â†’ è¾“å‡ºå¤´ï¼ˆnorm + linear + softmaxï¼‰å¾—åˆ°è¯è¡¨åˆ†å¸ƒï¼Œç”¨äº next-token predictionã€‚</p>
<hr>
<h2 id="3-10-Part-02-æ€»ç»“"><a href="#3-10-Part-02-æ€»ç»“" class="headerlink" title="3.10 Part 02 æ€»ç»“"></a>3.10 Part 02 æ€»ç»“</h2><p>æ€»çš„æ¥è¯´ï¼ŒPart 02 å°±æ˜¯åœ¨ Part 01 çš„ Tokenization ä¹‹åï¼ŒæŠŠâ€œèƒ½è®­ç»ƒçš„è¯­è¨€æ¨¡å‹â€çœŸæ­£æ­èµ·æ¥ï¼šæˆ‘ä»¬ä»æœ€åŸºç¡€çš„ Linear / Embedding å‡ºå‘ï¼Œé€æ­¥å®ç° RMSNormï¼ˆPre-Normï¼‰ã€ç°ä»£ LLM å¸¸ç”¨çš„ SwiGLU-FFNï¼Œå†åˆ°æœ€æ ¸å¿ƒä¹Ÿæœ€å®¹æ˜“å†™é”™çš„ï¼ˆRoPE + Causalï¼‰Multi-Head Self-Attentionï¼Œæœ€ç»ˆåƒæ­ç§¯æœ¨ä¸€æ ·ç»„è£…å‡ºå®Œæ•´çš„ TransformerBlockï¼Œå¹¶ä¸²è”æˆ TransformerLMï¼Œé€šè¿‡ Output Layer è¾“å‡º vocabulary logits ç”¨äº next-token predictionã€‚</p>
<p>è¿™ä¸€éƒ¨åˆ†æœ€å€¼å¾—è®°ä½çš„å·¥ç¨‹è¦ç‚¹æœ‰ä¸‰ç±»ï¼š</p>
<ul>
<li><strong>ç¨³å®šæ€§ï¼ˆstabilityï¼‰</strong>ï¼šSoftmax çš„æ•°å€¼ç¨³å®šï¼ˆå‡ maxï¼‰ã€Pre-Normï¼ˆRMSNorm æ”¾åœ¨å­å±‚å‰ï¼‰ã€ä»¥åŠ causal mask é˜²æ­¢æœªæ¥ä¿¡æ¯æ³„éœ²ï¼Œéƒ½æ˜¯â€œè®­ç»ƒèƒ½ä¸èƒ½è·‘èµ·æ¥â€çš„å…³é”®ã€‚</li>
<li><strong>æ•ˆç‡ï¼ˆefficiencyï¼‰</strong>ï¼šQ/K/V æŠ•å½±åº”å½“æ˜¯ 3 æ¬¡çŸ©é˜µä¹˜æ³•ï¼ˆæ›´è¿›ä¸€æ­¥å¯ä»¥åˆæˆ 1 æ¬¡ï¼‰ã€mask ç”¨â€œsoftmax å‰åŠ  <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>âˆ’</mo><mi mathvariant="normal">âˆ</mi></mrow><annotation encoding="application/x-tex">-\infty</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord">âˆ’</span><span class="mord">âˆ</span></span></span></span>â€è€Œä¸æ˜¯åˆ‡å­åºåˆ—ã€RoPE ç”¨é¢„è®¡ç®—çš„ sin/cos buffer å¤ç”¨è·¨ batch/è·¨å±‚ã€é¿å…æ˜¾å¼æ„é€  <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo>Ã—</mo><mi>d</mi></mrow><annotation encoding="application/x-tex">d \times d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span> æ—‹è½¬çŸ©é˜µã€‚</li>
<li><strong>ç»“æ„ï¼ˆarchitectureï¼‰</strong>ï¼šç°ä»£ LLM çš„ Block åŸºæœ¬éƒ½éµå¾ªâ€œRMSNorm â†’ MHA/FFN â†’ Residualâ€çš„ Pre-Norm æ¨¡å¼ï¼›FFN å¸¸ç”¨ SwiGLUï¼ˆæ¿€æ´» + gatingï¼‰ï¼›RoPE åªä½œç”¨åœ¨ Q/Kï¼ˆä¸ä½œç”¨åœ¨ Vï¼‰ï¼›æœ€åå†æ¥ä¸€ä¸ªè¾“å‡ºå¤´ï¼ˆå¯é€‰ final norm / weight tyingï¼‰æŠŠ hidden states æ˜ å°„åˆ°è¯è¡¨åˆ†å¸ƒã€‚</li>
</ul>
<blockquote>
<p><strong>ğŸ’¾ æ‹“å±•çŸ¥è¯†ï¼šLLM å‚æ•°é‡ä¸æ˜¾å­˜ä¼°ç®—</strong></p>
<p>æˆ‘ä»¬å®šä¹‰çš„æ¨¡å‹é…ç½® d_model=512, num_layers=4 æ˜¯éå¸¸å°çš„ã€‚å¦‚æœæ˜¯çœŸå®çš„ 7B (70äº¿å‚æ•°) æ¨¡å‹ï¼Œå¦‚ä½•ä¼°ç®—æ˜¾å­˜ï¼Ÿ</p>
<ol>
<li><strong>æ¨¡å‹æƒé‡</strong>: å‡è®¾ä½¿ç”¨ FP16 (16-bit floating point)ï¼Œæ¯ä¸ªå‚æ•°å  2 Bytesã€‚7B æ¨¡å‹æƒé‡çº¦ä¸º <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>7</mn><mo>Ã—</mo><msup><mn>10</mn><mn>9</mn></msup><mo>Ã—</mo><mn>2</mn><mtext>B</mtext><mo>â‰ˆ</mo><mn>14</mn><mtext>GB</mtext></mrow><annotation encoding="application/x-tex">7 \times 10^9 \times 2 \text{B} \approx 14 \text{GB}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">7</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">9</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">2</span><span class="mord text"><span class="mord">B</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â‰ˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">14</span><span class="mord text"><span class="mord">GB</span></span></span></span></span>ã€‚</li>
<li><strong>KV Cache (æ¨ç†æ—¶)</strong>: éšç€ Context Length å¢åŠ ï¼ŒKV Cache ä¼šå ç”¨å¤§é‡æ˜¾å­˜ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦ Multi-Query Attention (MQA) æˆ– Grouped-Query Attention (GQA) ç­‰æŠ€æœ¯çš„åŸå› ï¼ˆè™½ç„¶æœ¬ Assignment ä½¿ç”¨çš„æ˜¯æ ‡å‡†çš„ MHAï¼‰ã€‚</li>
<li><strong>ä¼˜åŒ–å™¨çŠ¶æ€ (è®­ç»ƒæ—¶)</strong>: AdamW ä¼˜åŒ–å™¨éœ€è¦ä¿å­˜ä¸€é˜¶å’ŒäºŒé˜¶åŠ¨é‡ï¼Œé€šå¸¸éœ€è¦æ¨¡å‹æƒé‡ 2-3 å€çš„æ˜¾å­˜ã€‚</li>
</ol>
</blockquote>
<hr>
<h1 id="4-Part-03-ä¼˜åŒ–å™¨ï¼ˆOptimizerï¼‰ä¸è®­ç»ƒä»£ç "><a href="#4-Part-03-ä¼˜åŒ–å™¨ï¼ˆOptimizerï¼‰ä¸è®­ç»ƒä»£ç " class="headerlink" title="4 Part 03: ä¼˜åŒ–å™¨ï¼ˆOptimizerï¼‰ä¸è®­ç»ƒä»£ç "></a>4 Part 03: ä¼˜åŒ–å™¨ï¼ˆOptimizerï¼‰ä¸è®­ç»ƒä»£ç </h1><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥å®ç°è®­ç»ƒè¯­è¨€æ¨¡å‹æ‰€éœ€çš„ç¬¬ä¸‰éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯å®šä¹‰æˆ‘ä»¬çš„Loss Functionï¼Œä»¥åŠOptimizerå’ŒLearning Rate Schedulerã€‚</p>
<hr>
<h2 id="4-1-æŸå¤±ï¼ˆLossï¼‰ä¸-å›°æƒ‘åº¦ï¼ˆPerplexityï¼‰"><a href="#4-1-æŸå¤±ï¼ˆLossï¼‰ä¸-å›°æƒ‘åº¦ï¼ˆPerplexityï¼‰" class="headerlink" title="4.1 æŸå¤±ï¼ˆLossï¼‰ä¸ å›°æƒ‘åº¦ï¼ˆPerplexityï¼‰"></a>4.1 æŸå¤±ï¼ˆLossï¼‰ä¸ å›°æƒ‘åº¦ï¼ˆPerplexityï¼‰</h2><p>æˆ‘ä»¬å…ˆæ¥å®šä¹‰æˆ‘ä»¬çš„Loss Functionï¼Œåœ¨ç¥ç»ç½‘ç»œè®­ç»ƒä¸­ï¼ŒLoss Functionï¼ˆæŸå¤±å‡½æ•°ï¼‰ç”¨äºè¡¡é‡æ¨¡å‹é¢„æµ‹ä¸çœŸå®æ ‡ç­¾ä¹‹é—´çš„å·®è·ã€‚å¯¹äºè¯­è¨€æ¨¡å‹ï¼Œæˆ‘ä»¬çš„æŸå¤±å‡½æ•°æ˜¯äº¤å‰ç†µæŸå¤±ï¼ˆCross Entropy Lossï¼‰ã€‚</p>
<h3 id="4-1-1-äº¤å‰ç†µæŸå¤±ï¼ˆCross-Entropy-Lossï¼‰"><a href="#4-1-1-äº¤å‰ç†µæŸå¤±ï¼ˆCross-Entropy-Lossï¼‰" class="headerlink" title="4.1.1 äº¤å‰ç†µæŸå¤±ï¼ˆCross Entropy Lossï¼‰"></a>4.1.1 äº¤å‰ç†µæŸå¤±ï¼ˆCross Entropy Lossï¼‰</h3><p>åœ¨ç°ä»£å¸¸è§çš„è¯­è¨€æ¨¡å‹æ˜¯Next-Token Predictionæ¨¡å‹ï¼Œå…¶è®­ç»ƒç›®æ ‡æ˜¯é¢„æµ‹ä¸‹ä¸€ä¸ªtokenï¼Œä¹Ÿå°±æ˜¯ç»™å®šå‰é¢ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span> ä¸ª tokenï¼Œé¢„æµ‹ç¬¬ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">t+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6984em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> ä¸ª token çš„æ¦‚ç‡åˆ†å¸ƒï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><mi>P</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mi mathvariant="normal">âˆ£</mi><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>â€¦</mo><mo separator="true">,</mo><msub><mi>x</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(30)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">P(x_{t+1}|x_1,x_2,\dots,x_t) \tag{30}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mord">âˆ£</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">â€¦</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span><span class="tag"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">30</span></span><span class="mord">)</span></span></span></span></span></span></p>
<p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªé•¿åº¦ä¸º <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi></mrow><annotation encoding="application/x-tex">T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span> çš„è®­ç»ƒåºåˆ— <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>â€¦</mo><mo separator="true">,</mo><msub><mi>x</mi><mi>T</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(x_1, x_2, \dots, x_T)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">â€¦</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>ï¼Œé‚£ä¹ˆæ¨¡å‹çš„ç›®æ ‡æ˜¯æœ€å¤§åŒ–æ•´ä¸ªåºåˆ—çš„è”åˆæ¦‚ç‡ï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><mi>P</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>â€¦</mo><mo separator="true">,</mo><msub><mi>x</mi><mi>T</mi></msub><mo stretchy="false">)</mo><mo>=</mo><munderover><mo>âˆ</mo><mrow><mi>t</mi><mo>=</mo><mn>1</mn></mrow><mi>T</mi></munderover><mi>P</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>t</mi></msub><mi mathvariant="normal">âˆ£</mi><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>â€¦</mo><mo separator="true">,</mo><msub><mi>x</mi><mrow><mi>t</mi><mo>âˆ’</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(31)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">P(x_1, x_2, \dots, x_T) = \prod_{t=1}^T P(x_t|x_1, x_2, \dots, x_{t-1}) \tag{31}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">â€¦</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.0954em;vertical-align:-1.2671em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8829em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.2671em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">âˆ£</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">â€¦</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span><span class="tag"><span class="strut" style="height:3.0954em;vertical-align:-1.2671em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">31</span></span><span class="mord">)</span></span></span></span></span></span></p>
<p>ä¸ºäº†å®ç°è¿™ä¸ªç›®æ ‡ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨äº¤å‰ç†µæŸå¤±ï¼ˆCross Entropy Lossï¼‰æ¥è¡¡é‡æ¨¡å‹é¢„æµ‹çš„æ¦‚ç‡åˆ†å¸ƒä¸çœŸå®åˆ†å¸ƒä¹‹é—´çš„å·®å¼‚ã€‚Cross Entropy Loss å¸¸ç”¨äºåˆ†ç±»ä»»åŠ¡ä¸­ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><mi mathvariant="script">L</mi><mo>=</mo><mo>âˆ’</mo><mfrac><mn>1</mn><mi>N</mi></mfrac><munderover><mo>âˆ‘</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></munderover><munderover><mo>âˆ‘</mo><mrow><mi>c</mi><mo>=</mo><mn>1</mn></mrow><mi>C</mi></munderover><msub><mi>y</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>c</mi></mrow></msub><mi>ln</mi><mo>â¡</mo><mo stretchy="false">(</mo><msub><mi>p</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>c</mi></mrow></msub><mo stretchy="false">)</mo></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(32)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">\mathcal{L} = -\frac{1}{N} \sum_{i=1}^N \sum_{c=1}^C y_{i,c} \ln(p_{i,c}) \tag{32}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathcal">L</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.106em;vertical-align:-1.2777em;"></span><span class="mord">âˆ’</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8829em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.2671em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">ln</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span><span class="tag"><span class="strut" style="height:3.106em;vertical-align:-1.2777em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">32</span></span><span class="mord">)</span></span></span></span></span></span></p>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> æ˜¯æ ·æœ¬æ•°é‡ï¼ˆåœ¨è¯­è¨€æ¨¡å‹ä¸­é€šå¸¸æ˜¯æ‰€æœ‰æ—¶é—´æ­¥çš„ token æ•°é‡ï¼‰</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi></mrow><annotation encoding="application/x-tex">C</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span> æ˜¯ç±»åˆ«æ•°é‡ï¼ˆè¯­è¨€æ¨¡å‹ä¸­æ˜¯è¯è¡¨å¤§å°ï¼‰</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>c</mi></mrow></msub></mrow><annotation encoding="application/x-tex">y_{i,c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> æ˜¯æ ·æœ¬ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> çš„çœŸå®æ ‡ç­¾çš„ one-hot ç¼–ç ï¼ˆå¦‚æœæ ·æœ¬ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> çš„çœŸå®ç±»åˆ«æ˜¯ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>c</mi><mo>âˆ—</mo></msup></mrow><annotation encoding="application/x-tex">c^*</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6887em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6887em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">âˆ—</span></span></span></span></span></span></span></span></span></span></span>ï¼Œåˆ™ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mrow><mi>i</mi><mo separator="true">,</mo><msup><mi>c</mi><mo>âˆ—</mo></msup></mrow></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">y_{i,c^*}=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6183em;"><span style="top:-2.786em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mbin mtight">âˆ—</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>ï¼Œå…¶ä»–ç±»åˆ«ä¸º 0ï¼‰</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>c</mi></mrow></msub></mrow><annotation encoding="application/x-tex">p_{i,c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">c</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> æ˜¯æ¨¡å‹å¯¹æ ·æœ¬ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> é¢„æµ‹ä¸ºç±»åˆ« <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">c</span></span></span></span> çš„æ¦‚ç‡ã€‚</li>
</ul>
<p>å®ç°è¿™ä¸ªæŸå¤±å‡½æ•°æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šç»“åˆ softmax ä¸€èµ·ä½¿ç”¨ï¼Œå› ä¸ºæ¨¡å‹è¾“å‡ºçš„ logits éœ€è¦å…ˆç»è¿‡ softmax è½¬æ¢ä¸ºæ¦‚ç‡åˆ†å¸ƒã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cs336_basics/loss.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cross_entropy</span>(<span class="params">logits: torch.Tensor, labels: torch.Tensor</span>):</span><br><span class="line">    logits = logits - torch.<span class="built_in">max</span>(logits, dim=<span class="number">1</span>, keepdim=<span class="literal">True</span>).values</span><br><span class="line">    log_probs = logits - torch.log(torch.<span class="built_in">sum</span>(torch.exp(logits), dim=<span class="number">1</span>, keepdim=<span class="literal">True</span>))</span><br><span class="line"></span><br><span class="line">    labels = labels.unsqueeze(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    loss = log_probs.gather(<span class="number">1</span>, labels).squeeze(<span class="number">1</span>) </span><br><span class="line">    loss = -loss.mean()</span><br><span class="line">    <span class="keyword">return</span> loss</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ log_probs.gather(-1, labels) è¿™ä¸€è¡Œä»£ç çš„ä½œç”¨æ˜¯ä» log_probs å¼ é‡ä¸­æå–å‡ºæ¯ä¸ªæ ·æœ¬å¯¹åº”çš„çœŸå®æ ‡ç­¾çš„å¯¹æ•°æ¦‚ç‡å€¼ã€‚å…·ä½“æ¥è¯´ï¼š</p>
<ul>
<li>log_probs çš„ shape æ˜¯ (N, C)ï¼Œè¡¨ç¤º <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> ä¸ªæ ·æœ¬åœ¨ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi></mrow><annotation encoding="application/x-tex">C</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span> ä¸ªç±»åˆ«ä¸Šçš„å¯¹æ•°æ¦‚ç‡åˆ†å¸ƒã€‚</li>
<li>labels çš„ shape æ˜¯ (N, 1)ï¼Œè¡¨ç¤ºæ¯ä¸ªæ ·æœ¬çš„çœŸå®ç±»åˆ«ç´¢å¼•ã€‚</li>
<li>gather(-1, labels) ä¼šæ ¹æ® labels ä¸­çš„ç´¢å¼•ï¼Œä» log_probs çš„ç¬¬äºŒç»´ï¼ˆç±»åˆ«ç»´åº¦ï¼‰ä¸­æå–å¯¹åº”çš„å¯¹æ•°æ¦‚ç‡å€¼ï¼Œç»“æœçš„ shape æ˜¯ (N, 1)ã€‚</li>
</ul>
<p>åœ¨ä½¿ç”¨è¿™ä¸ªäº¤å‰ç†µæŸå¤±å‡½æ•°æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šå°†æ¨¡å‹çš„è¾“å‡º logits å’Œå¯¹åº”çš„çœŸå®æ ‡ç­¾å±•å¼€æˆä¸€ç»´å‘é‡ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œå¯ä»¥ç®€åŒ–è®¡ç®—è¿‡ç¨‹ï¼Œä½¿å¾—æ¯ä¸ªæ—¶é—´æ­¥çš„é¢„æµ‹éƒ½è¢«è§†ä¸ºä¸€ä¸ªç‹¬ç«‹çš„æ ·æœ¬ï¼Œä»è€Œæ–¹ä¾¿è®¡ç®—æ•´ä½“çš„æŸå¤±ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cs336_basics/train_engine.py</span></span><br><span class="line"></span><br><span class="line">logits = model(inputs)</span><br><span class="line">logits = logits.view(-<span class="number">1</span>, logits.size(-<span class="number">1</span>))</span><br><span class="line">targets = targets.view(-<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="4-1-2-å›°æƒ‘åº¦ï¼ˆPerplexityï¼‰"><a href="#4-1-2-å›°æƒ‘åº¦ï¼ˆPerplexityï¼‰" class="headerlink" title="4.1.2 å›°æƒ‘åº¦ï¼ˆPerplexityï¼‰"></a>4.1.2 å›°æƒ‘åº¦ï¼ˆPerplexityï¼‰</h3><p>åœ¨è¯­è¨€æ¨¡å‹ä¸­ï¼Œé™¤äº†äº¤å‰ç†µæŸå¤±ï¼Œæˆ‘ä»¬è¿˜å¸¸ç”¨ä¸€ä¸ªæŒ‡æ ‡å«åšå›°æƒ‘åº¦ï¼ˆPerplexity, PPLï¼‰æ¥è¯„ä¼°æ¨¡å‹çš„æ€§èƒ½ã€‚å›°æƒ‘åº¦è¡¡é‡çš„æ˜¯æ¨¡å‹å¯¹æµ‹è¯•æ•°æ®çš„é¢„æµ‹èƒ½åŠ›ï¼Œæ•°å€¼è¶Šä½è¡¨ç¤ºæ¨¡å‹è¶Šå¥½ã€‚å®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><mtext>PPL</mtext><mo>=</mo><mi>exp</mi><mo>â¡</mo><mrow><mo fence="true">(</mo><mo>âˆ’</mo><mfrac><mn>1</mn><mi>N</mi></mfrac><munderover><mo>âˆ‘</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></munderover><msub><mi mathvariant="script">L</mi><mi>i</mi></msub><mo fence="true">)</mo></mrow></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(33)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">\text{PPL} = \exp\left( -\frac{1}{N} \sum_{i=1}^N \mathcal{L}_i \right) \tag{33}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord text"><span class="mord">PPL</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.106em;vertical-align:-1.2777em;"></span><span class="mop">exp</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">(</span></span><span class="mord">âˆ’</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathcal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size4">)</span></span></span></span><span class="tag"><span class="strut" style="height:3.106em;vertical-align:-1.2777em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">33</span></span><span class="mord">)</span></span></span></span></span></span></p>
<p>å®ƒæ˜¯äº¤å‰ç†µæŸå¤±çš„æŒ‡æ•°å½¢å¼ï¼Œå…¶ä¸­ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="script">L</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\mathcal{L}_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathcal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> æ˜¯ç¬¬ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> ä¸ªæ ·æœ¬çš„äº¤å‰ç†µæŸå¤±ï¼Œ<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> æ˜¯æ ·æœ¬æ€»æ•°ï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰æ—¶é—´æ­¥çš„ token æ•°é‡ã€‚å®ƒçš„ç›´è§‚æ„ä¹‰æ˜¯ï¼šæ¨¡å‹åœ¨é¢„æµ‹ä¸‹ä¸€ä¸ª token æ—¶ï¼Œå¹³å‡æ¯ä¸ª token æœ‰å¤šå°‘ç§å¯èƒ½çš„é€‰æ‹©ã€‚æˆ‘ä»¬å±•å¼€PPLçš„å®šä¹‰ï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><mtext>PPL</mtext><mo>=</mo><mi>exp</mi><mo>â¡</mo><mrow><mo fence="true">(</mo><mo>âˆ’</mo><mfrac><mn>1</mn><mi>N</mi></mfrac><munderover><mo>âˆ‘</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></munderover><mi>ln</mi><mo>â¡</mo><mo stretchy="false">(</mo><msub><mi>p</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo fence="true">)</mo></mrow><mo>=</mo><msup><mrow><mo fence="true">(</mo><munderover><mo>âˆ</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></munderover><mfrac><mn>1</mn><msub><mi>p</mi><mi>i</mi></msub></mfrac><mo fence="true">)</mo></mrow><mfrac><mn>1</mn><mi>N</mi></mfrac></msup></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(34)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">\text{PPL} = \exp\left( -\frac{1}{N} \sum_{i=1}^N \ln(p_i) \right) = \left( \prod_{i=1}^N \frac{1}{p_i} \right)^{\frac{1}{N}} \tag{34}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord text"><span class="mord">PPL</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.106em;vertical-align:-1.2777em;"></span><span class="mop">exp</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">(</span></span><span class="mord">âˆ’</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ‘</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">ln</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size4">)</span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3.4499em;vertical-align:-1.2777em;"></span><span class="minner"><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">(</span></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">âˆ</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.8804em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size4">)</span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:2.1723em;"><span style="top:-4.5812em;margin-right:0.05em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8443em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span style="top:-3.2255em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span></span></span></span></span></span></span></span></span></span><span class="tag"><span class="strut" style="height:3.4499em;vertical-align:-1.2777em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">34</span></span><span class="mord">)</span></span></span></span></span></span></p>
<p>PPL ç­‰ä»·äºâ€œæ¨¡å‹ç»™çœŸå® token çš„æ¦‚ç‡ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span>â€çš„å€’æ•° <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mi mathvariant="normal">/</mi><mi>p</mi></mrow><annotation encoding="application/x-tex">1/p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1/</span><span class="mord mathnormal">p</span></span></span></span> çš„å‡ ä½•å¹³å‡ï¼Œæ‰€ä»¥è¶Šå°è¡¨ç¤ºæ¨¡å‹å¹³å‡ç»™çœŸå€¼çš„æ¦‚ç‡è¶Šå¤§ã€‚</p>
<p>è¿™ä¸ªçœ‹èµ·æ¥å¾ˆæŠ½è±¡ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªå…·ä½“ä¾‹å­ï¼šå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªéå¸¸ç®€å•çš„è¯è¡¨ï¼Œåªæœ‰ 4 ä¸ª tokenï¼š{A, B, C, D}ã€‚ç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ªæµ‹è¯•åºåˆ— B, C, Dï¼Œæ¨¡å‹åœ¨æ¯ä¸ªæ—¶é—´æ­¥çš„é¢„æµ‹æ¦‚ç‡å¦‚ä¸‹ï¼š</p>
<ul>
<li>é¢„æµ‹ B çš„æ¦‚ç‡ï¼š0.5</li>
<li>é¢„æµ‹ C çš„æ¦‚ç‡ï¼š0.25</li>
<li>é¢„æµ‹ D çš„æ¦‚ç‡ï¼š0.1</li>
</ul>
<p>é‚£ä¹ˆï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—è¿™ä¸ªåºåˆ—çš„å›°æƒ‘åº¦ï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><mtext>PPL</mtext><mo>=</mo><mi>exp</mi><mo>â¡</mo><mrow><mo fence="true">(</mo><mo>âˆ’</mo><mfrac><mn>1</mn><mn>3</mn></mfrac><mrow><mo fence="true">(</mo><mi>ln</mi><mo>â¡</mo><mo stretchy="false">(</mo><mn>0.5</mn><mo stretchy="false">)</mo><mo>+</mo><mi>ln</mi><mo>â¡</mo><mo stretchy="false">(</mo><mn>0.25</mn><mo stretchy="false">)</mo><mo>+</mo><mi>ln</mi><mo>â¡</mo><mo stretchy="false">(</mo><mn>0.1</mn><mo stretchy="false">)</mo><mo fence="true">)</mo></mrow><mo fence="true">)</mo></mrow><mo>â‰ˆ</mo><mn>4.64</mn></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(35)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">\text{PPL} = \exp\left( -\frac{1}{3} \left( \ln(0.5) + \ln(0.25) + \ln(0.1) \right) \right) \approx 4.64 \tag{35}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord text"><span class="mord">PPL</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="mop">exp</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord">âˆ’</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mop">ln</span><span class="mopen">(</span><span class="mord">0.5</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mop">ln</span><span class="mopen">(</span><span class="mord">0.25</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mop">ln</span><span class="mopen">(</span><span class="mord">0.1</span><span class="mclose">)</span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â‰ˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">4.64</span></span><span class="tag"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">35</span></span><span class="mord">)</span></span></span></span></span></span></p>
<p>è¿™æ„å‘³ç€ï¼Œæ¨¡å‹åœ¨é¢„æµ‹ä¸‹ä¸€ä¸ª token æ—¶ï¼Œå¹³å‡æ¯ä¸ª token æœ‰å¤§çº¦ 4.64 ç§å¯èƒ½çš„é€‰æ‹©ã€‚å› ä¸ºè¯è¡¨åªæœ‰ 4 ä¸ª tokenï¼Œè¿™ä¸ªå›°æƒ‘åº¦è¡¨æ˜æ¨¡å‹çš„é¢„æµ‹èƒ½åŠ›è¿˜ä¸å¤Ÿå¥½ã€‚</p>
<p>ä»£ç å®ç°å¦‚ä¸‹ï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cs336_basics/loss.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">perplexity</span>(<span class="params">loss: torch.Tensor</span>) -&gt; torch.Tensor:</span><br><span class="line">    <span class="keyword">return</span> torch.exp(loss)</span><br></pre></td></tr></table></figure></p>
<hr>
<h2 id="4-2-ä¼˜åŒ–å™¨ï¼ˆOptimizerï¼‰-ä¸-å­¦ä¹ ç‡è°ƒåº¦å™¨ï¼ˆLearning-Rate-Schedulerï¼‰"><a href="#4-2-ä¼˜åŒ–å™¨ï¼ˆOptimizerï¼‰-ä¸-å­¦ä¹ ç‡è°ƒåº¦å™¨ï¼ˆLearning-Rate-Schedulerï¼‰" class="headerlink" title="4.2 ä¼˜åŒ–å™¨ï¼ˆOptimizerï¼‰ ä¸ å­¦ä¹ ç‡è°ƒåº¦å™¨ï¼ˆLearning Rate Schedulerï¼‰"></a>4.2 ä¼˜åŒ–å™¨ï¼ˆOptimizerï¼‰ ä¸ å­¦ä¹ ç‡è°ƒåº¦å™¨ï¼ˆLearning Rate Schedulerï¼‰</h2><p>æœ‰äº†Loss Functionä¹‹åï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥è¦å®šä¹‰Optimizerå’ŒLearning Rate Schedulerï¼Œæ¥æŒ‡å¯¼æ¨¡å‹å‚æ•°çš„æ›´æ–°ã€‚</p>
<hr>
<h3 id="4-2-1-AdamW"><a href="#4-2-1-AdamW" class="headerlink" title="4.2.1 AdamW"></a>4.2.1 AdamW</h3><p>åœ¨è¿™ä¸ªä½œä¸šä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨AdamW(Loshchilov and Hutter 2019)ä½œä¸ºä¼˜åŒ–å™¨ã€‚AdamW æ˜¯ Adam ä¼˜åŒ–å™¨çš„ä¸€ä¸ªå˜ä½“ï¼Œå®ƒé€šè¿‡å°†æƒé‡è¡°å‡ï¼ˆweight decayï¼‰ä¸æ¢¯åº¦æ›´æ–°è§£è€¦æ¥æ”¹å–„æ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›ã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹Adamæ˜¯ä»€ä¹ˆã€‚Adam æ˜¯ä¸€ç§è‡ªé€‚åº”å­¦ä¹ ç‡ä¼˜åŒ–ç®—æ³•ï¼Œå®ƒç»“åˆäº†åŠ¨é‡ï¼ˆMomentumï¼‰å’ŒRMSPropçš„æ€æƒ³ï¼Œé€šè¿‡è®¡ç®—æ¢¯åº¦çš„ä¸€é˜¶çŸ©ä¼°è®¡ï¼ˆå‡å€¼ï¼‰å’ŒäºŒé˜¶çŸ©ä¼°è®¡ï¼ˆæœªä¸­å¿ƒåŒ–çš„æ–¹å·®ï¼‰æ¥è°ƒæ•´æ¯ä¸ªå‚æ•°çš„å­¦ä¹ ç‡ã€‚Adam å¯¹æ¯ä¸ªå‚æ•° <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Î¸</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span></span></span></span> éƒ½ç»´æŠ¤ä¸¤ä»½çŠ¶æ€ï¼ˆstateï¼‰ï¼š</p>
<ul>
<li>ä¸€é˜¶çŸ©ï¼ˆåŠ¨é‡ï¼‰<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>m</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">m_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>ï¼šæ¢¯åº¦çš„æŒ‡æ•°æ»‘åŠ¨å¹³å‡ï¼ˆåˆ»ç”»æ¢¯åº¦ momentumï¼‰</li>
<li>äºŒé˜¶çŸ© <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">v_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>ï¼šæ¢¯åº¦å¹³æ–¹çš„æŒ‡æ•°æ»‘åŠ¨å¹³å‡ï¼ˆåˆ»ç”»æ¢¯åº¦å°ºåº¦ï¼‰</li>
</ul>
<p>å®ƒä»¬çš„æ›´æ–°è§„åˆ™å¦‚ä¸‹ï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>m</mi><mi>t</mi></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msub><mi>Î²</mi><mn>1</mn></msub><msub><mi>m</mi><mrow><mi>t</mi><mo>âˆ’</mo><mn>1</mn></mrow></msub><mo>+</mo><mo stretchy="false">(</mo><mn>1</mn><mo>âˆ’</mo><msub><mi>Î²</mi><mn>1</mn></msub><mo stretchy="false">)</mo><msub><mi>g</mi><mi>t</mi></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>v</mi><mi>t</mi></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msub><mi>Î²</mi><mn>2</mn></msub><msub><mi>v</mi><mrow><mi>t</mi><mo>âˆ’</mo><mn>1</mn></mrow></msub><mo>+</mo><mo stretchy="false">(</mo><mn>1</mn><mo>âˆ’</mo><msub><mi>Î²</mi><mn>2</mn></msub><mo stretchy="false">)</mo><msubsup><mi>g</mi><mi>t</mi><mn>2</mn></msubsup></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>Î¸</mi><mi>t</mi></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msub><mi>Î¸</mi><mrow><mi>t</mi><mo>âˆ’</mo><mn>1</mn></mrow></msub><mo>âˆ’</mo><mi>Î±</mi><mfrac><msub><mover accent="true"><mi>m</mi><mo>^</mo></mover><mi>t</mi></msub><mrow><msqrt><msub><mover accent="true"><mi>v</mi><mo>^</mo></mover><mi>t</mi></msub></msqrt><mo>+</mo><mi>Ïµ</mi></mrow></mfrac></mrow></mstyle></mtd></mtr></mtable></mtd><mtd width="50%"></mtd><mtd><mtext>(36)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{align*}
m_t &amp;= \beta_1 m_{t-1} + (1 - \beta_1) g_t \\
v_t &amp;= \beta_2 v_{t-1} + (1 - \beta_2) g_t^2 \\
\theta_t &amp;= \theta_{t-1} - \alpha \frac{\hat{m}_t}{\sqrt{\hat{v}_t} + \epsilon}
\end{align*}
\tag{36}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:5.6255em;vertical-align:-2.5628em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.0628em;"><span style="top:-5.5942em;"><span class="pstrut" style="height:3.3714em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-4.0701em;"><span class="pstrut" style="height:3.3714em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.0387em;"><span class="pstrut" style="height:3.3714em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:2.5628em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.0628em;"><span style="top:-5.5942em;"><span class="pstrut" style="height:3.3714em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">Î²</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">Î²</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-4.0701em;"><span class="pstrut" style="height:3.3714em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">Î²</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">Î²</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-2.453em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.0387em;"><span class="pstrut" style="height:3.3714em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.2528em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">Ïµ</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">m</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:2.5628em;"><span></span></span></span></span></span></span></span></span><span class="tag"><span class="strut" style="height:5.6255em;vertical-align:-2.5628em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">36</span></span><span class="mord">)</span></span></span></span></span></span><br>å…¶ä¸­ï¼Œ<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>g</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">g_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> æ˜¯å½“å‰æ¢¯åº¦ï¼Œ<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Î²</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">\beta_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">Î²</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> å’Œ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Î²</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">\beta_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">Î²</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> æ˜¯æ§åˆ¶æ»‘åŠ¨å¹³å‡çš„è¶…å‚æ•°ï¼Œ<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Î±</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span></span></span></span> æ˜¯å­¦ä¹ ç‡ï¼Œ<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Ïµ</mi></mrow><annotation encoding="application/x-tex">\epsilon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">Ïµ</span></span></span></span> æ˜¯é˜²æ­¢é™¤é›¶çš„å°å¸¸æ•°ã€‚<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>m</mi><mo>^</mo></mover><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">\hat{m}_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">m</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> å’Œ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>v</mi><mo>^</mo></mover><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">\hat{v}_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> æ˜¯åå·®ä¿®æ­£åçš„ä¼°è®¡ï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mover accent="true"><mi>m</mi><mo>^</mo></mover><mi>t</mi></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><msub><mi>m</mi><mi>t</mi></msub><mrow><mn>1</mn><mo>âˆ’</mo><msubsup><mi>Î²</mi><mn>1</mn><mi>t</mi></msubsup></mrow></mfrac></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mover accent="true"><mi>v</mi><mo>^</mo></mover><mi>t</mi></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><msub><mi>v</mi><mi>t</mi></msub><mrow><mn>1</mn><mo>âˆ’</mo><msubsup><mi>Î²</mi><mn>2</mn><mi>t</mi></msubsup></mrow></mfrac></mrow></mstyle></mtd></mtr></mtable></mtd><mtd width="50%"></mtd><mtd><mtext>(37)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{align*}
\hat{m}_t &amp;= \frac{m_t}{1 - \beta_1^t} \\
\hat{v}_t &amp;= \frac{v_t}{1 - \beta_2^t}
\end{align*}
\tag{37}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:4.7197em;vertical-align:-2.1099em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6099em;"><span style="top:-4.6099em;"><span class="pstrut" style="height:3.1076em;"></span><span class="mord"><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">m</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.1076em;"></span><span class="mord"><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:2.1099em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6099em;"><span style="top:-4.6099em;"><span class="pstrut" style="height:3.1076em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">Î²</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7754em;"><span style="top:-2.4337em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span style="top:-3.0448em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2663em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.9523em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.1076em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">Î²</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7754em;"><span style="top:-2.4337em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span style="top:-3.0448em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2663em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.9523em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:2.1099em;"><span></span></span></span></span></span></span></span></span><span class="tag"><span class="strut" style="height:4.7197em;vertical-align:-2.1099em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">37</span></span><span class="mord">)</span></span></span></span></span></span></p>
<p>åœ¨ Adam ä¸­ï¼Œæƒé‡è¡°å‡ï¼ˆweight decayï¼‰é€šå¸¸ä¼šè¢«å®ç°æˆ L2 æ­£åˆ™ï¼šä¹Ÿå°±æ˜¯åœ¨æŸå¤±å‡½æ•°ä¸­åŠ å…¥ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mi>Î»</mi><mn>2</mn></mfrac><mi mathvariant="normal">âˆ¥</mi><mi>Î¸</mi><msup><mi mathvariant="normal">âˆ¥</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\frac{\lambda}{2} \|\theta\|^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2251em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">Î»</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord">âˆ¥</span><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="mord"><span class="mord">âˆ¥</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span>ï¼ŒæŸå¤±å‡½æ•°å˜ä¸º <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">L</mi><mo>=</mo><msub><mi mathvariant="script">L</mi><mtext>original</mtext></msub><mo>+</mo><mfrac><mi>Î»</mi><mn>2</mn></mfrac><mi mathvariant="normal">âˆ¥</mi><mi>Î¸</mi><msup><mi mathvariant="normal">âˆ¥</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\mathcal{L} = \mathcal{L}_{\text{original}} + \frac{\lambda}{2} \|\theta\|^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathcal">L</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathcal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">original</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.2251em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">Î»</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord">âˆ¥</span><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="mord"><span class="mord">âˆ¥</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span>ã€‚å…¶å¯¹åº”çš„æ¢¯åº¦é¢å¤–å¤šä¸€é¡¹ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Î»</mi><mi>Î¸</mi></mrow><annotation encoding="application/x-tex">\lambda \theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">Î»</span><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span></span></span></span>ï¼Œä¹Ÿå°±æ˜¯ä¼šå˜æˆï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><msub><mi>g</mi><mi>t</mi></msub><mo>â†</mo><msub><mi>g</mi><mi>t</mi></msub><mo>+</mo><mi>Î»</mi><msub><mi>Î¸</mi><mrow><mi>t</mi><mo>âˆ’</mo><mn>1</mn></mrow></msub></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(38)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">g_t \leftarrow g_t + \lambda \theta_{t-1} \tag{38}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â†</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.9028em;vertical-align:-0.2083em;"></span><span class="mord mathnormal">Î»</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span></span><span class="tag"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">38</span></span><span class="mord">)</span></span></span></span></span></span></p>
<p>å¦‚æœç›´æ¥æŠŠè¿™ä¸ªä¿®æ”¹åçš„æ¢¯åº¦å¸¦å…¥ Adam çš„æ›´æ–°è§„åˆ™ï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°ï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>m</mi><mi>t</mi></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msub><mi>Î²</mi><mn>1</mn></msub><msub><mi>m</mi><mrow><mi>t</mi><mo>âˆ’</mo><mn>1</mn></mrow></msub><mo>+</mo><mo stretchy="false">(</mo><mn>1</mn><mo>âˆ’</mo><msub><mi>Î²</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><msub><mi>g</mi><mi>t</mi></msub><mo>+</mo><mi>Î»</mi><msub><mi>Î¸</mi><mrow><mi>t</mi><mo>âˆ’</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>v</mi><mi>t</mi></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msub><mi>Î²</mi><mn>2</mn></msub><msub><mi>v</mi><mrow><mi>t</mi><mo>âˆ’</mo><mn>1</mn></mrow></msub><mo>+</mo><mo stretchy="false">(</mo><mn>1</mn><mo>âˆ’</mo><msub><mi>Î²</mi><mn>2</mn></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><msub><mi>g</mi><mi>t</mi></msub><mo>+</mo><mi>Î»</mi><msub><mi>Î¸</mi><mrow><mi>t</mi><mo>âˆ’</mo><mn>1</mn></mrow></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>Î¸</mi><mi>t</mi></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msub><mi>Î¸</mi><mrow><mi>t</mi><mo>âˆ’</mo><mn>1</mn></mrow></msub><mo>âˆ’</mo><mi>Î±</mi><mfrac><msub><mover accent="true"><mi>m</mi><mo>^</mo></mover><mi>t</mi></msub><mrow><msqrt><msub><mover accent="true"><mi>v</mi><mo>^</mo></mover><mi>t</mi></msub></msqrt><mo>+</mo><mi>Ïµ</mi></mrow></mfrac></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msub><mi>Î¸</mi><mrow><mi>t</mi><mo>âˆ’</mo><mn>1</mn></mrow></msub><mo>âˆ’</mo><mi>Î±</mi><mfrac><msub><mover accent="true"><mi>m</mi><mo>^</mo></mover><mi>t</mi></msub><mrow><msqrt><msub><mover accent="true"><mi>v</mi><mo>^</mo></mover><mi>t</mi></msub></msqrt><mo>+</mo><mi>Ïµ</mi></mrow></mfrac></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{align*}
m_t &amp;= \beta_1 m_{t-1} + (1 - \beta_1)(g_t + \lambda \theta_{t-1}) \\
v_t &amp;= \beta_2 v_{t-1} + (1 - \beta_2)(g_t + \lambda \theta_{t-1})^2 \\
\theta_t &amp;= \theta_{t-1} - \alpha \frac{\hat{m}_t}{\sqrt{\hat{v}_t} + \epsilon} \\
&amp;= \theta_{t-1} - \alpha \frac{\hat{m}_t}{\sqrt{\hat{v}_t} + \epsilon}
\end{align*}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:8.227em;vertical-align:-3.8635em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.3635em;"><span style="top:-6.8949em;"><span class="pstrut" style="height:3.3714em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-5.3708em;"><span class="pstrut" style="height:3.3714em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.3394em;"><span class="pstrut" style="height:3.3714em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-0.7379em;"><span class="pstrut" style="height:3.3714em;"></span><span class="mord"></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:3.8635em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.3635em;"><span style="top:-6.8949em;"><span class="pstrut" style="height:3.3714em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">Î²</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">Î²</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">Î»</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-5.3708em;"><span class="pstrut" style="height:3.3714em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">Î²</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">Î²</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">Î»</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.3394em;"><span class="pstrut" style="height:3.3714em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.2528em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">Ïµ</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">m</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-0.7379em;"><span class="pstrut" style="height:3.3714em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.2528em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">Ïµ</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">m</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:3.8635em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>AdamWï¼ˆAdam with weight decayï¼‰æƒ³åšçš„äº‹æƒ…å¾ˆç®€å•ï¼šæ¯ä¸€æ­¥éƒ½æŠŠå‚æ•°å¾€ 0 æ‹‰ä¸€ç‚¹ï¼Œå³è®©å‚æ•°è§„æ¨¡å—æ§ã€æå‡æ³›åŒ–ï¼Œä¹Ÿå°±æ˜¯æƒé‡è¡°å‡ï¼Œåªæ˜¯ä¸€æ¡ç‹¬ç«‹çš„çº¿æ€§æ”¶ç¼©ï¼Œä¸è¢«ä»»ä½•è‡ªé€‚åº”ç¼©æ”¾å½±å“ã€‚ä½†åœ¨ Adam é‡Œï¼Œæƒ…å†µå¹¶éå¦‚æ­¤ã€‚</p>
<p>åœ¨ Adam é‡Œï¼Œæ›´æ–°ä¼šè¢« <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msqrt><msub><mover accent="true"><mi>v</mi><mo>^</mo></mover><mi>t</mi></msub></msqrt></mrow><annotation encoding="application/x-tex">\sqrt{\hat{v}_t}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.04em;vertical-align:-0.1828em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span></span></span></span></span></span></span></span></span> è¿›è¡ŒæŒ‰ç»´åº¦ç¼©æ”¾ã€‚è¿™æ„å‘³ç€ï¼š</p>
<ul>
<li>æ­£åˆ™é¡¹ä¹Ÿä¼šè¢«çº³å…¥ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>m</mi><mo>^</mo></mover><mi>t</mi></msub><mo separator="true">,</mo><msub><mover accent="true"><mi>v</mi><mo>^</mo></mover><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">\hat{m}_t, \hat{v}_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">m</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> çš„è®¡ç®—</li>
<li>ç»“æœå®ƒä¹Ÿä¼šè¢«ç¼©æ”¾</li>
</ul>
<p>æ¢å¥è¯è¯´ï¼šåœ¨ Adam è¿™ç§è‡ªé€‚åº”ä¼˜åŒ–å™¨é‡Œï¼ŒL2 æ­£åˆ™å‡ ä¹ä¸è¡¨ç°ä¸º weight decayã€‚(Loshchilov and Hutter 2019) çš„æ ¸å¿ƒè§‚å¯Ÿå°±æ˜¯ï¼šå¦‚æœæˆ‘ä»¬æƒ³è¦çœŸæ­£å®ç°â€œæŠŠå‚æ•°å¾€ 0 æ‹‰â€çš„æ­£åˆ™åŒ–æ•ˆæœï¼Œå°±åº”è¯¥æŠŠå®ƒä» Adam çš„æ¢¯åº¦æ›´æ–°ä¸­æ‹†å‡ºæ¥ã€‚</p>
<p>AdamW çš„ç®—æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="./ass01-AdamW-alg.png" alt="AdamW ç®—æ³•"></p>
<p>å¯ä»¥çœ‹åˆ°ï¼ŒAdamW æŠŠ weight decay ä»æ¢¯åº¦æ›´æ–°ä¸­è§£è€¦å‡ºæ¥ï¼Œç›´æ¥åœ¨å‚æ•°æ›´æ–°æ—¶åšçº¿æ€§æ”¶ç¼©ï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><msub><mi>Î¸</mi><mi>t</mi></msub><mo>=</mo><msub><mi>Î¸</mi><mrow><mi>t</mi><mo>âˆ’</mo><mn>1</mn></mrow></msub><mo>âˆ’</mo><mi>Î±</mi><mfrac><msub><mover accent="true"><mi>m</mi><mo>^</mo></mover><mi>t</mi></msub><mrow><msqrt><msub><mover accent="true"><mi>v</mi><mo>^</mo></mover><mi>t</mi></msub></msqrt><mo>+</mo><mi>Ïµ</mi></mrow></mfrac><mo>âˆ’</mo><mi>Î±</mi><mi>Î»</mi><msub><mi>Î¸</mi><mrow><mi>t</mi><mo>âˆ’</mo><mn>1</mn></mrow></msub></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(39)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">\theta_t = \theta_{t-1} - \alpha \frac{\hat{m}_t}{\sqrt{\hat{v}_t} + \epsilon} - \alpha \lambda \theta_{t-1} \tag{39}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9028em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:2.3014em;vertical-align:-0.93em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.2528em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">Ïµ</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">m</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.9028em;vertical-align:-0.2083em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="mord mathnormal">Î»</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">Î¸</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span></span><span class="tag"><span class="strut" style="height:2.3014em;vertical-align:-0.93em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">39</span></span><span class="mord">)</span></span></span></span></span></span></p>
<p>è¿™æ ·å°±ä¿è¯äº† weight decay çš„æ•ˆæœæ˜¯ä¸€è‡´çš„ï¼Œä¸ä¼šè¢«è‡ªé€‚åº”ç¼©æ”¾å½±å“ã€‚</p>
<p>ç†è§£äº† AdamW çš„åŸç†åï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ƒçš„ä»£ç å®ç°ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cs336_basics/optim.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AdamW</span>(torch.optim.Optimizer):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params"></span></span><br><span class="line"><span class="params">        self,</span></span><br><span class="line"><span class="params">        params: Iterable[torch.nn.Parameter],</span></span><br><span class="line"><span class="params">        lr: <span class="built_in">float</span> = <span class="number">1e-3</span>,</span></span><br><span class="line"><span class="params">        betas: <span class="built_in">tuple</span>[<span class="built_in">float</span>, <span class="built_in">float</span>] = (<span class="params"><span class="number">0.9</span>, <span class="number">0.999</span></span>),</span></span><br><span class="line"><span class="params">        eps: <span class="built_in">float</span> = <span class="number">1e-8</span>,</span></span><br><span class="line"><span class="params">        weight_decay: <span class="built_in">float</span> = <span class="number">1e-2</span>,</span></span><br><span class="line"><span class="params">    </span>):</span><br><span class="line">        <span class="keyword">if</span> lr &lt; <span class="number">0.0</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Invalid learning rate: <span class="subst">&#123;lr&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> eps &lt;= <span class="number">0.0</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Invalid epsilon value: <span class="subst">&#123;eps&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> weight_decay &lt; <span class="number">0.0</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Invalid weight_decay value: <span class="subst">&#123;weight_decay&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(betas, <span class="built_in">tuple</span>) <span class="keyword">or</span> <span class="built_in">len</span>(betas) != <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f&quot;betas must be a tuple of length 2, got: <span class="subst">&#123;betas&#125;</span>&quot;</span>)</span><br><span class="line">        beta1, beta2 = betas</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> (<span class="number">0.0</span> &lt;= beta1 &lt; <span class="number">1.0</span>):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Invalid beta1 value: <span class="subst">&#123;beta1&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> (<span class="number">0.0</span> &lt;= beta2 &lt; <span class="number">1.0</span>):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Invalid beta2 value: <span class="subst">&#123;beta2&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        defaults = <span class="built_in">dict</span>(lr=lr, betas=betas, eps=eps, weight_decay=weight_decay)</span><br><span class="line">        <span class="built_in">super</span>().__init__(params, defaults)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @torch.no_grad()</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">step</span>(<span class="params">self, closure: <span class="type">Optional</span>[<span class="built_in">callable</span>] = <span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ‰§è¡Œä¸€æ¬¡å‚æ•°æ›´æ–°&quot;&quot;&quot;</span></span><br><span class="line">        loss = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">if</span> closure <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">with</span> torch.enable_grad():</span><br><span class="line">                loss = closure()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> group <span class="keyword">in</span> <span class="variable language_">self</span>.param_groups:</span><br><span class="line">            lr: <span class="built_in">float</span> = group[<span class="string">&quot;lr&quot;</span>]</span><br><span class="line">            beta1, beta2 = group[<span class="string">&quot;betas&quot;</span>]</span><br><span class="line">            eps: <span class="built_in">float</span> = group[<span class="string">&quot;eps&quot;</span>]</span><br><span class="line">            weight_decay: <span class="built_in">float</span> = group[<span class="string">&quot;weight_decay&quot;</span>]</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> p <span class="keyword">in</span> group[<span class="string">&quot;params&quot;</span>]:</span><br><span class="line">                <span class="keyword">if</span> p.grad <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                grad = p.grad</span><br><span class="line">                <span class="keyword">if</span> grad.is_sparse:</span><br><span class="line">                    <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;AdamW does not support sparse gradients&quot;</span>)</span><br><span class="line"></span><br><span class="line">                state = <span class="variable language_">self</span>.state[p]</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(state) == <span class="number">0</span>:</span><br><span class="line">                    state[<span class="string">&quot;step&quot;</span>] = <span class="number">0</span></span><br><span class="line">                    state[<span class="string">&quot;exp_avg&quot;</span>] = torch.zeros_like(p, memory_format=torch.preserve_format)</span><br><span class="line">                    state[<span class="string">&quot;exp_avg_sq&quot;</span>] = torch.zeros_like(p, memory_format=torch.preserve_format)</span><br><span class="line"></span><br><span class="line">                exp_avg = state[<span class="string">&quot;exp_avg&quot;</span>]</span><br><span class="line">                exp_avg_sq = state[<span class="string">&quot;exp_avg_sq&quot;</span>]</span><br><span class="line"></span><br><span class="line">                state[<span class="string">&quot;step&quot;</span>] += <span class="number">1</span></span><br><span class="line">                t = state[<span class="string">&quot;step&quot;</span>]</span><br><span class="line"></span><br><span class="line">                <span class="comment"># æ›´æ–°ä¸€é˜¶/äºŒé˜¶åŠ¨é‡çš„æŒ‡æ•°æ»‘åŠ¨å¹³å‡ï¼ˆå¸¦åç½®çš„ä¼°è®¡ï¼‰</span></span><br><span class="line">                exp_avg.mul_(beta1).add_(grad, alpha=(<span class="number">1.0</span> - beta1))</span><br><span class="line">                exp_avg_sq.mul_(beta2).addcmul_(grad, grad, value=(<span class="number">1.0</span> - beta2))</span><br><span class="line"></span><br><span class="line">                <span class="comment"># åç½®ä¿®æ­£ï¼ˆå°†ä¸€é˜¶/äºŒé˜¶åŠ¨é‡ä»â€œå¸¦åä¼°è®¡â€æ ¡æ­£ä¸ºæ›´æ¥è¿‘æ— åï¼‰</span></span><br><span class="line">                bias_correction1 = <span class="number">1.0</span> - beta1**t</span><br><span class="line">                bias_correction2 = <span class="number">1.0</span> - beta2**t</span><br><span class="line"></span><br><span class="line">                <span class="comment"># è®¡ç®—æ­¥é•¿ï¼ˆå­¦ä¹ ç‡ + ä¸€é˜¶åç½®ä¿®æ­£ï¼‰</span></span><br><span class="line">                step_size = lr / bias_correction1</span><br><span class="line"></span><br><span class="line">                <span class="comment"># åˆ†æ¯ï¼šsqrt(v_hat) + eps</span></span><br><span class="line">                denom = (exp_avg_sq / bias_correction2).sqrt().add_(eps)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># åˆ†ç¦»çš„æƒé‡è¡°å‡ï¼šå…ˆå¯¹å‚æ•°åšè¡°å‡ï¼Œå†åšæ¢¯åº¦æ›´æ–°</span></span><br><span class="line">                <span class="keyword">if</span> weight_decay != <span class="number">0.0</span>:</span><br><span class="line">                    p.mul_(<span class="number">1.0</span> - lr * weight_decay)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># å‚æ•°æ›´æ–°ï¼šp = p - step_size * m_hat / (sqrt(v_hat) + eps)</span></span><br><span class="line">                p.addcdiv_(exp_avg, denom, value=-step_size)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> loss</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>ğŸ”§ è¿›é˜¶æŠ€å·§ï¼šParam Groups</strong></p>
<p>åœ¨ AdamW çš„å®ç°ä¸­ï¼Œä½ çœ‹åˆ°äº† for group in self.param_groups:ã€‚<br>PyTorch çš„ä¼˜åŒ–å™¨å…è®¸æˆ‘ä»¬å°†æ¨¡å‹çš„å‚æ•°åˆ†ç»„ï¼Œä»è€Œå¯¹ä¸åŒçš„å±‚åº”ç”¨ä¸åŒçš„å­¦ä¹ ç‡æˆ–æƒé‡è¡°å‡ã€‚</p>
<ul>
<li><strong>å…¸å‹åº”ç”¨</strong>: åœ¨å¾®è°ƒï¼ˆFine-tuningï¼‰æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸å¸Œæœ›åº•å±‚çš„ Transformer Block å­¦ä¹ ç‡ä½ä¸€ç‚¹ï¼ˆä¿æŒé€šç”¨ç‰¹å¾ï¼‰ï¼Œè€Œé¡¶å±‚çš„ Output Layer å­¦ä¹ ç‡é«˜ä¸€ç‚¹ï¼ˆé€‚åº”æ–°ä»»åŠ¡ï¼‰ã€‚é€šè¿‡ param_groups å°±å¯ä»¥è½»æ¾å®ç°è¿™ç§<strong>åˆ†å±‚å­¦ä¹ ç‡ (Layer-wise Learning Rate)</strong>ã€‚</li>
</ul>
</blockquote>
<hr>
<h3 id="4-2-2-ä½™å¼¦é€€ç«å­¦ä¹ ç‡è°ƒåº¦å™¨ï¼ˆCosine-Annealing-Learning-Rate-Schedulerï¼‰"><a href="#4-2-2-ä½™å¼¦é€€ç«å­¦ä¹ ç‡è°ƒåº¦å™¨ï¼ˆCosine-Annealing-Learning-Rate-Schedulerï¼‰" class="headerlink" title="4.2.2 ä½™å¼¦é€€ç«å­¦ä¹ ç‡è°ƒåº¦å™¨ï¼ˆCosine Annealing Learning Rate Schedulerï¼‰"></a>4.2.2 ä½™å¼¦é€€ç«å­¦ä¹ ç‡è°ƒåº¦å™¨ï¼ˆCosine Annealing Learning Rate Schedulerï¼‰</h3><p>æœ‰äº†ä¼˜åŒ–å™¨ä¹‹åï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªLearning Rate Scheduleræ¥åŠ¨æ€è°ƒæ•´å­¦ä¹ ç‡ã€‚åœ¨æ·±åº¦å­¦ä¹ è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œæœ€åˆé€‚çš„å­¦ä¹ ç‡ä¼šéšé˜¶æ®µå˜åŒ–ï¼š</p>
<ul>
<li><strong>è®­ç»ƒæ—©æœŸ</strong>ï¼šæ¨¡å‹è¿˜æ²¡å­¦åˆ°ä¸œè¥¿ï¼Œå‚æ•°ç¦»ç›®æ ‡å¾ˆè¿œ<ul>
<li>ç”¨æ›´å¤§çš„å­¦ä¹ ç‡ï¼Œæ›´æ–°æ›´å¿«ï¼Œloss ä¸‹é™æ›´å¿«</li>
</ul>
</li>
<li><strong>è®­ç»ƒåæœŸ</strong>ï¼šæ¨¡å‹æ¥è¿‘æ”¶æ•›<ul>
<li>ç”¨æ›´å°çš„å­¦ä¹ ç‡ï¼Œé¿å…åœ¨æœ€ä¼˜ç‚¹é™„è¿‘éœ‡è¡ï¼Œæå‡ç¨³å®šæ€§ä¸æœ€ç»ˆæ•ˆæœ</li>
</ul>
</li>
</ul>
<p>å› æ­¤æˆ‘ä»¬éœ€è¦Learning Rate Schedulerï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šåœ¨ä¸åŒæ—¶æœŸè°ƒæ•´ä¸åŒçš„Learning Rateã€‚ä¸€ä¸ªå¸¸è§çš„Learning Rate Schedulerå«åš Cosine Annealing Schedulerã€‚</p>
<p>å®ƒæŠŠå­¦ä¹ ç‡ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Î±</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">\alpha_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> åˆ†æˆä¸‰æ®µï¼š</p>
<ol>
<li><strong>Warm-Up</strong>ï¼šä» 0 çº¿æ€§æå‡åˆ° <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Î±</mi><mtext>max</mtext></msub></mrow><annotation encoding="application/x-tex">\alpha_{\text{max}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">max</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>ï¼ˆé˜²æ­¢ä¸€å¼€å§‹æ¢¯åº¦å¤ªä¹±ï¼Œç›´æ¥å¤§ LR ä¼šä¸ç¨³å®šï¼‰</li>
<li><strong>Cosine Annealing</strong>ï¼šä» <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Î±</mi><mtext>max</mtext></msub></mrow><annotation encoding="application/x-tex">\alpha_{\text{max}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">max</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> å¹³æ»‘é™åˆ° <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Î±</mi><mtext>min</mtext></msub></mrow><annotation encoding="application/x-tex">\alpha_{\text{min}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">min</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>ï¼ˆä¸‹é™è¿‡ç¨‹æ›´å¹³æ»‘ï¼Œæ¯”â€œçªç„¶é™å­¦ä¹ ç‡â€æ›´ç¨³ï¼‰</li>
<li><strong>Post-Annealing</strong>ï¼šä¿æŒ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Î±</mi><mtext>min</mtext></msub></mrow><annotation encoding="application/x-tex">\alpha_{\text{min}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">min</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ä¸å˜ï¼ˆè®©è®­ç»ƒåœ¨ä½ LR ä¸‹æ…¢æ…¢ç²¾ä¿®ï¼Œfine-tune é£æ ¼ï¼‰</li>
</ol>
<p>æˆ‘ä»¬å…ˆæ¥å®šä¹‰å‡ ä¸ªç¬¦å·ï¼š</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>ç¬¦å·</th>
<th>å«ä¹‰</th>
</tr>
</thead>
<tbody>
<tr>
<td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span></td>
<td>å½“å‰è®­ç»ƒ stepï¼ˆè¿­ä»£æ¬¡æ•°ï¼‰</td>
</tr>
<tr>
<td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Î±</mi><mtext>max</mtext></msub></mrow><annotation encoding="application/x-tex">\alpha_{\text{max}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">max</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></td>
<td>æœ€å¤§å­¦ä¹ ç‡ï¼ˆå³°å€¼ï¼‰</td>
</tr>
<tr>
<td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Î±</mi><mtext>min</mtext></msub></mrow><annotation encoding="application/x-tex">\alpha_{\text{min}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">min</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></td>
<td>æœ€å°/æœ€ç»ˆå­¦ä¹ ç‡</td>
</tr>
<tr>
<td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>w</mi></msub></mrow><annotation encoding="application/x-tex">T_w</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></td>
<td>warm-up çš„æ­¥æ•°ï¼ˆé¢„çƒ­å¤šä¹…ï¼‰</td>
</tr>
<tr>
<td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">T_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></td>
<td>Cosine Annealing é¢„çƒ­çš„æ­¥æ•°ï¼ˆåˆ°è¿™ä¸ª step å­¦ä¹ ç‡é™åˆ° <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Î±</mi><mtext>min</mtext></msub></mrow><annotation encoding="application/x-tex">\alpha_{\text{min}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">min</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>ï¼‰</td>
</tr>
<tr>
<td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Î±</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">\alpha_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></td>
<td>å½“å‰å­¦ä¹ ç‡</td>
</tr>
</tbody>
</table>
</div>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹å¦‚ä½•è°ƒæ•´è¿™ä¸‰ä¸ªä¸åŒçš„é˜¶æ®µï¼š</p>
<h4 id="é˜¶æ®µ1-Warm-Up"><a href="#é˜¶æ®µ1-Warm-Up" class="headerlink" title="é˜¶æ®µ1: Warm-Up"></a>é˜¶æ®µ1: Warm-Up</h4><p>å½“ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>&lt;</mo><msub><mi>T</mi><mi>w</mi></msub></mrow><annotation encoding="application/x-tex">t &lt; T_w</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6542em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> æ—¶ï¼Œæˆ‘ä»¬çº¿æ€§å¢é•¿åˆ° <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Î±</mi><mtext>max</mtext></msub></mrow><annotation encoding="application/x-tex">\alpha_{\text{max}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">max</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><msub><mi>Î±</mi><mi>t</mi></msub><mo>=</mo><mfrac><mi>t</mi><msub><mi>T</mi><mi>w</mi></msub></mfrac><msub><mi>Î±</mi><mtext>max</mtext></msub></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(40)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">\alpha_t = \frac{t}{T_w} \alpha_{\text{max}} \tag{40}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.1281em;vertical-align:-0.836em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.2921em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">max</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="tag"><span class="strut" style="height:2.1281em;vertical-align:-0.836em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">40</span></span><span class="mord">)</span></span></span></span></span></span></p>
<h4 id="é˜¶æ®µ2-Cosine-Annealing"><a href="#é˜¶æ®µ2-Cosine-Annealing" class="headerlink" title="é˜¶æ®µ2: Cosine Annealing"></a>é˜¶æ®µ2: Cosine Annealing</h4><p>è¿™ä¸ªæ˜¯ç›¸å¯¹å¤æ‚çš„é˜¶æ®µï¼Œåœ¨è¿™ä¸ªé˜¶æ®µæˆ‘ä»¬çš„å­¦ä¹ ç‡ç”¨ä½™å¼¦æ›²çº¿ä¸‹é™ï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><msub><mi>Î±</mi><mi>t</mi></msub><mo>=</mo><msub><mi>Î±</mi><mtext>min</mtext></msub><mo>+</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mrow><mo fence="true">(</mo><mn>1</mn><mo>+</mo><mi>cos</mi><mo>â¡</mo><mrow><mo fence="true">(</mo><mfrac><mrow><mi>t</mi><mo>âˆ’</mo><msub><mi>T</mi><mi>w</mi></msub></mrow><mrow><msub><mi>T</mi><mi>c</mi></msub><mo>âˆ’</mo><msub><mi>T</mi><mi>w</mi></msub></mrow></mfrac><mi>Ï€</mi><mo fence="true">)</mo></mrow><mo fence="true">)</mo></mrow><mo stretchy="false">(</mo><msub><mi>Î±</mi><mtext>max</mtext></msub><mo>âˆ’</mo><msub><mi>Î±</mi><mtext>min</mtext></msub><mo stretchy="false">)</mo></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(41)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">\alpha_t = \alpha_{\text{min}} + \frac{1}{2} \left( 1 + \cos\left( \frac{t - T_w}{T_c - T_w} \pi \right) \right) (\alpha_{\text{max}} - \alpha_{\text{min}}) \tag{41}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">min</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mop">cos</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3603em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathnormal" style="margin-right:0.03588em;">Ï€</span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">max</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">min</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span><span class="tag"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">41</span></span><span class="mord">)</span></span></span></span></span></span></p>
<p>è¿™ä¸ªå¼å­åšäº†ä¸¤ä»¶äº‹ï¼š</p>
<ul>
<li>ç”¨ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>cos</mi><mo>â¡</mo><mo stretchy="false">(</mo><mo>â‹…</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\cos(\cdot)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">cos</span><span class="mopen">(</span><span class="mord">â‹…</span><span class="mclose">)</span></span></span></span> äº§ç”Ÿä¸€ä¸ªä» 1 å¹³æ»‘åˆ° -1 çš„æ›²çº¿</li>
<li>å†æŠŠå®ƒæ˜ å°„æˆä¸€ä¸ªä» <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Î±</mi><mtext>max</mtext></msub></mrow><annotation encoding="application/x-tex">\alpha_{\text{max}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">max</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> å¹³æ»‘åˆ° <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Î±</mi><mtext>min</mtext></msub></mrow><annotation encoding="application/x-tex">\alpha_{\text{min}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">min</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> çš„å­¦ä¹ ç‡</li>
</ul>
<p>æˆ‘ä»¬æŸ¥çœ‹ä¸€ä¸‹ä¸¤ä¸ªç«¯ç‚¹ï¼š</p>
<ul>
<li>å½“ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>=</mo><msub><mi>T</mi><mi>w</mi></msub></mrow><annotation encoding="application/x-tex">t = T_w</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>cos</mi><mo>â¡</mo><mo stretchy="false">(</mo><mn>0</mn><mo stretchy="false">)</mo><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\cos(0) = 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">cos</span><span class="mopen">(</span><span class="mord">0</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Î±</mi><mi>t</mi></msub><mo>=</mo><msub><mi>Î±</mi><mtext>min</mtext></msub><mo>+</mo><msub><mi>Î±</mi><mtext>max</mtext></msub><mo>âˆ’</mo><msub><mi>Î±</mi><mtext>min</mtext></msub><mo>=</mo><msub><mi>Î±</mi><mtext>max</mtext></msub></mrow><annotation encoding="application/x-tex">\alpha_t = \alpha_{\text{min}} + \alpha_{\text{max}} - \alpha_{\text{min}} = \alpha_{\text{max}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">min</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">max</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">min</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">max</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></li>
<li>å½“ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>=</mo><msub><mi>T</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">t = T_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>cos</mi><mo>â¡</mo><mo stretchy="false">(</mo><mi>Ï€</mi><mo stretchy="false">)</mo><mo>=</mo><mo>âˆ’</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\cos(\pi) = -1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">cos</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">Ï€</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">âˆ’</span><span class="mord">1</span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Î±</mi><mi>t</mi></msub><mo>=</mo><msub><mi>Î±</mi><mtext>min</mtext></msub><mo>+</mo><mn>0</mn><mo>=</mo><msub><mi>Î±</mi><mtext>min</mtext></msub></mrow><annotation encoding="application/x-tex">\alpha_t = \alpha_{\text{min}} + 0 = \alpha_{\text{min}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">min</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">min</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></li>
</ul>
<h4 id="é˜¶æ®µ3-Post-Annealing"><a href="#é˜¶æ®µ3-Post-Annealing" class="headerlink" title="é˜¶æ®µ3: Post-Annealing"></a>é˜¶æ®µ3: Post-Annealing</h4><p>å½“ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>â‰¥</mo><msub><mi>T</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">t \geq T_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7719em;vertical-align:-0.136em;"></span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â‰¥</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> æ—¶ï¼Œæˆ‘ä»¬å°† <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Î±</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">\alpha_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> è®¾å®šä¸º <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Î±</mi><mtext>min</mtext></msub></mrow><annotation encoding="application/x-tex">\alpha_{\text{min}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">Î±</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">min</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>ï¼Œä¸”ä¿æŒä¸å˜ã€‚</p>
<p>ä»£ç å®ç°ä¹Ÿå¾ˆç®€å•ï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cs336_basics/optim.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cosine_annealing_lr</span>(<span class="params"></span></span><br><span class="line"><span class="params">    t: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    alpha_max: <span class="built_in">float</span>,</span></span><br><span class="line"><span class="params">    alpha_min: <span class="built_in">float</span>,</span></span><br><span class="line"><span class="params">    Tw: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    Tc: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">    <span class="comment"># é¢„çƒ­é˜¶æ®µ</span></span><br><span class="line">    <span class="keyword">if</span> Tw &gt; <span class="number">0</span> <span class="keyword">and</span> t &lt; Tw:</span><br><span class="line">        <span class="keyword">return</span> (t / Tw) * alpha_max</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä½™å¼¦é€€ç«é˜¶æ®µï¼ˆåŒ…å«è¾¹ç•Œ t == Tw çš„æƒ…å†µï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> t &lt;= Tc:</span><br><span class="line">        <span class="comment"># å¦‚æœ Tc == Twï¼Œè¯´æ˜æ²¡æœ‰é€€ç«åŒºé—´ï¼›åœ¨ t==Tw æ—¶ç›´æ¥è¿”å› alpha_max</span></span><br><span class="line">        <span class="keyword">if</span> Tc == Tw:</span><br><span class="line">            <span class="keyword">return</span> alpha_max</span><br><span class="line"></span><br><span class="line">        progress = (t - Tw) / (Tc - Tw)  <span class="comment"># å½’ä¸€åŒ–è¿›åº¦ï¼ŒèŒƒå›´ä¸º [0, 1]</span></span><br><span class="line">        <span class="keyword">return</span> alpha_min + <span class="number">0.5</span> * (<span class="number">1.0</span> + math.cos(math.pi * progress)) * (alpha_max - alpha_min)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># é€€ç«ç»“æŸåçš„é˜¶æ®µ</span></span><br><span class="line">    <span class="keyword">return</span> alpha_min</span><br></pre></td></tr></table></figure></p>
<p><img src="./ass01-cos-annealing.png" alt=""></p>
<div class="img-alt is-center">
Cosine Annealing Learning Rate Scheduler Example<br>
total_steps=10000, alpha_max=0.001, alpha_min=0.0001, Tw=500, Tc = total_steps // 2
</div>


<hr>
<h3 id="4-2-3-æ¢¯åº¦è£å‰ªï¼ˆGradient-Clippingï¼‰"><a href="#4-2-3-æ¢¯åº¦è£å‰ªï¼ˆGradient-Clippingï¼‰" class="headerlink" title="4.2.3 æ¢¯åº¦è£å‰ªï¼ˆGradient Clippingï¼‰"></a>4.2.3 æ¢¯åº¦è£å‰ªï¼ˆGradient Clippingï¼‰</h3><p>åœ¨è®­ç»ƒç¥ç»ç½‘ç»œæ—¶ï¼Œå¯èƒ½ä¼šé‡åˆ°æŸäº›â€œç‰¹åˆ«éš¾/ç‰¹åˆ«æç«¯â€çš„è®­ç»ƒæ ·æœ¬ï¼Œå®ƒä»¬ä¼šè®©æ¨¡å‹äº§ç”Ÿéå¸¸å¤§çš„æ¢¯åº¦ã€‚å¦‚æœç›´æ¥ç”¨è¿™ç§æ¢¯åº¦æ›´æ–°å‚æ•°ï¼Œå¯èƒ½ä¼šå¯¼è‡´ï¼š</p>
<ul>
<li><strong>Loss Spike</strong>ï¼šLoss çªç„¶çˆ†ç‚¸ï¼ˆæ•°å€¼ä¸ç¨³å®šï¼‰</li>
<li><strong>å‚æ•°æ›´æ–°æ­¥å­å¤ªå¤§</strong>ï¼šå¯¼è‡´è®­ç»ƒå‘æ•£</li>
<li><strong>è®­ç»ƒæ›²çº¿æŠ–åŠ¨å¾—å¾ˆå‰å®³</strong>ï¼šéš¾ä»¥æ”¶æ•›</li>
</ul>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå®è·µä¸­å¸¸ç”¨ <strong>Gradient Clipping</strong>ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³éå¸¸ç®€å•ï¼šæŠŠæ‰€æœ‰å‚æ•°çš„æ¢¯åº¦åˆèµ·æ¥ï¼Œè®¡ç®—å®ƒä»¬çš„ L2-Norm <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">âˆ¥</mi><mi>g</mi><msub><mi mathvariant="normal">âˆ¥</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">\|g\|_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">âˆ¥</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord"><span class="mord">âˆ¥</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶ç†è§£ä¸ºæ•´ä½“æ¢¯åº¦çš„å¼ºåº¦/æ€»èƒ½é‡ï¼Œç„¶åè®¾å®šä¸€ä¸ªé˜ˆå€¼ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span></span></span>ï¼ˆæœ€å¤§å…è®¸çš„æ¢¯åº¦èŒƒæ•°ï¼‰ã€‚</p>
<p>æˆ‘ä»¬æœ‰ä¸¤ç§æƒ…å†µï¼š</p>
<ol>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">âˆ¥</mi><mi>g</mi><msub><mi mathvariant="normal">âˆ¥</mi><mn>2</mn></msub><mo>â‰¤</mo><mi>M</mi></mrow><annotation encoding="application/x-tex">\|g\|_2 \le M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">âˆ¥</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord"><span class="mord">âˆ¥</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â‰¤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span></span></span>ï¼šè¯´æ˜æ¢¯åº¦åœ¨å®‰å…¨èŒƒå›´å†…ï¼Œç›´æ¥ä¿æŒåŸæ ·ã€‚</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">âˆ¥</mi><mi>g</mi><msub><mi mathvariant="normal">âˆ¥</mi><mn>2</mn></msub><mo>&gt;</mo><mi>M</mi></mrow><annotation encoding="application/x-tex">\|g\|_2 &gt; M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">âˆ¥</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord"><span class="mord">âˆ¥</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span></span></span>ï¼šè¯´æ˜è¿™ä¸ªæ¢¯åº¦è¿‡å¤§ï¼Œå¯èƒ½ä¼šé€ æˆé—®é¢˜ï¼Œå› æ­¤æˆ‘ä»¬ç­‰æ¯”ä¾‹ç¼©å°æ›´æ–°è¿™ä¸ªæ¢¯åº¦ï¼Œç¼©å°çš„ç³»æ•°æ˜¯ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mi>M</mi><mrow><mi mathvariant="normal">âˆ¥</mi><mi>g</mi><msub><mi mathvariant="normal">âˆ¥</mi><mn>2</mn></msub><mo>+</mo><mi>Ïµ</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{M}{\|g\|_2 + \epsilon}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.3923em;vertical-align:-0.52em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8723em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">âˆ¥</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span><span class="mord mtight"><span class="mord mtight">âˆ¥</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mbin mtight">+</span><span class="mord mathnormal mtight">Ïµ</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.52em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>ã€‚æ›´æ–°åçš„æ¢¯åº¦ä¸ºï¼š
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><mi>g</mi><mo>â†</mo><mi>g</mi><mo>â‹…</mo><mfrac><mi>M</mi><mrow><mi mathvariant="normal">âˆ¥</mi><mi>g</mi><msub><mi mathvariant="normal">âˆ¥</mi><mn>2</mn></msub><mo>+</mo><mi>Ïµ</mi></mrow></mfrac></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(42)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">g \leftarrow g \cdot \frac{M}{\|g\|_2 + \epsilon} \tag{42}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â†</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:2.2963em;vertical-align:-0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3603em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">âˆ¥</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord"><span class="mord">âˆ¥</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">Ïµ</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span><span class="tag"><span class="strut" style="height:2.2963em;vertical-align:-0.936em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">42</span></span><span class="mord">)</span></span></span></span></span></span>
</li>
</ol>
<p>é€šè¿‡è¿™ç§ç¼©æ”¾çš„æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ï¼š</p>
<ul>
<li><strong>æ–¹å‘ä¸å˜</strong>ï¼šè£å‰ªä¸ä¼šæ”¹å˜æ¢¯åº¦çš„æ–¹å‘ï¼ˆåªæ˜¯æ•´ä½“ç¼©æ”¾ï¼‰</li>
<li><strong>æ­¥å­å˜å°</strong>ï¼šå½“æ¢¯åº¦å¤ªå¤§æ—¶ï¼Œç›¸å½“äºå¼ºè¡Œè®©æ›´æ–°ä¸è¦è·¨å¤ªå¤§æ­¥</li>
<li><strong>æ›´ç¨³å®š</strong>ï¼šå°¤å…¶å¯¹ RNNã€Transformer æˆ–è®­ç»ƒæ—©æœŸå¸¸è§çš„â€œæ¢¯åº¦çˆ†ç‚¸â€é—®é¢˜å¾ˆæœ‰å¸®åŠ©</li>
</ul>
<p>ä»£ç å®ç°ä¹Ÿå¾ˆç®€å•ã€ç›´è§‚ï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cs336_basics/optim.py</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@torch.no_grad()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gradient_clip</span>(<span class="params"></span></span><br><span class="line"><span class="params">    parameters: Iterable[torch.nn.Parameter],</span></span><br><span class="line"><span class="params">    max_l2_norm: <span class="built_in">float</span>,</span></span><br><span class="line"><span class="params">    eps: <span class="built_in">float</span> = <span class="number">1e-6</span>,</span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="comment"># è®¡ç®—æ‰€æœ‰å‚æ•°æ¢¯åº¦çš„æ•´ä½“ L2 èŒƒæ•°</span></span><br><span class="line">    total_norm = <span class="number">0.0</span></span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> parameters:</span><br><span class="line">        <span class="keyword">if</span> p.grad <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            param_norm = p.grad.data.norm(<span class="number">2</span>)</span><br><span class="line">            total_norm += param_norm.item() ** <span class="number">2</span></span><br><span class="line">    total_norm = total_norm**<span class="number">0.5</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ ¹æ®ç¼©æ”¾ç³»æ•°å¯¹æ¢¯åº¦è¿›è¡Œè£å‰ªï¼ˆå½“æ€»èŒƒæ•°è¶…è¿‡é˜ˆå€¼æ—¶æ‰ç¼©æ”¾ï¼‰</span></span><br><span class="line">    clip_coef = max_l2_norm / (total_norm + eps)</span><br><span class="line">    <span class="keyword">if</span> clip_coef &lt; <span class="number">1.0</span>:</span><br><span class="line">        <span class="keyword">for</span> p <span class="keyword">in</span> parameters:</span><br><span class="line">            <span class="keyword">if</span> p.grad <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                p.grad.data.mul_(clip_coef)</span><br></pre></td></tr></table></figure></p>
<hr>
<h3 id="4-2-4-æ•´åˆå®ç°"><a href="#4-2-4-æ•´åˆå®ç°" class="headerlink" title="4.2.4 æ•´åˆå®ç°"></a>4.2.4 æ•´åˆå®ç°</h3><p>æœ‰äº†è¿™ä¸‰ä¸ªä¼˜åŒ–çš„ç»„ä»¶ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠå®ƒä»¬æ”¾åœ¨ä¸€èµ·ï¼Œå½¢æˆä¸€ä¸ªå®Œæ•´çš„è®­ç»ƒæ­¥éª¤ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cs336_basics/train_engine.py</span></span><br><span class="line"></span><br><span class="line">inputs, targets = data_loading_sequential(</span><br><span class="line">            x=x,</span><br><span class="line">            batch_size=train_config.batch_size,</span><br><span class="line">            context_length=model.config.max_seq_len,</span><br><span class="line">            device=train_config.device,</span><br><span class="line">            state=state,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å‰å‘ä¼ æ’­</span></span><br><span class="line">        <span class="keyword">with</span> ctx:</span><br><span class="line">            logits = model(inputs)</span><br><span class="line">            logits = logits.view(-<span class="number">1</span>, logits.size(-<span class="number">1</span>))</span><br><span class="line">            targets = targets.view(-<span class="number">1</span>)</span><br><span class="line">            loss = cross_entropy(logits, targets)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># åå‘ä¼ æ’­ + å‚æ•°æ›´æ–°</span></span><br><span class="line">        optimizer.zero_grad(set_to_none=<span class="literal">True</span>)</span><br><span class="line">        loss.backward()</span><br><span class="line">        <span class="comment"># æ¢¯åº¦è£å‰ª</span></span><br><span class="line">        gradient_clip(model.parameters(), max_l2_norm=train_config.max_grad_norm)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å­¦ä¹ ç‡è°ƒåº¦</span></span><br><span class="line">        lr = cosine_annealing_lr(</span><br><span class="line">            t=step,</span><br><span class="line">            alpha_max=train_config.max_lr,</span><br><span class="line">            alpha_min=train_config.min_lr,</span><br><span class="line">            Tw=train_config.warmup_steps,</span><br><span class="line">            Tc=train_config.num_steps - train_config.warmup_steps,</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">for</span> param_group <span class="keyword">in</span> optimizer.param_groups:</span><br><span class="line">            param_group[<span class="string">&quot;lr&quot;</span>] = lr</span><br><span class="line">        optimizer.step()</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="4-3-æ•°æ®åŠ è½½å™¨ï¼ˆDataloaderï¼‰"><a href="#4-3-æ•°æ®åŠ è½½å™¨ï¼ˆDataloaderï¼‰" class="headerlink" title="4.3 æ•°æ®åŠ è½½å™¨ï¼ˆDataloaderï¼‰"></a>4.3 æ•°æ®åŠ è½½å™¨ï¼ˆDataloaderï¼‰</h2><p>æœ‰äº†æ¨¡å‹å’Œä¼˜åŒ–å™¨ä¹‹åï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ª<strong>æ•°æ®åŠ è½½å™¨ï¼ˆDataloaderï¼‰</strong>æ¥æä¾›è®­ç»ƒæ•°æ®ã€‚åœ¨è¯­è¨€æ¨¡å‹çš„è®­ç»ƒä¸­ï¼Œæ•°æ®é€šå¸¸æ˜¯æ–‡æœ¬åºåˆ—ï¼Œæˆ‘ä»¬éœ€è¦å°†è¿™äº›æ–‡æœ¬åºåˆ—è½¬æ¢ä¸ºæ¨¡å‹å¯ä»¥å¤„ç†çš„æ ¼å¼ã€‚è¿˜è®°å¾—æˆ‘ä»¬åœ¨ Part 01 è®²è¿‡çš„ Tokenization å—ï¼Ÿæˆ‘ä»¬éœ€è¦å…ˆæŠŠæ–‡æœ¬è½¬æˆ token idsï¼Œç„¶åå†ç»„ç»‡æˆé€‚åˆæ¨¡å‹è¾“å…¥çš„æ‰¹æ¬¡ã€‚æˆ‘ä»¬å·²ç»è®­ç»ƒå®ŒTokenizerï¼Œå¹¶ä¸”æŠŠæ–‡æœ¬è½¬æ¢æˆäº†token idçš„å½¢å¼ä¿å­˜åœ¨ .bin æ–‡ä»¶é‡Œï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªDataloaderæ¥ä»è¿™äº›token idsä¸­æå–è®­ç»ƒæ ·æœ¬ã€‚</p>
<p>åœ¨è¿™ä¸ªä½œä¸šä¸­ï¼Œæˆ‘ä»¬é‡‡ç”¨<strong>ä¸º context_length çš„é¡ºåºé‡‡æ ·ï¼ˆsequential samplingï¼‰</strong> ä½œä¸ºä¸€ä¸ªæ•°æ®åŠ è½½å™¨ã€‚æˆ‘ä»¬ä¼šä¸æ–­åœ°ä»æ•°æ®ä¸­æŒ‰é¡ºåºæå–å‡ºé•¿åº¦ä¸º context_length çš„å­åºåˆ—ä½œä¸ºè¾“å…¥ï¼Œç›®æ ‡æ˜¯é¢„æµ‹ä¸‹ä¸€ä¸ª tokenã€‚æˆ‘ä»¬ä¼šä¸æ–­åœ°ä»æ•°æ®ä¸­æå–è¿™æ ·çš„å­åºåˆ—ï¼Œç›´åˆ°è¾¾åˆ°æŒ‡å®šçš„æ‰¹æ¬¡å¤§å°ï¼ˆbatch sizeï¼‰ã€‚</p>
<p>ä»£ç ä¸­ç”¨çš„æ˜¯ <strong>Random Sampling</strong>ï¼Œä¹Ÿå°±æ˜¯éšæœºæŒ‡å®šèµ·ç‚¹ï¼Œç„¶åæˆªå– context_length çš„åºåˆ—ä½œä¸ºè¾“å…¥ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cs336_basics/data.py</span></span><br><span class="line"></span><br><span class="line">original_data = np.memmap( </span><br><span class="line">    train_config.train_data_path, </span><br><span class="line">    dtype=np.uint16, </span><br><span class="line">    mode=<span class="string">&quot;r+&quot;</span>, </span><br><span class="line">)</span><br><span class="line">x_t = torch.from_numpy(original_data) </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_batch_sequential</span>(<span class="params"></span></span><br><span class="line"><span class="params">    x_t: torch.Tensor | np.ndarray,</span></span><br><span class="line"><span class="params">    batch_size: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    context_length: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    device: <span class="built_in">str</span> | torch.device,</span></span><br><span class="line"><span class="params">    state: BatchState,</span></span><br><span class="line"><span class="params">    *,</span></span><br><span class="line"><span class="params">    stride: <span class="built_in">int</span> | <span class="literal">None</span> = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    <span class="keyword">if</span> stride <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        stride = context_length</span><br><span class="line"></span><br><span class="line">    n = x_t.numel()</span><br><span class="line">    max_start = n - context_length - <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> max_start &lt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Sequence too short: n=<span class="subst">&#123;n&#125;</span>, context_length=<span class="subst">&#123;context_length&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># é¿å…æ¯ä¸ªæ ·æœ¬éƒ½åšå–æ¨¡å›ç»•ï¼šå¦‚æœå³å°†è¶Šè¿‡æœ«å°¾ï¼Œå°±æŠŠæ¸¸æ ‡é‡ç½®åˆ°å¼€å¤´</span></span><br><span class="line">    last_start = state.pos + (batch_size - <span class="number">1</span>) * stride</span><br><span class="line">    end = last_start + context_length + <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> end &gt; n:</span><br><span class="line">        state.pos = <span class="number">0</span></span><br><span class="line">        last_start = (batch_size - <span class="number">1</span>) * stride</span><br><span class="line">        end = last_start + context_length + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    base = x_t[state.pos : end]  <span class="comment"># 1D contiguous slice</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ„é€  (B, T) çš„äºŒç»´è§†å›¾ï¼›å¯¹ PyTorch tensor æ¥è¯´ stride å•ä½æ˜¯â€œå…ƒç´ ä¸ªæ•°â€</span></span><br><span class="line">    inputs = base.as_strided(size=(batch_size, context_length), stride=(stride, <span class="number">1</span>)) </span><br><span class="line">    targets = base[<span class="number">1</span>:].as_strided(size=(batch_size, context_length), stride=(stride, <span class="number">1</span>)) <span class="comment"># å³ç§»ä¸€ä½ä½œä¸ºæ ‡ç­¾</span></span><br><span class="line"></span><br><span class="line">    state.pos += batch_size * stride</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å…ˆæ¬åˆ°ç›®æ ‡è®¾å¤‡å†è½¬ longï¼ˆå…ˆæ¬è¿å† castï¼šæ›´çœ CPUï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">isinstance</span>(device, torch.device) <span class="keyword">and</span> device.<span class="built_in">type</span> == <span class="string">&quot;cuda&quot;</span>) <span class="keyword">or</span> (</span><br><span class="line">        <span class="built_in">isinstance</span>(device, <span class="built_in">str</span>) <span class="keyword">and</span> <span class="string">&quot;cuda&quot;</span> <span class="keyword">in</span> device.lower()</span><br><span class="line">    ):</span><br><span class="line">        inputs = inputs.to(device, non_blocking=<span class="literal">True</span>).long() </span><br><span class="line">        targets = targets.to(device, non_blocking=<span class="literal">True</span>).long() </span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        inputs = inputs.long().to(device)</span><br><span class="line">        targets = targets.long().to(device)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> inputs, targets</span><br></pre></td></tr></table></figure>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™éƒ¨åˆ†å¯èƒ½æ˜¯è®­ç»ƒæ—¶é—´ç“¶é¢ˆï¼Œå› ä¸ºæ•°æ®åŠ è½½å’Œé¢„å¤„ç†å¯èƒ½ä¼šæ¯”è¾ƒæ…¢ï¼Œå°¤å…¶æ˜¯å½“æ•°æ®é‡å¾ˆå¤§æ—¶ã€‚æˆ‘ä»¬è¿ç”¨äº†ä»¥ä¸‹å‡ ä¸ªæŠ€å·§æ¥æå‡æ•°æ®åŠ è½½çš„æ•ˆç‡ï¼š</p>
<ul>
<li>ä½¿ç”¨ np.memmap æ¥å†…å­˜æ˜ å°„æ•°æ®æ–‡ä»¶ï¼Œè¿™æ ·å¯ä»¥é¿å…ä¸€æ¬¡æ€§åŠ è½½æ•´ä¸ªæ•°æ®é›†åˆ°å†…å­˜ä¸­ï¼ŒèŠ‚çœå†…å­˜ç©ºé—´ã€‚</li>
<li>ä½¿ç”¨ as_strided æ¥åˆ›å»ºè¾“å…¥å’Œç›®æ ‡çš„è§†å›¾ï¼Œé¿å…äº†æ•°æ®çš„å¤åˆ¶ï¼Œæé«˜äº†æ•ˆç‡ã€‚</li>
<li>ä½¿ç”¨éé˜»å¡çš„æ•°æ®ä¼ è¾“ï¼ˆnon_blocking=Trueï¼‰æ¥åŠ é€Ÿæ•°æ®ä» CPU åˆ° GPU çš„ä¼ è¾“ã€‚</li>
</ul>
<hr>
<h2 id="4-4-æ£€æŸ¥ç‚¹ï¼ˆCheckpointï¼‰"><a href="#4-4-æ£€æŸ¥ç‚¹ï¼ˆCheckpointï¼‰" class="headerlink" title="4.4 æ£€æŸ¥ç‚¹ï¼ˆCheckpointï¼‰"></a>4.4 æ£€æŸ¥ç‚¹ï¼ˆCheckpointï¼‰</h2><p>åœ¨è®­ç»ƒæ¨¡å‹çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ—¶ä¸æ—¶çš„ä¿æŒ Checkpointï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºè®­ç»ƒæ¨¡å‹ä¸åªæ˜¯â€œæŠŠ loss è®­åˆ°ä½â€è¿™ä¹ˆç®€å•ï¼Œæˆ‘ä»¬è¿˜ç»å¸¸éœ€è¦ï¼š</p>
<ul>
<li><strong>ä¸­é€”æ¢å¤è®­ç»ƒ</strong>ï¼šæ¯”å¦‚è®­ç»ƒè·‘åˆ°ä¸€åŠæœºå™¨æ–­äº†ã€ä½œä¸šè¶…æ—¶ã€æ„å¤–é€€å‡º</li>
<li><strong>å®éªŒä¸å¤ç°</strong>ï¼šæ–¹ä¾¿ä¹‹ååˆ†æè®­ç»ƒè¿‡ç¨‹ã€æ¯”è¾ƒä¸åŒé˜¶æ®µçš„æ¨¡å‹ã€åšä¸åŒé˜¶æ®µçš„é‡‡æ ·ã€Exponential Moving Averageï¼ˆEMAï¼‰ç­‰ç­‰</li>
</ul>
<p>Checkpoint çš„ç›®æ ‡æ˜¯ï¼š<strong>è®©ä½ èƒ½ä»ä¸­æ–­å¤„æ— ç¼ç»§ç»­è®­ç»ƒ</strong>ã€‚<br>å› æ­¤è‡³å°‘è¦å­˜è¿™ä¸‰ç±»ä¸œè¥¿ï¼š</p>
<ol>
<li><strong>æ¨¡å‹å‚æ•°ï¼ˆmodel weightsï¼‰</strong><ul>
<li>æ²¡æœ‰å®ƒï¼Œå°±æ²¡æœ‰æ¨¡å‹æœ¬ä½“äº†</li>
</ul>
</li>
<li><strong>ä¼˜åŒ–å™¨çŠ¶æ€ï¼ˆoptimizer stateï¼‰</strong><ul>
<li>ä¾‹å¦‚ AdamW çš„ä¸€é˜¶/äºŒé˜¶åŠ¨é‡ï¼ˆmoment estimatesï¼‰</li>
<li>ä¸å­˜ä¼˜åŒ–å™¨çŠ¶æ€ï¼Œæ¢å¤åè®­ç»ƒå°±ä¼šå˜ï¼ˆå› ä¸ºåŠ¨é‡æ²¡äº†ï¼‰</li>
</ul>
</li>
<li><strong>å½“å‰è¿­ä»£æ­¥æ•°ï¼ˆiteration / stepï¼‰</strong><ul>
<li>ç”¨æ¥æ¢å¤å­¦ä¹ ç‡ä»å¤´å¼€å§‹æˆ–é”™ä½</li>
<li>å¦åˆ™å­¦ä¹ ç‡ä¼šä»å¤´å¼€å§‹ schedule</li>
</ul>
</li>
</ol>
<p>å®ç°å¦‚ä¸‹ï¼š<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cs336_basics/utils.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">save_checkpoint</span>(<span class="params"></span></span><br><span class="line"><span class="params">    model: torch.nn.Module,</span></span><br><span class="line"><span class="params">    optimizer,</span></span><br><span class="line"><span class="params">    iteration,</span></span><br><span class="line"><span class="params">    out: <span class="built_in">str</span> | os.PathLike | typing.BinaryIO | typing.IO[<span class="built_in">bytes</span>],</span></span><br><span class="line"><span class="params">    verbose: <span class="built_in">bool</span> = <span class="literal">False</span>,</span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    state = &#123;</span><br><span class="line">        <span class="string">&quot;model_state_dict&quot;</span>: model.state_dict(),</span><br><span class="line">        <span class="string">&quot;optimizer_state_dict&quot;</span>: optimizer.state_dict(),</span><br><span class="line">        <span class="string">&quot;iteration&quot;</span>: iteration,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    torch.save(state, out)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> verbose:</span><br><span class="line">        print_color(<span class="string">f&quot;Checkpoint saved to <span class="subst">&#123;out&#125;</span>&quot;</span>, <span class="string">&quot;blue&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_checkpoint</span>(<span class="params"></span></span><br><span class="line"><span class="params">    src: <span class="built_in">str</span> | os.PathLike | typing.BinaryIO | typing.IO[<span class="built_in">bytes</span>], model, optimizer, verbose: <span class="built_in">bool</span> = <span class="literal">False</span></span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    state = torch.load(src, map_location=get_device())</span><br><span class="line"></span><br><span class="line">    model.load_state_dict(state[<span class="string">&quot;model_state_dict&quot;</span>])</span><br><span class="line">    optimizer.load_state_dict(state[<span class="string">&quot;optimizer_state_dict&quot;</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> verbose:</span><br><span class="line">        print_color(<span class="string">f&quot;Checkpoint loaded from <span class="subst">&#123;src&#125;</span>&quot;</span>, <span class="string">&quot;blue&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> state[<span class="string">&quot;iteration&quot;</span>]</span><br></pre></td></tr></table></figure></p>
<hr>
<h2 id="4-5-è®­ç»ƒå¾ªç¯"><a href="#4-5-è®­ç»ƒå¾ªç¯" class="headerlink" title="4.5 è®­ç»ƒå¾ªç¯"></a>4.5 è®­ç»ƒå¾ªç¯</h2><p>æœ€åï¼Œæˆ‘ä»¬æŠŠæ‰€æœ‰çš„ç»„ä»¶æ”¾åœ¨ä¸€èµ·ï¼Œå½¢æˆä¸€ä¸ªå®Œæ•´çš„è®­ç»ƒå¾ªç¯ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cs336_basics/train_engine.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">train</span>(<span class="params">model: torch.nn.Module, optimizer: torch.optim.Optimizer, train_config: TrainingConfig</span>):</span><br><span class="line">    tokenizer = load_tokenizer_from_dir(train_config.dataset_dir)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># åŠ è½½è®­ç»ƒæ•°æ®é›†</span></span><br><span class="line">    original_data = np.memmap(</span><br><span class="line">        train_config.train_data_path,</span><br><span class="line">        dtype=np.uint16,</span><br><span class="line">        mode=<span class="string">&quot;r+&quot;</span>,</span><br><span class="line">    )</span><br><span class="line">    x = torch.from_numpy(original_data)</span><br><span class="line"></span><br><span class="line">    best_eval_loss = <span class="built_in">float</span>(<span class="string">&quot;inf&quot;</span>)</span><br><span class="line">    ctx = get_ctx(train_config.use_mixed_precision, train_config.device)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®­ç»ƒä¸»å¾ªç¯</span></span><br><span class="line">    state = BatchState(pos=<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">for</span> step <span class="keyword">in</span> <span class="built_in">range</span>(train_config.num_steps):</span><br><span class="line">        <span class="comment"># è·å–ä¸€ä¸ª batch çš„è¾“å…¥/æ ‡ç­¾ï¼ˆé¡ºåºè¯»å–ï¼‰</span></span><br><span class="line">        inputs, targets = data_loading_sequential(</span><br><span class="line">            x=x,</span><br><span class="line">            batch_size=train_config.batch_size,</span><br><span class="line">            context_length=model.config.max_seq_len,</span><br><span class="line">            device=train_config.device,</span><br><span class="line">            state=state,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å‰å‘ä¼ æ’­</span></span><br><span class="line">        <span class="keyword">with</span> ctx:</span><br><span class="line">            logits = model(inputs)</span><br><span class="line">            logits = logits.view(-<span class="number">1</span>, logits.size(-<span class="number">1</span>))</span><br><span class="line">            targets = targets.view(-<span class="number">1</span>)</span><br><span class="line">            loss = cross_entropy(logits, targets)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># åå‘ä¼ æ’­ + å‚æ•°æ›´æ–°</span></span><br><span class="line">        optimizer.zero_grad(set_to_none=<span class="literal">True</span>)</span><br><span class="line">        loss.backward()</span><br><span class="line">        <span class="comment"># æ¢¯åº¦è£å‰ª</span></span><br><span class="line">        gradient_clip(model.parameters(), max_l2_norm=train_config.max_grad_norm)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å­¦ä¹ ç‡è°ƒåº¦</span></span><br><span class="line">        lr = cosine_annealing_lr(</span><br><span class="line">            t=step,</span><br><span class="line">            alpha_max=train_config.max_lr,</span><br><span class="line">            alpha_min=train_config.min_lr,</span><br><span class="line">            Tw=train_config.warmup_steps,</span><br><span class="line">            Tc=train_config.num_steps - train_config.warmup_steps,</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">for</span> param_group <span class="keyword">in</span> optimizer.param_groups:</span><br><span class="line">            param_group[<span class="string">&quot;lr&quot;</span>] = lr</span><br><span class="line">        optimizer.step()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è®°å½•æ—¥å¿—</span></span><br><span class="line">        <span class="keyword">if</span> train_config.wandb_logging:</span><br><span class="line">            wandb.log(</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;train/loss&quot;</span>: loss.item(),</span><br><span class="line">                    <span class="string">&quot;train/perplexity&quot;</span>: perplexity(loss).item(),</span><br><span class="line">                    <span class="string">&quot;train/lr&quot;</span>: lr,</span><br><span class="line">                &#125;,</span><br><span class="line">                step=step + <span class="number">1</span>,</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">        print_color(</span><br><span class="line">            <span class="string">f&quot;Step <span class="subst">&#123;step + <span class="number">1</span>&#125;</span>/<span class="subst">&#123;train_config.num_steps&#125;</span>, Loss: <span class="subst">&#123;loss.item():<span class="number">.4</span>f&#125;</span>, LR: <span class="subst">&#123;lr:<span class="number">.6</span>f&#125;</span>&quot;</span>, <span class="string">&quot;green&quot;</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> train_config.eval_log_interval &gt; <span class="number">0</span> <span class="keyword">and</span> (step + <span class="number">1</span>) % train_config.eval_log_interval == <span class="number">0</span>:</span><br><span class="line">            <span class="comment"># æ¸…ç†æ˜¾å­˜/å†…å­˜å ç”¨</span></span><br><span class="line">            <span class="keyword">del</span> inputs, targets, logits, loss</span><br><span class="line">            clear_memory()</span><br><span class="line"></span><br><span class="line">            print_color(<span class="string">&quot;Evaluating model...&quot;</span>, <span class="string">&quot;blue&quot;</span>)</span><br><span class="line">            eval_loss, eval_perplexity = eval_model(model, train_config, step + <span class="number">1</span>)</span><br><span class="line">            wandb.log(</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;eval/loss&quot;</span>: eval_loss.item(),</span><br><span class="line">                    <span class="string">&quot;eval/perplexity&quot;</span>: eval_perplexity.item(),</span><br><span class="line">                &#125;,</span><br><span class="line">                step=step + <span class="number">1</span>,</span><br><span class="line">            )</span><br><span class="line">            print_color(</span><br><span class="line">                <span class="string">f&quot;Eval Loss: <span class="subst">&#123;eval_loss.item():<span class="number">.4</span>f&#125;</span>, Eval Perplexity: <span class="subst">&#123;eval_perplexity.item():<span class="number">.4</span>f&#125;</span>&quot;</span>, <span class="string">&quot;blue&quot;</span></span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">if</span> eval_loss &lt; best_eval_loss:</span><br><span class="line">                best_eval_loss = eval_loss</span><br><span class="line">                print_color(<span class="string">f&quot;New best eval loss: <span class="subst">&#123;best_eval_loss:<span class="number">.4</span>f&#125;</span>&quot;</span>, <span class="string">&quot;yellow&quot;</span>)</span><br><span class="line">                out_path = os.path.join(</span><br><span class="line">                    train_config.save_checkpoint_dir,</span><br><span class="line">                    train_config.model_name,</span><br><span class="line">                    <span class="string">f&quot;best_model_step_<span class="subst">&#123;step + <span class="number">1</span>&#125;</span>.pt&quot;</span>,</span><br><span class="line">                )</span><br><span class="line">                save_checkpoint(</span><br><span class="line">                    model=model,</span><br><span class="line">                    optimizer=optimizer,</span><br><span class="line">                    iteration=step + <span class="number">1</span>,</span><br><span class="line">                    out=out_path,</span><br><span class="line">                    verbose=<span class="literal">True</span>,</span><br><span class="line">                )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># é‡‡æ ·ç”Ÿæˆç¤ºä¾‹</span></span><br><span class="line">        <span class="keyword">if</span> train_config.sampling_log_interval &gt; <span class="number">0</span> <span class="keyword">and</span> (step + <span class="number">1</span>) % train_config.sampling_log_interval == <span class="number">0</span>:</span><br><span class="line">            generated_outputs = generate(</span><br><span class="line">                model=model,</span><br><span class="line">                prompt=<span class="string">&quot;Once upon a time&quot;</span>,</span><br><span class="line">                tokenizer=tokenizer,</span><br><span class="line">                max_new_tokens=<span class="number">256</span>,</span><br><span class="line">                top_k=<span class="number">50</span>,</span><br><span class="line">                temperature=<span class="number">0.8</span>,</span><br><span class="line">            )</span><br><span class="line">            generated_text = generated_outputs[<span class="string">&quot;generated_text&quot;</span>]</span><br><span class="line">            print_color(<span class="string">f&quot;Generated text at step <span class="subst">&#123;step + <span class="number">1</span>&#125;</span>:&quot;</span>, <span class="string">&quot;cyan&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Once upon a time&quot;</span>, end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">            print_color(<span class="string">f&quot;<span class="subst">&#123;generated_text&#125;</span>\n&quot;</span>, <span class="string">&quot;cyan&quot;</span>)</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="5-Part-04-ç”Ÿæˆ"><a href="#5-Part-04-ç”Ÿæˆ" class="headerlink" title="5 Part 04: ç”Ÿæˆ"></a>5 Part 04: ç”Ÿæˆ</h1><p>è®­ç»ƒå®Œæ¨¡å‹ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒæ¥ç”Ÿæˆæ–‡æœ¬ã€‚åœ¨è¯­è¨€æ¨¡å‹ä¸­ï¼Œæ–‡æœ¬ç”Ÿæˆé€šå¸¸æ˜¯é€šè¿‡<strong>é‡‡æ ·ï¼ˆsamplingï¼‰</strong>çš„æ–¹å¼æ¥å®ç°çš„ã€‚ç»™å®šä¸€ä¸ªåˆå§‹çš„ä¸Šä¸‹æ–‡ï¼ˆpromptï¼‰ï¼Œæ¨¡å‹ä¼šæ ¹æ®å½“å‰çš„ä¸Šä¸‹æ–‡é¢„æµ‹ä¸‹ä¸€ä¸ª token çš„æ¦‚ç‡åˆ†å¸ƒï¼Œç„¶åä»è¿™ä¸ªåˆ†å¸ƒä¸­é‡‡æ ·ä¸€ä¸ª tokenï¼ŒåŠ å…¥åˆ°ä¸Šä¸‹æ–‡ä¸­ï¼Œé‡å¤è¿™ä¸ªè¿‡ç¨‹ï¼Œç›´åˆ°ç”ŸæˆæŒ‡å®šé•¿åº¦çš„æ–‡æœ¬ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹é‡‡æ ·çš„åŸºæœ¬æµç¨‹ï¼š</p>
<ol>
<li><strong>è¾“å…¥ä¸Šä¸‹æ–‡</strong>ï¼šç»™å®šä¸€ä¸ªåˆå§‹çš„æ–‡æœ¬ä¸Šä¸‹æ–‡ï¼ˆpromptï¼‰ï¼Œå°†å…¶è½¬æ¢ä¸º token idsã€‚</li>
<li><strong>å¾ªç¯ç”Ÿæˆ</strong>ï¼šå¯¹äºæ¯ä¸€æ­¥ç”Ÿæˆï¼š<ul>
<li>ä½¿ç”¨æ¨¡å‹é¢„æµ‹ä¸‹ä¸€ä¸ª token çš„æ¦‚ç‡åˆ†å¸ƒã€‚</li>
<li>æ ¹æ®é‡‡æ ·ç­–ç•¥ä»æ¦‚ç‡åˆ†å¸ƒä¸­é€‰æ‹©ä¸‹ä¸€ä¸ª tokenã€‚</li>
<li>å°†é€‰ä¸­çš„ token åŠ å…¥åˆ°ä¸Šä¸‹æ–‡ä¸­ï¼Œä½œä¸ºä¸‹ä¸€æ­¥çš„è¾“å…¥ã€‚</li>
<li>é‡å¤ä¸Šè¿°è¿‡ç¨‹ï¼Œç›´åˆ°ç”ŸæˆæŒ‡å®šæ•°é‡çš„ tokenã€‚</li>
</ul>
</li>
<li><strong>è¾“å‡ºç”Ÿæˆæ–‡æœ¬</strong>ï¼šå°†ç”Ÿæˆçš„ token ids è½¬æ¢å›æ–‡æœ¬ï¼Œè¾“å‡ºæœ€ç»ˆç”Ÿæˆçš„æ–‡æœ¬ã€‚</li>
</ol>
<p>ç”¨ä»£ç å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cs336_basics/generation.py</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@torch.no_grad()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate</span>(<span class="params"></span></span><br><span class="line"><span class="params">    model: torch.nn.Module,</span></span><br><span class="line"><span class="params">    prompt: torch.Tensor | <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">    tokenizer: BPETokenizer,</span></span><br><span class="line"><span class="params">    max_new_tokens: <span class="built_in">int</span> = <span class="number">256</span>,</span></span><br><span class="line"><span class="params">    top_k: <span class="built_in">int</span> = <span class="number">0</span>,</span></span><br><span class="line"><span class="params">    top_p: <span class="built_in">float</span> = <span class="number">0.0</span>,</span></span><br><span class="line"><span class="params">    temperature: <span class="built_in">float</span> = <span class="number">1.0</span>,</span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="built_in">dict</span>:</span><br><span class="line">    model.<span class="built_in">eval</span>()</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(prompt, <span class="built_in">str</span>):</span><br><span class="line">        out = tokenizer.encode(prompt)</span><br><span class="line">        input_ids = out.ids <span class="keyword">if</span> <span class="built_in">hasattr</span>(out, <span class="string">&quot;ids&quot;</span>) <span class="keyword">else</span> out  <span class="comment"># è¾“å…¥ token id åˆ—è¡¨ï¼ˆList[int]ï¼‰</span></span><br><span class="line">        input_ids = torch.tensor(input_ids, dtype=torch.long).unsqueeze(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        input_ids = prompt.unsqueeze(<span class="number">0</span>)  <span class="comment"># å¢åŠ  batch ç»´åº¦</span></span><br><span class="line"></span><br><span class="line">    input_ids = input_ids.to(model.device)</span><br><span class="line">    input_len = input_ids.shape[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> torch.amp.autocast(<span class="string">&quot;cuda&quot;</span>, enabled=<span class="literal">False</span>):</span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(max_new_tokens):</span><br><span class="line">            logits = model(input_ids)</span><br><span class="line">            next_token_logits = logits[:, -<span class="number">1</span>, :].<span class="built_in">float</span>()   <span class="comment"># å–æœ€åä¸€ä¸ªä½ç½®çš„ logitsï¼ˆé¢„æµ‹ä¸‹ä¸€ä¸ª tokenï¼‰</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># ä»æ¦‚ç‡åˆ†å¸ƒä¸­é‡‡æ ·ä¸‹ä¸€ä¸ª token</span></span><br><span class="line">            <span class="keyword">assert</span> temperature &gt; <span class="number">0.0</span>, <span class="string">&quot;Temperature must be positive.&quot;</span></span><br><span class="line">            <span class="keyword">assert</span> top_p == <span class="number">0.0</span> <span class="keyword">or</span> top_k == <span class="number">0</span>, <span class="string">&quot;Only one of top_p or top_k should be set.&quot;</span></span><br><span class="line">            next_token_logits = next_token_logits / temperature</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> top_k &gt; <span class="number">0</span>:</span><br><span class="line">                next_token_id = top_k_sampling(next_token_logits, top_k)</span><br><span class="line">            <span class="keyword">elif</span> top_p &gt; <span class="number">0.0</span>:</span><br><span class="line">                next_token_id = top_p_sampling(next_token_logits, top_p)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                next_token_id = next_token_logits.argmax(dim=-<span class="number">1</span>, keepdim=<span class="literal">True</span>)  <span class="comment"># ä¸é‡‡æ ·åˆ™ç”¨è´ªå¿ƒç­–ç•¥</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> next_token_id.item() == tokenizer.eos_token_id:</span><br><span class="line">                <span class="keyword">break</span>  <span class="comment"># ç”Ÿæˆåˆ° EOSï¼ˆç»“æŸç¬¦ï¼‰åˆ™åœæ­¢</span></span><br><span class="line">            input_ids = torch.cat([input_ids, next_token_id], dim=-<span class="number">1</span>)  <span class="comment"># æŠŠæ–° token æ‹¼æ¥åˆ°è¾“å…¥åºåˆ—æœ«å°¾</span></span><br><span class="line"></span><br><span class="line">    input_ids = input_ids.squeeze(<span class="number">0</span>)  <span class="comment"># å»æ‰ batch ç»´åº¦</span></span><br><span class="line">    all_text = tokenizer.decode(input_ids.tolist())</span><br><span class="line">    generated_ids = input_ids[input_len:]</span><br><span class="line">    generated_text = tokenizer.decode(generated_ids.tolist())</span><br><span class="line"></span><br><span class="line">    model.train()</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&quot;all_text&quot;</span>: all_text,</span><br><span class="line">        <span class="string">&quot;generated_text&quot;</span>: generated_text,</span><br><span class="line">        <span class="string">&quot;generated_ids&quot;</span>: generated_ids,</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ä¸åŒçš„é‡‡æ ·è¿‡ç¨‹ï¼Œä¼šç”Ÿæˆä¸åŒé£æ ¼çš„æ–‡æœ¬ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å‡ ç§å¸¸ç”¨çš„é‡‡æ ·æ–¹æ³•ï¼š</p>
<ul>
<li>Greedy Sampling</li>
<li>Top-K Sampling</li>
<li>Top-P (Nucleus) Sampling</li>
</ul>
<hr>
<h2 id="5-1-è´ªå¿ƒé‡‡æ ·ï¼ˆGreedy-Samplingï¼‰"><a href="#5-1-è´ªå¿ƒé‡‡æ ·ï¼ˆGreedy-Samplingï¼‰" class="headerlink" title="5.1 è´ªå¿ƒé‡‡æ ·ï¼ˆGreedy Samplingï¼‰"></a>5.1 è´ªå¿ƒé‡‡æ ·ï¼ˆGreedy Samplingï¼‰</h2><p>Greedy Sampling æ˜¯æœ€ç®€å•çš„ä¸€ç§é‡‡æ ·æ–¹æ³•ã€‚åœ¨æ¯ä¸€æ­¥ç”Ÿæˆæ—¶ï¼Œæ¨¡å‹ä¼šé€‰æ‹©æ¦‚ç‡æœ€é«˜çš„ token ä½œä¸ºä¸‹ä¸€ä¸ª tokenã€‚è™½ç„¶è¿™ç§æ–¹æ³•ç®€å•ä¸”é«˜æ•ˆï¼Œä½†å®ƒå¯èƒ½ä¼šå¯¼è‡´ç”Ÿæˆçš„æ–‡æœ¬ç¼ºä¹å¤šæ ·æ€§å’Œåˆ›é€ æ€§ï¼Œå› ä¸ºå®ƒæ€»æ˜¯é€‰æ‹©æœ€å¯èƒ½çš„é€‰é¡¹ï¼Œå®¹æ˜“é™·å…¥å±€éƒ¨æœ€ä¼˜ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cs336_basics/generation.py</span></span><br><span class="line">next_token_id = next_token_logits.argmax(dim=-<span class="number">1</span>, keepdim=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="5-2-Top-K-é‡‡æ ·ï¼ˆTop-K-Samplingï¼‰"><a href="#5-2-Top-K-é‡‡æ ·ï¼ˆTop-K-Samplingï¼‰" class="headerlink" title="5.2 Top-K é‡‡æ ·ï¼ˆTop-K Samplingï¼‰"></a>5.2 Top-K é‡‡æ ·ï¼ˆTop-K Samplingï¼‰</h2><p>Top-K Sampling æ˜¯ä¸€ç§æ”¹è¿›çš„é‡‡æ ·æ–¹æ³•ã€‚åœ¨æ¯ä¸€æ­¥ç”Ÿæˆæ—¶ï¼Œæ¨¡å‹ä¼šé€‰æ‹©æ¦‚ç‡æœ€é«˜çš„ K ä¸ª tokenï¼Œç„¶åä»è¿™ K ä¸ª token ä¸­æ ¹æ®å®ƒä»¬çš„æ¦‚ç‡åˆ†å¸ƒè¿›è¡Œé‡‡æ ·ã€‚è¿™æ ·å¯ä»¥å¢åŠ ç”Ÿæˆæ–‡æœ¬çš„å¤šæ ·æ€§ï¼ŒåŒæ—¶ä»ç„¶ä¿æŒä¸€å®šçš„è´¨é‡ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cs336_basics/generation.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">top_k_sampling</span>(<span class="params"></span></span><br><span class="line"><span class="params">    logits: torch.Tensor,</span></span><br><span class="line"><span class="params">    top_k: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    <span class="keyword">if</span> top_k &lt;= <span class="number">0</span>:</span><br><span class="line">        <span class="comment"># ä»å®Œæ•´çš„æ¦‚ç‡åˆ†å¸ƒä¸­é‡‡æ ·ï¼ˆä¸åš top-k æˆªæ–­ï¼‰</span></span><br><span class="line">        probs = F.softmax(logits, dim=-<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> torch.multinomial(probs, num_samples=<span class="number">1</span>).squeeze(-<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1. åªä¿ç•™ top-k ä¸ªæœ€å¤§çš„ logitsï¼ˆå…¶ä½™ä½ç½®è®¾ä¸º -infï¼Œç›¸å½“äºæ¦‚ç‡ä¸º 0ï¼‰</span></span><br><span class="line">    top_k_logits, top_k_indices = torch.topk(logits, top_k, dim=-<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    filtered_logits = torch.full_like(logits, <span class="built_in">float</span>(<span class="string">&quot;-inf&quot;</span>))</span><br><span class="line">    filtered_logits.scatter_(dim=-<span class="number">1</span>, index=top_k_indices, src=top_k_logits)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. åœ¨æˆªæ–­åçš„ logits ä¸Šåš softmaxï¼Œå¾—åˆ°å½’ä¸€åŒ–æ¦‚ç‡</span></span><br><span class="line">    probs = F.softmax(filtered_logits, dim=-<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3. æŒ‰è¯¥æ¦‚ç‡åˆ†å¸ƒè¿›è¡Œé‡‡æ ·ï¼Œå¾—åˆ°ä¸‹ä¸€ä¸ª token</span></span><br><span class="line">    next_token = torch.multinomial(probs, num_samples=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> next_token</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="5-3-Top-P-é‡‡æ ·ï¼ˆTop-P-Samplingï¼‰"><a href="#5-3-Top-P-é‡‡æ ·ï¼ˆTop-P-Samplingï¼‰" class="headerlink" title="5.3 Top-P é‡‡æ ·ï¼ˆTop-P Samplingï¼‰"></a>5.3 Top-P é‡‡æ ·ï¼ˆTop-P Samplingï¼‰</h2><p>Top-P Samplingï¼ˆä¹Ÿç§°ä¸º Nucleus Samplingï¼‰æ˜¯ä¸€ç§æ›´çµæ´»çš„é‡‡æ ·æ–¹æ³•ã€‚åœ¨æ¯ä¸€æ­¥ç”Ÿæˆæ—¶ï¼Œæ¨¡å‹ä¼šé€‰æ‹©ç´¯è®¡æ¦‚ç‡è¾¾åˆ° P çš„æœ€å° token é›†åˆï¼Œç„¶åä»è¿™ä¸ªé›†åˆä¸­æ ¹æ®å®ƒä»¬çš„æ¦‚ç‡åˆ†å¸ƒè¿›è¡Œé‡‡æ ·ã€‚è¿™æ ·å¯ä»¥åŠ¨æ€è°ƒæ•´å€™é€‰ token çš„æ•°é‡ï¼Œæ—¢ä¿è¯äº†å¤šæ ·æ€§ï¼Œåˆé¿å…äº†é€‰æ‹©è¿‡äºç½•è§çš„ tokenã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cs336_basics/generation.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">top_p_sampling</span>(<span class="params">logits: torch.Tensor, top_p: <span class="built_in">float</span></span>) -&gt; torch.Tensor:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    logits: (B, V)</span></span><br><span class="line"><span class="string">    è¿”å›: (B,) é‡‡æ ·å¾—åˆ°çš„ token id</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">assert</span> <span class="number">0.0</span> &lt; top_p &lt;= <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1. æŒ‰ logits ä»å¤§åˆ°å°æ’åºï¼ˆå¾—åˆ°æ’åºåçš„ logits ä»¥åŠå¯¹åº”çš„è¯è¡¨ç´¢å¼•ï¼‰</span></span><br><span class="line">    sorted_logits, sorted_indices = torch.sort(logits, dim=-<span class="number">1</span>, descending=<span class="literal">True</span>)</span><br><span class="line">    sorted_probs = F.softmax(sorted_logits, dim=-<span class="number">1</span>)</span><br><span class="line">    cumulative_probs = torch.cumsum(sorted_probs, dim=-<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. æ ‡è®°éœ€è¦å‰”é™¤çš„ tokenï¼šç´¯è®¡æ¦‚ç‡è¶…è¿‡ top_p çš„éƒ¨åˆ†ç½®ä¸º Trueï¼ˆä½†è‡³å°‘ä¿ç•™ 1 ä¸ª tokenï¼‰</span></span><br><span class="line">    sorted_indices_to_remove = cumulative_probs &gt; top_p</span><br><span class="line">    sorted_indices_to_remove[..., <span class="number">1</span>:] = sorted_indices_to_remove[..., :-<span class="number">1</span>].clone()</span><br><span class="line">    sorted_indices_to_remove[..., <span class="number">0</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3. å°†â€œéœ€è¦å‰”é™¤â€çš„ mask æŒ‰æ’åºç´¢å¼•æ•£å°„å›åŸå§‹è¯è¡¨ä½ç½®</span></span><br><span class="line">    indices_to_remove = torch.zeros_like(logits, dtype=torch.<span class="built_in">bool</span>)</span><br><span class="line">    indices_to_remove.scatter_(dim=-<span class="number">1</span>, index=sorted_indices, src=sorted_indices_to_remove)</span><br><span class="line">    <span class="comment"># 4. æŠŠè¢«å‰”é™¤ä½ç½®çš„ logits ç½®ä¸º -infï¼ˆsoftmax åæ¦‚ç‡ä¸º 0ï¼‰</span></span><br><span class="line">    filtered_logits = logits.masked_fill(indices_to_remove, <span class="built_in">float</span>(<span class="string">&quot;-inf&quot;</span>))</span><br><span class="line">    <span class="comment"># 5. åœ¨è¿‡æ»¤åçš„åˆ†å¸ƒä¸Šé‡‡æ ·ä¸‹ä¸€ä¸ª token</span></span><br><span class="line">    probs = F.softmax(filtered_logits, dim=-<span class="number">1</span>)</span><br><span class="line">    next_token = torch.multinomial(probs, num_samples=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> next_token</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="5-4-Temperature"><a href="#5-4-Temperature" class="headerlink" title="5.4 Temperature"></a>5.4 Temperature</h2><p>å½“ç„¶ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡è°ƒæ•´ <strong>temperature</strong> æ¥æ§åˆ¶ç”Ÿæˆæ–‡æœ¬çš„éšæœºæ€§ã€‚Temperature æ˜¯ä¸€ä¸ªæ­£æ•°ï¼Œé€šå¸¸åœ¨<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo stretchy="false">(</mo><mn>0</mn><mo separator="true">,</mo><mi mathvariant="normal">âˆ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(0, \infty)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">âˆ</span><span class="mclose">)</span></span></span></span></span><br>èŒƒå›´å†…ã€‚å®ƒé€šè¿‡ç¼©æ”¾ logits æ¥å½±å“æ¦‚ç‡åˆ†å¸ƒï¼š</p>
<ul>
<li>å½“ temperature &lt; 1 æ—¶ï¼Œæ¦‚ç‡åˆ†å¸ƒä¼šå˜å¾—æ›´é™¡å³­ï¼Œæ¨¡å‹æ›´å€¾å‘äºé€‰æ‹©é«˜æ¦‚ç‡çš„ tokenï¼Œç”Ÿæˆçš„æ–‡æœ¬æ›´ç¡®å®šæ€§ã€‚</li>
<li>å½“ temperature &gt; 1 æ—¶ï¼Œæ¦‚ç‡åˆ†å¸ƒä¼šå˜å¾—æ›´å¹³å¦ï¼Œæ¨¡å‹æ›´å€¾å‘äºé€‰æ‹©ä½æ¦‚ç‡çš„ tokenï¼Œç”Ÿæˆçš„æ–‡æœ¬æ›´å…·å¤šæ ·æ€§å’Œåˆ›é€ æ€§ã€‚</li>
</ul>
<p>æ•°å­¦ä¸Šï¼Œæˆ‘ä»¬é€šè¿‡é™¤ä»¥ temperature æ¥è°ƒæ•´ logitsï¼š<br><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><msub><mtext>softmax</mtext><mi>i</mi></msub><mo stretchy="false">(</mo><mi>z</mi><mo separator="true">;</mo><mi>T</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mi>exp</mi><mo>â¡</mo><mrow><mo fence="true">(</mo><mfrac><msub><mi>z</mi><mi>i</mi></msub><mi>T</mi></mfrac><mo fence="true">)</mo></mrow></mrow><mrow><munder><mo>âˆ‘</mo><mi>j</mi></munder><mi>exp</mi><mo>â¡</mo><mrow><mo fence="true">(</mo><mfrac><msub><mi>z</mi><mi>j</mi></msub><mi>T</mi></mfrac><mo fence="true">)</mo></mrow></mrow></mfrac></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(43)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">\text{softmax}_i(z; T) = \frac{\exp\left(\frac{z_i}{T}\right)}{\sum_j \exp\left(\frac{z_j}{T}\right)} \tag{43}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord text"><span class="mord">softmax</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mpunct">;</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.7658em;vertical-align:-1.1758em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.59em;"><span style="top:-2.26em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">âˆ‘</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.162em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.4358em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">exp</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8087em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.5073em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.044em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.74em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop">exp</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7115em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.4101em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.044em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:1.1758em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span><span class="tag"><span class="strut" style="height:2.7658em;vertical-align:-1.1758em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">43</span></span><span class="mord">)</span></span></span></span></span></span></p>
<p><img src="./temperature-sampling.png" alt="Temperatureå¯¹é‡‡æ ·åˆ†å¸ƒçš„å½±å“ç¤ºæ„å›¾"></p>
<hr>
<h2 id="5-5-Part-04-æ€»ç»“"><a href="#5-5-Part-04-æ€»ç»“" class="headerlink" title="5.5 Part 04 æ€»ç»“"></a>5.5 Part 04 æ€»ç»“</h2><p>åœ¨æœ¬éƒ¨åˆ†ï¼Œæˆ‘ä»¬ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨è®­ç»ƒå¥½çš„è¯­è¨€æ¨¡å‹è¿›è¡Œæ–‡æœ¬ç”Ÿæˆã€‚æˆ‘ä»¬è®¨è®ºäº†å‡ ç§å¸¸ç”¨çš„é‡‡æ ·æ–¹æ³•ï¼ŒåŒ…æ‹¬ Greedy Sampling, Top-K Sampling å’Œ Top-P Samplingï¼Œå¹¶ä»‹ç»äº†å¦‚ä½•é€šè¿‡è°ƒæ•´ temperature æ¥æ§åˆ¶ç”Ÿæˆæ–‡æœ¬çš„éšæœºæ€§ã€‚é€šè¿‡è¿™äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç”Ÿæˆå¤šæ ·åŒ–ä¸”æœ‰è¶£çš„æ–‡æœ¬å†…å®¹ã€‚</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>Sampling Method</th>
<th>Description</th>
<th>Pros</th>
<th>Cons</th>
</tr>
</thead>
<tbody>
<tr>
<td>Greedy Sampling</td>
<td>é€‰æ‹©æ¦‚ç‡æœ€é«˜çš„ token</td>
<td>ç®€å•é«˜æ•ˆ</td>
<td>å¯èƒ½ç¼ºä¹å¤šæ ·æ€§ï¼Œå®¹æ˜“é™·å…¥å±€éƒ¨æœ€ä¼˜</td>
</tr>
<tr>
<td>Top-K Sampling</td>
<td>ä»æ¦‚ç‡æœ€é«˜çš„ K ä¸ª token ä¸­é‡‡æ ·ï¼ŒK è¶Šå¤§å¤šæ ·æ€§è¶Šé«˜</td>
<td>å¢åŠ å¤šæ ·æ€§</td>
<td>éœ€è¦é€‰æ‹©åˆé€‚çš„ K å€¼ï¼Œé€šå¸¸ K å€¼åœ¨ 10 åˆ° 50 ä¹‹é—´</td>
</tr>
<tr>
<td>Top-P Sampling</td>
<td>ä»ç´¯è®¡æ¦‚ç‡è¾¾åˆ° P çš„ token é›†åˆä¸­é‡‡æ ·ï¼ŒP è¶Šå¤§å¤šæ ·æ€§è¶Šé«˜</td>
<td>åŠ¨æ€è°ƒæ•´å€™é€‰ token æ•°é‡</td>
<td>éœ€è¦é€‰æ‹©åˆé€‚çš„ P å€¼ï¼Œé€šå¸¸ P å€¼åœ¨ 0.8 åˆ° 0.9 ä¹‹é—´</td>
</tr>
<tr>
<td>Temperature Adjustment</td>
<td>é€šè¿‡è°ƒæ•´ temperature æ§åˆ¶éšæœºæ€§ï¼Œtemperature è¶Šå¤§å¤šæ ·æ€§è¶Šé«˜</td>
<td>çµæ´»æ§åˆ¶ç”Ÿæˆæ–‡æœ¬çš„å¤šæ ·æ€§</td>
<td>éœ€è¦é€‰æ‹©åˆé€‚çš„ temperature å€¼ï¼Œé€šå¸¸åœ¨ 0.7 åˆ° 1.0 ä¹‹é—´</td>
</tr>
</tbody>
</table>
</div>
<hr>
<h1 id="6-Part-05-å®éªŒ"><a href="#6-Part-05-å®éªŒ" class="headerlink" title="6 Part 05: å®éªŒ"></a>6 Part 05: å®éªŒ</h1><p>ç»ˆäºï¼Œæˆ‘ä»¬å®Œæˆäº†æ¨¡å‹çš„è®­ç»ƒå’Œç”Ÿæˆéƒ¨åˆ†ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®éªŒç»“æœã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬è®­ç»ƒäº†ä¸€ä¸ªå°å‹çš„ GPT-like æ¨¡å‹ï¼Œæ¨¡å‹é…ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cs336_basics/configs.py</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ModelConfig</span>:</span><br><span class="line">    vocab_size: <span class="built_in">int</span> = <span class="number">10000</span></span><br><span class="line">    max_seq_len: <span class="built_in">int</span> = <span class="number">256</span></span><br><span class="line"></span><br><span class="line">    d_model: <span class="built_in">int</span> = <span class="number">512</span></span><br><span class="line">    d_ff: <span class="built_in">int</span> = <span class="number">1344</span></span><br><span class="line"></span><br><span class="line">    num_heads: <span class="built_in">int</span> = <span class="number">16</span></span><br><span class="line">    num_layers: <span class="built_in">int</span> = <span class="number">4</span></span><br><span class="line"></span><br><span class="line">    dropout: <span class="built_in">float</span> = <span class="number">0.1</span></span><br><span class="line"></span><br><span class="line">    use_rms_norm: <span class="built_in">bool</span> = <span class="literal">True</span></span><br><span class="line">    pre_norm: <span class="built_in">bool</span> = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">     <span class="comment"># ç‰¹æ®Š token çš„ ID</span></span><br><span class="line">    eos_token_id: <span class="built_in">int</span> = <span class="number">256</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># RoPE</span></span><br><span class="line">    use_rope: <span class="built_in">bool</span> = <span class="literal">True</span></span><br><span class="line">    rope_theta: <span class="built_in">float</span> = <span class="number">10000.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># å…¶ä»–é€‰é¡¹</span></span><br><span class="line">    tie_weights: <span class="built_in">bool</span> = <span class="literal">False</span></span><br><span class="line">    use_final_norm: <span class="built_in">bool</span> = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TrainingConfig</span>:</span><br><span class="line">    batch_size: <span class="built_in">int</span> = <span class="number">32</span></span><br><span class="line">    num_steps: <span class="built_in">int</span> = <span class="number">6_000</span></span><br><span class="line">    dataset_dir: <span class="built_in">str</span> = <span class="string">&quot;datasets/tiny_stories&quot;</span></span><br><span class="line">    train_data_path: <span class="built_in">str</span> = <span class="string">&quot;datasets/tiny_stories/train.bin&quot;</span></span><br><span class="line">    eval_data_path: <span class="built_in">str</span> = <span class="string">&quot;datasets/tiny_stories/eval.bin&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä¼˜åŒ–å™¨ï¼ˆOptimizerï¼‰ç›¸å…³å‚æ•°</span></span><br><span class="line">    betas: <span class="built_in">tuple</span> = field(default=(<span class="number">0.9</span>, <span class="number">0.98</span>))</span><br><span class="line">    weight_decay: <span class="built_in">float</span> = <span class="number">1e-5</span></span><br><span class="line">    max_lr: <span class="built_in">float</span> = <span class="number">2e-4</span></span><br><span class="line">    min_lr: <span class="built_in">float</span> = <span class="number">1e-5</span></span><br><span class="line">    warmup_steps: <span class="built_in">int</span> = <span class="number">1000</span></span><br><span class="line">    max_grad_norm: <span class="built_in">float</span> = <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ—¥å¿—ä¸æ¨¡å‹ä¿å­˜ï¼ˆcheckpointï¼‰ç›¸å…³</span></span><br><span class="line">    wandb_logging: <span class="built_in">bool</span> = <span class="literal">True</span></span><br><span class="line">    eval_log_interval: <span class="built_in">int</span> = <span class="number">500</span></span><br><span class="line">    sampling_log_interval: <span class="built_in">int</span> = <span class="number">1000</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># å…¶ä»–é…ç½®</span></span><br><span class="line">    model_name: <span class="built_in">str</span> = <span class="string">&quot;tiny_stories_transformer&quot;</span></span><br><span class="line">    save_checkpoint_dir: <span class="built_in">str</span> = <span class="string">&quot;checkpoints&quot;</span></span><br><span class="line">    device: <span class="built_in">str</span> = <span class="string">&quot;cuda&quot;</span></span><br><span class="line">    debug_mode: <span class="built_in">bool</span> = <span class="literal">False</span></span><br><span class="line">    use_mixed_precision: <span class="built_in">bool</span> = <span class="literal">True</span></span><br><span class="line">    seed: <span class="built_in">int</span> = <span class="number">2025</span></span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªT4 GPUè¿›è¡Œè®­ç»ƒï¼Œè®­ç»ƒäº†6Kæ­¥ï¼ŒBatch Sizeä¸º32ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è®­ç»ƒç»“æœã€‚</p>
<hr>
<h2 id="6-1-æ›²çº¿å›¾"><a href="#6-1-æ›²çº¿å›¾" class="headerlink" title="6.1 æ›²çº¿å›¾"></a>6.1 æ›²çº¿å›¾</h2><div style="display:flex; flex-wrap:wrap; gap:12px; justify-content:center; margin: 12px 0;">
  <img src="./t1.png" style="width:calc(50% - 6px); border-radius:8px;" />
  <img src="./t2.png" style="width:calc(50% - 6px); border-radius:8px;" />
  <img src="./t3.png" style="width:calc(50% - 6px); border-radius:8px;" />
  <img src="./t4.png" style="width:calc(50% - 6px); border-radius:8px;" />
</div>
<div class="img-alt is-center">Loss å’Œ Perplexity æ›²çº¿æ˜¾ç¤º</div>

<h2 id="6-2-ç”Ÿæˆæ–‡æœ¬ç¤ºä¾‹"><a href="#6-2-ç”Ÿæˆæ–‡æœ¬ç¤ºä¾‹" class="headerlink" title="6.2 ç”Ÿæˆæ–‡æœ¬ç¤ºä¾‹"></a>6.2 ç”Ÿæˆæ–‡æœ¬ç¤ºä¾‹</h2><p><img
  src="./generate.png"
  style="width:100%; height:auto; max-height:none; object-fit:contain; display:block; border-radius:12px;"
/></p>
<div class="img-alt is-center">ç”Ÿæˆæ–‡æœ¬ç¤ºä¾‹</div>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œç”Ÿæˆçš„å¥å­æœ‰ä¸€å®šçš„è¿è´¯æ€§ï¼Œä½†æ˜¯æ•…äº‹å¹¶ä¸å®Œæ•´ï¼Œä¸”æœ‰ä¸€å®šçš„é€»è¾‘æ··ä¹±ã€‚è¿™æ˜¯å› ä¸ºæ¨¡å‹è§„æ¨¡è¾ƒå°ï¼Œè®­ç»ƒæ­¥æ•°æœ‰é™ï¼Œæ— æ³•å®Œå…¨æ•æ‰åˆ°å¤æ‚çš„è¯­è¨€ç»“æ„å’Œæ•…äº‹èƒŒæ™¯ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹å‡ ç§æ–¹å¼æ¥æå‡ç”Ÿæˆæ•ˆæœï¼š</p>
<ol>
<li><strong>å¢åŠ è®­ç»ƒæ­¥æ•°</strong>ï¼šç°åœ¨æ˜¯10Kï¼Œå¦‚æœå¢åŠ åˆ°15Kã€20Kï¼Œæ•ˆæœåº”è¯¥ä¼šæ›´å¥½</li>
<li><strong>å¢å¤§Batch Size</strong>ï¼šç›¸å¯¹æ¥è¯´ï¼ŒBatch Sizeè¶Šå¤§ï¼ŒNoiseå°±è¶Šå°ï¼Œè®­ç»ƒå°±æ›´åŠ ç¨³å®š</li>
<li><strong>å¢åŠ Context Length</strong>ï¼šå½“å‰çš„Context Lengthæ˜¯256ï¼Œå°†å…¶å¢å¤§åˆ°512ï¼Œæˆ–è€…æ›´å¤§ï¼Œå¯ä»¥è¦†ç›–ä¸€ä¸ªæ•´ä¸ªå®Œæ•´çš„æ•…äº‹ç»“æ„ã€‚</li>
</ol>
<hr>
<h1 id="7-æ€»ç»“"><a href="#7-æ€»ç»“" class="headerlink" title="7 æ€»ç»“"></a>7 æ€»ç»“</h1><p>æ­å–œå¤§å®¶ ğŸ‰ï¼ç»è¿‡ä¸æ‡ˆçš„åŠªåŠ›ï¼Œç»ˆäºå®Œæˆäº†è¿™ä¸ª Assignmentã€‚åœ¨è¿™ä¸ª Assignment ä¸­ï¼Œæˆ‘ä»¬äº†è§£äº†ä»€ä¹ˆæ˜¯ BPE Tokenizerï¼ŒTransformer Language Model çš„æ¶æ„ï¼ŒLLM çš„è®­ç»ƒæµç¨‹ï¼Œä»¥åŠæˆåŠŸåœ¨æœ€åç”Ÿæˆäº†ä¸€æ®µè¿˜ä¸é”™çš„å°æ•…äº‹ï¼Œç»™è‡ªå·±é¼“æŒ ğŸ‘ï¼å½“ç„¶ï¼Œæˆ‘ä»¬çš„æ—…ç¨‹æ‰åˆšåˆšå¼€å§‹ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¦ä¸æ–­çš„ä¼˜åŒ–è¿™ä¸ª Language Modelã€‚æ¯”å¦‚ Flash Attention çš„å®ç°ï¼Œå¯ä»¥è®© LLM åœ¨ä¸€ä¸ªGPUä¸­è·‘çš„æ›´å¿«ï¼ŒParallelism å¯ä»¥è®© LLM å¤šè…¿è·‘æ­¥ï¼Œå¹¶ä¸”æˆ‘ä»¬è¿˜ä¼šäº†è§£ä¸åŒçš„ Evaluation çš„æ–¹æ³•ã€‚ä½†æ˜¯ï¼Œç›®å‰ä¸ºæ­¢ï¼Œå·²ç»åšçš„å¾ˆå¥½äº†ï¼Œè¯·åšæŒä¸‹å»ã€‚</p>
</article><div class="post-copyright"><div class="post-copyright__author_group"><div class="post-copyright__author_img"><img class="post-copyright__author_img_front" src="/img/avatar.png"></div><div class="post-copyright__author_name">emopps</div><div class="post-copyright__author_desc">emopps</div></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div id="quit-box" onclick="RemoveRewardMask()"></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">æœ¬æ–‡æ˜¯åŸåˆ›æ–‡ç« ï¼Œé‡‡ç”¨<a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans">CC BY-NC-SA 4.0</a>åè®®ï¼Œå®Œæ•´è½¬è½½è¯·æ³¨æ˜æ¥è‡ª<a href="/">emopps</a></span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/LLM/"><span class="tags-punctuation"><i class="solitude fas fa-hashtag"></i>LLM<span class="tagsPageCount">1</span></span></a><a class="post-meta__tags" href="/tags/NLP/"><span class="tags-punctuation"><i class="solitude fas fa-hashtag"></i>NLP<span class="tagsPageCount">1</span></span></a><a class="post-meta__tags" href="/tags/PyTorch/"><span class="tags-punctuation"><i class="solitude fas fa-hashtag"></i>PyTorch<span class="tagsPageCount">1</span></span></a><a class="post-meta__tags" href="/tags/Tokenization/"><span class="tags-punctuation"><i class="solitude fas fa-hashtag"></i>Tokenization<span class="tagsPageCount">1</span></span></a><a class="post-meta__tags" href="/tags/Transformer/"><span class="tags-punctuation"><i class="solitude fas fa-hashtag"></i>Transformer<span class="tagsPageCount">1</span></span></a></div></div></div><nav class="needEndHide pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2025/09/12/c++%E6%9D%BF%E5%AD%90/"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">æ•°æ®ç»“æ„ä¸ç®—æ³•æ¨¡æ¿</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><div class="top-group"><div class="sayhi" id="sayhi" onclick="sco.changeWittyWord()"></div></div></div><div class="avatar"><img alt="å¤´åƒ" src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/default_avatar.avif'"></div><div class="description">è¿™æ˜¯æˆ‘çš„åšå®¢</div><div class="bottom-group"><span class="left"><div class="name">emopps</div><div class="desc">ä½†æˆ‘çš„äºŒåå‡ <br>åƒä¸‹æ£‹<br>è¿›é€€æ˜¯å‰æ–¹</div></span><div class="social-icons is-center"><a class="social-icon" target="_blank" rel="noopener" href="https://github.com/emopps" title="Github"><i class="solitude  fab fa-github"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="solitude fas fa-bars"></i><span>æ–‡ç« ç›®å½•</span></div><div class="toc-content" id="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Assignment-01-Tokenization-amp-Language-Modeling"><span class="toc-text">Assignment 01: Tokenization &amp; Language Modeling</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%87%86%E5%A4%87"><span class="toc-text">1 å‡†å¤‡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-PyTorch-%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E9%80%9F%E8%A7%88"><span class="toc-text">1.1 PyTorch æ ¸å¿ƒæ¦‚å¿µé€Ÿè§ˆ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E4%B8%8B%E8%BD%BD%E5%8E%9F%E5%A7%8B%E4%BB%A3%E7%A0%81%E5%92%8C%E6%95%B0%E6%8D%AE%E9%9B%86"><span class="toc-text">1.2 ä¸‹è½½åŸå§‹ä»£ç å’Œæ•°æ®é›†</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Part-01-%E5%AD%97%E8%8A%82%E5%AF%B9%E7%BC%96%E7%A0%81-BPE-%E5%AE%9E%E7%8E%B0"><span class="toc-text">2 Part 01: å­—èŠ‚å¯¹ç¼–ç  (BPE) å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-BPE-%E7%AE%97%E6%B3%95%E5%9B%9E%E9%A1%BE"><span class="toc-text">2.1 BPE ç®—æ³•å›é¡¾</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-BPE-V0"><span class="toc-text">2.2 BPE V0</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-%E9%A2%84%E5%A4%84%E7%90%86"><span class="toc-text">2.3 é¢„å¤„ç†</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-1-%E5%9F%BA%E4%BA%8E%E7%89%B9%E6%AE%8A-Token-%E7%9A%84%E5%88%87%E5%88%86"><span class="toc-text">2.3.1 åŸºäºç‰¹æ®Š Token çš„åˆ‡åˆ†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-2-%E5%9F%BA%E4%BA%8E%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E7%9A%84%E5%88%87%E5%88%86"><span class="toc-text">2.3.2 åŸºäºæ­£åˆ™è¡¨è¾¾å¼çš„åˆ‡åˆ†</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E5%9B%A0%E4%B8%80%EF%BC%9A%E9%81%BF%E5%85%8D%E2%80%9C%E6%AF%8F%E5%90%88%E5%B9%B6%E4%B8%80%E6%AC%A1%E5%B0%B1%E9%9C%80%E8%A6%81%E9%87%8D%E6%96%B0%E6%89%AB%E6%8F%8F%E4%B8%80%E9%81%8D%E2%80%9D"><span class="toc-text">åŸå› ä¸€ï¼šé¿å…â€œæ¯åˆå¹¶ä¸€æ¬¡å°±éœ€è¦é‡æ–°æ‰«æä¸€éâ€</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E5%9B%A0%E4%BA%8C%EF%BC%9A%E9%81%BF%E5%85%8D%E2%80%9C%E5%88%87%E5%87%BA%E5%8F%AA%E6%9C%89%E6%A0%87%E7%82%B9%E4%B8%8D%E5%90%8C%E7%9A%84%E9%87%8D%E5%A4%8D-token%E2%80%9D"><span class="toc-text">åŸå› äºŒï¼šé¿å…â€œåˆ‡å‡ºåªæœ‰æ ‡ç‚¹ä¸åŒçš„é‡å¤ tokenâ€</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Regex-%E8%AF%A6%E8%A7%A3"><span class="toc-text">Regex è¯¦è§£</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-3-%E5%A4%9A%E8%BF%9B%E7%A8%8B"><span class="toc-text">2.3.3 å¤šè¿›ç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-4-%E5%85%B6%E4%BB%96"><span class="toc-text">2.3.4 å…¶ä»–</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-BPE-V1-%E5%A0%86%E4%BC%98%E5%8C%96"><span class="toc-text">2.4 BPE V1: å †ä¼˜åŒ–</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-BPE-V2-%E5%A0%86%E4%BC%98%E5%8C%96-%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96"><span class="toc-text">2.5 BPE V2: å †ä¼˜åŒ– + ç´¢å¼•ä¼˜åŒ–</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-6-%E8%AE%AD%E7%BB%83-BPE"><span class="toc-text">2.6 è®­ç»ƒ BPE</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E4%B8%80%E4%B8%8B%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81"><span class="toc-text">è¿è¡Œä¸€ä¸‹æµ‹è¯•ä»£ç </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7-BPE-on-TinyStory"><span class="toc-text">2.7 BPE on TinyStory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-8-BPE-Tokenizer"><span class="toc-text">2.8 BPE Tokenizer</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#BPE-Tokenizer-%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD"><span class="toc-text">BPE Tokenizer æ ¸å¿ƒåŠŸèƒ½</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-8-1-BPETokenizer-%E4%B8%AD%E7%9A%84%E7%BC%96%E7%A0%81"><span class="toc-text">2.8.1 BPETokenizer ä¸­çš„ç¼–ç </span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-9-%E5%88%86%E8%AF%8D%E4%B8%8E%E6%95%B0%E6%8D%AE%E4%BF%9D%E5%AD%98"><span class="toc-text">2.9 åˆ†è¯ä¸æ•°æ®ä¿å­˜</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-10-Part-01-%E6%80%BB%E7%BB%93"><span class="toc-text">2.10 Part 01 æ€»ç»“</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-Part-02-%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%AE%9E%E7%8E%B0"><span class="toc-text">3 Part 02: è¯­è¨€æ¨¡å‹å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E7%BA%BF%E6%80%A7%E5%B1%82%EF%BC%88Linear-Module%EF%BC%89"><span class="toc-text">3.1 çº¿æ€§å±‚ï¼ˆLinear Moduleï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E5%B5%8C%E5%85%A5%E6%A8%A1%E5%9E%8B%EF%BC%88Embedding-Model%EF%BC%89"><span class="toc-text">3.2 åµŒå…¥æ¨¡å‹ï¼ˆEmbedding Modelï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-RMS%E5%BD%92%E4%B8%80%E5%8C%96%EF%BC%88RMS-Norm%EF%BC%89"><span class="toc-text">3.3 RMSå½’ä¸€åŒ–ï¼ˆRMS-Normï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-%E9%80%90%E7%82%B9%E5%89%8D%E9%A6%88%E7%BD%91%E7%BB%9C%EF%BC%88PointWise-Feed-Forward-Network%EF%BC%89"><span class="toc-text">3.4 é€ç‚¹å‰é¦ˆç½‘ç»œï¼ˆPointWise Feed Forward Networkï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-RoPE"><span class="toc-text">3.5 RoPE</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E6%97%8B%E8%BD%AC%E8%A7%92%E5%BA%A6"><span class="toc-text">å®šä¹‰æ—‹è½¬è§’åº¦ Î¸i,k\theta_{i,k}Î¸i,kâ€‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E6%97%8B%E8%BD%AC%E5%9D%97"><span class="toc-text">å®šä¹‰æ—‹è½¬å— RkiR_k^iRkiâ€‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E6%97%8B%E8%BD%AC%E7%9F%A9%E9%98%B5"><span class="toc-text">æ•´ä½“æ—‹è½¬çŸ©é˜µ RiR_iRiâ€‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-1-RoPE-%E7%9A%84%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82"><span class="toc-text">3.5.1 RoPE çš„å®ç°ç»†èŠ‚</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-6-%E5%A4%9A%E5%A4%B4%E6%B3%A8%E6%84%8F%E5%8A%9B%E6%9C%BA%E5%88%B6%EF%BC%88Multi-Headed-Attention%EF%BC%89"><span class="toc-text">3.6 å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶ï¼ˆMulti-Headed Attentionï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-1-%E7%BC%A9%E6%94%BE%E7%82%B9%E7%A7%AF%E6%B3%A8%E6%84%8F%E5%8A%9B%E6%9C%BA%E5%88%B6%EF%BC%88Scaled-Dot-Product-Attention%EF%BC%89"><span class="toc-text">3.6.1 ç¼©æ”¾ç‚¹ç§¯æ³¨æ„åŠ›æœºåˆ¶ï¼ˆScaled Dot-Product Attentionï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-6-1-1-Softmax-%E5%87%BD%E6%95%B0"><span class="toc-text">3.6.1.1 Softmax å‡½æ•°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-6-1-2-%E7%BC%A9%E6%94%BE%E7%82%B9%E7%A7%AF%E6%B3%A8%E6%84%8F%E5%8A%9B%E6%9C%BA%E5%88%B6%EF%BC%88Scaled-Dot-Product-Attention%EF%BC%89"><span class="toc-text">3.6.1.2 ç¼©æ”¾ç‚¹ç§¯æ³¨æ„åŠ›æœºåˆ¶ï¼ˆScaled Dot Product Attentionï¼‰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-6-1-3-%E5%9B%A0%E6%9E%9C%E6%8E%A9%E7%A0%81%EF%BC%88Causal-Masking%EF%BC%89"><span class="toc-text">3.6.1.3 å› æœæ©ç ï¼ˆCausal Maskingï¼‰</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-6-2-%E5%A4%9A%E5%A4%B4%E6%B3%A8%E6%84%8F%E5%8A%9B%E6%9C%BA%E5%88%B6%EF%BC%88Multi-Headed-Attention%EF%BC%89"><span class="toc-text">3.6.2 å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶ï¼ˆMulti Headed Attentionï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-3-%E5%BC%A0%E9%87%8F%E5%BD%A2%E7%8A%B6%E5%8F%98%E6%8D%A2"><span class="toc-text">3.6.3 å¼ é‡å½¢çŠ¶å˜æ¢</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-4-RoPE-in-Attention"><span class="toc-text">3.6.4 RoPE in Attention</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-7-Transformer-%E5%9D%97"><span class="toc-text">3.7 Transformer å—</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-7-0-1-%E5%89%8D%E7%BD%AE%E5%BD%92%E4%B8%80%E5%8C%96%EF%BC%88Pre-Norm%EF%BC%89"><span class="toc-text">3.7.0.1 å‰ç½®å½’ä¸€åŒ–ï¼ˆPre-Normï¼‰</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-8-%E8%BE%93%E5%87%BA%E5%B1%82%EF%BC%88Output-Layer%EF%BC%89"><span class="toc-text">3.8 è¾“å‡ºå±‚ï¼ˆOutput Layerï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-8-1-%E6%9D%83%E9%87%8D%E5%85%B1%E4%BA%AB%EF%BC%88Weight-Tying%EF%BC%89"><span class="toc-text">3.8.1 æƒé‡å…±äº«ï¼ˆWeight Tyingï¼‰</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-9-%E5%AE%8C%E6%95%B4-Transformer-%E6%A8%A1%E5%9E%8B"><span class="toc-text">3.9 å®Œæ•´ Transformer æ¨¡å‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-10-Part-02-%E6%80%BB%E7%BB%93"><span class="toc-text">3.10 Part 02 æ€»ç»“</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-Part-03-%E4%BC%98%E5%8C%96%E5%99%A8%EF%BC%88Optimizer%EF%BC%89%E4%B8%8E%E8%AE%AD%E7%BB%83%E4%BB%A3%E7%A0%81"><span class="toc-text">4 Part 03: ä¼˜åŒ–å™¨ï¼ˆOptimizerï¼‰ä¸è®­ç»ƒä»£ç </span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E6%8D%9F%E5%A4%B1%EF%BC%88Loss%EF%BC%89%E4%B8%8E-%E5%9B%B0%E6%83%91%E5%BA%A6%EF%BC%88Perplexity%EF%BC%89"><span class="toc-text">4.1 æŸå¤±ï¼ˆLossï¼‰ä¸ å›°æƒ‘åº¦ï¼ˆPerplexityï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-1-%E4%BA%A4%E5%8F%89%E7%86%B5%E6%8D%9F%E5%A4%B1%EF%BC%88Cross-Entropy-Loss%EF%BC%89"><span class="toc-text">4.1.1 äº¤å‰ç†µæŸå¤±ï¼ˆCross Entropy Lossï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-2-%E5%9B%B0%E6%83%91%E5%BA%A6%EF%BC%88Perplexity%EF%BC%89"><span class="toc-text">4.1.2 å›°æƒ‘åº¦ï¼ˆPerplexityï¼‰</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E4%BC%98%E5%8C%96%E5%99%A8%EF%BC%88Optimizer%EF%BC%89-%E4%B8%8E-%E5%AD%A6%E4%B9%A0%E7%8E%87%E8%B0%83%E5%BA%A6%E5%99%A8%EF%BC%88Learning-Rate-Scheduler%EF%BC%89"><span class="toc-text">4.2 ä¼˜åŒ–å™¨ï¼ˆOptimizerï¼‰ ä¸ å­¦ä¹ ç‡è°ƒåº¦å™¨ï¼ˆLearning Rate Schedulerï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-1-AdamW"><span class="toc-text">4.2.1 AdamW</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2-%E4%BD%99%E5%BC%A6%E9%80%80%E7%81%AB%E5%AD%A6%E4%B9%A0%E7%8E%87%E8%B0%83%E5%BA%A6%E5%99%A8%EF%BC%88Cosine-Annealing-Learning-Rate-Scheduler%EF%BC%89"><span class="toc-text">4.2.2 ä½™å¼¦é€€ç«å­¦ä¹ ç‡è°ƒåº¦å™¨ï¼ˆCosine Annealing Learning Rate Schedulerï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%B6%E6%AE%B51-Warm-Up"><span class="toc-text">é˜¶æ®µ1: Warm-Up</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%B6%E6%AE%B52-Cosine-Annealing"><span class="toc-text">é˜¶æ®µ2: Cosine Annealing</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%B6%E6%AE%B53-Post-Annealing"><span class="toc-text">é˜¶æ®µ3: Post-Annealing</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-3-%E6%A2%AF%E5%BA%A6%E8%A3%81%E5%89%AA%EF%BC%88Gradient-Clipping%EF%BC%89"><span class="toc-text">4.2.3 æ¢¯åº¦è£å‰ªï¼ˆGradient Clippingï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-4-%E6%95%B4%E5%90%88%E5%AE%9E%E7%8E%B0"><span class="toc-text">4.2.4 æ•´åˆå®ç°</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD%E5%99%A8%EF%BC%88Dataloader%EF%BC%89"><span class="toc-text">4.3 æ•°æ®åŠ è½½å™¨ï¼ˆDataloaderï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-%E6%A3%80%E6%9F%A5%E7%82%B9%EF%BC%88Checkpoint%EF%BC%89"><span class="toc-text">4.4 æ£€æŸ¥ç‚¹ï¼ˆCheckpointï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5-%E8%AE%AD%E7%BB%83%E5%BE%AA%E7%8E%AF"><span class="toc-text">4.5 è®­ç»ƒå¾ªç¯</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-Part-04-%E7%94%9F%E6%88%90"><span class="toc-text">5 Part 04: ç”Ÿæˆ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-%E8%B4%AA%E5%BF%83%E9%87%87%E6%A0%B7%EF%BC%88Greedy-Sampling%EF%BC%89"><span class="toc-text">5.1 è´ªå¿ƒé‡‡æ ·ï¼ˆGreedy Samplingï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-Top-K-%E9%87%87%E6%A0%B7%EF%BC%88Top-K-Sampling%EF%BC%89"><span class="toc-text">5.2 Top-K é‡‡æ ·ï¼ˆTop-K Samplingï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-Top-P-%E9%87%87%E6%A0%B7%EF%BC%88Top-P-Sampling%EF%BC%89"><span class="toc-text">5.3 Top-P é‡‡æ ·ï¼ˆTop-P Samplingï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-4-Temperature"><span class="toc-text">5.4 Temperature</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-5-Part-04-%E6%80%BB%E7%BB%93"><span class="toc-text">5.5 Part 04 æ€»ç»“</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-Part-05-%E5%AE%9E%E9%AA%8C"><span class="toc-text">6 Part 05: å®éªŒ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-%E6%9B%B2%E7%BA%BF%E5%9B%BE"><span class="toc-text">6.1 æ›²çº¿å›¾</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-%E7%94%9F%E6%88%90%E6%96%87%E6%9C%AC%E7%A4%BA%E4%BE%8B"><span class="toc-text">6.2 ç”Ÿæˆæ–‡æœ¬ç¤ºä¾‹</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-%E6%80%BB%E7%BB%93"><span class="toc-text">7 æ€»ç»“</span></a></li></ol></div></div><div class="card-widget card-tags card-archives card-webinfo card-allinfo"><div class="card-tag-cloud"><a href="/tags/LLM/">LLM<sup>1</sup></a><a href="/tags/NLP/">NLP<sup>1</sup></a><a href="/tags/PyTorch/">PyTorch<sup>1</sup></a><a href="/tags/Tokenization/">Tokenization<sup>1</sup></a><a href="/tags/Transformer/">Transformer<sup>1</sup></a><a href="/tags/c/">c++<sup>2</sup></a><a href="/tags/%E5%AD%A6%E4%B9%A0/">å­¦ä¹ <sup>3</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/">æ•°æ®ç»“æ„ä¸ç®—æ³•<sup>1</sup></a><a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">æ“ä½œç³»ç»Ÿ<sup>1</sup></a><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">è®¡ç®—æœºç½‘ç»œ<sup>1</sup></a></div><style>.card-tag-cloud::after {
    display: none !important;
}</style><hr><div class="webinfo"><div class="webinfo-item"><div class="item-name">æ–‡ç« æ€»æ•° :</div><div class="item-count">5</div></div><div class="webinfo-item"><div class="item-name">å»ºç«™å¤©æ•° :</div><div class="item-count" id="runtimeshow"></div></div><div class="webinfo-item"><div class="item-name">æœ€åæ›´æ–° :</div><time class="item-count" datetime="2026-02-08T05:15:38.584Z"></time></div><div class="webinfo-item"><div class="item-name">å…¨ç«™å­—æ•° :</div><div class="item-count">130.5k</div></div></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="solitude fas fa-map"></i><span>æœ€è¿‘å‘å¸ƒ</span></div><div class="aside-list"><a class="aside-list-item" href="/cs336/" title="Tokenization &amp; Language Modeling"><div class="thumbnail"><img alt="Tokenization &amp; Language Modeling" src="/img/covers/cs336.png"><span class="thumbnail_text">cs336-a1</span></div><div class="content"><span class="title" href="/cs336/" title="Tokenization &amp; Language Modeling">Tokenization &amp; Language Modeling</span><span class="categories" href="/cs336/">å­¦ä¹ ç¬”è®°</span></div></a><a class="aside-list-item" href="/2025/09/12/c++%E6%9D%BF%E5%AD%90/" title="æ•°æ®ç»“æ„ä¸ç®—æ³•æ¨¡æ¿"><div class="thumbnail"><img alt="æ•°æ®ç»“æ„ä¸ç®—æ³•æ¨¡æ¿" src="/img/covers/ds.png"><span class="thumbnail_text">c++æ¨¡æ¿</span></div><div class="content"><span class="title" href="/2025/09/12/c++%E6%9D%BF%E5%AD%90/" title="æ•°æ®ç»“æ„ä¸ç®—æ³•æ¨¡æ¿">æ•°æ®ç»“æ„ä¸ç®—æ³•æ¨¡æ¿</span><span class="categories" href="/2025/09/12/c++%E6%9D%BF%E5%AD%90/">æŠ€æœ¯åˆ†äº«</span></div></a><a class="aside-list-item" href="/2025/07/24/c++%E5%85%AB%E8%82%A1%E6%96%87/" title="c++å…«è‚¡"><div class="thumbnail"><img alt="c++å…«è‚¡" src="/img/covers/c++.png"><span class="thumbnail_text">c++å…«è‚¡</span></div><div class="content"><span class="title" href="/2025/07/24/c++%E5%85%AB%E8%82%A1%E6%96%87/" title="c++å…«è‚¡">c++å…«è‚¡</span><span class="categories" href="/2025/07/24/c++%E5%85%AB%E8%82%A1%E6%96%87/">æŠ€æœ¯åˆ†äº«</span></div></a><a class="aside-list-item" href="/2025/07/24/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%85%AB%E8%82%A1%E6%96%87/" title="æ“ä½œç³»ç»Ÿå…«è‚¡"><div class="thumbnail"><img alt="æ“ä½œç³»ç»Ÿå…«è‚¡" src="/img/covers/os.png"><span class="thumbnail_text">æ“ä½œç³»ç»Ÿ</span></div><div class="content"><span class="title" href="/2025/07/24/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%85%AB%E8%82%A1%E6%96%87/" title="æ“ä½œç³»ç»Ÿå…«è‚¡">æ“ä½œç³»ç»Ÿå…«è‚¡</span><span class="categories" href="/2025/07/24/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%85%AB%E8%82%A1%E6%96%87/">æŠ€æœ¯åˆ†äº«</span></div></a><a class="aside-list-item" href="/2025/07/24/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E5%85%AB%E8%82%A1%E6%96%87/" title="è®¡ç®—æœºç½‘ç»œå…«è‚¡"><div class="thumbnail"><img alt="è®¡ç®—æœºç½‘ç»œå…«è‚¡" src="/img/covers/cn.png"><span class="thumbnail_text">è®¡ç®—æœºç½‘ç»œ</span></div><div class="content"><span class="title" href="/2025/07/24/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E5%85%AB%E8%82%A1%E6%96%87/" title="è®¡ç®—æœºç½‘ç»œå…«è‚¡">è®¡ç®—æœºç½‘ç»œå…«è‚¡</span><span class="categories" href="/2025/07/24/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E5%85%AB%E8%82%A1%E6%96%87/">æŠ€æœ¯åˆ†äº«</span></div></a></div></div></div></div></main><footer id="footer"><div id="footer_deal"><a class="deal_link" target="_blank" rel="noopener" href="https://github.com/emopps" title="Github"><i class="solitude  fab fa-github"></i></a><div class="nolazyload footer_mini_logo" id="footer_mini_logo" title="è¿”å›é¡¶éƒ¨" onclick="sco.toTop()"><img alt="è¿”å›é¡¶éƒ¨"></div><a class="deal_link" target="_blank" rel="noopener" href="https://space.bilibili.com/" title="Bilibili"><i class="solitude  fab fa-bilibili"></i></a></div><div id="st-footer"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div class="copyright">Â© 2026 By<a class="footer-bar-link" href="/" title="emopps">emopps</a></div><div class="beian-group"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://hexo.io/" title="æ¡†æ¶ï¼šHexo">æ¡†æ¶ï¼šHexo</a><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/everfu/hexo-theme-solitude" title="ä¸»é¢˜ï¼šSolitude">ä¸»é¢˜ï¼šSolitude</a></div></div><div><div class="footer-bar-right"><a class="footer-bar-link" href="/atom.xml" title="">RSS</a><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/everfu/hexo-theme-solitude/blob/main/LICENSE" title=""><i class="solitude fas fa-copyright"></i><i class="solitude fab fa-creative-commons-by"></i><i class="solitude fab fa-creative-commons-nc"></i><i class="solitude fab fa-creative-commons-nd"></i></a></div></div></div></div><div class="comment-barrage needEndHide"></div></footer></div><div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="solitude fas fa-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="solitude fas fa-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="solitude fas fa-arrows-rotate"></i></div><div class="rightMenu-item" id="menu-top"><i class="solitude fas fa-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="solitude fas fa-clone"></i><span>å¤åˆ¶é€‰ä¸­æ–‡æœ¬</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="solitude fas fa-clipboard"></i><span>ç²˜è´´æ–‡æœ¬</span></div><div class="rightMenu-item" id="menu-newwindow"><i class="solitude far fa-window-maximize"></i><span>æ–°çª—å£æ‰“å¼€</span></div><div class="rightMenu-item" id="menu-copylink"><i class="solitude fas fa-link"></i><span>å¤åˆ¶é“¾æ¥åœ°å€</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="solitude fas fa-clone"></i><span>å¤åˆ¶æ­¤å›¾ç‰‡</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="solitude fas fa-cloud-arrow-down"></i><span>ä¸‹è½½æ­¤å›¾ç‰‡</span></div><div class="rightMenu-item" id="menu-search"><i class="solitude fas fa-magnifying-glass"></i><span>ç«™å†…æœç´¢</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><div class="rightMenu-item" id="menu-darkmode" onclick="sco.switchDarkMode()"><i class="solitude fas fa-circle-half-stroke"></i><span class="menu-darkmode-text">æ·±è‰²æ¨¡å¼</span></div></div></div><div id="rightmenu-mask"></div></div><div><!-- Critical scripts loaded synchronously--><script src="/js/utils.js?v=3.0.21"></script><script src="/js/main.js?v=3.0.21"></script><!-- Non-critical scripts loaded asynchronously--><script async src="/js/third_party/waterfall.min.js?v=3.0.21"></script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><!-- Feature-specific scripts loaded asynchronously--><script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/typeit@8.8.7/dist/index.umd.min.js"></script><script defer src="/js/third_party/universe.min.js?v=3.0.21"></script><script>document.addEventListener('DOMContentLoaded', () => {
  if (typeof dark === 'function') dark();
});
</script><script defer src="/js/tw_cn.js?v=3.0.21"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script><!-- UI enhancement scripts--><script defer src="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.js"></script><!-- Music player scripts--><script>var meting_api = 'https://api.injahow.cn/meting/?server=:server&type=:type&id=:id&auth=:auth&r=:r';</script><script defer src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/meting@2.0.1/dist/Meting.min.js"></script><!-- Cover color processing scripts--><script defer src="https://cdn.jsdelivr.net/npm/colorthief@2.6.0/dist/color-thief.min.js"></script><script defer src="/js/covercolor/local.js?v=3.0.21"></script><script>window.paceOptions = {
  restartOnPushState: false
}

utils.addGlobalFn('pjaxSend', () => {
  Pace.restart()
}, 'pace_restart')
</script><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!-- Search functionality--><!-- Right menu functionality--><script defer src="/js/right_menu.js?v=3.0.21"></script><script src="/schedule/chinese-lunar.js"></script><script src="/schedule/schedule.js"></script><script src="/schedule/history.js"></script><div class="js-pjax"></div></div><!-- pjax--><script>let pjax = null;

function initPjax() {
    if (typeof Pjax === 'undefined') {
        console.warn('Pjax is not loaded yet, retrying...');
        setTimeout(initPjax, 100);
        return;
    }

    pjax = new Pjax({
        elements: 'a:not([target="_blank"])',
        selectors: ["title","#body-wrap","#site-config","meta[name=\"description\"]",".js-pjax","meta[property^=\"og:\"]","#config-diff",".rs_show",".rs_hide"],
        cacheBust: false,
        analytics: false,
        scrollRestoration: false
    })

    // å°† pjax å®ä¾‹æŒ‚è½½åˆ°å…¨å±€
    window.pjax = pjax;

    document.querySelectorAll('script[data-pjax]').forEach(item => {
        const newScript = document.createElement('script')
        const content = item.text || item.textContent || item.innerHTML || ""
        Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
        newScript.appendChild(document.createTextNode(content))
        item.parentNode.replaceChild(newScript, item)
    })

    document.addEventListener('pjax:complete', () => {
        window.refreshFn()

        document.querySelectorAll('script[data-pjax]').forEach(item => {
            const newScript = document.createElement('script')
            const content = item.text || item.textContent || item.innerHTML || ""
            Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
            newScript.appendChild(document.createTextNode(content))
            item.parentNode.replaceChild(newScript, item)
        })

        GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

    })

    document.addEventListener('pjax:error', (e) => {
        if (e.request.status === 404) {
            pjax.loadUrl('/404.html')
        }
    })
}

// åˆå§‹åŒ– Pjax
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPjax);
} else {
    initPjax();
}</script><!-- google adsense--><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><button class="search-close-button"><i class="solitude fas fa-xmark"></i></button></nav><div class="search-wrap"><div class="search-box"><input class="search-box-input" id="search-input" type="text" autocomplete="off" spellcheck="false" autocorrect="off" autocapitalize="off" placeholder="è¾“å…¥å…³é”®è¯å¿«é€ŸæŸ¥æ‰¾"></div><div id="search-results"><div id="search-hits"></div></div><div id="search-pagination"></div><div id="search-tips"></div></div></div><div id="search-mask"></div></div><script src="/js/search/local.js?v=3.0.21"></script></body></html>
        <script>
            const posts = ["/cs336/","2025/09/12/c++æ¿å­/","2025/07/24/c++å…«è‚¡æ–‡/","2025/07/24/æ“ä½œç³»ç»Ÿå…«è‚¡æ–‡/","2025/07/24/è®¡ç®—æœºç½‘ç»œå…«è‚¡æ–‡/"];
            function toRandomPost() {
                const randomPost = posts[Math.floor(Math.random() * posts.length)];
                pjax.loadUrl(GLOBAL_CONFIG.root + randomPost);
            }
        </script>